{"version":3,"sources":["webpack://cpu-audio/./src/utils.js","webpack://cpu-audio/./src/i18n.js","webpack://cpu-audio/./src/default_dataset.js","webpack://cpu-audio/./src/convert.js","webpack://cpu-audio/./src/translate_vtt.js","webpack://cpu-audio/./src/build_playlist.js","webpack://cpu-audio/./src/media_element_extension.js","webpack://cpu-audio/./src/trigger.js","webpack://cpu-audio/./src/finger_manager.js","webpack://cpu-audio/./src/build_chapters.js","webpack://cpu-audio/./src/build_interface.js","webpack://cpu-audio/./src/element_cpu.js","webpack://cpu-audio/./src/cpu_controller.class.js","webpack://cpu-audio/./src/cpu_audio.class.js","webpack://cpu-audio/./src/default_document_cpu_parameters.js","webpack://cpu-audio/./src/document_cpu.js","webpack://cpu-audio/./src/index.js","webpack://cpu-audio/./tmp/insert_template.js"],"names":["CpuAudioTagName","CpuControllerTagName","selectorInterface","selectorAcceptable","selectorAudioInComponent","passiveEvent","passive","oncePassiveEvent","once","querySelectorDo","selector","callback","subtree","document","Array","from","querySelectorAll","forEach","adjacentArrayValue","arr","value","offset","indexOf","index","browserIsDecent","undefined","window","customElements","absolutizeUrl","url","test_element","createElement","href","split","notScreenContext","matchMedia","matches","preventLinkToSamePage","event","location","target","preventDefault","escapeHtml","text","burn_after_reading","innerText","out","innerHTML","remove","findInterface","child","closest","findContainer","includes","tagName","CPU","closest_cpuaudio","parentNode","host","warn","message","console","sources_i18n","prefered_language","querySelector","lang","length","toLowerCase","languages","navigator","language","browserLanguage","added","line","code","__","head","defaultDataset","domain","header_element","content","title","attr","playlist","waveform","duration","download","units_scale","d","h","m","s","scale","_is_only_numeric","_any_not_numeric","timeInSeconds","givenTime","seconds","test","Number","convert","colontimeInSeconds","subunittimeInSeconds","secondsInTime","givenSeconds","Infinity","converted","inned","key","hasOwnProperty","multiply","digits","Math","floor","secondsInColonTime","durationIso","toUpperCase","atom","replace","atoms","pos","secondsInPaddledColonTime","colon_time","substr","acceptables_tags","i","em","b","bold","u","vtt_opentag","vtt_closetag","vtt_cr","not_acceptable_tag","name","opentag","tag","class_name","attribute","$_attr","trim","closetag","translateVTT","vtt_taged","plane_playlist","buildPlaylist","wasFocusedId","globalController","isController","previous_playlist","current_playlist","currentPlaylist","pointDataGroup","plane","addPlane","track","panel","highlight","_comp","clearPlane","removePlane","audiotag_id","getElementById","dataset","link","bulkPoints","element","shadowRoot","insertAdjacentElement","planePanel","highlightPoint","audiotag","id","activecueClassname","planeName","pointName","planeAndPointNamesFromId","focusPoint","recallStoredPlay","currentAudiotagPlaying","isAudiotagStreamed","lasttimecode","localStorage","getItem","currentSrc","trigger","_last_play_error","seekElementAt","play","HTMLAudioElement","prototype","CPU_connected","count_element","streamed","uncertainDuration","isNaN","audiotagDuration","_natural","_forced","audiotagPreloadMetadata","addEventListener","setAttribute","attach_events_audiotag","playOnce","ended","on","update","pause","getAttribute","CPU_controller","this","CPU_update","controller","api","body_className_playing_cue","playOnceUnlock","autoplay","_timecode_start","_timecode_end","hashOrder","async","hashcode","callback_fx","at_start","hash","timecode","segments","parameter","p_key","p_value","timecode_start","timecode_end","jumpIdAt","hover","clientX","targetTouches","container","x","width","shadowId","getBoundingClientRect","ratio","showThrobberAt","hideThrobber","throbble","offsetX","DocumentCPU","clientWidth","isAudiotagPlaying","updateLoading","at","removeItem","document_cpu","lastUsed","currentTime","promised","then","hadPlayed","catch","error","unlock","bind","CPU_api","glowBeforePlay","setActContainer","isEqualNode","wasFocused","focusedId","attachAudiotagToController","showMain","redrawAllPlanes","setModeContainer","switchControllerTo","toggleplay","paused","mult","altKey","ctrlKey","metaKey","shiftKey","seek_relative","hideThrobberLater","keyCode","focused","restart","keymove","prevFocus","nextFocus","reward","foward","fastreward","fastFactor","fastfoward","prevcue","points","planePoints","go","cue","Object","values","reverse","end","start","nextcue","cuechange","active_cue","body_classes","body","classList","add","setItem","String","playlist_name","playlists","playlist_index","next_id","next_audiotag","pressing","acceptable_press_actions","pressManager","press","clearTimeout","setTimeout","repeat","repeatDelay","repeatFactor","release","plane_chapters","get_chapter_tracks","chapter_track","textTracks","tracks","kind","build_chapters","has","cues","cuechange_event_this","cuechange_event","removeEventListener","point","cuepoint","startTime","endTime","activeCues","body_class","body_classlist","cue_line","_activecue_id","removeHighlightsPoints","emitEvent","nativeShare","canonical","audiotagDataset","share","buildInterface","interface_classlist","cliquables","time","actions","showActions","back","poster","elementId","_buttons","button_element","timeline_element","showHandheldNav","repositionTracks","this_build_chapters","track_element","_CPU_load_ev","buildChaptersLoader","updatePlayButton","updateLinks","canonical_element","acceptableHideAtttributes","previewClassname","planeNameBorders","validId","planePointNamesFromId","element_id","match","previewContainerHover","getPointId","isSeconds","sec","showElement","show","checkPointData","CPU_element_api","container_interface","shadow","mode_when_play","hasAttribute","mode_was","act_was","_CPU_planes","_planes","attributesChanges","mode","mode_still","mode_play","setHideContainer","event_name","detail","dispatchEvent","CustomEvent","bubbles","cancelable","composed","classes","act","hide_elements","container_class","hide_this","_attr","control_button","aria","_preload","readyState","HAVE_CURRENT_DATA","loading","label","will_act","_CPU_played","hide_panels_except_play_mark","loadingline_element","style","_is_at","elapse_element","duration_element","updateLine","isAudiotagGlobal","check","addPoint","error_object","error_message","showInterface","MediaError","MEDIA_ERR_ABORTED","media_err_aborted","MEDIA_ERR_NETWORK","media_err_network","MEDIA_ERR_DECODE","media_err_decode","MEDIA_ERR_SRC_NOT_SUPPORTED","media_err_src_not_supported","media_err_unknow","pageerror","updateError","updateTime","updateTimeBorders","seconds_begin","seconds_end","left","right","seeked_time","phylactere","positionTimeElement","opacity","dateTime","_hider","timepos","tag_id","_url","encodeURIComponent","_twitter","twitter","substring","src","links","facebook","email","classlist","toggle","styleName","css","removeCss","appendChild","element_canonical","untitled","time_element","backgroundImage","addIdToAudiotag","completeTemplate","keys","concat","planeTrack","planeData","removeHighlightsPoints_bind","assignEventsOnPlanes","plane_track","plane_panel","mirroredInController","drawPlane","fromEntries","entries","sort","point_a","point_b","_st_max","planeSort","previous_element","planePointNames","pointPanel","pointData","image","use_link","elementPointTrack","pointTrack","tabIndex","track_img","elementPointPanel","planeNav","drawPoint","panelReorder","nav","refreshPlane","original_data","will_refresh","that_start","removePoint","className","mirror","focus","relativeFocus","self","go_foward","planeNames","validPlane","data","previous_pointName","fromPlane","scanToNextPlane","scanToPrevPlane","observer_component","component","media_tagname","info","copyAttributesToMediaDataset","CpuControllerElement","HTMLElement","super","template","attachShadow","MutationObserver","observe","childList","attributes","observer_audio","CpuAudioElement","connectedCallback","hidden","removeAttribute","push","connectAudiotag","filter","entry_id","playStopOthers","alternateDelay","advanceInPlaylist","adjacentKey","obj","doNeedleMove","secs","mocked_event","HAVE_FUTURE_DATA","doElementPlay","HTMLMediaElement","load","fastSeek","e","current_audiotag","main","moment","more","e_mail","insert_template","define","get","HTMLDocument"],"mappings":"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","file":"cpu-audio.js","sourcesContent":["/** @license\nCpu-Audio: an extension to the hash system to address timecode into audio/video elements and a player WebComponent\nVersion 6.7pre\nCopyright (C) 2014-2021 Xavier \"dascritch\" Mouton-Dubosc & contributors.\nLicense GNU GPL 3\n\n- project mini-site https://dascritch.github.io/cpu-audio/\n- project repository : https://github.com/dascritch/cpu-audio\n- use case : http://cpu.pm\n- blog post : https://dascritch.net/post/2018/11/06/Reconstruire-son-lecteur-audio-pour-le-web\n**/\n\nexport const CpuAudioTagName = 'CPU-AUDIO';\nexport const CpuControllerTagName = 'CPU-CONTROLLER';\nexport const selectorInterface = '#interface';\nexport const selectorAcceptable = 'audio[controls]';\nexport const selectorAudioInComponent = 'cpu-audio audio'; // should be 'audio[controls]' but PHRACK APPLE !\n\n// Parameters for addEventListener\n// @private\nexport const passiveEvent = {passive: true};\n// @private\nexport const oncePassiveEvent = {passive: true, once: true};\n\n// private,to add attributes for unnamed <audio>\n// @private\nexport const dynamicallyAllocatedIdPrefix = 'CPU-Audio-tag-';\n\n/**\n * @summary Process a function on each matched CSS selector found in a DOM tree\n *\n * @param      {string}                selector             The css selector\n * @param      {Function}              callback             The callback function, its 1st parameter will be the matching DOM element\n * @param      {Element|HTMLDocument|ShadowRoot}  [subtree=document]  The subtree, by default the whole hosting document\n */\nexport function querySelectorDo(selector, callback, subtree=document) {\n\tArray.from(\n\t\tsubtree.querySelectorAll(selector)\n\t).forEach(callback);\n}\n\n/**\n * @summary Find adjacent key to a key in object, previous or next one\n * @public via document.CPU for tests purposes\n *\n * @param      \t{object}              \tobject    \tObject to analyze\n * @param       string \t\t\t\t\tkey \t\tKey where to position\n * @param       number \t\t\t\t\toffset \t\toffset to reposition. -1 for previous, +1 for next\n * @return    \tstring|null|undefined          \t\tfound key, null or undefined if inapplicable\n */\nexport function adjacentKey(obj, key, offset) {\n\tif (!obj?.hasOwnProperty) {\n\t\treturn null;\n\t}\n\tconst keys = Object.keys(obj);\n\treturn keys[keys.indexOf(key) + offset];\n}\n\n/**\n * @summary Find adjacent value to a value in an array, previous or next one\n *\n * @param      \tarray              \t\tarray    \tArray to analyse\n * @param       string \t\t\t\t\tvalue \t\tValue where to position\n * @param       number \t\t\t\t\toffset \t\toffset to reposition. -1 for previous, +1 for next\n * @return    \tstring|null|undefined          \t\tfound key, null or undefined if inapplicable\n */\nexport function adjacentArrayValue(arr, value, offset) {\n\tif (!arr?.indexOf) {\n\t\treturn null;\n\t}\n\tconst index = arr.indexOf(value);\n\tif (index === -1) {\n\t\treturn null;\n\t}\n\treturn arr[index + offset];\n}\n\n\n/**\n * @summary Determines if the hosting browser can use webcomponents.\n *\n * @return     {boolean}  True if decent browser for webcomponents, False otherwise.\n */\nexport function browserIsDecent() {\n\treturn window.customElements !== undefined;\n}\n\n/**\n * @summary Transform a possibily relative URL to an absolute URL, including server name, but removing hash part\n *\n * @param      {string}  url     The url\n * @return     {string}  url     Absolute url\n */\nexport function absolutizeUrl(url) {\n\tlet test_element = document.createElement('a');\n\ttest_element.href = (typeof url !== 'string') ? url : url.split('#')[0];\n\treturn test_element.href;\n}\n\n/**\n * @summary Checks if we are in a screen context, and not a vocal or braille interface\n *\n * @return     {boolean}  False if have a screen\n */\nexport function notScreenContext() {\n\treturn !window.matchMedia('screen').matches;\n}\n\n/**\n * @summary Will prevent a link in a page if linked to the same absolute URL\n *\n * @param      {Event}  event   The event\n */\nfunction preventLinkToSamePage(event) {\n\tif (absolutizeUrl(window.location.href) === absolutizeUrl(event.target.href)) {\n\t\tevent.preventDefault();\n\t}\n}\n\n/**\n * @summary Cancel any action on this link if its href is in this page\n *\n * @param      {Element}  element  The <A> DOM element\n */\nexport function preventLinkOnSamePage(element) {\n\telement.addEventListener('click', preventLinkToSamePage);\n}\n\n/**\n * @summary Escape a text. Will truly escape HTML tags and entities. No hazardous regexes or replaces\n *\n * @param      {string}  text    The text\n * @return     {string}  HTML escaped text\n */\nexport function escapeHtml(text) {\n\tlet burn_after_reading = document.createElement('span');\n\tburn_after_reading.innerText = text;\n\tlet out = burn_after_reading.innerHTML;\n\tburn_after_reading.remove();\n\treturn out;\n}\n\n/**\n * @summary check if an element.id is cited in hash url\n *\n * @param      {string}   id      element id to check\n * @return     {boolean}  is in hash\n * /\nfunction id_in_hash(id) {\n\treturn location.hash.substr(1).split('&').includes(id);\n}*/\n\n\n/**\n * @summary For any ShadowDOM element, will returns its parent interface container\n * @public via document.CPU.findInterface\n *\n * @param      {Element}  child   The ShadowDOM child\n * @return     {Element}  The #interface element\n */\nexport function findInterface(child) {\n\treturn child.closest(selectorInterface);\n}\n\n/**\n * @summary For any <audio> tag or its child tag or shadowDOM element, returns the element `CPU` API\n * @public via document.CPU.findContainer\n *\n * @param      {Element}  child   The child\n * @return     {CPU_element_api}       Element.CPU\n */\nexport function findContainer(child) {\n\tif ([CpuAudioTagName, CpuControllerTagName].includes(child.tagName)) {\n\t\treturn child.CPU;\n\t}\n\n\tlet closest_cpuaudio = child.closest(CpuAudioTagName);\n\tif (closest_cpuaudio) {\n\t\treturn closest_cpuaudio.CPU;\n\t}\n\n\treturn findInterface(child).parentNode.host.CPU;\n}\n\n\n/**\n * @summary Shortcut for console info\n *\n * @param      {string}  message  The message\n */\nexport function info(message) {\n\twindow.console.info(`${CpuAudioTagName}: `,message);\n}\n\n/**\n * @summary Shortcut for console warning\n *\n * @param      {string}  message  The message\n */\nexport function warn(message) {\n\twindow.console.warn(`${CpuAudioTagName}: `,message);\n}\n\n/**\n * @summary Shortcut for console error\n *\n * @param      {string}  message  The message\n */\nexport function error(message) {\n\twindow.console.error(`${CpuAudioTagName}: `,message);\n}\n","const sources_i18n = {\n\t'fr' : {\n\t\t'loading' : 'Chargement en cours',\n\t\t'pause' : 'Pause',\n\t\t'play' : 'Lecture',\n\t\t'canonical' : 'Lien vers la fiche du sonore',\n\t\t'moment' : 'Lien vers ce moment',\n\n\t\t'untitled' : '(sans titre)',\n\t\t'cover' : 'pochette',\n\t\t'more' : 'Actions',\n\t\t'share' : 'Partager',\n\t\t'twitter' : 'Partager sur Twitter',\n\t\t'facebook' : 'Partager sur Facebook',\n\t\t'e_mail' : 'Partager par e-mail',\n\t\t'download' : 'Tlcharger',\n\t\t'back' : 'Annuler',\n\n\t\t'chapters' : 'Chapitres',\n\t\t'playlist' : 'Playlist',\n\n\t\t'media_err_aborted' : 'Vous avez annul la lecture.',\n\t\t'media_err_network' : 'Une erreur rseau a caus l\\'interruption du tlchargement.',\n\t\t'media_err_decode' : 'La lecture du sonore a t annule suite  des problmes de corruption ou de fonctionnalits non supports par votre navigateur.',\n\t\t'media_err_src_not_supported' : 'Le sonore n\\'a pu tre charg, soit  cause de sourcis sur le serveur, le rseau ou parce que le format n\\'est pas support.',\n\t\t'media_err_unknow' : 'Erreur due  une raison inconnue.'\n\t},\n\t'en' : {\n\t\t'loading' : 'Loading',\n\t\t'pause' : 'Pause',\n\t\t'play' : 'Play',\n\t\t'canonical' : 'Link to the sound\\'s page',\n\t\t'moment' : 'Link to this time',\n\n\t\t'untitled' : '(untitled)',\n\t\t'cover' : 'cover',\n\t\t'more' : 'Actions',\n\t\t'share' : 'Share',\n\t\t'twitter' : 'Share on Twitter',\n\t\t'facebook' : 'Share on Facebook',\n\t\t'e_mail' : 'Share via e-mail',\n\t\t'download' : 'Download',\n\t\t'back' : 'Back',\n\n\t\t'chapters' : 'Chapters',\n\t\t'playlist' : 'Playlist',\n\n\t\t'media_err_aborted' : 'You have aborted the play.',\n\t\t'media_err_network' : 'A network error broke the download.',\n\t\t'media_err_decode' : 'Play was canceled due to file corruption or a not supported function in your browser.',\n\t\t'media_err_src_not_supported' : 'The media cannot be downloaded due to server problems, network problems or unsupported by your browser.',\n\t\t'media_err_unknow' : 'Error of unknown cause.'\n\t},\n};\n\n\n// First, we'll try to guess the hosting page language\nexport let prefered_language = document.querySelector('html').lang;\n\nif ((!prefered_language.length) || (!(prefered_language.toLowerCase() in sources_i18n))) {\n\n\t// Inexisting ?\n\tprefered_language = 'en';\n\t// We will use english in last resort\n\n\t// trying to find the browser preferences\n\tlet languages = window.navigator.languages;\n\tlanguages = (languages !== undefined) ?\n\t\t\t\tlanguages :\n\t\t\t\t[(navigator.language || navigator.browserLanguage)];\n\tlet added = false;\n\tfor (let line of languages) {\n\t\tif (line.split) {\n\t\t\t// we will only look (yes, this is bad) at the first level xx of any locale xx-YY code\n\t\t\tlet code = line.split('-')[0];\n\t\t\tif ( (!added) && (code in sources_i18n)) {\n\t\t\t\t// we still don't have a locale selected and this one is in our register, we can use it\n\t\t\t\tprefered_language = code;\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport const __ = sources_i18n[prefered_language];\n","let head = document.head;\n\nexport const defaultDataset = {\n\tget title() {\n\t\tfor (const domain of ['property=\"og:title\"', 'name=\"twitter:title\"']) {\n\t\t\tconst header_element = head.querySelector(`meta[${domain}]`);\n\t\t\tif (header_element) {\n\t\t\t\treturn header_element.content;\n\t\t\t}\n\t\t}\n\t\tconst title = document.title;\n\t\treturn title === '' ? null : title;\n\t},\n\tget poster() {\n\t\tfor (const attr of ['property=\"og:image\"', 'name=\"twitter:image:src\"']) {\n\t\t\tconst header_element = head.querySelector(`meta[${attr}]`);\n\t\t\tif (header_element) {\n\t\t\t\treturn header_element.content;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t},\n\tget canonical() {\n\t\tconst header_element = head.querySelector('link[rel=\"canonical\"]');\n\t\tif (header_element) {\n\t\t\treturn header_element.href;\n\t\t}\n\t\treturn location.href.split('#')[0];\n\t},\n\tget twitter() {\n\t\tconst header_element = head.querySelector('meta[name=\"twitter:creator\"]');\n\t\tif ((header_element) && (header_element.content.length > 1)) {\n\t\t\treturn header_element.content;\n\t\t}\n\t\treturn null;\n\t},\n\tplaylist : null,\n\twaveform : null,\n\tduration : null,\n\tdownload : null\n};","const units_scale = {\n\td : 86400,\n\th : 3600,\n\tm : 60,\n\ts : 1\n};\nlet scale = [1, 60, 3600, 86400];\n\nconst _is_only_numeric = /^\\d+$/;\nconst _any_not_numeric = /\\D*/g;\n\n// How Inifity (streamed live media with unspecified duration) should be humanly expressed\nconst Infinity_representation = '?';\n\n/**\n * @summary convert a string empty, with a number, with a colon-coded or an human-coded timecode in seconds\n * @public\n *\n * @class      timeInSeconds (name)\n * @param      {string}  givenTime  The given time\n * @return     {number}  time in seconds\n */\nexport const timeInSeconds = function(givenTime) {\n\tlet seconds = 0;\n\tif (givenTime !== '') {\n\t\tif (_is_only_numeric.test(givenTime)) {\n\t\t\tseconds = Number(givenTime);\n\t\t} else {\n\t\t\tseconds = givenTime.includes(':') ?\n\t\t\t\tconvert.colontimeInSeconds(givenTime) :\n\t\t\t\tconvert.subunittimeInSeconds(givenTime) ;\n\t\t}\n\t}\n\treturn seconds;\n};\n\n/**\n * @summary convert a human-coded (`1h2m3s`) time in seconds\n * @public\n *\n * @class      subunittimeInSeconds (name)\n * @param      {string}  givenTime  The given time\n * @return     {number}  seconds\n */\nexport const subunittimeInSeconds = function(givenTime) {\n\tlet seconds = 0;\n\tlet atom;\n\tfor(let key in units_scale) {\n\t\tif ( (units_scale.hasOwnProperty(key)) && (givenTime.includes(key)) ) {\n\t\t\t[atom, givenTime] = givenTime.split(key);\n\t\t\tseconds += Number(atom.replace(_any_not_numeric,'' )) * units_scale[key];\n\t\t}\n\t}\n\treturn seconds;\n};\n\n/**\n * @summary    convert a colon-coded (`01:02:03`) time in seconds\n * @public\n *\n * @class      colontimeInSeconds (name)\n * @param      {string}  givenTime  The given time\n * @return     {number}  Time in seconds\n */\nexport const colontimeInSeconds = function(givenTime) {\n\tlet seconds = 0;\n\tlet atoms = givenTime.split(':');\n\tfor (let pos = 0 ; pos < atoms.length ; pos++) {\n\t\tseconds += Number(atoms[pos]) * scale[((atoms.length-1) - pos)];\n\t}\n\treturn seconds;\n};\n\n/**\n * @summary convert a time in seconds in a human-coded time (`1h2m3s`). Zero is `0s`.\n * @public\n *\n * @class      secondsInTime (name)\n * @param      {number}   givenSeconds  The given seconds\n * @return     {string}   Converted time\n */\nexport const secondsInTime = function(givenSeconds) {\n\tif (givenSeconds === Infinity) {\n\t\treturn Infinity_representation;\n\t}\n\tlet converted = '';\n\tlet inned = false;\n\tfor (let key in units_scale) {\n\t\tif (units_scale.hasOwnProperty(key)) {\n\t\t\tlet multiply = units_scale[key];\n\t\t\tif ((givenSeconds >= multiply) || (inned)) {\n\t\t\t\tinned = true;\n\t\t\t\tlet digits = Math.floor(givenSeconds / multiply);\n\t\t\t\tconverted += digits + key;\n\t\t\t\tgivenSeconds -= digits * multiply;\n\t\t\t}\n\t\t}\n\t}\n\treturn converted === '' ? '0s' : converted;\n};\n\n/**\n * @summary    convert a time in seconds in a colon-coded time (`1:02:03s`). Zero is `0:00`.\n * @public\n *\n * @class      secondsInColonTime (name)\n * @param      {number}          givenSeconds  The given seconds\n * @return     {string}  Converted time\n */\nexport const secondsInColonTime = function(givenSeconds) {\n\tif (givenSeconds === Infinity) {\n\t\treturn Infinity_representation;\n\t}\n\tlet converted = '';\n\tlet inned = false;\n\tfor (let key in units_scale) {\n\t\tif (units_scale.hasOwnProperty(key)) {\n\t\t\tlet multiply = units_scale[key];\n\t\t\tif ((givenSeconds >= multiply) || (inned)) {\n\t\t\t\tinned = true;\n\t\t\t\tlet digits = Math.floor(givenSeconds / multiply);\n\t\t\t\tconverted += (converted === '' ? '' : ':');\n\t\t\t\tconverted += ( ((digits<10) && (converted !== '')) ? '0' : '') + digits ;\n\t\t\t\tgivenSeconds -= digits * multiply;\n\t\t\t}\n\t\t}\n\t}\n\tif (converted.length === 1) {\n\t\t// between 0 and 9 seconds\n\t\treturn `0:0${converted}`;\n\t}\n\tif (converted.length === 2) {\n\t\t// between 10 and 59 seconds\n\t\treturn `0:${converted}`;\n\t}\n\n\treturn converted === '' ? '0:00' : converted;\n};\n\n/**\n * @summary same as `secondsInColonTime`, but suited for `<input type=\"time\"\n * />`. Zero is `00:00:00`.\n *\n * @public\n *\n * @class      secondsInPaddledColonTime (name)\n * @param      {number}  givenSeconds  The given seconds\n * @return     {string}  Converted time\n */\nexport const secondsInPaddledColonTime = function(givenSeconds) {\n\tif (givenSeconds === Infinity) {\n\t\treturn Infinity_representation;\n\t}\n\t// principaly needed by <input type=\"time\"> whom needs a really precise HH:MM:SS format\n\tlet colon_time = convert.secondsInColonTime(givenSeconds);\n\treturn '00:00:00'.substr(0, 8 - colon_time.length ) + colon_time;\n};\n\n/**\n * @summary convert a duration in an ISO 8601 string suitable for `datetime=\"\"` attribute in <time>\n * See spec in https://www.w3.org/TR/html51/infrastructure.html#durations\n * @public\n *\n * @class      durationIso (name)\n * @param      {number}  givenSeconds  Duration, in seconds\n * @return     {string}  Converted duration\n */\nexport const durationIso = function(givenSeconds) {\n\treturn `P${convert.secondsInTime(givenSeconds).toUpperCase()}`;\n};\n\nexport const convert = {\n\ttimeInSeconds,\n\tsubunittimeInSeconds,\n\tcolontimeInSeconds,\n\tsecondsInTime,\n\tsecondsInColonTime,\n\tsecondsInPaddledColonTime,\n\tdurationIso\n};\n","import {escapeHtml} from './utils.js';\n\nlet acceptables_tags = {\n\ti     : 'i',\n\tem    : 'em', \t// (not in the standard but used in legacy CPU.pm show)\n\tb     : 'b',\n\tbold  : 'strong', // (declared in the MDN page, but never saw it in standard pages)\n\tu     : 'u',\n\tlang  : 'i' \t\t// emphasis for typographic convention\n};\n\n/**\n *\n * NEVER EVER BELIEVE you can parse HTML with regexes ! This function works because we just do minimalistic changes\n * By the way, regexes are really time consuming, both for you and your computer.\n * And, sincerely, I love playing on https://regexcrossword.com/\n */\n\n// regexes used for WebVTT tag validation\nconst vtt_opentag = /<(\\w+)(\\.[^>]+)?( [^>]+)?>/gi;\nconst vtt_closetag = /<\\/(\\w+)( [^>]*)?>/gi;\nconst vtt_cr = /\\n/gi;\n\n/**\n * Checks if a WebVTT candidate tag name is acceptable or not\n *\n * @param      {string}  name    Tag name\n * @return     {boolean}  not accepted (inverted logic)\n */\nfunction not_acceptable_tag(name) {\n\treturn !(name in acceptables_tags);\n}\n\n/**\n * @param      {string}   \t\t   tag \t\t\tUnused regex capture\n * @param      {string}   \t\t   name \t\tName of the tag\n * @param      {string}   \t\t   class_name \tattribute key, unused\n * @param      {string}   \t\t   attribute \tattribute value, may be language code\n * @return     {string}\n */\nfunction opentag(tag, name, class_name, attribute) {\n\tname = name.toLowerCase();\n\tif (not_acceptable_tag(name)) {\n\t\treturn '';\n\t}\n\tlet $_attr = '';\n\tif (name === 'lang') {\n\t\t$_attr = ` lang=\"${attribute.trim()}\"`;\n\t}\n\treturn `<${acceptables_tags[name]}${$_attr}>`;\n}\n\n/**\n * @param      {string}   \t\t   tag \t\t\tUnused regex capture\n * @param      {string}   \t\t   name \t\tName of the tag\n * @return     {string}\n */\nfunction closetag(tag, name) {\n\tname = name.toLowerCase();\n\tif (not_acceptable_tag(name)) {\n\t\treturn '';\n\t}\n\treturn `</${acceptables_tags[name]}>`;\n}\n\n/**\n * @summary Transform WebVTT tag langage into HTML tags, filtering out some\n * (needed @public mainly for tests. Moving it up and do those tests in CLI will make it @private-izable)\n *\n * @param      {string}            vtt_taged  The vtt tagged\n * @return     string                         HTML tagged string\n */\nexport function translateVTT(vtt_taged) {\n\n\tif ((vtt_taged.split('<').length) !== (vtt_taged.split('>').length)) {\n\t\t// unmatching < and >, probably badly written tags, or in full text\n\t\t// unsurprisingly, (vtt_taged.split('<').length) is a lot faster than using regex. JS needs a standard property for counting substring occurences in a string\n\t\treturn escapeHtml(vtt_taged);\n\t}\n\n\treturn vtt_taged.\n\t\t\treplace(vtt_opentag, opentag).\n\t\t\treplace(vtt_closetag, closetag).\n\t\t\treplace(vtt_cr, '<br/>');\n}\n","import {__} from './i18n.js';\nimport {activecueClassname, planeAndPointNamesFromId} from './element_cpu.js';\n\n// plane for _playlist. Only used in <CPU-Controller>\nconst plane_playlist = '_playlist';\n\n/**\n * @summary Builds or refresh the playlist panel.\n Should be called only for <cpu-controller>\n * @private was public\n *\n * @param       {Object}  \tcontainer  \t\t<cpu-controller>.CPU\n *\n */\nexport function buildPlaylist(wasFocusedId) {\n\tconst globalController = document.CPU.globalController;\n\tif ((!globalController) || (!globalController.isController)) {\n\t\t// Note that ONLY the global controller will display the playlist. For now.\n\t\treturn;\n\t}\n\n\tlet previous_playlist = globalController.current_playlist;\n\tglobalController.current_playlist = document.CPU.currentPlaylist();\n\tconst pointDataGroup = {};\n\n\tif (! globalController.plane(plane_playlist)) {\n\t\tglobalController.addPlane(plane_playlist, {\n\t\t\ttitle \t\t: __['playlist'],\n\t\t\ttrack \t\t: false,\n\t\t\tpanel \t\t: 'nocuetime',\n\t\t\thighlight \t: true,\n\t\t\t_comp \t\t: true \t\t\t\t// data stored on CPU-Controller ONLY\n\t\t});\n\t}\n\n\tif (previous_playlist !== globalController.current_playlist) {\n\t\tglobalController.clearPlane(plane_playlist);\n\t\tif (globalController.current_playlist.length === 0) {\n\t\t\t// remove plane to hide panel. Yes, overkill\n\t\t\tglobalController.removePlane(plane_playlist);\n\t\t\treturn;\n\t\t}\n\n\t\tfor (let audiotag_id of globalController.current_playlist) {\n\t\t\t// TODO : when audiotag not here, do not add point\n\t\t\t/*container.addPoint(plane_playlist, audiotag_id, {\n\t\t\t\ttext : document.getElementById(audiotag_id)?.dataset.title, \n\t\t\t\tlink : `#${audiotag_id}&t=0`\n\t\t\t});\n\t\t\t*/\n\t\t\tpointDataGroup[audiotag_id] = {\n\t\t\t\ttext : document.getElementById(audiotag_id)?.dataset.title, \n\t\t\t\tlink : `#${audiotag_id}&t=0`\n\t\t\t};\n\t\t}\n\n\t\tglobalController.bulkPoints(plane_playlist, pointDataGroup);\n\t\t// move _playlist on top. Hoping it will insert it RIGHT AFTER the main element.\n\t\tglobalController.element.shadowRoot.querySelector('main').insertAdjacentElement(\n\t\t\t'afterend', globalController.planePanel(plane_playlist) );\n\t}\n\n\tglobalController.highlightPoint(plane_playlist, globalController.audiotag.id, activecueClassname);\n\n\tif (wasFocusedId) {\n\t\t// we need to give back focus to the points, as they disapeared\n\t\tconst [planeName, pointName] = planeAndPointNamesFromId(wasFocusedId);\n\t\tglobalController.focusPoint(planeName, pointName);\n\t}\n}","import {CpuAudioTagName, dynamicallyAllocatedIdPrefix, browserIsDecent, passiveEvent, oncePassiveEvent} from './utils.js';\n\nimport {trigger} from './trigger.js';\nimport {buildPlaylist} from './build_playlist.js';\n\n// Indicate if media element was extended\nHTMLAudioElement.prototype.CPU_connected = false;\n\n/**\n * @summary At start, will start the last playing <audio> tag at its last known position\n *\n * @param      {Object}  event   The event\n */\nfunction recallStoredPlay(event) {\n\tlet audiotag = event.target;\n\tif ((document.CPU.currentAudiotagPlaying !== null) || (isAudiotagStreamed(audiotag))) {\n\t\treturn;\n\t}\n\tlet lasttimecode = Number(window.localStorage.getItem(audiotag.currentSrc));\n\t// TODO and no hashed time\n\tif ((lasttimecode > 0) && (!trigger._last_play_error)) {\n\t\tdocument.CPU.seekElementAt(audiotag, lasttimecode);\n\t\ttrigger.play(null, audiotag);\n\t}\n}\n\n// used for addIdToAudiotag , when tag was not named in HTML or DOM\nlet\tcount_element = 0;\n\n/**\n * @summary Adds an identifier to audiotag at build time.\n * @private\n */\nexport function\taddIdToAudiotag(audiotag) {\n\taudiotag.id = audiotag.id || `${dynamicallyAllocatedIdPrefix}${count_element++}`;\n}\n\n\n/**\n * @summary Determines if audiotag source is streamed, and so unactivate reposition, position memory, length display\n *\n * @param      {HTMLAudioElement|null}  audiotag  The audiotag\n * @return     {boolean}            \tTrue if audiotag streamed, False otherwise.\n */\nexport function isAudiotagStreamed(audiotag) {\n\treturn ((audiotag == null) || (audiotag.duration === Infinity) || (audiotag.dataset.streamed != null));\n}\n\n\n/**\n * @summary Checks if an audiotag's duration is suitable for ratio maths\n * A media may have unusable duration for ratio because \n * - media is unreadable\n * - media is streamed\n * - even if it is a fishied file, its duration is still unknown (Chrome may be late)\n * @private\n *\n * @param      {number|null}  \tduration   \t`duration` of an audiotag, or result of `audiotagDuration(audiotag)`\n * @return     {boolean}       \t\t\t\tUnusable duration\n */\nexport function uncertainDuration(duration) {\n\n\treturn (duration === 0) || (duration === Infinity) || (duration === null) || (isNaN(duration));\n}\n\n/**\n * @summary Try to find audiotag duration, or its manually declared duration\n * @private\n *\n * @param      {HTMLAudioElement}  \taudiotag   \tAudio to check length\n * @return     {Number|null}       \t\t\tResult in seconds. Null if non applicable\n */\nexport function audiotagDuration(audiotag) {\n\tlet out = null;\n\tlet _natural = Number(audiotag.duration);\n\tif (!isNaN(_natural)){\n\t\tout = _natural;\n\t} else {\n\t\tconst _forced = Number(audiotag.dataset.duration);\n\t\tif (_forced > 0) {\n\t\t\tout = _forced;\n\t\t}\n\t}\n\treturn out;\n}\n\n\n/**\n * @summary Force <audio> to preload its metadata, and so its duration, then callback the event\n * @private\n *\n * @param       {HTMLAudioElement}\taudiotag    The playing <audio> tag\n * @param       {function}\t\t\tcallback   \tOnce metadata loaded, function to callback\n * @param \t\t{any}\t\t\t\tevent \t\t...with it main parameter, usually an event\n */\nexport function audiotagPreloadMetadata(audiotag, callback=null, event=null) {\n\taudiotag.addEventListener(\n\t\t'loadedmetadata',\n\t\t() => {callback?.(event);},\n\t\toncePassiveEvent);\n\t// loading metadata. May not work on Apples\n\taudiotag.setAttribute('preload', 'metadata');\n}\n\n/**\n * @summary Attach events on a <audio> tag\n *\n * @param      {HTMLAudioElement}  audiotag  The audiotag\n */\nexport function attach_events_audiotag(audiotag) {\n\taudiotag.addEventListener('loadedmetadata', recallStoredPlay, oncePassiveEvent);\n\taudiotag.addEventListener('play', trigger.playOnce, passiveEvent);\n\taudiotag.addEventListener('ended', trigger.ended, passiveEvent);\n\t// those  for PHRACKING SAFARI\n\taudiotag.addEventListener('ready', recallStoredPlay, passiveEvent);\n\taudiotag.addEventListener('canplay', recallStoredPlay, passiveEvent);\n\n\t// see https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Media_events for list of events\n\t[\n\t\t'ready', 'load', 'loadeddata', 'canplay', 'abort',\n\t\t'error', 'emptied',\n\t\t'play', 'playing', 'pause', 'ended',\n\t\t'durationchange',  'loadedmetadata', 'timeupdate', 'waiting'\n\t].forEach( (on) => {\n\t\taudiotag.addEventListener(on, trigger.update, passiveEvent);\n\t});\n\n\tif (!browserIsDecent()) {\n\t\t// in case we are in legacy mode\n\t\t[\n\t\t\t'pause', 'ended'\n\t\t].forEach( (on) => {\n\t\t\taudiotag.addEventListener(on, trigger.pause, passiveEvent);\n\t\t});\n\t}\n\n\t// ask ASAP metadata about media\n\tif (audiotag.getAttribute('preload') === '') {\n\t\taudiotagPreloadMetadata(audiotag);\n\t}\n}\n\n/**\n * @summary Connects an audiotag to CPU APIs, launched at start or when the webcomponent appears\n *\n * @param      {HTMLAudioElement}  audiotag  The audiotag\n */\nexport function connectAudiotag(audiotag) {\n\tif (audiotag.CPU_connected) {\n\t\treturn;\n\t}\n\taudiotag.CPU_connected = true;\n\n\tattach_events_audiotag(audiotag);\n\n\t// hide native controls\n\taudiotag.hidden = true;\n\t// PHRACK SAFARI\n\taudiotag.removeAttribute('controls');\n\n\t// playlist\n\tif (typeof(audiotag.dataset.playlist) === 'string') {\n\t\tlet playlist_name = audiotag.dataset.playlist;\n\t\tif (!(playlist_name in document.CPU.playlists)) {\n\t\t\tdocument.CPU.playlists[playlist_name] = [];\n\t\t}\n\t\t// TODO do not rerecord id if already in this playlist. Remove from other playlists\n\t\t// TODO LATER, remove id when cpu-audio or audiotag removed\n\t\tdocument.CPU.playlists[playlist_name].push(audiotag.id);\n\n\t\t// refresh controller playlist if any\n\t\tlet globalController = document.CPU.globalController;\n\t\tif ((globalController) && (playlist_name === document.CPU.currentPlaylist())) {\n\t\t\tbuildPlaylist();\n\t\t}\n\t}\n}\n\n\n/**\n * @summary Return the parent <cpu-audio> DOM element\n *\n * @class      CPU_controller (name)\n * @return     {Element}  <cpu-audio> DOM element\n */\nHTMLAudioElement.prototype.CPU_controller = function() {\n\treturn this.closest(CpuAudioTagName);\n};\n\n/**\n * @summary Trigger display updates in the interface\n *\n * @class      CPU_update (name)\n */\nHTMLAudioElement.prototype.CPU_update = function() {\n\tlet controller = this.CPU_controller();\n\tif (controller) {\n\t\tlet api = controller.CPU;\n\t\tif ((api) && (api.update)) {\n\t\t\t// i don't like try catch\n\t\t\tapi.update();\n\t\t}\n\t}\n\tif (document.CPU.globalController) {\n\t\tdocument.CPU.globalController.update();\n\t}\n};\n","import {oncePassiveEvent, adjacentArrayValue, findContainer, warn} from './utils.js';\nimport {isAudiotagStreamed, audiotagPreloadMetadata, audiotagDuration, uncertainDuration} from './media_element_extension.js';\nimport {timeInSeconds} from './convert.js';\nimport {buildPlaylist} from './build_playlist.js';\nimport {planeAndPointNamesFromId} from './element_cpu.js';\n\nconst KEY_LEFT_ARROW = 37;\nconst KEY_RIGHT_ARROW = 39;\n\nlet NotAllowedError = 'Auto-play prevented : Browser requires a manual interaction first.';\nlet NotSupportedError = 'The browser refuses the audio source, probably due to audio format.';\n\n// actual active elements\n// @type {string|null}\nlet\tbody_className_playing_cue = null;\n\n\n/**\n * @summary If audio position out of begin/end borders, remove borders\n * @private\n *\n * @param      {number}  at      timecode position\n */\nfunction removeTimecodeOutOfBorders(at) {\n\tif (\n\t\t(at < trigger._timecode_start)\n\t\t|| ((trigger._timecode_end !== false) && (at > trigger._timecode_end)) ) {\n\t\ttrigger._timecode_start = 0;\n\t\ttrigger._timecode_end = false;\n\t}\n}\n\n/**\n * @summary If playing media was prevented by browser due to missing focus, event on focus does unlock player\n * @private\n *\n * @param      {Object|undefined}  \t\tevent    \tUnlocking event\n * @param      {HTMLAudioElement|null}  audiotag   \tThe audiotag to start playing, event's target if not defined\n */\nfunction playOnceUnlock(event, audiotag) {\n\ttrigger._last_play_error = false;\n\tif (document.CPU.autoplay) {\n\t\ttrigger.play(event, audiotag);\n\t}\n}\n\n/**\n * @summary When a <cpu-audio> plays, attach it to the eventual <cpu-controller>\n * @private\n *\n * @param      {audiotag}  HTMLAudioElement   The playing <audio> tag\n */\nfunction switchControllerTo(audiotag) {\n\tconst globalController = document.CPU.globalController;\n\tif (!globalController) {\n\t\treturn;\n\t}\n\tif  (!audiotag.isEqualNode(globalController.audiotag)) {\n\t\tconst wasFocused = globalController.focusedId();\n\t\tglobalController.attachAudiotagToController(audiotag);\n\t\tglobalController.audiotag = audiotag;\n\t\tglobalController.showMain();\n\t\tglobalController.redrawAllPlanes();\n\t\tglobalController.setModeContainer(); \t// to switch back the display between streamed/not-str medias\n\t\tbuildPlaylist(wasFocused);\n\t}\n}\n\n\nexport const trigger = {\n\n\t// @private   MAY GO OUT OF THIS OBJECT IF NOT TESTED OUTSIDE\n\t_timecode_start : 0,\n\t// @private   MAY GO OUT OF THIS OBJECT IF NOT TESTED OUTSIDE\n\t_timecode_end : false,\n\n\t// @private   MAY GO OUT OF THIS OBJECT IF NOT TESTED OUTSIDE\n\t_last_play_error : false,\n\n\t/**\n\t * @summary    Interprets the hash part of the URL, when loaded or changed\n\t * @package\n\t *\n\t * still exposed in public for tests\n\t *\n\t * @param      {string|Object}  hashcode     Called hashcode\n\t * @param      {Function|null}  callback_fx  When done, call a function to end the tests (optional).\n\t */\n\thashOrder : async function(hashcode, callback_fx = null) {\n\t\tlet at_start = true;\n\t\tif (typeof hashcode !== 'string') {\n\t\t\tat_start = 'at_start' in hashcode;\n\t\t\thashcode = location.hash.substr(1);\n\t\t}\n\t\tlet hash = '';\n\t\tlet timecode = '';\n\t\tlet segments = hashcode.split('&');\n\t\tlet autoplay = false;\n\n\t\tfor (let parameter of segments) {\n\t\t\tif ((!parameter.includes('=')) && (hash === '')) {\n\t\t\t\t// should reference to the ID of the element\n\t\t\t\thash = parameter;\n\t\t\t} else {\n\t\t\t\t// should be a key=value parameter\n\t\t\t\tlet [p_key, p_value] = parameter.split('=');\n\t\t\t\tswitch (p_key) {\n\t\t\t\t\tcase 't':\n\t\t\t\t\t\t// is a time index\n\t\t\t\t\t\ttimecode = p_value || '0';\n\t\t\t\t\t\t// we make autoplay at requested timecode, simplier of the user\n\t\t\t\t\t\tautoplay = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'autoplay':\n\t\t\t\t\t\t// is a card from a social network, run now\n\t\t\t\t\t\tautoplay = p_value === '1';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'auto_play':\n\t\t\t\t\t\t// is a card from a social network, run now\n\t\t\t\t\t\tautoplay = p_value === 'true';\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ((timecode === '') || ((at_start) && (!autoplay))) {\n\t\t\t// this is a normal anchor call. Go back to normal behaviour\n\t\t\tcallback_fx?.();\n\t\t\treturn /* false */;\n\t\t}\n\n\t\t// we may have a begin,end notation\n\t\tlet [timecode_start, timecode_end] = timecode.split(',');\n\t\ttrigger._timecode_start = timeInSeconds(timecode_start);\n\t\ttrigger._timecode_end = timecode_end !== undefined ? timeInSeconds(timecode_end) : false;\n\t\tif (trigger._timecode_end !== false) {\n\t\t\ttrigger._timecode_end = (trigger._timecode_end > trigger._timecode_start) ?\n\t\t\t\ttrigger._timecode_end :\n\t\t\t\tfalse;\n\t\t}\n\n\t\tawait document.CPU.jumpIdAt(hash, timecode_start, callback_fx);\n\n\t\t// not in document.CPU (yet) to avoid unuseful repaint\n\t\tbuildPlaylist();\n\t\t// scroll to the audio element. Should be reworked, or parametrable , see issue #60\n\t\t// window.location.hash = `#${hash}`;\n\t},\n\n\t/**\n\t * @summary Update throbber position when hovering the timeline interface\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\thover : function(event) {\n\t\tconst {target, clientX, targetTouches} = event;\n\t\tif (!target) {\n\t\t\t// pointerenter event may be fired without target. Strange for a pointer\n\t\t\treturn;\n\t\t}\n\t\tconst container = findContainer(target);\n\t\tconst audiotag = container.audiotag;\n\t\tconst duration = audiotagDuration(audiotag);\n\t\tif (uncertainDuration(duration)) {\n\t\t\tif (!isAudiotagStreamed(audiotag)) {\n\t\t\t\taudiotagPreloadMetadata(audiotag, trigger.hover, event);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tconst {x, width} = container.shadowId('time').getBoundingClientRect();\n\t\t// clientX - x  x position of cursor in the #time element \n\t\t// Xoffset / width  ratio in the timeline\n\t\tconst ratio = ((clientX ?? targetTouches?.[0]?.clientX) - x) / width;\n\t\t// ratio * duration = time position in the audio\n\t\tcontainer.showThrobberAt(ratio * container.audiotag.duration);\n\t},\n\n\t/**\n\t * @summary Hide the throbber when leaving the timeline interface\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tout : function({target}) {\n\t\tfindContainer(target).hideThrobber();\n\t},\n\n\t/**\n\t * @summary Change play position of a audio tag\n\t *\n\t * @param      {Object}  event   The event, may be mocked\n\t */\n\tthrobble : function(event) {\n\t\tconst {target, offsetX} = event;\n\t\tconst DocumentCPU = document.CPU;\n\t\tconst audiotag = findContainer(target).audiotag;\n\t\tconst ratio = offsetX / target.clientWidth;\n\t\tconst duration = audiotagDuration(audiotag); // we get the real or supposed duration\n\n\t\tif ((DocumentCPU.currentAudiotagPlaying) && (!DocumentCPU.isAudiotagPlaying(audiotag))) {\n\t\t\t// Chrome needs to STOP any other playing tag before seeking\n\t\t\t//  Very slow seeking on Chrome #89\n\t\t\ttrigger.pause(undefined, DocumentCPU.currentAudiotagPlaying);\n\t\t}\n\n\t\t// we may have improper duration due to a streamed media, so let's start directly !\n\t\ttrigger.play(event);\n\t\tif (uncertainDuration(duration)) {\n\t\t\t// Correct play from position on the timeline when metadata not preloaded #88\n\t\t\t// indicate we are loading something. We set a full width bar\n\t\t\taudiotag.CPU_controller()?.updateLoading?.(undefined, 100);\n\t\t\treturn;\n\t\t}\n\t\tDocumentCPU.seekElementAt(audiotag, \n\t\t\t// We know the media length  normal execution. \n\t\t\tevent.at ?? \n\t\t\t\t// Else : normal trigger usage, via an event\n\t\t\t\t( ratio * duration )\n\t\t);\n\t},\n\n\t/**\n\t * @summary    Do pause\n\t *\n\t * @param      {Object|undefined|null}   event     The event, may be omitted\n\t * @param      {Element|undefined|null}  audiotag  The audiotag, if omitted, will be event's target\n\t */\n\tpause : function(event = null, audiotag = null) {\n\t\tif (!audiotag) {\n\t\t\tlet {target} = event;\n\t\t\taudiotag = (target.tagName === 'AUDIO') ? target : findContainer(target).audiotag;\n\t\t}\n\t\taudiotag.pause();\n\t\tdocument.CPU.currentAudiotagPlaying = null;\n\t\twindow.localStorage.removeItem(audiotag.currentSrc);\n\t},\n\n\t/**\n\t * @summary    Change referenced playing audio, pause the previous one\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tplayOnce : function({target}) {\n\t\tlet document_cpu = document.CPU;\n\t\t// target, aka audiotag\n\t\tdocument.CPU.lastUsed = target;\n\n\t\tif ( \n\t\t\t(document_cpu.playStopOthers) && \n\t\t\t(document_cpu.currentAudiotagPlaying) && \n\t\t\t(!document_cpu.isAudiotagPlaying(target)) \n\t\t\t) {\n\t\t\ttrigger.pause(undefined, document_cpu.currentAudiotagPlaying);\n\t\t}\n\t\tdocument_cpu.currentAudiotagPlaying = target;\n\t},\n\n\t/**\n\t * @summary    Do play an audio tag\n\t *\n\t * @param      {Object|undefined|null}   event     The event, may be mocked or ommitted\n\t * @param      {Element|undefined|null}  audiotag  The audiotag\n\t */\n\tplay : function(event=null, audiotag=null) {\n\t\tif ( (!event) && (trigger._last_play_error)) {\n\t\t\twarn(`play() prevented because already waiting for focus`);\n\t\t\treturn;\n\t\t}\n\t\taudiotag = audiotag ?? findContainer(event.target).audiotag;\n\n\t\ttrigger._last_play_error = false;\n\t\tremoveTimecodeOutOfBorders(audiotag.currentTime);\n\n\t\tlet promised = audiotag.play();\n\n\t\tif (promised) {\n\t\t\tpromised.then(\n\t\t\t\t() => {\n\t\t\t\t\t// we have a successful play occured, we can display wait event later\n\t\t\t\t\tdocument.CPU.hadPlayed = true;\n\t\t\t\t}\n\t\t\t).catch(\n\t\t\t\terror => {\n\t\t\t\t\ttrigger._last_play_error = true;\n\t\t\t\t\tlet unlock = playOnceUnlock.bind(this, audiotag);\n\t\t\t\t\tswitch (error.name) {\n\t\t\t\t\t\tcase 'NotAllowedError':\n\t\t\t\t\t\t\twarn(NotAllowedError);\n\t\t\t\t\t\t\tdocument.addEventListener('focus', unlock, oncePassiveEvent);\n\t\t\t\t\t\t\tdocument.addEventListener('click', unlock, oncePassiveEvent);\n\n\t\t\t\t\t\t\tif (audiotag.CPU_connected) {\n\t\t\t\t\t\t\t\tlet CPU_api = audiotag.CPU_controller().CPU;\n\t\t\t\t\t\t\t\tCPU_api.glowBeforePlay = true;\n\t\t\t\t\t\t\t\tCPU_api.setActContainer('glow');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'NotSupportedError':\n\t\t\t\t\t\t\terror(NotSupportedError);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t\tswitchControllerTo(audiotag);\n\t},\n\n\ttoggleplay : function({target}) {\n\t\tconst audiotag = findContainer(target).audiotag;\n\t\taudiotag.paused ?\n\t\t\ttrigger.play(null, audiotag) :\n\t\t\ttrigger.pause(null, audiotag);\n\t},\n\n\t/**\n\t * @summary Interprets pressed key\n\t *\n\t * @param      {Object}  event   The event\n\t * @param      {number}  mult    Multiply the keypressed act, 1 by default\n\t */\n\tkey : function(event, mult=1) {\n\t\t// do not interpret key when there is a modifier, for not preventing browsers shortcurs\n\t\tif (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet container = findContainer(event.target);\n\t\tlet audiotag = container.audiotag;\n\n\t\t/** @param      {number}  seconds    Relative position fowards */\n\t\tfunction seek_relative(seconds) {\n\t\t\tlet at = container.audiotag.currentTime + seconds;\n\t\t\tat = at > 0 ? at : 0;\n\t\t\tlet duration = audiotag.duration;\n\t\t\tif (!isNaN(duration)) {\n\t\t\t\tat = at < duration ? at : duration;\n\t\t\t}\n\t\t\tevent.at = at;\n\t\t\tcontainer.showThrobberAt(event.at);\n\t\t\ttrigger.throbble(event);\n\t\t\tcontainer.hideThrobberLater();\n\t\t}\n\n\t\tswitch (event.keyCode) {\n\t\t\tcase 13 : // enter : standard usage, except if focus is #control\n\t\t\t\tif (container.focused()?.id.toLowerCase() != 'control') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\ttrigger.toggleplay(event);\n\t\t\t\tbreak;\n\t\t\tcase 27 : // esc\n\t\t\t\ttrigger.restart(event);\n\t\t\t\ttrigger.pause(undefined, audiotag);\n\t\t\t\tbreak;\n\t\t\tcase 32 : // space\n\t\t\t\ttrigger.toggleplay(event);\n\t\t\t\tbreak;\n\t\t\t// pageUp 33\n\t\t\t// pageDown 34\n\t\t\tcase 35 : // end\n\t\t\t\tdocument.CPU.seekElementAt(audiotag, audiotag.duration);\n\t\t\t\tbreak;\n\t\t\tcase 36 : // home\n\t\t\t\ttrigger.restart(event);\n\t\t\t\tbreak;\n\t\t\tcase KEY_LEFT_ARROW : // \n\t\t\t\tseek_relative(- (document.CPU.keymove * mult));\n\t\t\t\tbreak;\n\t\t\tcase KEY_RIGHT_ARROW : // \n\t\t\t\tseek_relative(+ (document.CPU.keymove * mult));\n\t\t\t\tbreak;\n\t\t\tcase 38 : // \n\t\t\t\tcontainer.prevFocus(); //   trigger.prevcue(event);\n\t\t\t\tbreak;\n\t\t\tcase 40 : //  \n\t\t\t\tcontainer.nextFocus(); //  trigger.nextcue(event);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn ;\n\t\t}\n\t\tevent.preventDefault?.();\n\t},\n\n\t/**\n\t * @summary Pressing restart button, Rewind at start the audio tag\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\trestart : function({target}) {\n\t\tlet container = findContainer(target);\n\t\tdocument.CPU.seekElementAt(container.audiotag, 0);\n\t},\n\t/**\n\t * @summary Pressing reward button\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\treward : function(event) {\n\t\tevent.keyCode = KEY_LEFT_ARROW;\n\t\ttrigger.key(event);\n\t},\n\t/**\n\t * @summary Pressing foward button\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tfoward : function(event) {\n\t\tevent.keyCode = KEY_RIGHT_ARROW;\n\t\ttrigger.key(event);\n\t},\n\t/**\n\t * @summary Pressing fastreward button\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tfastreward : function(event) {\n\t\tevent.keyCode = KEY_LEFT_ARROW;\n\t\ttrigger.key(event, document.CPU.fastFactor);\n\t},\n\t/**\n\t * @summary Pressing fastfoward button\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tfastfoward : function(event) {\n\t\tevent.keyCode = KEY_RIGHT_ARROW;\n\t\ttrigger.key(event, document.CPU.fastFactor);\n\t},\n\n\t/**\n\t * @summary Pressing prevcue button, or PROVISOIRE hit  key\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tprevcue : function( /* event */) {\n\t\tconst container = findContainer(event.target);\n\t\tconst audiotag = container.audiotag;\n\t\tconst points = container.planePoints('_chapters');\n\t\tif (!points) {\n\t\t\treturn;\n\t\t}\n\t\tconst [, pointName] = planeAndPointNamesFromId( body_className_playing_cue );\n\t\tlet go = adjacentArrayValue(points, pointName, -1);\n\t\tif (!go) {\n\t\t\tfor (let cue of Object.values(points).reverse()) {\n\t\t\t\tif ((!go) && (cue.end <= audiotag.currentTime)) {\n\t\t\t\t\tgo = cue;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (go) {\n\t\t\tdocument.CPU.jumpIdAt(audiotag.id, go.start);\n\t\t}\n\t},\n\n\t/**\n\t * @summary Pressing nextcue button, or PROVISOIRE hit  key\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tnextcue : function(/* event */) {\n\t\tconst container = findContainer(event.target);\n\t\tconst audiotag = container.audiotag;\n\t\tconst points = container.planePoints('_chapters');\n\t\tif (!points) {\n\t\t\treturn;\n\t\t}\n\t\tconst [, pointName] = planeAndPointNamesFromId( body_className_playing_cue );\n\t\tlet go = adjacentArrayValue(points, pointName, 1);\n\t\tif (!go) {\n\t\t\tfor (let cue of Object.values(points)) {\n\t\t\t\tif ((!go) && (cue.start >= audiotag.currentTime)) {\n\t\t\t\t\tgo = cue;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (go) {\n\t\t\tdocument.CPU.jumpIdAt(audiotag.id, go.start);\n\t\t}\n\t},\n\n\t/**\n\t * @summary Refresh document body when changing chapter\n\t *\n\t * @param      {Object}   active_cue         \t\tThe TextTrack actived\n\t * @param      {HTMLAudioElement}   audiotag        Audiotag relative to TextTrack\n\t *\n\t * To not warns on classList.remove()\n\t * @suppress {checkTypes}\n\t */\n\tcuechange : function(active_cue, audiotag) {\n\t\tlet body_classes = document.body.classList;\n\t\tbody_classes.remove(body_className_playing_cue);\n\t\t// giving a class to document.body, with a syntax according to https://www.w3.org/TR/CSS21/syndata.html#characters\n\t\tbody_className_playing_cue = `cpu_playing_tag_${audiotag.id}_cue_${active_cue.id}`;\n\t\tbody_classes.add(body_className_playing_cue);\n\t},\n\n\n\t/**\n\t * @summary Updatting time position. Pause if a end position was defined\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tupdate : function({target:audiotag}) {\n\t\tif ((trigger._timecode_end !== false) && (audiotag.currentTime > trigger._timecode_end)) {\n\t\t\ttrigger.pause(undefined, audiotag);\n\t\t}\n\n\t\taudiotag.CPU_update();\n\t\tif ((!audiotag.paused) && (!isAudiotagStreamed(audiotag))) {\n\t\t\twindow.localStorage.setItem(audiotag.currentSrc, String(audiotag.currentTime));\n\t\t}\n\t},\n\n\t/**\n\t * @summary When an audiotag is ended, advance in playlist\n\t *\n\t * @param      {Object}  \t\t\t\t\t\t\tevent     The event\n\t * @param      {HTMLAudioElement|null|undefined}  \taudiotag  The audiotag, mays be omitted, will be calculated from event\n\t */\n\tended : function({target}, audiotag=null) {\n\t\t// the media element reached its end\n\t\taudiotag = audiotag ?? target;\n\t\tlet {dataset, id} = audiotag;\n\n\t\tif (!dataset.playlist) {\n\t\t\treturn;\n\t\t}\n\t\t// and is in a declarated playlist\n\t\tlet playlist_name = dataset.playlist;\n\t\tlet playlist = document.CPU.playlists[playlist_name];\n\t\tif (playlist === undefined) { \n\t\t\t// test strict : we may have a funnily 'undefined' named playlist ;)\n\t\t\twarn(`Named playlist ${playlist_name} not created. WTF ?`);\n\t\t\treturn;\n\t\t}\n\t\tlet playlist_index = playlist.indexOf(id);\n\t\tif (playlist_index < 0) {\n\t\t\twarn(`Audiotag ${id} not in playlist ${playlist_name}. WTF ?`);\n\t\t\treturn;\n\t\t}\n\t\tif ((playlist_index +1) === playlist.length) {\n\t\t\t// end of playlist\n\t\t\treturn;\n\t\t}\n\t\tlet next_id = playlist[ playlist_index+1 ];\n\n\t\tlet next_audiotag = /** @type {HTMLAudioElement} */ (document.getElementById(next_id));\n\t\tif (!next_audiotag) {\n\t\t\twarn(`Audiotag #${next_id} doesn't exists. WTF ?`);\n\t\t\treturn;\n\t\t}\n\t\t// Play the next media in playlist, starting at zero\n\t\tdocument.CPU.seekElementAt(next_audiotag, 0);\n\t\ttrigger.play({}, next_audiotag);\n\t},\n\n};\n","import {trigger} from './trigger.js';\n\n// Repeated event allocation\nlet pressing = null;\nconst acceptable_press_actions = ['fastreward', 'reward', 'foward', 'fastfoward'];\n\n// Handheld navigation button process\n// @private\nexport const pressManager = {\n\t/*\n\t * @summary Start handheld navigation button press\n\t * @private\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tpress : function (event) {\n\t\tlet target = event.target.id ? event.target : event.target.closest('button');\n\t\tif ( (!target.id) || (!acceptable_press_actions.includes(target.id))) {\n\t\t\t// we have been misleaded\n\t\t\treturn;\n\t\t}\n\t\t// execute the associated function\n\t\ttrigger[target.id](event);\n\t\tif (pressing) {\n\t\t\twindow.clearTimeout(pressing);\n\t\t}\n\n\t\tpressing = window.setTimeout(pressManager.repeat, document.CPU.repeatDelay, { target });\n\t\tevent.preventDefault();\n\t},\n\t/*\n\t * @summary Repeat during pressing handheld navigation button\n\t * @private\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\trepeat : function (event) {\n\t\ttrigger[event.target.id](event);\n\t\t// next call : repetition are closest\n\t\tpressing = window.setTimeout(pressManager.repeat, document.CPU.repeatFactor, event);\n\t\tevent.preventDefault?.();\n\t},\n\t/*\n\t * @summary Release handheld navigation button\n\t * @private\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\trelease : function (event) {\n\t\twindow.clearTimeout(pressing);\n\t\tpressing = null;\n\t\tevent.preventDefault();\n\t}\n};\n","import {oncePassiveEvent, passiveEvent} from './utils.js';\nimport {__, prefered_language} from './i18n.js';\nimport {trigger} from './trigger.js';\nimport {translateVTT} from './translate_vtt.js';\nimport {activecueClassname} from './element_cpu.js';\n\nconst plane_chapters = '_chapters';\n\n/**\n * @summary Add listeners on tracks to build chapters when loaded\n * @private\n * \n * @param      {Object}  container  <cpu-audio>.CPU\n */\nexport function buildChaptersLoader(container) {\n\tbuild_chapters(container);\n\tlet audiotag = container.audiotag;\n\tlet this_build_chapters = build_chapters.bind(undefined, container);\n\n\t// sometimes, we MAY have loose loading\n\taudiotag.addEventListener('loadedmetadata', this_build_chapters, oncePassiveEvent);\n\n\tlet track_element = audiotag.querySelector('track[kind=\"chapters\"]');\n\tif ((track_element) && (!track_element._CPU_load_ev)) {\n\t\ttrack_element._CPU_load_ev = track_element.addEventListener('load', this_build_chapters, passiveEvent);\n\t}\n}\n\n/**\n * @summary Extract usable chapter tracks from audiotag\n * @private\n *\n * @param      {HTMLAudioElement} \taudiotag\tThe <audio> supposed to have a chapter tracj\n * @return     {TextTrack|null}  \t\t\t\tThe TextTrack, or null if not applicable\n */\nfunction get_chapter_tracks(audiotag) {\n\tif (!audiotag) {\n\t\treturn null;\n\t}\n\n\tlet chapter_track = null;\n\tif (audiotag.textTracks?.length > 0) {\n\t\tfor (let tracks of audiotag.textTracks) {\n\t\t\tif (\n\t\t\t\t\t(tracks.kind.toLowerCase() === 'chapters') &&\n\t\t\t\t\t(tracks.cues) &&  // linked to default=\"\" attribute, only one per set !\n\t\t\t\t\t(\n\t\t\t\t\t\t(!chapter_track) /* still no active track */\n\t\t\t\t\t\t|| (tracks.language.toLowerCase() === prefered_language) /* correspond to <html lang> */\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\tchapter_track = tracks;\n\t\t\t}\n\t\t}\n\t}\n\treturn chapter_track;\n}\n\n/**\n * @summary Builds or refresh chapters interface.\n * @private was public\n *\n * @param      {Object}  \t\t\tcontainer  <cpu-audio>.CPU\n * @param      {Object|undefined}  \tevent          The event\n */\nexport async function build_chapters(container) {\n\t// this functions is called THREE times at load : at build, at loadedmetada event and at load event\n\t// and afterwards, we have to reposition track points on duractionchange\n\n\tif (container.isController) {\n\t\t// not your job, CPUController\n\t\treturn;\n\t}\n\n\tconst audiotag = container.audiotag;\n\tlet has = false;\n\tconst pointDataGroup = {};\n\n\tif (audiotag) {\n\t\tconst chapter_track = get_chapter_tracks(audiotag);\n\n\t\tif (chapter_track?.cues.length > 0) {\n\t\t\tcontainer.addPlane(plane_chapters, {\n\t\t\t\ttitle : __['chapters'],\n\t\t\t\ttrack : 'chapters'\n\t\t\t});\n\n\t\t\tlet cuechange_event_this = cuechange_event.bind(undefined, container);\n\t\t\t// ugly, but best way to catch the DOM element, as the `cuechange` event won't give it to you via `this` or `event`\n\t\t\t// adding/reinstall chapter changing event\n\t\t\tchapter_track.removeEventListener('cuechange', cuechange_event_this);\n\t\t\tchapter_track.addEventListener('cuechange', cuechange_event_this, passiveEvent);\n\n\t\t\tfor (let cue of chapter_track.cues) {\n\t\t\t\tif (!container.point(plane_chapters, cue.id)) {\n\t\t\t\t\t// avoid unuseful redraw, again\n\t\t\t\t\tlet cuepoint = Math.floor(cue.startTime);\n\t\t\t\t\tpointDataGroup[cue.id] = {\n\t\t\t\t\t\tstart : cuepoint,\n\t\t\t\t\t\ttext  : translateVTT(cue.text),\n\t\t\t\t\t\tlink  : true,          // point the link to start time position\n\t\t\t\t\t\tend   : cue.endTime    // end timecode of the cue\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (chapter_track.cues.length > 0) {\n\t\t\t\thas = true;\n\t\t\t}\n\t\t\tcontainer.bulkPoints(plane_chapters, pointDataGroup);\n\t\t\tcuechange_event(container, {\n\t\t\t\ttarget : {\n\t\t\t\t\tactiveCues : chapter_track.cues\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tlet body_class = `cpu_tag_${audiotag.id}_chaptered`;\n\tlet body_classlist = document.body.classList;\n\tif (has) {\n\t\t// indicate in host page that audio tag chapters are listed\n\t\t// see https://github.com/dascritch/cpu-audio/issues/36\n\t\tbody_classlist.add(body_class);\n\t} else {\n\t\tcontainer.removePlane(plane_chapters);\n\t\tbody_classlist.remove(body_class);\n\t}\n\n\t/*\n\tif ((active_cue) && (id_in_hash(this.audiotag.id)) ) {\n\t\t// shoud be set ONLY if audiotag is alone in page or if audiotag.id named in hash\n\t\ttrigger.cuechange(active_cue, this.audiotag);\n\t\tthis.emitEvent('chapterChanged', {\n\t\t\tcue : active_cue\n\t\t});\n\t\t// and so, shall we scroll ?\n\t}\n\t*/\n\n}\n\n/**\n * @summary Call when a chapter is changed, to trigger the changes\n * @private\n *\n * @param      {Object}  container  Element.CPU\n * @param      {Object}  event   \tThe event\n */\nexport function cuechange_event(container, event = null) {\n\t// TODO : if not event, based on '_chapters' information from audio\n\n\tconst activeCues = event ? event.target.activeCues : get_chapter_tracks(container.audiotag)?.activeCues;\n\t\n\tlet cue;\n\t// Chrome may put more than one activeCue. That's a stupid regression from them, but alas... I have to do with\n\tlet currentTime = container.audiotag.currentTime;\n\t\n\tif (activeCues?.length > 0) {\n\t\tfor (let cue_line of activeCues) {\n\t\t\tif ((cue_line.startTime <= currentTime) && (currentTime < cue_line.endTime)) {\n\t\t\t\tcue = cue_line;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (cue?.id === container._activecue_id) {\n\t\treturn ;\n\t}\n\n\tcontainer.removeHighlightsPoints(plane_chapters, activecueClassname);\n\tcontainer._activecue_id = cue?.id;\n\n\tif (cue) {\n\t\ttrigger.cuechange(cue, container.audiotag);\n\t\tcontainer.emitEvent('chapterChanged', { cue });\n\t\tcontainer.highlightPoint(plane_chapters, cue.id, activecueClassname);\n\t}\n}","import {passiveEvent, findContainer, preventLinkOnSamePage} from './utils.js';\nimport {trigger} from './trigger.js';\nimport {pressManager} from './finger_manager.js';\nimport {buildChaptersLoader} from './build_chapters.js';\nimport {buildPlaylist} from './build_playlist.js';\n\n/**\n * @summary Interprets `navigator.share` native API\n *\n * @param      {Object}  event   The event\n */\nfunction nativeShare(event) {\n\tlet {title, canonical} = findContainer(event.target).audiotagDataset();\n\tnavigator.share({\n\t\ttitle,\n\t\ttext\t: title,\n\t\turl \t: canonical\n\t});\n\tevent.preventDefault();\n}\n\n/**\n * @private, because at start\n *\n * @param      {Object}  \t\t\tcontainer  <cpu-audio>.CPU\n *\n * @summary Builds the controller.\n */\nexport function buildInterface(container) {\n\tlet interface_classlist = container.shadowId('interface').classList;\n\n\t// hide broken image while not loaded\n\tcontainer.shadowId('poster')?.addEventListener('load', () => {\n\t\tinterface_classlist.add('poster-loaded');\n\t}, passiveEvent);\n\n\tlet showMain = container.showMain.bind(container);\n\n\t// main buttons management\n\tlet cliquables = {\n\t\tpause      : trigger.pause,\n\t\tplay       : trigger.play,\n\t\ttime       : trigger.throbble,\n\t\tactions    : container.showActions.bind(container),\n\t\tback       : showMain,\n\t\tposter     : showMain,\n\t\trestart    : trigger.restart,\n\t\ttoggleplay : trigger.toggleplay\n\t};\n\tfor (let elementId in cliquables) {\n\t\tcontainer.shadowId(elementId)?.addEventListener('click', cliquables[elementId], passiveEvent);\n\t}\n\n\t// relative browsing buttons management\n\t//  *ward : handheld nav to allow long press to repeat action\n\tconst _buttons = ['prevcue', 'fastreward', 'reward', 'foward', 'fastfoward', 'nextcue'];\n\tfor (let elementId of _buttons) {\n\t\tconst button_element = container.shadowId(elementId);\n\t\tbutton_element?.addEventListener('pointerdown', pressManager.press);\n\t\tbutton_element?.addEventListener('pointerout', pressManager.release);\n\t\tbutton_element?.addEventListener('pointerup', pressManager.release);\n\t}\n\n\t// keyboard management\n\tcontainer.element.addEventListener('keydown', trigger.key);\n\n\t// throbber management\n\tconst timeline_element = container.shadowId('time');\n\ttimeline_element?.addEventListener('pointerenter', trigger.hover, passiveEvent);\n\ttimeline_element?.addEventListener('pointermove', trigger.hover, passiveEvent);\n\ttimeline_element?.addEventListener('pointerout', trigger.out, passiveEvent);\n\t// alternative fine navigation for handhelds\n\ttimeline_element?.addEventListener('contextmenu', container.showHandheldNav.bind(container));\n\n\tif (navigator.share) {\n\t\tinterface_classlist.add('hasnativeshare');\n\t\tcontainer.shadowId('nativeshare')?.addEventListener('click', nativeShare, passiveEvent);\n\t}\n\n\tif (!container.audiotag)  {\n\t\t// <cpu-controller> without <cpu-audio> , see https://github.com/dascritch/cpu-audio/issues/91\n\t\treturn;\n\t}\n\n\tcontainer.audiotag.addEventListener('durationchange', container.repositionTracks.bind(container), passiveEvent);\n\n\tbuildChaptersLoader(container);\n\tbuildPlaylist();\n\tcontainer.showMain();\n\tcontainer.updatePlayButton();\n\tcontainer.emitEvent('ready');\n\n\tcontainer.updateLinks();\n\n\tlet canonical_element = container.shadowId('canonical'); \n\tif (canonical_element) {\n\t\tpreventLinkOnSamePage( canonical_element );\n\t}\n}","import {adjacentArrayValue, CpuControllerTagName, findContainer, selectorAudioInComponent, querySelectorDo, absolutizeUrl, error, escapeHtml, passiveEvent} from './utils.js';\nimport {__} from './i18n.js';\nimport {defaultDataset} from './default_dataset.js';\nimport {secondsInColonTime, secondsInTime, durationIso} from './convert.js';\nimport {translateVTT} from './translate_vtt.js';\nimport {trigger} from './trigger.js';\nimport {isAudiotagStreamed, audiotagDuration, uncertainDuration, addIdToAudiotag, audiotagPreloadMetadata} from './media_element_extension.js';\nimport {buildInterface} from './build_interface.js';\nimport {cuechange_event} from './build_chapters.js';\n\n// Acceptables attributes values for hide=\"\" parameter on webcomponent\nconst acceptableHideAtttributes = ['poster', 'actions', 'timeline', 'chapters', 'panels', 'panels-title', 'panels-except-play'];\n\n// should be put in CPU-controller ?\nconst previewClassname = 'with-preview';\nexport const activecueClassname = 'active-cue';\n\nlet planeNameBorders = '_borders';\n\n// Regex used to validate planes, points and injected css names\nconst validId = /^[a-zA-Z0-9\\-_]+$/;\n\n// Regex for extracting plane and point names from an id\nconst planePointNamesFromId = /^[a-zA-Z0-9\\-_]+_([a-zA-Z0-9\\-_]+)(_.*_([a-zA-Z0-9\\-_]+))?$/;\n\n/**\n * @summary Gets the plane point names from an id on a ShadowDOM element.\n * @package\n\n * repeated in the class for testing purposes\n *\n * @param      {string}  element_id  The element identifier\n * @return     {Array<string>}    An array with two strings : plane name and point name, both can be null. \n */\nexport function planeAndPointNamesFromId(element_id) {\n\tlet  planeName, pointName;\n\tif (typeof element_id == 'string') {\n\t\t[, planeName, , pointName] = element_id?.match(planePointNamesFromId) || [];\n\t}\n\treturn [planeName??'', pointName??''];\n}\n\n/**\n * @summary    Highlight the playable positions when hovering a marked link\n *\n * @param      {Object}  event   An hover event\n */\nfunction previewContainerHover({target}) {\n\tif (!target.id) {\n\t\ttarget = target.closest('[id]');\n\t}\n\tif (!target) {\n\t\treturn;\n\t}\n\n\tlet [planeName, pointName] = planeAndPointNamesFromId(target.id);\n\tfindContainer(target).highlightPoint(planeName, pointName);\n}\n\n/**\n * @summary Gets the point track identifier\n *\n * @param      {string}  planeName  The plane name\n * @param      {string}  pointName  The point name\n * @param      {boolean} panel       Is panel (true) or track (false)\n * @return     {string}  The point track identifier.\n */\nfunction getPointId(planeName, pointName, panel) {\n\treturn `${ panel?'panel':'track' }_${planeName}_point_${pointName}`;\n}\n\n/**\n  * @param  {number|undefined|boolean} sec  Is it a \"seconds\" value ?\n  * @return {boolean}\n  */\nfunction isSeconds(sec = false) {\n\t// completely ugly... but  WAT  ! as in https://www.destroyallsoftware.com/talks/wat\n\treturn ((sec !== undefined) && (sec !== false));\n}\n\n/**\n * @summary Show or hide an element\n *\n * @param      {Element} element  \tThe element to show or hide\n * @param      {boolean} show \t\tShow if true, hide if false\n */\nfunction showElement({classList}, show) {\n\tif (show) {\n\t\tclassList.remove('no');\n\t} else {\n\t\tclassList.add('no');\n\t}\n}\n\n/**\n * @summary Clean up DOM elements of any annotations, before rebuild them\n * @private\n *\n * @param      {Element} container  The webcontainer to clean-up\n */\nfunction undrawAllPlanes(container) {\n\tquerySelectorDo('aside, div.panel', (element) => { element.remove(); }, container);\n}\n\n/**\n * @summary Check acceptance of a pointData for insertion\n *\n * @param      {Object} pointData  \tnormalized pointData to check\n * @return     boolean \t\t\t\ttrue is ok\n */\nfunction checkPointData({start, end}) {\n\treturn (((start == null) || (start >= 0)) && ((end == null) || (end >= start)));\n}\n\nexport class CPU_element_api {\n\t/**\n\t *\n\t * @summary Constructs the object.\n\t * @public\n\t *\n\t * @param      {Element}  element              The DOMelement\n\t * @param      {Element}  container_interface  The container interface\n\t */\n\tconstructor(element, container_interface) {\n\t\t// I hate this style. I rather prefer the object notation\n\t\tthis.element = element;\n\t\tthis.shadow = element.shadowRoot;\n\t\tthis.audiotag = /* @type {HTMLAudioElement} */ element.audiotag;\n\t\tthis.container = container_interface;\n\t\tthis.mode_when_play = null;\n\t\tthis.glowBeforePlay = !! element.hasAttribute('glow');\n\t\tthis.current_playlist = [];\n\t\tthis._activecue_id = null;\n\t\tthis.mode_was = null;\n\t\tthis.act_was = null;\n\n\t\telement.CPU = this;\n\n\t\tif ( (this.audiotag) && (! this.audiotag._CPU_planes)) {\n\t\t\tthis.audiotag._CPU_planes = {};\n\t\t}\n\n\t\tthis.isController = this.element.tagName === CpuControllerTagName;\n\t\t// only used for CPU-CONTROLLER, for playlist\n\t\tthis._planes = {};\n\n\t\tif (!this.audiotag) {\n\t\t\tdocument.CPU.globalController = this;\n\t\t\tthis.audiotag = document.querySelector(selectorAudioInComponent);\n\t\t}\n\n\t\tbuildInterface(this);\n\t\tthis.attachAudiotagToController(this.audiotag);\n\t\tthis.attributesChanges();\n\t}\n\n\tattributesChanges() {\n\t\t// mode=\"\" attribute, on general aspect. may be coma separated\n\t\tlet mode=null;\n\t\tif (this.element.hasAttribute('mode')) {\n\t\t\tmode = this.element.getAttribute('mode');\n\t\t\t// in case of a mode=\"still,play\" declaration\n\t\t\tlet [mode_still, mode_play] = mode.split(',');\n\t\t\tif (mode_play) {\n\t\t\t\tmode = this.audiotag.paused ? mode_still : mode_play;\n\t\t\t\tthis.mode_when_play = mode_play;\n\t\t\t}\n\t\t}\n\t\tthis.setModeContainer(mode);\n\n\t\t// hide=\"\" attribute, space separated elements to hide\n\t\tif (this.element.hasAttribute('hide')) {\n\t\t\tthis.setHideContainer(this.element.getAttribute('hide').split(' '));\n\t\t}\n\t}\n\n\t/**\n\t * @summary Check if the actual <cpu-audio> is mirrored in <cpu-controller>. False if no cpu-controller\n\t * @private but next time public ?\n\t *\n\t * @return     boolean\t\t\tFalse if no cpu-controller or not mirrored\n     */\n\tmirroredInController() {\n\t\tlet globalController = document.CPU.globalController;\n\t\treturn (globalController) && (this.audiotag.isEqualNode(globalController.audiotag));\n\t}\n\n\n\t/**\n\t * @summary Passthru there only for testing purposes.\n\t * @private but needed in tests\n\t *\n\t * @param      {string}            vtt_taged  The vtt tagged\n\t * @return     string                         HTML tagged string\n     */\n\ttranslateVTT(vtt_taged) {\n\t\treturn translateVTT(vtt_taged);\n\t}\n\n\t/**\n\t * @summary Passthru there only for testing purposes. Perhaps may be on document.CPU as public method ?\n\t * @public\n\t */\n\tplaneAndPointNamesFromId(element_id) {\n\t\treturn planeAndPointNamesFromId(element_id);\n\t}\n\n\t/**\n\t * @summary    create and fire custom events for the global document.\n\t * @private\n\t *\n\t * We async-ed it, to avoid ultra-probable performances issues\n\t *\n\t * @param      {string}            event_name  The event name, will be prefixed with CPU_\n\t * @param      {Object|undefined}  detail      Specific public informations about the event\n\t * @return     {Promise}           { description_of_the_return_value }\n\t */\n\tasync emitEvent(event_name, detail = undefined) {\n\t\tthis.element.dispatchEvent(\n\t\t\tnew CustomEvent(`CPU_${event_name}`, {\n\t\t\t\ttarget \t\t: this.element,\n\t\t\t\tbubbles \t: true,\n\t\t\t\tcancelable \t: false,\n\t\t\t\tcomposed \t: false,\n\t\t\t\tdetail \t\t: detail\n\t\t\t})\n\t\t);\n\t}\n\n\tshadowId(id) {\n\t\treturn this.shadow.getElementById(id);\n\t}  \n\n\t/**\n\t * @summary Used for `mode=\"\"` attribute.\n\t * @public\n\t *\n\t * @param      {string|null}  mode    Accepted are only in `/\\w+/` format, 'default' by default\n\t */\n\tsetModeContainer(mode = null) {\n\t\tmode = mode ?? 'default';\n\t\tif (this.mode_was === mode) {\n\t\t\treturn;\n\t\t}\n\t\tlet classes = this.container.classList;\n\t\tclasses.remove(`mode-${this.mode_was}`);\n\t\tclasses.add(`mode-${mode}`);\n\t\tthis.mode_was = mode;\n\t}\n\t/**\n\t * @summary Change the presentation style reflecting the media tag status\n\t * @public\n\t *\n\t * @param      {string}  act     can be 'loading', 'pause', 'glow' or 'play'\n\t */\n\tsetActContainer(act) {\n\t\tif (this.act_was === act) {\n\t\t\treturn;\n\t\t}\n\t\tif ( (! document.CPU.hadPlayed) && (this.act_was !== null) && (act === 'loading') ){\n\t\t\treturn;\n\t\t}\n\t\tlet classes = this.container.classList;\n\t\tclasses.remove(\n\t\t\t'act-loading',\n\t\t\t'act-buffer',\n\t\t\t'act-pause',\n\t\t\t'act-play',\n\t\t\t'act-glow'\n\t\t\t);\n\t\tclasses.add(`act-${act}`);\n\t\tif ((this.act_was === 'play') && (act === 'loading')) {\n\t\t\tclasses.add(`act-buffer`);\n\t\t}\n\t\tthis.act_was = act;\n\t}\n\t/**\n\t * @public\n\t * @summary Hide some blocks in the interface\n\t * used for `hide=\"\"` attribute\n\t *\n\t * @param      {Array<string>}  hide_elements  Array of strings, may contains\n\t *                                        'actions' or 'chapters'\n\t */\n\tsetHideContainer(hide_elements) {\n\t\tlet container_class = this.container.classList;\n\n\t\tfor (let hide_this of acceptableHideAtttributes) {\n\t\t\tcontainer_class.remove(`hide-${hide_this}`);\n\t\t}\n\n\t\tfor (let hide_this of hide_elements) {\n\t\t\thide_this = hide_this.toLowerCase();\n\t\t\tif (acceptableHideAtttributes.includes(hide_this)) {\n\t\t\t\tcontainer_class.add(`hide-${hide_this}`);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @public\n\t * @summary update play/pause button according to media status\n\t */\n\tupdatePlayButton() {\n\t\tlet audiotag = this.audiotag;\n\t\tlet _attr = audiotag.getAttribute('preload');\n\t\tlet control_button = this.shadowId('control');\n\t\tconst aria = 'aria-label';\n\t\tlet _preload = _attr ? (_attr.toLowerCase() !== 'none') : true ;\n\t\tif (\n\t\t\t\t(audiotag.readyState < audiotag.HAVE_CURRENT_DATA ) &&\n\t\t\t\t((_preload) || (audiotag._CPU_played))\n\t\t\t) {\n\t\t\tthis.setActContainer('loading');\n\t\t\tcontrol_button.setAttribute(aria, __.loading);\n\t\t\treturn;\n\t\t}\n \t\t// warning : play/pause still inverted in \"__\"\n \t\tlet label = 'pause';\n\t\tlet will_act = 'play';\n\t\tif (audiotag.paused) {\n\t\t\tlabel = 'play';\n\t\t\twill_act = 'pause';\n\t\t\tif ((!audiotag._CPU_played) && (this.glowBeforePlay)) {\n\t\t\t\t// TODO check option\n\t\t\t\twill_act = 'glow';\n\t\t\t}\n\t\t}\n\n\t\tthis.setActContainer(will_act);\n\t\tcontrol_button.setAttribute(aria, __[label]);\n\t\tlet hide_panels_except_play_mark = 'last-used';\n\n\t\tlet container_class = this.container.classList;\n\t\tif (!audiotag.paused) {\n\t\t\taudiotag._CPU_played = true;\n\t\t\tcontainer_class.add(hide_panels_except_play_mark);\n\t\t\tif (this.mode_when_play) {\n\t\t\t\tthis.setModeContainer(this.mode_when_play);\n\t\t\t\tthis.mode_when_play = null;\n\t\t\t}\n\t\t} else {\n\t\t\tif (! this.audiotag.isEqualNode(document.CPU.lastUsed)) {\n\t\t\t\tcontainer_class.remove(hide_panels_except_play_mark);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Update time-line length\n\t * @private\n\t *\n\t * @param      {number}  \t\t\t\t\tseconds  The seconds\n\t * @param      {number|undefined|null=}  \tratio    ratio position in case time position are still unknown\n\t */\n\tupdateLine(seconds, ratio = null) {\n\t\tlet loadingline_element = this.shadowId('loadingline');\n\t\tif (!loadingline_element) {\n\t\t\treturn;\n\t\t}\n\t\tlet { duration } = this.audiotag;\n\t\tratio = ratio ?? ( duration === 0 ? 0 : (100*seconds / duration) );\n\t\tloadingline_element.style.width = `${ratio}%`;\n\t}\n\n\t/**\n\t * @summary update current timecode and related links\n\t * @private\n\t */\n\tupdateTime() {\n\t\tlet audiotag = this.audiotag;\n\t\tlet timecode = isAudiotagStreamed(audiotag) ? 0 : Math.floor(audiotag.currentTime);\n\t\tlet canonical = audiotag.dataset.canonical ?? '' ;\n\t\tlet _is_at = canonical.indexOf('#');\n\t\tlet elapse_element = this.shadowId('elapse');\n\t\tif (elapse_element) {\n\t\t\telapse_element.href = \n\t\t\t\t`${ absolutizeUrl(canonical) }#${ (_is_at < 0) ?\n\t\t\t\t\taudiotag.id :\n\t\t\t\t\tcanonical.substr(_is_at + 1) }&t=${timecode}`;\n\t\t}\n\n\t\tlet currenttime_element = this.shadowId('currenttime');\n\t\tif (currenttime_element) {\n\t\t\tthis.shadowId('currenttime').innerText = secondsInColonTime(audiotag.currentTime);\n\t\t}\n\t\tlet duration_element = this.shadowId('totaltime');\n\t\tif (duration_element) {\n\t\t\tconst duration = audiotagDuration(audiotag);\n\t\t\tduration_element.innerText = uncertainDuration(duration) ? '' : `\\u00a0/\\u00a0${secondsInColonTime(duration)}`;\n\t\t\tshowElement(duration_element, duration);\n\t\t}\n\t\tthis.updateLine(audiotag.currentTime);\n\t}\n\n\t/**\n\t * @summary Shows indicators for the limits of the playing position\n\t * @private\n\t */\n\tupdateTimeBorders() {\n\t\tlet audiotag = this.audiotag;\n\t\tif ((!document.CPU.isAudiotagGlobal(audiotag)) || (trigger._timecode_end === false)) {\n\t\t\tthis.removePlane(planeNameBorders);\n\t\t\treturn;\n\t\t}\n\t\t// verify if plane exists, and point is invariant\n\t\tif (this.plane(planeNameBorders)) {\n\t\t\tlet check = this.point(planeNameBorders, planeNameBorders);\n\t\t\tif (\n\t\t\t\t(check) &&\n\t\t\t\t(check.start === trigger._timecode_start) &&\n\t\t\t\t(check.end === trigger._timecode_end)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.addPlane(planeNameBorders,{\n\t\t\ttrack   \t: 'borders',\n\t\t\tpanel   \t: false,\n\t\t\thighlight \t: false\n\t\t});\n\t\tthis.addPoint(planeNameBorders, planeNameBorders, {\n\t\t\tstart \t\t: trigger._timecode_start,\n\t\t\tlink    \t: false,\n\t\t\tend     \t: trigger._timecode_end\n\t\t});\n\n\t}\n\t/**\n\t * @summary Show that the media is loading\n\t * @private\n\t *\n\t * @param      {number}  seconds  The seconds\n\t */\n\tupdateLoading(seconds, ratio) {\n\t\tthis.updateLine(seconds, ratio);\n\t\tthis.setActContainer('loading');\n\t}\n\n\t/**\n\t * @summary Show the current media error status. NOTE : this is not working, even on non supported media type\n\t * Chrome logs an error  Uncaught (in promise) DOMException: Failed to load because no supported source was found. \n\t * but don't update message\n\t *\n\t * @private\n\t *\n\t * @return     {boolean}  True if an error is displayed\n\t */\n\tupdateError() {\n\t\tconst audiotag = this.audiotag;\n\t\tif (!audiotag) {\n\t\t\treturn true;\n\t\t}\n\t\tlet error_object = audiotag.error;\n\t\tif (error_object) {\n\t\t\tlet error_message;\n\t\t\tthis.showInterface('error');\n\t\t\tconst m = MediaError;\n\t\t\tswitch (error_object.code) {\n\t\t\t\tcase m.MEDIA_ERR_ABORTED:\n\t\t\t\t\terror_message = __.media_err_aborted;\n\t\t\t\t\tbreak;\n\t\t\t\tcase m.MEDIA_ERR_NETWORK:\n\t\t\t\t\terror_message = __.media_err_network;\n\t\t\t\t\tbreak;\n\t\t\t\tcase m.MEDIA_ERR_DECODE:\n\t\t\t\t\terror_message = __.media_err_decode;\n\t\t\t\t\tbreak;\n\t\t\t\tcase m.MEDIA_ERR_SRC_NOT_SUPPORTED:\n\t\t\t\t\terror_message = __.media_err_src_not_supported;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\terror_message = __.media_err_unknow;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst pageerror = this.shadowId('pageerror');\n\t\t\tif (pageerror) {\n\t\t\t\tpageerror.innerText = error_message;\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * @summary Will refresh player interface at each time change (a lot)\n\t *\n\t * @private\n\t */\n\tupdate() {\n\t\tif (!this.updateError()) {\n\t\t\tthis.updatePlayButton();\n\t\t\tthis.updateTime();\n\t\t\tthis.updateTimeBorders();\n\t\t}\n\t}\n\n\t/**\n\t * @summary Position an element in the timeline, on its time\n\t * @private\n\t *\n\t * @param      {Element} \t\t\t  \t\t    element         Element to impact, should be in #time\n\t * @param      {number|null|undefined}   \t  \tseconds_begin   Starts position in seconds, do not apply if undefined\n\t * @param      {number|null|undefined|boolean}\tseconds_end     Ends position in seconds, do not apply if NaN\n\t */\n\tpositionTimeElement(element, seconds_begin = null, seconds_end = null) {\n\t\tconst { duration } = this.audiotag;\n\n\t\tif (uncertainDuration(duration)) {\n\t\t\t// duration still unkown ! We will need to redraw later the tracks\n\t\t\treturn;\n\t\t}\n\n\t\tif (isSeconds(seconds_begin)) {\n\t\t\telement.style.left =  `${100 * (seconds_begin / duration)}%`;\n\t\t}\n\t\tif (isSeconds(seconds_end)) {\n\t\t\telement.style.right = `${100 * (1 - (seconds_end / duration))}%`;\n\t\t}\n\n\t}\n\n\t/**\n\t * @summary Shows the throbber\n\t *\n\t * @public\n\t *\n\t * @param      {number}  seeked_time  The seeked time\n\t */\n\tasync showThrobberAt(seeked_time) {\n\t\tconst audiotag = this.audiotag;\n\t\tif (audiotag.duration < 1) {\n\t\t\t// do not try to show if no metadata\n\t\t\treturn;\n\t\t}\n\t\tif ((isNaN(audiotag.duration)) && (!isAudiotagStreamed(audiotag))) {\n\t\t\t// as we navigate on the timeline, we wish to know its total duration\n\t\t\t// yes, this is twice calling, as of trigger.throbble()\n  \t\t\taudiotag.setAttribute('preload', 'metadata');\n\t\t\taudiotagPreloadMetadata(audiotag, trigger.hover, event);\n\t\t}\n\n\t\tconst phylactere = this.shadowId('popup');\n\t\tthis.positionTimeElement(phylactere, seeked_time);\n\t\tphylactere.style.opacity = 1;\n\t\tphylactere.innerHTML = secondsInColonTime(seeked_time);\n\t\tphylactere.dateTime = secondsInTime(seeked_time).toUpperCase();\n\t}\n\n\t/**\n\t * @summary Hides immediately the throbber.\n\t * @public\n\t */\n\thideThrobber() {\n\t\t// we use opacity instead of a class change to permits opacity smooth transition via `--cpu-background-transitions`\n\t\tthis.shadowId('popup').style.opacity = 0;\n\t}\n\n\t/**\n\t * @summary Hides the throbber later. Will delay the hiding if recalled.\n\t * @public\n\t */\n\thideThrobberLater() {\n\t\tlet hideThrobber_delay = 1000;\n\t\tconst phylactere = this.shadowId('popup');\n\t\tif (phylactere._hider) {\n\t\t\twindow.clearTimeout(phylactere._hider);\n\t\t}\n\t\tphylactere._hider = window.setTimeout(this.hideThrobber.bind(this), hideThrobber_delay);\n\t}\n\n\t/**\n\t * @summary Will get presentation data from <audio> or from parent document\n\t *\n\t * @package\n\t *\n\t * @return     {Object}  dataset\n\t */\n\taudiotagDataset() {\n\t\treturn {...defaultDataset, ...this.audiotag.dataset};\n\t}\n\n\t/**\n\t * @private\n\t * still need to be public exposed for tests\n\t *\n\t * @summary Update links for sharing\n\t */\n\tupdateLinks() {\n\t\tconst audiotag = this.audiotag;\n\t\tconst dataset = this.audiotagDataset();\n\t\tconst canonical = absolutizeUrl( dataset.canonical ?? '' );\n\t\tconst timepos = (audiotag.currentTime === 0)  ? '' : `&t=${Math.floor(audiotag.currentTime)}`;\n\t\t// watch out : we should put the ID only if canonical URL is strictly identical to this page\n\t\tconst tag_id = (canonical === absolutizeUrl(window.location.href)) ? audiotag.id : '';\n\t\tconst _url = encodeURIComponent(`${canonical}#${tag_id}${timepos}`);\n\t\tlet _twitter = '';\n\t\tif (dataset.twitter?.[0]==='@') {\n\t\t\t /* why did I want an @ in the attribute if I cut it in my code ? to keep HTML readable and comprehensible, instead to developpe attribute name into a \"twitter-handler\" */\n\t\t\t_twitter = `&via=${dataset.twitter.substring(1)}`;\n\t\t}\n\t\tconst link = audiotag.querySelector('source[data-downloadable]')?.src ||\n\t\t\t\t\t dataset.download ||\n\t\t\t\t\t audiotag.currentSrc;\n\n\t\tconst title = dataset.title;\n\t\tconst links = {\n\t\t\ttwitter  : `https://twitter.com/share?text=${title}&url=${_url}${_twitter}`,\n\t\t\tfacebook : `https://www.facebook.com/sharer.php?t=${title}&u=${_url}`,\n\t\t\temail    : `mailto:?subject=${title}&body=${_url}`,\n\t\t\tlink\n\t\t};\n\t\tfor (let key in links) {\n\t\t\tconst element = this.shadowId(key);\n\t\t\tif (element) {\n\t\t\t\telement.href = links[key];\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Shows the interface\n\t *\n\t * @public\n\t * @param      {string}  mode    The mode, can be 'main', 'share' or 'error'\n\t */\n\tshowInterface(mode) {\n\t\tlet classlist = this.container.classList;\n\t\tclasslist.remove(\n\t\t\t'show-main',\n\t\t\t'show-share',\n\t\t\t'show-error',\n\t\t\t'media-streamed'\n\t\t);\n\t\tif (isAudiotagStreamed(this.audiotag)) {\n\t\t\tclasslist.add('media-streamed');\n\t\t}\n\t\tclasslist.add(`show-${mode}`);\n\t}\n\n\t/**\n\t * @summary Shows the sharing panel\n\t * @private\n\t */\n\tshowActions(/* event */) {\n\t\tthis.showInterface('share');\n\t\tthis.updateLinks();\n\t}\n\n\t/**\n\t * @summary Shows the main manel\n\t * @private\n\t */\n\tshowMain(/* event */) {\n\t\tshowElement(this.container, true);\n\t\tthis.showInterface('main');\n\t}\n\n\t/**\n\t * @package not mature enough\n     * @summary Shows the handheld fine navigation\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tshowHandheldNav(event) {\n\t\tif (isAudiotagStreamed(this.audiotag)) {\n\t\t\treturn;\n\t\t}\n\t\tthis.container.classList.toggle('show-handheld-nav');\n\t\tevent?.preventDefault();\n\t}\n\n\t/**\n\t * @summary Inject a <style> into the shadowDom.\n\t * @public\n\t *\n\t * Usage example in applications/chapters_editor.js\n\t *\n\t * @param \t{string}  styleName   \tA name in the range /[a-zA-Z0-9\\-_]+/, key to tag the created <style>\n\t * @param \t{string}  css \t\t\tinline CSS to inject\n\t */\n\tinjectCss(styleName, css) {\n\t\tif (!styleName.match(validId)) {\n\t\t\terror(`injectCss invalid key \"${styleName}\"`);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.removeCss(styleName);\n\t\tconst element = document.createElement('style');\n\t\telement.id = `style_${styleName}`;\n\t\telement.innerHTML = css;\n\t\tthis.container.appendChild(element);\n\t}\n\n\t/**\n\t * @summary Remove an injected <style> into the shadowDom\n\t * @public\n\t *\n\t * @param \t{string}  styleName   \tKey of the created <style> , /[a-zA-Z0-9\\-_]+/\n\t */\n\tremoveCss(styleName) {\n\t\tthis.shadowId(`style_${styleName}`)?.remove();\n\t}\n\n\n\t/**\n\t * @summary Complete the interface at build time\n\t * @package\n\t */\n\tcompleteTemplate() {\n\t\tconst dataset = this.audiotagDataset();\n\t\tlet { title, waveform } = dataset;\n\t\tconst element_canonical = this.shadowId('canonical');\n\t\tif (element_canonical) {\n\t\t\telement_canonical.href = dataset.canonical;\n\t\t\tlet classlist = element_canonical.classList;\n\t\t\tif (!title) {\n\t\t\t\tclasslist.add('untitled');\n\t\t\t\ttitle = __.untitled;\n\t\t\t} else {\n\t\t\t\tclasslist.remove('untitled');\n\t\t\t}\n\t\t\telement_canonical.innerText = title;\n\t\t}\n\n\t\tif (this.element.title !== title) {\n\t\t\tthis.element.title = title; // WATCHOUT ! May goes recursive with observers on the wbecomponent\n\t\t}\n\t\tconst poster = this.shadowId('poster');\n\t\tif (poster) {\n\t\t\tposter.src = dataset.poster || '';\n\t\t}\n\t\tconst time_element = this.shadowId('time');\n\t\tif (time_element) {\n\t\t\ttime_element.style.backgroundImage = waveform ? `url(${waveform})` : '';\n\t\t}\n\t\tthis.showMain();\n\t}\n\t/**\n\t * @summary Attach the audiotag to the API\n\t * @package\n\t *\n\t * @param      {Element}  audiotag  The audiotag\n\t */\n\tattachAudiotagToController(audiotag) {\n\t\tif (!audiotag) {\n\t\t\treturn;\n\t\t}\n\t\tthis.audiotag = audiotag;\n\t\taddIdToAudiotag(audiotag);\n\t\tthis.completeTemplate();\n\n\t\t// throw simplified event\n\t\ttrigger.update({target : audiotag});\n\t}\n\n\n\t/**\n\t * @summary Gets an array of whole planes\n\t * @private\n\t *\n\t * @return     {Array(string)}        array of planeNames\n\t */\n\tplaneNames() {\n\t\t// TODO : we need a way to order them, see #123 https://github.com/dascritch/cpu-audio/issues/123\n\t\t// BUG we may have duplicates, it can happens even with protections in addPlane() \n\t\treturn Object.keys(this._planes).concat(Object.keys(this.audiotag._CPU_planes));\n\t}\n\n\t/**\n\t * @summary Gets the plane info\n\t * @private\n\t *\n\t * @param      {string}  planeName     The name\n\t * @return     {Object}                 data of the plane\n\t */\n\tplane(planeName) {\n\t\treturn this._planes[planeName] ?? this.audiotag._CPU_planes[planeName];\n\t}\n\n\t/**\n\t * @summary Gets the plane track element\n\t * @private but needed in tests\n\t *\n\t * @param      {string}  planeName   The name\n\t * @return     {Element}    The <aside> track element from ShadowDom interface\n\t */\n\tplaneTrack(planeName) {\n\t\treturn this.shadowId(`track_${planeName}`);\n\t}\n\n\t/**\n\t * @summary Gets the plane panel element\n\t * @private but needed in test\n\t *\n\t * @param      {string}  planeName   The name\n\t * @return     {Element}    The panel element from ShadowDom interface\n\t */\n\tplanePanel(planeName) {\n\t\treturn this.shadowId(`panel_${planeName}`);\n\t}\n\n\t/**\n\t * @summary Gets the <nav><ul> plane panel element\n\t * @private but needed in tests\n\t *\n\t * @param      {string}  planeName   The name\n\t * @return     {Element}    The <ul> element from ShadowDom interface, null if inexisting\n\t */\n\tplaneNav(planeName) {\n\t\treturn this.planePanel(planeName)?.querySelector(`ul`);\n\t}\n\n\t/**\n\t * @summary Draws a plane\n\t * @private\n\t *\n\t * @param      {string}  planeName  The plane name\n\t */\n\tdrawPlane(planeName) {\n\t\tthis.planeTrack(planeName)?.remove();\n\t\tthis.planePanel(planeName)?.remove();\n\n\t\tlet planeData = this.plane(planeName);\n\t\tif (!planeData) {\n\t\t\treturn ;\n\t\t}\n\t\tlet { track, panel, title } = planeData;\n\t\tlet removeHighlightsPoints_bind = this.removeHighlightsPoints.bind(this, planeName, previewClassname, true);\n\n\t\t/**\n\t\t * @param      {Element}  element  Impacted element\n\t\t */\n\t\tfunction assignEventsOnPlanes(element) {\n\t\t\telement.addEventListener('mouseover', previewContainerHover, passiveEvent);\n\t\t\telement.addEventListener('focusin', previewContainerHover, passiveEvent);\n\t\t\telement.addEventListener('mouseleave', removeHighlightsPoints_bind, passiveEvent);\n\t\t\telement.addEventListener('focusout', removeHighlightsPoints_bind, passiveEvent);\n\t\t}\n\n\n\t\tif (track !== false) {\n\t\t\t// we have to create the track timeline\n\t\t\tlet plane_track = document.createElement('aside');\n\t\t\tplane_track.id = `track_${planeName}`;\n\t\t\tif (track !== true) {\n\t\t\t\t// with a class list\n\t\t\t\tplane_track.classList.add(track.split(' '));\n\t\t\t}\n\n\t\t\tthis.shadowId('line').appendChild(plane_track);\n\t\t\tassignEventsOnPlanes(plane_track);\n\t\t}\n\n\t\tif (panel !== false) {\n\t\t\t// we have to create the panel area\n\t\t\tlet plane_panel = document.createElement('div');\n\t\t\tplane_panel.id = `panel_${planeName}`;\n\t\t\tif (panel !== true) {\n\t\t\t\t// with a class list\n\t\t\t\tplane_panel.classList.add(panel.split(' '));\n\t\t\t}\n\n\t\t\tplane_panel.classList.add('panel');\n\n\t\t\tplane_panel.innerHTML = `<h6>${escapeHtml(title)}</h6><nav><ul></ul></nav>`;\n\t\t\tthis.container.appendChild(plane_panel);\n\t\t\tshowElement( plane_panel.querySelector('h6') , title);\n\t\t\tassignEventsOnPlanes(plane_panel);\n\t\t}\n\n\t\tif ( (!this.isController) && (this.mirroredInController()) ) {\n\t\t\tdocument.CPU.globalController.drawPlane(planeName);\n\t\t}\n\n\t}\n\n\t/**\n\t * @summary Add an annotation plane layer\n\t * @public\n\t *\n\t * @param      {string}   planeName   A name in the range /[a-zA-Z0-9\\-_]+/\n\t * @param      {Object}   planeData   { \n\t \t\t\t\t\t\t\t\t\t\ttitle : The displayed title for the panel,\n\t \t\t\t\t\t\t\t\t\t\ttrack : true/false/classnames ,\n\t * \t\t\t\t\t\t\t\t\t\tpanel : true/false/classnames ,\n\t * \t\t\t\t\t\t\t\t\t\thighlight : true/false,\n\t *\t\t\t\t\t\t\t\t\t\t_comp : true/false // only stored in component, private use only\n\t  }\n\t *\n\t * @return     {boolean}  success\n\t */\n\taddPlane(planeName, planeData = {}) {\n\t\tif ((! planeName.match(validId)) || (this.plane(planeName))) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// I don't understand (yet) why, when I move this declaration at top of file, tests will fail\n\t\tconst default_plane_data = {\n\t\t\ttrack       : true,\n\t\t\tpanel       : true,\n\t\t\ttitle       : '',\n\t\t\thighlight   : true,\n\t\t\tpoints      : {},\n\t\t\t_comp\t\t: false\n\t\t};\n\n\t\tplaneData = { ...default_plane_data, ...planeData};\n\n\t\tif (!planeData._comp) {\n\t\t\tif (this.isController) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tthis.audiotag._CPU_planes = this.audiotag._CPU_planes ?? {};\n\t\t\tthis.audiotag._CPU_planes[planeName] = planeData;\n\t\t} else {\n\t\t\tthis._planes[planeName] = planeData;\n\t\t}\n\t\tthis.drawPlane(planeName);\n\t\treturn true;\n\t}\n\t/**\n\t * @summary Remove an annotation plane layer\n\t * @public\n\t *\n\t * @param      {string}   planeName    A name in the range /[a-zA-Z0-9\\-_]+/\n\t *\n\t * @return     {boolean}  success\n\t */\n\tremovePlane(planeName) {\n\t\tif ( (! planeName.match(validId)) || (! this.plane(planeName)) || (this.isController && (!this._planes[planeName])) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tdelete (this._planes[planeName] ? this._planes : this.audiotag._CPU_planes)[planeName];\n\n\t\tthis.planeTrack(planeName)?.remove();\n\t\tthis.planePanel(planeName)?.remove();\n\n\t\tif ( (!this.isController) && (this.mirroredInController()) ) {\n\t\t\t// as plane data is removed, it will remove its aside and track\n\t\t\tdocument.CPU.globalController.drawPlane(planeName);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Shortcut to get  points data\n\t * @private\n\t *\n\t * @param      {string}  planeName  The plane name\n\t * @return     {Object}  Data\n\t */\n\tplanePoints(planeName) {\n\t\treturn this.plane(planeName)?.points;\n\t}\n\n\t/**\n\t * @summary Gets the point info\n\t * @public\n\t *\n\t * @param      {string}  planeName  The plane name\n\t * @param      {string}  pointName  The point name\n\t * @return     {Object}  Data\n\t */\n\tpoint(planeName, pointName) {\n\t\treturn this.plane(planeName)?.points?.[pointName];\n\t}\n\n\t/**\n\t * @summary Gets the point element in the track\n\t * @private but needed in tests\n\t *\n\t * @param      {string}  planeName   The plane\n\t * @param      {string}  pointName   The point\n\t * @return     {Element}    The <div> point element into <aside> from ShadowDom interface\n\t */\n\tpointTrack(planeName, pointName) {\n\t\treturn this.shadowId(getPointId(planeName, pointName, false));\n\t}\n\n\t/**\n\t * @summary Gets the point element in the panel\n\t * @private but needed in tests\n\t *\n\t * @param      {string}  planeName   The plane\n\t * @param      {string}  pointName   The point\n\t * @return     {Element}    The <li> point element into panel from ShadowDom interface\n\t */\n\tpointPanel(planeName, pointName) {\n\t\treturn this.shadowId(getPointId(planeName, pointName, true));\n\t}\n\n\t/**\n\t * @summary    Resort points of a plane by start-time\n\t * @private\n\t *\n\t * @param      {string}   planeName     The plane name\n\t */\n\tplaneSort(planeName) {\n\t\tthis.plane(planeName).points =  Object.fromEntries( \n\t\t\t\t\t\t\t\tObject.entries(\n\t\t\t\t\t\t\t    \tthis.planePoints(planeName)\n\t\t\t\t\t\t\t\t).sort(\n\t\t\t\t\t\t\t    \t([, point_a], [, point_b]) => {\n\t\t\t\t\t\t\t    \t\treturn point_a.start - point_b.start;\n\t\t\t\t\t\t\t    \t}\n\t\t\t\t\t\t\t    )\n\t\t\t\t\t\t    );\n\t\tlet points = Object.values( this.plane(planeName).points );\n\t\tthis.plane(planeName)._st_max = points[points.length - 1]?.start ?? 0;\n\t}\n\n\t/**\n\t * @summary    get pointNames from a planeName\n\t * @private may goes public later\n\t *\n\t * @param      {string}   planeName     The plane name\n\t * @return     {[string]} points_names\t Array of pointNames\n\t */\n\tplanePointNames(planeName) {\n\t\treturn Object.keys(this.planePoints(planeName));\n\t}\n\n\t/**\n\t * @summary    Reorder panel of a plane by points order\n\t * @private\n\t *\n\t * @param      {string}   planeName     The plane name\n\t */\n\tpanelReorder(planeName) {\n\t\t// TODO we may lose focused element. Store it to refocus it at the end\n\t\tthis.planeSort(planeName);\n\t\tif (!this.planePanel(planeName)) {\n\t\t\treturn;\n\t\t}\n\t\tlet previous_element, element;\n\t\tfor (let pointName of this.planePointNames(planeName)) {\n\t\t\telement = this.pointPanel(planeName, pointName);\n\t\t\tprevious_element?.insertAdjacentElement('afterend', element);\n\t\t\tprevious_element = element;\n\t\t}\n\t}\n\n\t/**\n\t * @summary Draws a plane point\n\t * @private\n\t *\n\t * @param      {string}  planeName  The plane name\n\t * @param      {string}  pointName  The point name\n\t */\n\tdrawPoint(planeName, pointName) {\n\t\tconst audiotag = this.audiotag ?? document.CPU.globalController.audiotag;\n\t\tconst pointData = this.point(planeName, pointName);\n\t\tconst {start, link, text, image, end} = pointData;\n\n\t\tlet use_link = '#';\n\t\tif (link === true) {\n\t\t\t// automated link to the audio tag.\n\t\t\tuse_link = `#${audiotag.id}&t=${start}`;\n\t\t}\n\t\tif (typeof(link) === 'string') {\n\t\t\t// Integrator of the page wants a specific url (hoping he know what he do with a \"javascript:\")\n\t\t\tuse_link = link;\n\t\t}\n\n\t\tlet track = this.planeTrack(planeName);\n\t\tlet elementPointTrack;\n\t\tif (track) {\n\t\t\telementPointTrack = this.pointTrack(planeName, pointName);\n\t\t\tif (!elementPointTrack) {\n\t\t\t\telementPointTrack = document.createElement('a');\n\t\t\t\telementPointTrack.id = getPointId(planeName, pointName, false);\n\t\t\t\t// TODO : how to do chose index of a point track if there is no link, or a panel but no track??\n\t\t\t\telementPointTrack.tabIndex = -1; \n\t\t\t\telementPointTrack.innerHTML = '<img alt=\"\" /><span></span>';\n\t\t\t\ttrack.appendChild(elementPointTrack);\n\t\t\t}\n\t\t\telementPointTrack.href = use_link;\n\t\t\telementPointTrack.title = text;\n\t\t\tlet track_img = elementPointTrack.querySelector('img');\n\t\t\tshowElement(track_img, image);\n\t\t\ttrack_img.src = image || '';\n\t\t\telementPointTrack.querySelector('img').innerHTML = text ;\n\t\t\tthis.positionTimeElement(elementPointTrack, start, end);\n\t\t}\n\n\t\tlet panel = this.planeNav(planeName);\n\t\tlet elementPointPanel;\n\t\tif (panel) {\n\t\t\telementPointPanel = this.pointPanel(planeName, pointName);\n\t\t\tif (!elementPointPanel) {\n\t\t\t\telementPointPanel = document.createElement('li');\n\t\t\t\telementPointPanel.id = getPointId(planeName, pointName, true);\n\t\t\t\telementPointPanel.innerHTML = '<a href=\"#\" class=\"cue\"><strong></strong><time></time></a>';\n\t\t\t\tpanel.appendChild(elementPointPanel);\n\t\t\t}\n\t\t\telementPointPanel.querySelector('a').href = use_link;\n\t\t\telementPointPanel.querySelector('strong').innerHTML = text;\n\t\t\tlet time_element = elementPointPanel.querySelector('time');\n\t\t\ttime_element.dateTime = durationIso(start);\n\t\t\ttime_element.innerText = secondsInColonTime(start);\n\t\t}\n\n\t\tthis.emitEvent('drawPoint', {\n\t\t\tplaneName,\n\t\t\tpointName,\n\t\t\tpointData,\n\t\t\telementPointTrack,\n\t\t\telementPointPanel,\n\t\t});\n\n\t\tif ( (!this.isController) && (this.mirroredInController()) ) {\n\t\t\tdocument.CPU.globalController.drawPoint(planeName, pointName);\n\t\t}\n\t}\n\n\t/**\n\t * @summary Add an annotation point\n\t * @public\n\t *\n\t * @param      {string}   planeName      The existing plane name\n\t * @param      {string}   pointName      The point name, should conform to /^[a-zA-Z0-9\\-_]+$/\n\t * @param      {Object}   pointData      {\n\t * \t\t\t\t\t\t\t\t\t\t\tstart : <seconds>,\n\t *\t\t\t\t\t\t\t\t\t\t    image : <url>,\n\t * \t\t\t\t\t\t\t\t\t\t\tlink  : <url>/true (in audio)/false (none),\n\t * \t\t\t\t\t\t\t\t\t\t\ttext  : <text>,\n\t * \t\t\t\t\t\t\t\t\t\t\tend   : <seconds> }\n\t *\n\t * @return     {boolean}  success\n\t */\n\taddPoint(planeName, pointName, pointData={}) {\n\t\tlet start = Number(pointData.start);\n\n\t\tif ( (!pointName.match(validId)) ||\n\t\t\t(!this.plane(planeName)) ||\n\t\t\t(this.point(planeName, pointName)) ||\n\t\t\t(!checkPointData(pointData)) ) {\n\t\t\treturn false;\n\t\t}\n\t\tif ((!this._planes[planeName]) && (this.isController)) {\n\t\t\t// accept points adding on controller only for private planes\n\t\t\treturn false;\n\t\t}\n\t\t\n\t\tpointData.start = start;\n\t\tthis.plane(planeName).points[pointName] = pointData;\n\n\t\tthis.emitEvent('addPoint', {\n\t\t\tplaneName,\n\t\t\tpointName,\n\t\t\tpointData\n\t\t});\n\n\t\tif (this.plane(planeName)._st_max > start) {\n\t\t\t// we need to reorder the plane\n\t\t\tthis.panelReorder(planeName);\n\t\t} else {\n\t\t\tthis.drawPoint(planeName, pointName);\n\t\t\tthis.plane(planeName)._st_max = start;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Bulk push (add/modify) points\n\t * @public\n\t *\n\t * @param      {string}   planeName      The existing plane name\n\t * @param      {Object}   Object of pointData      {\n\t \t                                         point_1 : pointData_1,\n\t \t                                         point_2 : pointData_2,\n\t * \t\t\t\t\t\t\t\t\t\t\t}\n\t *\n\t * @return     {boolean}  success\n\t */\n\tbulkPoints(planeName, pointDataGroup={}) {\n\t\tif (!this.plane(planeName)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif ((!this._planes[planeName]) && (this.isController)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tfor (let [pointName, pointData] of Object.entries(pointDataGroup)) {\n\t\t\tif ((!pointName.match(validId)) || (!checkPointData(pointData))) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\tlet from_points = this.plane(planeName).points;\n\t\tpointDataGroup = {...from_points, ...pointDataGroup};\n\t\tthis.plane(planeName).points = pointDataGroup;\n\n\t\tthis.emitEvent('bulkPoints', {\n\t\t\tplaneName,\n\t\t\tpointDataGroup\n\t\t});\n\t\tlet nav = this.planeNav(planeName);\n\t\tif (nav) {\n\t\t\tnav.innerHTML = '';\n\t\t}\n\t\tthis.refreshPlane(planeName);\n\t\treturn true;\n\t}\n\n\n\t/**\n\t * @summary Edit an annotation point\n\t * @public\n\t *\n\t * @param      {string}   planeName      The existing plane name\n\t * @param      {string}   pointName      The existing point name\n\t * @param      {Object}   data            { 'image' : <url>,\n\t * \t\t\t\t\t\t\t\t\t\t\t'link'  : <url>/true (in audio)/false (none),\n\t * \t\t\t\t\t\t\t\t\t\t\t'text'  : <text>,\n\t * \t\t\t\t\t\t\t\t\t\t\t'start' : <seconds>,\n\t * \t\t\t\t\t\t\t\t\t\t\t'end'   : <seconds> }\n\t *\t\t\t\t\t\t\t\t\t\t  will only change keys in the list\n\t */\n\teditPoint(planeName, pointName, pointData) {\n\t\tlet plane = this.plane(planeName);\n\t\tif (!plane) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet original_data = this.point(planeName, pointName);\n\t\tif (!original_data) {\n\t\t\treturn false;\t\n\t\t}\n\n\t\tlet { start } = pointData;\n\t\tstart = Number(start);\n\t\tlet will_refresh = ((start != null) && (start !== original_data.start));\n\n\t\tpointData = {...original_data, ...pointData};\n\n\t\tif (!checkPointData(pointData)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tplane.points[pointName] = pointData;\n\n\t\tthis.drawPoint(planeName, pointName);\n\t\tif (will_refresh) {\n\t\t\tthis.panelReorder(planeName);\n\t\t}\n\n\t\tthis.emitEvent('editPoint', {\n\t\t\tplaneName,\n\t\t\tpointName,\n\t\t\tpointData\n\t\t});\n\n\t\tif (plane._st_max < start) {\n\t\t\tplane._st_max = start;\n\t\t}\n\t}\n\n\t/**\n\t * @summary Remove an annotation point\n\t * @public\n\t *\n\t * @param      {string}   planeName  A name in the range /^[a-zA-Z0-9\\-_$]+/\n\t * @param      {string}   pointName  A name in the range /^[a-zA-Z0-9\\-_$]+/\n\t * @return     {boolean}  success\n\t */\n\tremovePoint(planeName, pointName) {\n\t\tlet plane = this.plane(planeName);\n\t\tif ((!plane) || (!this.point(planeName, pointName))) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.emitEvent('removePoint', {\n\t\t\tplaneName,\n\t\t\tpointName\n\t\t});\n\n\t\tthis.pointTrack(planeName, pointName)?.remove();\n\t\tthis.pointPanel(planeName, pointName)?.remove();\n\n\t\t//  recalc _start_max for caching repaints\n\t\tlet _st_max = 0;\n\t\tfor (let s of Object.values(this.planePoints(planeName))) {\n\t\t\tlet that_start = Number(s.start);\n\t\t\t_st_max = _st_max < that_start ? that_start : _st_max;\n\t\t}\n\t\tplane._st_max = _st_max;\n\n\t\tif ( (!this.isController) && (this.mirroredInController()) ) {\n\t\t\tdocument.CPU.globalController.removePoint(planeName, pointName);\n\t\t}\n\t\tif (plane.points[pointName]) {\n\t\t\tdelete plane.points[pointName];\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Remove any points from an annotation plane\n\t * @public\n\t *\n\t * @param      {string}  planeName  The plane name\n\t */\n\tclearPlane(planeName) {\n\t\tlet plane = this.plane(planeName);\n\t\tif (!plane) {\n\t\t\treturn false;\n\t\t}\n\n\t\tfor (let pointName of Object.keys(plane.points)) {\n\t\t\tthis.removePoint(planeName, pointName);\n\t\t}\n\t\t// need to repass in case of badly removed / malformed entries\n\t\tlet nav = this.planeNav(planeName);\n\t\tif (nav) {\n\t\t\tnav.innerHTML = '';\n\t\t}\n\t\t// purge repaint flag to redraw\n\t\tplane._st_max = 0;\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Refresh a plane. a panelReorder may be enough\n\t * @public\n\t *\n\t * @param      {string}  planeName  The plane name\n\t */\n\trefreshPlane(planeName) {\n\t\tthis.planeSort(planeName);\n\t\tfor (let pointName of this.planePointNames(planeName)) {\n\t\t\tthis.drawPoint(planeName, pointName);\n\t\t}\n\t}\n\n\t/**\n\t * @summary Clear and redraw all planes\n\t * Mainly when cpu-controller is changing targeted audio tag\n\t * @public\n\t */\n\tredrawAllPlanes() {\n\t\tundrawAllPlanes(this.container);\n\n\t\tfor (let planeName of Object.keys({...this._planes, ...this.audiotag._CPU_planes})) {\n\t\t\tthis.drawPlane(planeName);\n\t\t\tthis.refreshPlane(planeName);\n\t\t}\n\n\t\t// due to a Chrome glitch on chapters panel in cpu-controller while changing playing cpu-audio, we have to refresh a cuechange_event \n\t\tcuechange_event(this);\n\t}\n\n\t/**\n\t * @summary Needed because Chrome can fire loadedmetadata before knowing audio duration. Fired at durationchange\n\t *\n\t * @private\n\t */\n\trepositionTracks() {\n\t\tlet duration = this.audiotag.duration;\n\t\tif (uncertainDuration(duration)) {\n\t\t\t// duration still unkown\n\t\t\treturn ;\n\t\t}\n\n\t\tfor (let planeName in this.audiotag._CPU_planes) {\n\t\t\tlet plane_data = this.plane(planeName);\n\t\t\tif (plane_data.track) {\n\t\t\t\tfor (let pointName of this.planePointNames(planeName)) {\n\t\t\t\t\tlet element = this.pointTrack(planeName, pointName);\n\t\t\t\t\tlet {start, end} = this.point(planeName, pointName);\n\t\t\t\t\tthis.positionTimeElement(element, start, end);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Remove any previewes on plane points\n\t * @public\n\t *\n\t * @param\t\t\t {string}  planeName The plane name to operate\n\t * @param      {string}  className Targeted class name, 'with-preview' by default\n\t * @param      {boolean} mirror     Also act on linked cpu-controller/cpu-audio\n\t */\n\tremoveHighlightsPoints(planeName, className=previewClassname, mirror=true) {\n\t\tquerySelectorDo(\n\t\t\t`#track_${planeName} .${className}, #panel_${planeName} .${className}`,\n\t\t\t(element) => { element.classList.remove(className); },\n\t\t\tthis.container);\n\t\tif ( (mirror) && (this.mirroredInController()) ) {\n\t\t\tlet globalController = document.CPU.globalController;\n\n\t\t\tlet on;\n\t\t\tif (!this.isController) {\n\t\t\t\ton = globalController;\n\t\t\t} else {\n\t\t\t\ton = findContainer(globalController.audiotag);\n\t\t\t}\n\t\t\ton.removeHighlightsPoints(planeName, className, false);\n\t\t}\n\t}\n\n\t/**\n\t * @summary Sets a preview on a plane point\n\t * @public\n\t *\n\t * @param      {string}  planeName  The plane name\n\t * @param      {string}  pointName  The point name\n\t * @param      {string}  className  class name, 'with-preview' by default\n\t * @param      {boolean} mirror     Also act on linked cpu-controller/cpu-audio, true by default\n\t */\n\thighlightPoint(planeName, pointName, className=previewClassname, mirror=true) {\n\t\tthis.removeHighlightsPoints(planeName, className, mirror);\n\n\t\tif (! this.plane(planeName)?.highlight) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.pointTrack(planeName, pointName)?.classList.add(className);\n\t\tthis.pointPanel(planeName, pointName)?.classList.add(className);\n\n\t\tif ( (mirror) && (this.mirroredInController()) ) {\n\t\t\tlet DocumentCPU = document.CPU;\n\t\t\tlet on;\n\t\t\tif (!this.isController) {\n\t\t\t\ton = DocumentCPU.globalController;\n\t\t\t} else {\n\t\t\t\ton = findContainer(DocumentCPU.globalController.audiotag);\n\t\t\t}\n\t\t\ton.highlightPoint(planeName, pointName, className, false);\n\t\t}\n\t}\n\n\n\t/**\n\t * @summary Give focus on an annotation point\n\t * @public\n\t *\n\t * @param      {string}   planeName      The existing plane name\n\t * @param      {string}   pointName      The existing point name\n\t * @return      boolean    has focus\n\t */\n\tfocusPoint(planeName, pointName) {\n\t\t// get element, first on the plane, and else on the plane\n\t\tconst element = this.pointPanel(planeName, pointName)?.querySelector('a') ?? this.pointTrack(planeName, pointName);\n\t\tif (!element) {\n\t\t\treturn false;\n\t\t}\n\t\telement.focus();\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Get focused element in shadow\n\t * @public\n\t *\n\t * @return      {Element|null}   \t\tFocused element, or null\n\t */\n\tfocused() {\n\t\treturn this.shadow.querySelector(':focus');\n\t}\n\n\t/**\n\t * @summary Get ID of focused element in shadow\n\t * @public\n\t *\n\t * @return      {string|null|undefined}   \t\tFocused ID, or null or undefined\n\t */\n\tfocusedId() {\n\t\tconst target = this.focused();\n\t\tif (!target) {\n\t\t\treturn;\n\t\t}\n\t\tconst out = target.id  != '' ? target.id : target.closest('[id]').id;\n\t\treturn out == '' ? null : out;\n\t}\n\n\t/**\n\t * @summary browse yo with focus in panels using  key\n\t * @private\n\t */\n\tprevFocus() {\n\t\trelativeFocus(this, false);\n\t}\n\n\t/**\n\t * @summary browse down with focus in panels using  key\n\t * @private\n\t */\n\tnextFocus() {\n\t\trelativeFocus(this, true);\n\t}\n\n}\n\n/**\n * @summary relatively browse up or down with focus\n * @private\n */\nfunction relativeFocus(self, go_foward) {\n\tconst planeNames = self.planeNames();\n\tif (planeNames.length == 0) {\n\t\treturn;\n\t}\n\n\tconst validPlane = (data) => {\n\t\tlet {track, panel, points} = self.plane(data);\n\t\treturn (((track !== false) || (panel !== false)) && (points) && (Object.keys(points).length > 0));\n\t};\n\n\tconst scanToPrevPlane = (fromPlane) => {\n\t\tfor(let id = planeNames.indexOf(fromPlane) -1; id >= 0 ; id--) {\n\t\t\tlet out = planeNames[id];\n\t\t\tif (validPlane(out)) {\n\t\t\t\treturn out;\n\t\t\t}\n\t\t}\n\t};\n\tconst scanToNextPlane = (fromPlane) => {\n\t\tfor(let id = planeNames.indexOf(fromPlane) +1; id < planeNames.length ; id++) {\n\t\t\tlet out = planeNames[id];\n\t\t\tif (validPlane(out)) {\n\t\t\t\treturn out;\n\t\t\t}\n\t\t}\n\t};\n\n\tlet previous_pointName, planeName, pointName, planePointNames;\n\tlet wasFocused = self.focused();\n\tif (wasFocused) {\n\t\tif (!wasFocused.id) {\n\t\t\twasFocused = wasFocused.closest('[id]');\n\t\t}\n\t\t[planeName,previous_pointName] = planeAndPointNamesFromId(wasFocused.id);\n\t}\n\tif (previous_pointName != '') {\n\t\tplanePointNames = self.planePointNames(planeName);\n\t\tpointName = adjacentArrayValue(planePointNames, previous_pointName, go_foward?1:-1);\n\t}\n\tif (!pointName) {\n\t\tplaneName = go_foward ? scanToNextPlane(planeName) : scanToPrevPlane(planeName);\n\t\tif (!planeName) {\n\t\t\treturn;\n\t\t}\n\t\tlet points = self.planePointNames(planeName);\n\t\tpointName = points[go_foward ? 0 : (points.length-1)];\n\t}\n\tself.focusPoint(planeName, pointName);\n}\n\n","import {CpuAudioTagName, CpuControllerTagName, selectorAcceptable, selectorInterface, notScreenContext, findContainer, info, warn, } from './utils.js';\nimport {CPU_element_api} from './element_cpu.js';\n\n\n/**\n * @summary Interprets if <cpu-audio>/<cpu-controller> element is modified\n *\n * @param      {Object}  mutationsList  The mutations list\n */\nfunction observer_component([{target}]) {\n\tconst container = findContainer(target);\n\tlet component = container.element;\n\tlet media_tagname = 'audio';\n\tlet audio_element = component.querySelector(media_tagname);\n\tif ((!audio_element) && (component.tagName !== CpuControllerTagName)) {\n\t\tinfo(`<${media_tagname}> element was removed.`);\n\t\tcomponent.remove();\n\t\treturn;\n\t}\n\n\tcomponent.copyAttributesToMediaDataset?.();\n\tcontainer.attributesChanges();\n}\n\n/**\n * Controller without assigned audio element, i.e. global page controller\n *\n * @class      CpuControllerElement (name)\n */\nexport class CpuControllerElement extends HTMLElement {\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.CPU = null;\n\t\tthis.observer_component = null;\n\n\t\tif (notScreenContext()) {\n\t\t\t// I'm not in a screen context, as a braille surface\n\t\t\t// Sorry, but your browser's native controls are surely more accessible\n\t\t\tthis.remove();\n\t\t\treturn ;\n\t\t}\n\n\t\t/// TODO if a CPU-Controller is still there, do not create\n\n\t\tif (this.tagName === CpuAudioTagName) {\n\t\t\tif (!this.querySelector(selectorAcceptable)) {\n\t\t\t\t// Graceful degradation : do not start if no media element OR no native controls\n\t\t\t\twarn(`Tag <${CpuAudioTagName}> without <audio controls>.\\nSee https://github.com/dascritch/cpu-audio/blob/master/INSTALL.md for a correct installation.`);\n\t\t\t\tthis.remove();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif ((this.tagName === CpuControllerTagName) && (document.CPU.globalController)) {\n\t\t\t// called twice ????\n\t\t\twarn(`<${CpuControllerTagName}> tag instancied twice.`);\n\t\t\tthis.remove();\n\t\t\treturn ;\n\t\t}\n\n\t\tlet template =  document.querySelector('template#CPU__template');\n\t\tlet shadow_element = this.attachShadow({mode: 'open'});\n\t\tshadow_element.innerHTML = template.innerHTML;\n\t}\n\n\tconnectedCallback() {\n\t\tif (notScreenContext()) {\n\t\t\treturn ;\n\t\t}\n\n\t\tif (!this.shadowRoot) {\n\t\t\treturn;\n\t\t}\n\n\t\tnew CPU_element_api(this, this.shadowRoot.querySelector(selectorInterface));\n\n\t\tthis.observer_component = new MutationObserver(observer_component);\n\t\tthis.observer_component.observe(this, {\n\t\t\tchildList \t: true,\n\t\t\tattributes\t: true\n\t\t});\n\t\tthis.CPU.attributesChanges();\n\t}\n\n\tdisconnectedCallback() {\n\t\tif ((this.tagName === CpuControllerTagName) && (document.CPU.globalController)) {\n\t\t\tdocument.CPU.globalController = null;\n\t\t}\n\t}\n\n}\n","import {selectorAcceptable, findContainer} from './utils.js';\nimport {CpuControllerElement} from './cpu_controller.class.js';\nimport {connectAudiotag} from './media_element_extension.js';\nimport {timeInSeconds} from './convert.js';\nimport {build_chapters} from './build_chapters.js';\n\n\n/**\n * @summary Interprets if <audio> element is modified or removed\n * TODO : act when a child change as <source> or <track>\n *\n * @param      {Object}  mutationsList  The mutations list\n */\nfunction observer_audio([{target}]) {\n\tconst container = findContainer(target);\n\n\t// in case <track> changed/removed\n\tbuild_chapters(container);\n\n\t// in case attributes changed\n\tcontainer.completeTemplate();\n\n\tconst globalController = document.CPU.globalController;\n\tif (container.audiotag.isEqualNode(globalController?.audiotag)) {\n\t\tbuild_chapters(globalController);\n\t\tglobalController.completeTemplate();\n\t}\n}\n\n/**\n * Controller with assigned audio element\n *\n * @class      CpuAudioElement (name)\n */\nexport class CpuAudioElement extends CpuControllerElement {\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.audiotag = this.querySelector(selectorAcceptable);\n\t\tif (!this.audiotag) {\n\t\t\tthis.remove();\n\t\t\treturn ;\n\t\t}\n\t\tthis.observer_audio = null;\n\t}\n\n\tcopyAttributesToMediaDataset() {\n\t\tif (!this.audiotag) {\n\t\t\tthis.remove();\n\t\t\treturn ;\n\t\t}\n\t\t// copying personalized data to audio tag\n\t\tfor (let key in document.CPU.defaultDataset) {\n\t\t\tif (this.hasAttribute(key)) {\n\t\t\t\tlet value = this.getAttribute(key);\n\t\t\t\tthis.audiotag.dataset[key] = (key !== 'duration') ? value : timeInSeconds(value);\n\t\t\t}\n\t\t}\n\t}\n\n\tconnectedCallback() {\n\t\tif (!this.audiotag) {\n\t\t\treturn;\n\t\t}\n\t\t\n\t\tthis.copyAttributesToMediaDataset();\n\n\t\tsuper.connectedCallback();\n\n\t\tconnectAudiotag(this.CPU.audiotag);\n\n\t\tthis.observer_audio = new MutationObserver(observer_audio);\n\t\tthis.observer_audio.observe(this, {\n\t\t\tchildList\t: true,\n\t\t\tattributes\t: true,\n\t\t\tsubtree\t\t: true\n\t\t});\n\t}\n\n\tdisconnectedCallback() {\n\t\tif (this.audiotag?.id)  {\n\t\t\tconst playlists = document.CPU.playlists;\n\t\t\t// remove reference in playlists\n\t\t\tfor (let index in playlists) {\n\t\t\t\tconst out = playlists[index].filter(entry_id => entry_id !== this.audiotag.id);\n\t\t\t\tdocument.CPU.playlists[index] = out;\n\t\t\t\tif (out.length === 0) {\n\t\t\t\t\tdelete document.CPU.playlists[index];\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t}\n}\n","export const DefaultParametersDocumentCPU = {\n\t// those values may be later modified via loading parameters\n\n\t// @public\n\t// @type boolean\n\tautoplay : false,\n\n\t// @public\n\t// @type number\n\tkeymove : 5,\n\t// @public\n\t// @type boolean\n\tplayStopOthers : true,\n\t// @public\n\t// @type number\n\t// why 500ms ? Because Chrome will trigger a touchcancel event at 800ms to show a context menu\n\talternateDelay : 500,\n\n\t// @public\n\t// @type number\n\tfastFactor : 4,\n\t// @public\n\t// @type number\n\trepeatDelay : 400,\n\t// @public\n\t// @type number\n\trepeatFactor : 100,\n\n\t// @public\n\t// @type boolean\n\tadvanceInPlaylist : true,\n\n};","import {adjacentKey, findInterface, findContainer, oncePassiveEvent, selectorAudioInComponent, warn} from './utils.js';\nimport {DefaultParametersDocumentCPU} from './default_document_cpu_parameters.js';\nimport {defaultDataset} from './default_dataset.js';\nimport {convert, timeInSeconds} from './convert.js';\nimport {trigger} from './trigger.js';\nimport {isAudiotagStreamed} from './media_element_extension.js';\n\nexport const DocumentCPU = {\n\t// global object for global API\n\n\t// public, parameters\n\t...DefaultParametersDocumentCPU,\n\n\t// public, actual active elements\n\t// @public\n\t// @type {HTMLAudioElement|null}\n\tcurrentAudiotagPlaying : null,\n\t// @type {CpuControllerElement|null}\n\t// @public\n\tglobalController : null,\n\n\t// private, indicate a play already occured in the DOM, so we can start any play\n\t// @private\n\t// @type boolean\n\thadPlayed : false,\n\n\t// private, indicate last used audiotag\n\t// @private\n\t// @type {HTMLAudioElement|null}\n\tlastUsed : null,\n\n\t// public, playlists\n\t// @public\n\t// @type Object\n\tplaylists : {},\n\n\t// public, Exposing internals needed for tests\n\t// @public\n\tconvert,\n\t// @public\n\ttrigger,\n\n\tdefaultDataset,\n\n\t// @public utilities to find shadowRoot and CPU API\n\tfindInterface,\n\tfindContainer,\n\t// @public utilities for manipulations\n\tadjacentKey,\n\n\t/**\n\t * @public\n\t * @summary Determines if audiotag is currently playing.\n\t *\n\t * @param      {HTMLAudioElement}   audiotag  The audiotag\n\t * @return     {boolean}  True if audiotag playing, False otherwise.\n\t */\n\tisAudiotagPlaying : function(audiotag) {\n\t\tlet currentAudiotagPlaying = document.CPU.currentAudiotagPlaying;\n\t\treturn (currentAudiotagPlaying) && (audiotag.isEqualNode(currentAudiotagPlaying));\n\t},\n\t/**\n\t * @public\n\t * @summary Determines if audiotag is displayed in <cpu-controller>\n\t *\n\t * @param      {HTMLAudioElement}   audiotag  The audiotag\n\t * @return     {boolean}  True if audiotag global, False otherwise.\n\t */\n\tisAudiotagGlobal : function(audiotag) {\n\t\treturn this.globalController ? \n\t\t\taudiotag.isEqualNode(this.globalController.audiotag) : \n\t\t\tthis.isAudiotagPlaying(audiotag);\n\t},\n\n\t/**\n\t * @public\n\t * @summary Position a timecode to a named audio tag\n\t *\n\t * @param      {string}   hash         The id=\"\" of an <audio> tag\n\t * @param      {string}   timecode     The timecode,\n\t * @param      {Function|null|undefined}   callback_fx  Function to be called afterwards, for ending tests\n\t */\n\tjumpIdAt : async function(hash, timecode, callback_fx=undefined) {\n\n\t\t/**\n\t\t * @param \t{Object}\tevent \ttriggered event, or mockup\n\t\t */\n\t\tfunction doNeedleMove({target:audiotag}) {\n\t\t\t// maybe we should add `timecode` in argument (timecode, event), and bind it to the event listener, moving the function upper\n\t\t\tlet secs = timeInSeconds(timecode);\n\t\t\tdocument.CPU.seekElementAt(audiotag, secs);\n\n\t\t\tlet mocked_event = {target : audiotag};\n\t\t\tif (audiotag.readyState >= audiotag.HAVE_FUTURE_DATA) {\n\t\t\t\tdoElementPlay(mocked_event);\n\t\t\t} else {\n\t\t\t\taudiotag.addEventListener('canplay', doElementPlay, oncePassiveEvent);\n\t\t\t}\n\t\t\ttrigger.update(mocked_event);\n\t\t}\n\n\t\t/**\n\t\t * @param \t{Object}\tevent \ttriggered event, or mockup\n\t\t */\n\t\tfunction doElementPlay(event) {\n\t\t\tlet tag = event.target;\n\t\t\ttrigger.play(null, tag);\n\t\t\tcallback_fx?.();\n\t\t}\n\n\t\tlet audiotag = /** @type {HTMLAudioElement} */ ( (hash !== '') ? document.getElementById(hash)  :  document.querySelector(selectorAudioInComponent) );\n\n\t\tif ((audiotag == null) || (audiotag.currentTime === undefined)) {\n\t\t\twarn(`Unknow audiotag ${hash}`);\n\t\t\treturn;\n\t\t}\n\n\t\tlet mocked_event = {target : audiotag};\n\t\tif (audiotag.readyState < HTMLMediaElement.HAVE_CURRENT_DATA) {\n\t\t\t// WHHYYYY ??????\n\t\t\taudiotag.addEventListener('loadedmetadata', doNeedleMove , oncePassiveEvent);\n\t\t\taudiotag.load();\n\t\t\ttrigger.update(mocked_event);\n\t\t} else {\n\t\t\tdoNeedleMove(mocked_event);\n\t\t}\n\t\t// No problems\n\t},\n\n\t/**\n\t * @summary Position a <audio> element to a time position\n\t * @public\n\t *\n\t * @param      {HTMLAudioElement}  audiotag  <audio> DOM element\n\t * @param      {number}  seconds   \tWanted position, in seconds\n\t *\n\t */\n\tseekElementAt : function (audiotag, seconds) {\n\t\tif ((isNaN(seconds)) || // may happens, if the audio track is not loaded/loadable\n\t\t\t(isAudiotagStreamed(audiotag))) { // never try to set a position on a streamed media\n\t\t\treturn;\n\t\t}\n\n\t\tif (audiotag.fastSeek) {\n\t\t\t// HTMLAudioElement.fastSeek() is an experimental but really fast function.\n\t\t\taudiotag.fastSeek(seconds);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\t// Browsers may not have fastSeek but can set currentTime\n\t\t\t\taudiotag.currentTime = seconds;\n\t\t\t} catch(e) {\n\t\t\t\t// except sometimes, so you must use standard media fragment\n\t\t\t\taudiotag.src = `${audiotag.currentSrc.split('#')[0]}#t=${seconds}`;\n\t\t\t}\n\t\t}\n\n\t\tlet controller = audiotag.CPU_controller();\n\t\t// it may be still constructing it, so be precautionous\n\t\tcontroller?.updateLoading?.(seconds);\n\t},\n\n\n\t/**\n>\t * @summary Return the current playing playlist array\n\t * @public\n\t *\n\t * @return     {Array}  Array with named id\n\t */\n\tcurrentPlaylist : function() {\n\n\t\tlet current_audiotag = this.globalController?.audiotag;\n\t\tif (!current_audiotag) {\n\t\t\treturn [];\n\t\t}\n\t\tfor (let playlist of Object.values(this.playlists)) {\n\t\t\tif (playlist.includes(current_audiotag.id)) {\n\t\t\t\treturn playlist;\n\t\t\t}\n\t\t}\n\t\treturn [];\n\t}\n};\n","import {CpuAudioTagName, CpuControllerTagName, selectorAcceptable, browserIsDecent, passiveEvent, querySelectorDo, warn} from './utils.js';\n\nimport {CpuAudioElement} from './cpu_audio.class.js';\nimport {CpuControllerElement} from './cpu_controller.class.js';\nimport {attach_events_audiotag} from './media_element_extension.js';\nimport {DocumentCPU} from './document_cpu.js';\nimport {insert_template} from '../tmp/insert_template.js';\nimport {trigger} from './trigger.js';\n\n/**\n * Entry point\n *\n * @return     {Promise}  No returned value\n */\nasync function main() {\n\tinsert_template();\n\n\tif (!browserIsDecent()) {\n\t\twarn(`WebComponent may NOT behave correctly on this browser. Only timecode hash links are activated.\\nSee https://github.com/dascritch/cpu-audio/ for details`);\n\t\tquerySelectorDo(selectorAcceptable, attach_events_audiotag);\n\t\tdocument.body.classList.add('cpu-audio-without-webcomponents');\n\t} else {\n\t\twindow.customElements.define(CpuAudioTagName.toLowerCase(), CpuAudioElement);\n\t\twindow.customElements.define(CpuControllerTagName.toLowerCase(), CpuControllerElement);\n\t\tdocument.body.classList.add('cpu-audio-with-webcomponents');\n\t}\n\twindow.addEventListener('hashchange', trigger.hashOrder, passiveEvent);\n\ttrigger.hashOrder({ at_start : true });\n}\n\nif ((document.CPU) || (window.customElements.get(CpuAudioTagName.toLowerCase()))) {\n\twarn('cpu-audio is called twice');\n} else {\n\t// Here comes document.CPU\n\tHTMLDocument.prototype.CPU = DocumentCPU;\n\n\tif (document.body !== null) {\n\t\tmain();\n\t} else {\n\t\t// needed in cpu-audio.js context\n\t\tdocument.addEventListener('DOMContentLoaded', main, passiveEvent);\n\t}\n}\n","// auto-generated source, done via make.sh\n\t\t\timport {__} from '../src/i18n.js';\n\t\t\t/** @summary insert styles and template into host document */\n\t\t\texport function insert_template(){\n\t\t\t\tlet style = document.createElement('style');\n\t\t\t\tstyle.innerHTML = `audio[controls]{display:block;width:100%}:root{--cpu-height:64px;--cpu-font-family:Lato,\"Open Sans\",\"Segoe UI\",Frutiger,\"Frutiger Linotype\",\"Dejavu Sans\",\"Helvetica Neue\",Arial,sans-serif;--cpu-font-size:15px;--cpu-font-small-size:calc(var(--cpu-font-size) * 0.8);--cpu-background:#555;--cpu-color:#ddd;--cpu-playing-background:#444;--cpu-playing-color:#fff;--cpu-error-background:#a00;--cpu-error-color:#ff7;--cpu-popup-background:#aaa;--cpu-popup-color:#333;--cpu-cue:#000;--cpu-timeline-limits:#f00;--cpu-elapse-width:160px;--cpu-min-padding:16px;--cpu-inner-shadow:inset 0px 5px 10px -5px black;--cpu-color-transitions:0s;--cpu-background-transitions:0s;--cpu-unfold:0s;--cpu-focus-outline:none}@media (max-width:640px){.interface,:root{--cpu-font-size:13px;--cpu-height:48px;--cpu-elapse-width:140px;--cpu-min-padding:4px}@media (max-width:480px){.interface,:root{--cpu-elapse-width:70px}}}`;\n\t\t\t\tdocument.head.appendChild(style);\n\n\t\t\t\tlet template = document.createElement('template');\n\t\t\t\ttemplate.id = 'CPU__template';\n\t\t\t\ttemplate.innerHTML = `<style>:host{all:initial;display:block;contain:content}.act-buffer,.act-play{--cpu-background:var(--cpu-playing-background);--cpu-color:var(--cpu-playing-color)}.show-error{--cpu-background:var(--cpu-error-background);--cpu-color:var(--cpu-error-color)}#interface{--cpu-timeline-height:10px;background:var(--cpu-background);color:var(--cpu-color)}#interface,*{font-family:var(--cpu-font-family);font-size:var(--cpu-font-size);font-weight:400;font-style:normal;line-height:1.2;border:none;padding:0;margin:0;text-indent:0;list-style-type:none;-webkit-user-select:none;user-select:none;transition:color var(--cpu-color-transitions),background-color var(--cpu-background-transitions),opacity var(--cpu-background-transitions)}main{display:flex;overflow:hidden;height:var(--cpu-height)}a,button{color:currentColor;border:none;text-decoration:none;cursor:pointer;-webkit-touch-callout:none}button{background:0 0}a:focus,button:focus{outline:var(--cpu-focus-outline)}svg{fill:currentColor;width:var(--cpu-height);height:var(--cpu-height)}em,i{font-style:italic}b,h5 a,strong{font-weight:700}[src='']{visibility:hidden}#pageerror{padding:0 4px;align-self:center}.siders{flex:0 0 var(--cpu-height);width:var(--cpu-height);max-height:var(--cpu-height);height:100%;text-align:center;vertical-align:middle}.act-glow #play,.act-loading #loading,.act-pause #play,.act-play #pause{display:block}.act-glow #play{animation:glow 2s infinite}@keyframes glow{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}.show-main #pagemain,.show-share #pageshare{flex:1 1 100%;display:flex;align-items:center}.act-loading #loading circle{fill:#777;opacity:1;animation:pulse 2s infinite}#loading circle:nth-child(2){animation-delay:.5s}#loading circle:nth-child(3){animation-delay:1s}@keyframes pulse{50%{opacity:0}}#poster{max-width:var(--cpu-height);min-width:var(--cpu-height);max-height:var(--cpu-height);min-height:var(--cpu-height);object-fit:contain;opacity:0}.poster-loaded #poster{opacity:1}.siders svg{vertical-align:middle;max-width:100%;max-height:100%}#titleline{display:flex;align-items:center}#about,#title{flex:1 1 auto;position:relative}#title{overflow:hidden;text-overflow:''}#title a{display:block;max-height:calc(6px + calc(2 * var(--cpu-font-size)))}#canonical.untitled{font-style:italic}#elapse{flex:0 1 var(--cpu-elapse-width);text-align:right}.mode-compact #elapse{flex:0 0 calc(var(--cpu-elapse-width) + 32px);text-align:center}#time{background-color:#000;background-repeat:no-repeat;background-size:100% 100%;width:100%;height:var(--cpu-timeline-height);display:block;position:relative}#loadingline{background:currentColor;height:var(--cpu-timeline-height);display:block;position:absolute;left:0;pointer-events:none}#loadingline:after{content:'';position:absolute;right:0;width:0;height:var(--cpu-timeline-height);display:block;outline:var(--cpu-color) 4px solid;z-index:127;opacity:0}main:focus #loadingline:after,main:hover #loadingline:after{opacity:1}aside{position:absolute;width:100%}aside a{position:absolute;display:block}aside a span{display:none}aside.chapters{height:2px}aside.chapters a{background:var(--cpu-cue);height:2px;border:1px solid var(--cpu-background)}aside.chapters a.active-cue{background:var(--cpu-color)}aside.borders{pointer-events:none;height:var(--cpu-timeline-height);z-index:4;top:calc(var(--cpu-timeline-height) + 6px)}aside.borders a{height:var(--cpu-timeline-height);background:0 0}aside.borders a:after,aside.borders a:before{pointer-events:none;content:\"\";position:absolute;width:2px;height:var(--cpu-timeline-height);border:2px solid var(--cpu-timeline-limits)}aside.borders a:before{border-right-width:0;left:0}aside.borders a:after{border-left-width:0;left:100%}aside.ticker{height:16px;top:30px}aside.ticker a.active-cue{left:0!important;right:0!important;background:inherit!important;color:inherit!important}aside.ticker a.active-cue span{display:inline-block}.act-loading #loadingline{background:repeating-linear-gradient(45deg,var(--cpu-color) 0,var(--cpu-background) 15px,var(--cpu-color) 30px);background-size:200% 200%;animation:loadingline 1s linear infinite}@keyframes loadingline{0%{background-position-y:var(--cpu-timeline-height)}}#handheld-nav{max-height:calc(6px + calc(2 * var(--cpu-font-size)));padding-bottom:8px}.show-handheld-nav #handheld-nav{display:flex}#handheld-nav *{flex:1 0 auto;height:calc(2 * var(--cpu-font-size))}.hide-actions #actions{visibility:hidden;pointer-events:none;min-width:var(--cpu-min-padding);max-width:var(--cpu-min-padding)}#pageshare{text-align:center}#pageshare a{display:flex;align-items:center;justify-content:center;height:var(--cpu-height)}#pageshare a,#pageshare div{flex:1 0;color:#fff;text-decoration:none;overflow:hidden;text-overflow:clip}#pageshare svg{vertical-align:middle;width:32px;height:32px}#twitter{background:#4db5f4}#facebook,#nativeshare{background:#5974cc}#email{background:#c00}#link{background:#77f}#popup{pointer-events:none;position:absolute;transform:translate(-25px,-19px);z-index:127;min-width:50px;font-size:11px;text-align:center;padding:2px;border-radius:4px;box-shadow:#000 2px 2px;background:var(--cpu-popup-background);color:var(--cpu-popup-color);opacity:0}#popup:before{pointer-events:none;content:\"\";position:absolute;z-index:127;left:20px;bottom:-8px;width:0;height:0;border-top:8px solid var(--cpu-popup-background);border-left:4px solid transparent;border-right:4px solid transparent}.panel{display:flex;list-style:none;flex-direction:column;padding:0 var(--cpu-min-padding);box-shadow:var(--cpu-inner-shadow)}h6{text-align:center}.cue{border-top:1px solid #000;display:flex;margin:0;padding:2px}.cue strong{flex:1 1;font-weight:400}.cue time{flex:0 0 var(--cpu-elapse-width) 0px;text-align:right}.nocuetime time{display:none}.cue time,aside a,aside.ticker *,h6{font-size:var(--cpu-font-small-size)}.mode-compact{width:calc(var(--cpu-elapse-width) + var(--cpu-height) * 2 + 32px)}.mode-button{width:var(--cpu-height)}.mode-button #about,.mode-button #actions,.mode-button #poster,.mode-button .panel,.mode-button aside,.mode-compact #actions,.mode-compact #line,.mode-compact #title,.mode-compact .panel,.mode-compact aside{width:0;display:none}#control svg,#handheld-nav,#pageshare #nativeshare,.hasnativeshare #pageshare .nonativeshare,.hide-chapters .chapters,.hide-panels .panel,.hide-panels-except-play .panel,.hide-panels-title h6,.hide-poster #poster,.hide-timeline #line,.media-streamed #line,.media-streamed #link,.mode-hidden,.no,.show-error #pagemain,.show-error #pageshare,.show-error #poster,.show-error .panel,.show-handheld-nav #titleline,.show-main #pageerror,.show-main #pageshare,.show-share #pageerror,.show-share #pagemain{display:none}.hasnativeshare #pageshare #nativeshare,.hide-panels-except-play.last-used .panel{display:flex}.mode-compact.show-main #pagemain{flex:0 0 auto}#pageshare div:hover,.active-cue,.with-preview,a:focus,a:hover,button:focus,button:hover{background:var(--cpu-focus-background,var(--cpu-color))!important;color:var(--cpu-focus-color,var(--cpu-background))!important}@media (max-width:640px){.nosmall{display:none!important}#elapse{max-height:16px}#interface{--cpu-timeline-height:8px}#handheld-nav{padding-bottom:4px}aside.ticker{top:22px}}@media (max-width:480px){.nosmaller{display:none!important}.mode-default #elapse{flex:0 1 var(--cpu-elapse-width)}.mode-default #pagemain{padding-bottom:16px}#titleline{height:32px}#line{position:absolute;left:calc(0px - var(--cpu-height));right:calc(0px - var(--cpu-height));height:16px;top:32px}aside a{pointer-events:none}aside.borders{top:-2px}aside.chapters{top:8px}#handheld-nav{padding-bottom:2px}.siders svg{height:calc(var(--cpu-height) - 16px)}}@media (max-width:320px){.mode-default #elapse,.nosmallest{display:none!important}}@media print{#interface{display:none}}@media (prefers-reduced-motion:reduce){*{animation:none!important}}</style><div id=\"interface\"class=\"no\"tabindex=\"0\"><main><img id=\"poster\"class=\"nosmall\"src=\"\"alt=\"\"loading=\"lazy\"decoding=\"async\"><section id=\"pageerror\"role=\"alert\"></section><section id=\"pagemain\"><button type=\"button\"id=\"control\"tabindex=\"0\"class=\"siders\"><svg id=\"loading\"viewBox=\"0 0 32 32\"><title>${__.loading}</title><circle cx=\"6\"cy=\"22\"r=\"4\"/><circle cx=\"16\"cy=\"22\"r=\"4\"/><circle cx=\"26\"cy=\"22\"r=\"4\"/></svg> <svg id=\"pause\"viewBox=\"0 0 32 32\"><title>${__.pause}</title><path d=\"M 6,6 12.667,6 12.667,26 6,26 z\"/><path d=\"M 19.333,6 26,6 26,26 19.333,26 z\"/></svg> <svg id=\"play\"viewBox=\"0 0 32 32\"><title>${__.play}</title><path d=\"M 6,6 6,26 26,16 z\"/></svg></button><div id=\"about\"><div id=\"titleline\"><h5 id=\"title\"><a href=\"#\"id=\"canonical\"aria-label=\"${__.canonical}\"></a></h5><a id=\"elapse\"aria-label=\"${__.moment}\"tabindex=\"-1\"><span id=\"currenttime\"></span><span id=\"totaltime\"class=\"nosmaller\"></span></a></div><div id=\"handheld-nav\"><button type=\"button\"id=\"restart\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><polygon points=\"4,0 8,0 8,16 4,16\"/><path d=\"M 16,0 8,8 16,16 z\"/><path d=\"M 24,0 16,8 24,16 z\"/></svg></button> <button type=\"button\"id=\"fastreward\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 8,0 0,8 8,16 z\"/><path d=\"M 16,0 8,8 16,16 z\"/><path d=\"M 24,0 16,8 24,16 z\"/></svg></button> <button type=\"button\"id=\"reward\"class=\"nosmallest\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 12,0 4,8 12,16 z\"/><path d=\"M 20,0 12,8 20,16 z\"/></svg></button> <button type=\"button\"id=\"foward\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 4,0 12,8 4,16 z\"/><path d=\"M 12,0 20,8 12,16 z\"/></svg></button> <button type=\"button\"id=\"fastfoward\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 0,0 8,8 0,16 z\"/><path d=\"M 8,0 16,8 8,16 z\"/><path d=\"M 16,0 24,8 16,16 z\"/></svg></button></div><div id=\"line\"><div id=\"time\"><div id=\"loadingline\"role=\"progressbar\"aria-labelledby=\"popup\"></div><time id=\"popup\">--:--</time></div></div></div><button id=\"actions\"aria-label=\"${__.more}\"title=\"${__.more}\"class=\"siders\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><circle cx=\"7\"cy=\"16\"r=\"3\"/><circle cx=\"16\"cy=\"16\"r=\"3\"/><circle cx=\"25\"cy=\"16\"r=\"3\"/></svg></button></section><section id=\"pageshare\"><a href=\"#\"target=\"social\"id=\"nativeshare\"aria-label=\"${__.share}\"title=\"${__.share}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 21 0 C 18.2 0 16 2.2 16 5 C 16 5.1 16 5.2 16.0 5.2 L 8.2 9.2 C 7.3 8.4 6.2 8 5 8 C 2.2 8 0 10.2 0 13 C 0 15.8 2.2 18 5 18 C 6.2 18 7.3 17.5 8.2 16.8 L 16 20.8 C 16.0 20.8 16 20.9 16 21 C 16 23.8 18.2 26 21 26 C 23.8 26 26 23.8 26 21 C 26 18.2 23.8 16 21 16 C 19.8 16 18.7 16.4 17.8 17.2 L 10 13.3 C 10 13.2 10 13.1 10 13 C 10 12.9 10 12.8 10 12.8 L 17.8 8.8 C 18.7 9.6 19.8 10 21 10 C 23.8 10 26 7.8 26 5 C 26 2.2 23.8 0 21 0 Z\"></path></svg> <span class=\"nosmall\">${__.share}</span> </a><a href=\"#\"target=\"social\"id=\"twitter\"class=\"nonativeshare\"aria-label=\"${__.twitter}\"title=\"${__.twitter}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 25.9,9.9 C 25.2,10.2 24.4,10.4 23.6,10.5 24.5,10 25.1,9.2 25.4,8.2 24.6,8.8 23.8,9.1 22.9,9.3 22.1,8.5 21.1,8 19.9,8 c -2.2,0 -4,1.8 -4,4 0,0 0,0.6 0.1,0.9 -3.3,-0.2 -6.3,-1.8 -8.3,-4.2 -0.3,0.6 -0.5,1.3 -0.5,2 0,1.4 0.7,2.6 1.8,3.4 -0.7,0 -1.3,-0.2 -1.8,-0.5 0,0 0,0 0,0.1 0,2 1.4,3.6 3.2,4 -0.3,0.1 -0.7,0.1 -1.1,0.1 -0.3,0 -0.5,0 -0.8,-0.1 0.5,1.6 2,2.8 3.7,2.8 -1.4,1.1 -3.1,1.7 -5,1.7 -0.3,0 -0.6,0 -1,-0.1 1.8,1.1 3.9,1.8 6.1,1.8 7.4,0 11.4,-6.1 11.4,-11.4 0,-0.2 0,-0.3 0,-0.5 0.8,-0.6 1.4,-1.3 2,-2.1 z\"/></svg> <span class=\"nosmall\">${__.twitter}</span> </a><a href=\"#\"target=\"social\"id=\"facebook\"class=\"nonativeshare\"aria-label=\"${__.facebook}\"title=\"${__.facebook}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"m 21.1,16 -3.7,0 0,10 -4.3,0 0,-10 -2.1,0 0,-3.3 2.1,0 0,-2.1 c 0,-2.9 1.2,-4.6 4.7,-4.6 l 3.9,0 0,3.5 -3.2,0 c -1,0 -1.1,0.5 -1.1,1.4 l -0,1.8 4.3,0 -0.6,3.3 0,0 z\"/></svg> <span class=\"nosmall\">${__.facebook}</span> </a><a href=\"#\"target=\"social\"id=\"email\"class=\"nonativeshare\"aria-label=\"${__.e_mail}\"title=\"${__.e_mail}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"m 8,9 15.9,0 c 0.3,0 0.6,0.1 0.8,0.2 l -8.8,9 -8.8,-9 c 0.3,-0.1 0.5,-0.2 0.8,-0.2 z m -2,12.3 0,-10.5 c 0,0 0,-0.1 0,-0.1 l 5.8,6 -5.8,5.1 c 0,-0.1 -0.1,-0.3 -0.1,-0.4 z m 17.9,1.8 -15.9,0 c -0.2,0 -0.3,0 -0.5,-0.1 l 5.7,-5 2.8,2.9 2.8,-2.9 5.7,5 c -0.2,0 -0.3,0.1 -0.5,0.1 z m 2,-1.8 c 0,0.2 0,0.3 -0.1,0.5 l -5.8,-5.1 5.8,-6 c 0,0 0,0.1 0,0.1 z\"/></svg> <span class=\"nosmall\">${__.e_mail}</span> </a><a href=\"#\"target=\"social\"download=\"\"id=\"link\"aria-label=\"${__.download}\"title=\"${__.download}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 6,6 26,6 16,22 z\"/><rect x=\"6\"y=\"22\"width=\"20\"height=\"4\"/></svg> <span class=\"nosmall\">${__.download}</span> </a><a href=\"#\"id=\"back\"aria-label=\"${__.back}\"title=\"${__.back}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 9,8 24,23 23,24 8,9 z\"/><path d=\"M 9,24 24,9 23,8 8,23 z\"/></svg> <span class=\"nosmall\">${__.back}</span></a></section></main></div>`;\n\t\t\t\tdocument.head.appendChild(template);\n\t\t\t}\n\t\t\n"],"sourceRoot":""}