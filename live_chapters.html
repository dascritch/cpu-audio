<meta charset="UTF-8" />
<script src="./dist/cpu-audio.js" async></script>

<cpu-audio 
    title="First, Choose an URL for source"
    hide="poster actions">
    <audio controls id="sound">
        <source src="./tests-assets/blank.mp3" type="audio/mpeg" />
        <track kind="chapters" src="" default />
    </audio>
    <!-- {% include no_component_message.html %} -->
</cpu-audio>

<p id="steps">
    <a href="#configure">Configure</a>
    <a href="#edit_chapters">Edit chapters</a>
    <a href="#generated_html">Generated HTML</a>
    <a href="#generated_md">Generated MarkDown</a>
    <a href="#generated_wiki">Generated DokuWiki</a>
    <a href="#generated_vtt">Generated WebVTT</a>
</p>

<!-- -->

<form id="configure" action="#edit_chapters" class="pan" >

    <fieldset>
        <label for="source_audio">
            <span>URL source audio</span>
            <input id="source_audio" name="source_audio" type="url" />
        </label>
    </fieldset>

    <fieldset>
        <label for="source_waveform">
            <span>(optional) : URL waveform image</span>
            <input id="source_waveform" name="source_waveform" type="url" />
        </label>
        <label for="source_webvtt">
            <span>(optional) : URL WebVTT track to re-edit</span>
            <input id="source_webvtt" name="source_webvtt" type="url" />
        </label>
    </fieldset>

    <fieldset class="actions">
        <button type="submit">Go to editor</button>
    </fieldset>

</form>

<!-- -->

<form id="edit_chapters" action="#generated_html" class="pan">

    <fieldset class="actions">
        <button type="button" id="add"><strong>+</strong> Add a chapter</button>
        <button type="button" id="reorder"><strong>↓</strong> Reorder chapters</button>
        <button type="submit">See result</button>
    </fieldset>

    <fieldset id="list">
        <p class="line">
            <button type="button" class="test">Test</button>
            <button type="button" class="set">Set</button>
            <input class="timecode_input" inputmode="numeric" pattern="^([0-5]?[0-9]:){0,2}[0-5]?[0-9]$" placeholder="00:00:00" size="8" />
            <input type="text" placeholder="Chapter name" />
            <button type="button" class="remove"><strong>×</strong> Remove</button>
        </p>
    </fieldset>

</form>


<div class="pan" id="generated_html">
    <fieldset id="html_out">
    </fieldset>    

    <fieldset>
        <p>Copy and paste this HTML code :</p>

        <pre id="html_source"></pre>
    </fieldset>
</div>

<div class="pan" id="generated_md">
    <fieldset>
        <p>Copy and paste this MarkDown code :</p>

        <pre id="md_source"></pre>
    </fieldset>
</div>

<div class="pan" id="generated_wiki">
    <fieldset>
        <p>Copy and paste this Wiki code :</p>

        <pre id="wiki_source"></pre>
    </fieldset>
</div>

<div class="pan" id="generated_vtt">
    <fieldset>
        <p><a id="vtt_source_download" download="chapter.vtt">Save this in a .vtt file</a> :</p>

        <pre id="vtt_source"></pre>

        <p>Then insert a &lt;track kind="chapters" default src="…"&gt; tag reffering it in your &lt;audio control&gt; tag</p>

    </fieldset>
</div>

<script>
document.location.hash = '#configure'; 

var new_chapter_line;
var sound_element, list_element, edit_source_audio_element, edit_source_waveform_element, edit_source_webvtt_element;
var sound_CPU;

var chapters = [];
var cues = [];

function set_source_audio() {
    let url = edit_source_audio_element.value;
    let is_track = sound_element.querySelector('track');
    sound_CPU = sound_element.CPU_controller().CPU;
    sound_element.src = url;
    sound_element.dataset.title = decodeURIComponent(url.replace(/(^.*\/)([^\/]+)/,'$2'));
    sound_element.dataset.waveform = edit_source_waveform_element.value;
    if ( (edit_source_webvtt_element.value !== '') && ((is_track === null) || (is_track.src !== edit_source_webvtt_element.value)) ) {
        for(let t of sound_element.textTracks) {
            t.mode = 'disabled';
        }
        if (is_track !== null) {
            is_track.remove();
        }
        sound_CPU.clear_plane('_chapters');

        let track_element = document.createElement('track');
        track_element.default = true;
        track_element.kind = 'chapters';
        track_element.mode = '';
        sound_element.appendChild(track_element);
        track_element.src = edit_source_webvtt_element.value;
        console.log(edit_source_webvtt_element.value, track_element.src, track_element);
        sound_CPU.build_chapters_loader();
    }
 }

function check_configure(event) {
    event.preventDefault();
    // test if audio is correctly loaded
    document.location.hash = '#edit_chapters';
}

function add_line() {
    let line = document.createElement('p');
    line.innerHTML = new_chapter_line;
    document.getElementById('list').appendChild(line);
}


function reorder_lines() {
    let out = [];
    let no_time_inc = 0;
    let lines = Array.from(list_element.querySelectorAll('p'));

    function interpret_line(this_line_element) {
        let time = this_line_element.querySelector('.timecode_input').value;
        if (time === '') {
            // no time code ? add a fake record for the end
            time = `99:99:${no_time_inc++}`;
        }
        secs = document.CPU.convert.TimeInSeconds(time);
        out.push({
            'secs' : secs,
            'time' : document.CPU.convert.SecondsInPaddledColonTime(secs),
            'text' : this_line_element.querySelector('[type="text"]').value,
        });
    }

    let nb = 0;
    function repopulate_line(this_line_element) {
        let line = out[nb++];
        this_line_element.querySelector('.timecode_input').value = line.time;
        this_line_element.querySelector('[type="text"]').value = line.text;
    }

    lines.forEach(interpret_line);
    out.sort(function(a, b){
        return a.secs - b.secs;
    })
    lines.forEach(repopulate_line);
}


function check_for_actions(event) {
    if (event.target.tagName === 'BUTTON') {
        let this_line_element = event.target.closest('p');
        let this_line_time_element = this_line_element.querySelector('.timecode_input');
        switch (event.target.className) {
            case 'test' : 
                document.CPU.jumpIdAt('sound', document.CPU.convert.TimeInSeconds(this_line_time_element.value));
                break ;
            case 'set' : 
                this_line_time_element.value = document.CPU.convert.SecondsInPaddledColonTime(sound_element.currentTime);
                break ;
            case 'remove' :
                this_line_element.remove();
                event.preventDefault();
                break ;
        }
    }
}


function interpret_form(event) {
    let data;
    let track = document.querySelector('audio').addTextTrack("chapters");

    function prepare_export_file(text) {
        data = new Blob([text], {type: 'text/plain'});
        let textFile = window.URL.createObjectURL(data);
        return textFile;
    }

    function interpret_line(this_line_element) {
        let time = this_line_element.querySelector('.timecode_input').value;
        if (time === '') {
            // no time code ? do not record this one
            return ;
        }
        let this_line_data = {
            code: time,
            time: Math.floor(document.CPU.convert.TimeInSeconds( time )),
            text: this_line_element.querySelector('[type="text"]').value
        };
        chapters.push(this_line_data);

        /** TODO : Reordinate by timestamp **/
        /** TODO : Add a .end **/
    }

    function build_html_source() {
        let out1=[];
        let out2=[];
        for(let line of chapters) {
           out1.push(`\n\t<li><a href="#t=${line.time}">${line.text} (${document.CPU.convert.SecondsInColonTime(line.time)})</a></li>`) 
           out2.push(`\n\t<li>${line.text} — (<a href="#t=${line.time}">${document.CPU.convert.SecondsInColonTime(line.time)}</a>)</li>`) 
        }
        return `<ol>${out1.join('')}\n</ol>\n<p>Alternate version :</p>\n<ol>${out2.join('')}\n</ol>`;
    }

    function build_md_source() {
        let out =[];
        for(let line of chapters) {
           out.push(`\n * [${line.text}](#t=${line.time})`) 
        }
        return `${out.join('')}`;
    }

    function build_wiki_source() {
        let out =[];
        for(let line of chapters) {
           out.push(`\n  - [[#t=${line.time}|${line.text}]]`) 
        }
        return `${out.join('')}`;
    }

    function build_vtt_source() {
        let out =[];
        let number = 0;
        for(let line of chapters) {
            number++;
            let start = document.CPU.convert.SecondsInPaddledColonTime(line.time);
            let end = document.CPU.convert.SecondsInPaddledColonTime( number < chapters.length ? chapters[number].time : sound_element.duration );
            out.push(`\n\nchapter-${number}\n${start}.000 --> ${end}.000\n${line.text}`) 
        }
        return `WEBVTT FILE\n${out.join('')}\n`;
    }

    function rebuild_track_and_display() {
        /* Something is missing in the W3C spec... */
        let comp_cpu = document.querySelector('cpu-audio').CPU;
        let plane = 'chapters';
        comp_cpu.add_plane(plane,'Preview chapters', {'track' : 'chapters'});
        comp_cpu.clear_plane(plane);
        let number = 0;
        for(let line of chapters) {
            number++;
            let point = `chapter-${number}`;
            comp_cpu.add_point(plane, line.time, point, {
                text : line.text,
                end :  number < chapters.length ? chapters[number].time : sound_element.duration 
            });
        }
    }

    event.preventDefault();
    reorder_lines();
    chapters = [];
    Array.from(list_element.querySelectorAll('p')).forEach(interpret_line);
    let html_source =  build_html_source();
    if (chapters.length === 0) {
        // empty list
        return;
    }
    document.getElementById('html_out').innerHTML = html_source;
    document.getElementById('html_source').innerText =  html_source;
    document.getElementById('md_source').innerText = build_md_source();
    document.getElementById('wiki_source').innerText = build_wiki_source();
    let vtt = build_vtt_source();
    document.getElementById('vtt_source').innerText = vtt;
    let vtt_virtual_file = prepare_export_file(vtt);
    document.getElementById('vtt_source_download').href = vtt_virtual_file;
    document.getElementById('vtt_source_download').download = sound_element.dataset.title.replace(/(.*)(\.(ogg|mp3|wav|flac|mp4|aac))$/,'$1') + '.vtt';
    // update tracklist in cpu-audio . To be done
    rebuild_track_and_display();
    document.location.hash = '#generated_html';
}

document.addEventListener('DOMContentLoaded', function(){
    sound_element = document.getElementById('sound');
    list_element = document.getElementById('list');
    edit_source_audio_element = document.getElementById('source_audio');
    edit_source_waveform_element = document.getElementById('source_waveform');
    edit_source_webvtt_element = document.getElementById('source_webvtt');

    /* Settings */
    edit_source_audio_element.addEventListener('change', set_source_audio);
    edit_source_waveform_element.addEventListener('change', set_source_audio);
    edit_source_webvtt_element.addEventListener('change', set_source_audio);
    document.getElementById('configure').addEventListener('submit', check_configure);

    /* Chapter editor */
    new_chapter_line = document.querySelector('p.line').innerHTML;
    document.getElementById('add').addEventListener('click', add_line);
    document.getElementById('reorder').addEventListener('click', reorder_lines);
    list_element.addEventListener('click', check_for_actions);

    document.getElementById('edit_chapters').addEventListener('submit' , interpret_form);
});
</script>

<style>
    #configure label {
        display: flex;
    }

    #configure label span {
        flex : 0 0 150px;
    }

    #configure label input {
        flex : 1 1 auto;
    }

    button {
        padding : 6px;
        border-radius: 4px;
    }

    button[type="submit"] {
        color : white;
        background : green;
    }

    #steps {
        display: flex;
        width: 100%;
    }

    #steps a {
        padding : 4px;
        border : 1px #ccc solid;
    }

    .pan {
        display :none ;
    }
    .pan:target {
        display :block ;
    }

    fieldset {
        border  :1px solid #ccc
    }

    #list p {
        display : flex;
        width : 100%;
    }

    #list p span {
        user-select: none;
        cursor: move;
        flex : 0 0 auto;
    }

    #list p input[type="text"] {
        flex : 1 0 auto;
    }

</style>
