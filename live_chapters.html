<meta charset="UTF-8" />
<script src="./dist/cpu-audio.js" async></script>

<cpu-audio 
    title="First, Choose an URL for source"
    hide="poster actions">
    <audio controls id="sound">
        <source src="./tests-assets/blank.mp3" type="audio/mpeg" />
        <track kind="chapters" src="" default />
    </audio>
    <!-- {% include no_component_message.html %} -->
</cpu-audio>


<details id="at_start" open>
    <summary>Configure editor</summary>
    <form id="configure" action="#edit_chapters" method="post">

        <fieldset>
            <label for="source_audio">
                <span>URL source audio</span>
                <input id="source_audio" name="source_audio" type="url" />
            </label>
        </fieldset>

        <fieldset>
            <label for="source_waveform">
                <span>(optional) : URL waveform image</span>
                <input id="source_waveform" name="source_waveform" type="url" />
            </label>
            <label for="source_webvtt">
                <span>(optional) : URL WebVTT track to re-edit NEED REWORK TO WORK AGAIN</span>
                <input id="source_webvtt" name="source_webvtt" type="url" />
            </label>
        </fieldset>

        <fieldset class="actions">
            <button type="submit">Go to editor</button>
        </fieldset>

        <p>Please note : this editor is difficult to use on small screens. Sorry.</p>
        <p>Think my editor is ugly ? You're right ! <a href="https://github.com/dascritch/cpu-audio/blob/master/CONTRIBUTING.md">Just help us !</a></p>

    </form>
</details>

<!-- -->

<details id="chapters">
    <summary>Chapters editor</summary>
    <form id="edit_chapters" action="#generated_html" method="post">

        <fieldset class="actions">
            <button type="button" id="add"><strong>+</strong> Add a chapter</button>
        </fieldset>

        <fieldset id="list">
            <p class="line editing" id="line-0">
                <button type="button" class="test">Test</button>
                <button type="button" class="set">Set</button>
                <input class="timecode_input" inputmode="numeric" pattern="^([0-5]?[0-9]:){0,2}[0-5]?[0-9]$" placeholder="00:00:00" size="8" />
                <input class="text_input" type="text" placeholder="Chapter name" />
                <button type="button" class="remove"><strong>×</strong>Remove this chapter</button>
            </p>
        </fieldset>

    </form>
</details>

<!-- -->
<details id="generated_html">
    <summary>Generated HTML</summary>

    <fieldset id="html_out">
    </fieldset>    

    <fieldset>
        <p>Copy and paste this HTML code :</p>

        <pre id="html_source"></pre>
    </fieldset>
</details>

<details id="generated_md">
    <summary>Generated MarkDown</summary>
    <fieldset>
        <p>Copy and paste this MarkDown code :</p>

        <pre id="md_source"></pre>
    </fieldset>
</details>

<details id="generated_wiki">
    <summary>Generated DokuWiki</summary>

    <fieldset>
        <p>Copy and paste this Wiki code :</p>

        <pre id="wiki_source"></pre>
    </fieldset>
</details>

<details id="generated_vtt">
    <summary>Generated WebVTT</summary>

    <fieldset>
        <p><a id="vtt_source_download" download="chapter.vtt">Save this in a .vtt file</a> :</p>

        <pre id="vtt_source"></pre>

        <p>Then insert a &lt;track kind="chapters" default src="…"&gt; tag reffering it in your &lt;audio control&gt; tag</p>

    </fieldset>
</details>

<script>

var new_chapter_line;
var sound_element, list_element, edit_source_audio_element, edit_source_waveform_element, edit_source_webvtt_element;
var sound_CPU;
var line_number = 1;

var chapters = [];
var cues = [];

function set_source_audio() {
    let url = edit_source_audio_element.value;
    let is_track = sound_element.querySelector('track');
    document.body.classList.add('loaded');
    
    sound_element.src = url;
    sound_element.dataset.title = decodeURIComponent(url.replace(/(^.*\/)([^\/]+)/,'$2'));
    sound_element.dataset.waveform = edit_source_waveform_element.value;
    if ( (edit_source_webvtt_element.value !== '') && ((is_track === null) || (is_track.src !== edit_source_webvtt_element.value)) ) {
        for(let t of sound_element.textTracks) {
            t.mode = 'disabled';
        }
        if (is_track !== null) {
            is_track.remove();
        }
        sound_CPU.clear_plane('_chapters');

        let track_element = document.createElement('track');
        track_element.default = true;
        track_element.kind = 'chapters';
        track_element.mode = '';
        sound_element.appendChild(track_element);
        track_element.src = edit_source_webvtt_element.value;
        sound_CPU.build_chapters_loader();
    }
}

function check_configure(event) {
    set_source_audio();
    event.preventDefault();
    // test if audio is correctly loaded
    document.querySelector('#at_start').open = false;
    document.querySelector('#chapters').open = true;
}

function currentTime_in_colon() {
    return document.CPU.convert.SecondsInPaddledColonTime(sound_element.currentTime);
}

function add_line() {
    let line = document.createElement('p');
    line.id = `line-${line_number++}`;
    line.innerHTML = new_chapter_line;
    line.classList.add('line');
    line.querySelector('.timecode_input').value = currentTime_in_colon();
    add_events_line(line);
    document.getElementById('list').appendChild(line);
    show_only_line(line.id);
    // set time to the current audio time 
}

function reorder_lines() {
    let out = [];
    let no_time_inc = 0;
    let lines = Array.from(list_element.querySelectorAll('p'));

    function interpret_line(this_line_element) {
        let time = this_line_element.querySelector('.timecode_input').value;
        if (time === '') {
            // no time code ? add a fake record for the end
            time = `99:99:${no_time_inc++}`;
        }
        secs = document.CPU.convert.TimeInSeconds(time);
        out.push({
            'secs' : secs,
            'time' : document.CPU.convert.SecondsInPaddledColonTime(secs),
            'text' : this_line_element.querySelector('[type="text"]').value,
        });
    }

    let nb = 0;
    function repopulate_line(this_line_element) {
        let line = out[nb++];
        this_line_element.querySelector('.timecode_input').value = line.time;
        this_line_element.querySelector('[type="text"]').value = line.text;
    }

    lines.forEach(interpret_line);
    out.sort(function(a, b){
        return a.secs - b.secs;
    })
    lines.forEach(repopulate_line);
}


function check_for_actions(event) {
    if (event.target.tagName === 'BUTTON') {
        let this_line_element = event.target.closest('p');
        let this_line_time_element = this_line_element.querySelector('.timecode_input');
        switch (event.target.className) {
            case 'test' : 
                document.CPU.jumpIdAt('sound', document.CPU.convert.TimeInSeconds(this_line_time_element.value));
                break ;
            case 'set' : 
                this_line_time_element.value = currentTime_in_colon();
                interpret_line(this_line_element);
                break ;
            case 'remove' :
                this_line_element.remove();
                event.preventDefault();
                break ;
        }
    }
}

function show_only_line(point_name) {
    Array.from(
        document.querySelectorAll('p.line')
        ).forEach( (element) => {
            element.classList.remove('editing');
        });
    let active_line = document.getElementById(point_name) ;
    active_line.classList.add('editing');
    active_line.querySelector('input[type="text"]').focus();
}

function focus_on_point(CPU_controler, plane_name, point_name) {
    // click on the Chapters preview panel
    show_only_line(point_name);
}

function interpret_line(this_line_element) {
    let time = this_line_element.querySelector('.timecode_input').value;
    let text = this_line_element.querySelector('[type="text"]').value;
    if ( (time === '') || (text === '') ) {
        // no time code ? no text ? do not record it yet
        return ;
    }
    let seconds = Math.floor(document.CPU.convert.TimeInSeconds( time ));
    // TODO : clean HTML , perhaps via a innerHTML ?
    let this_line_data = {
        code: time,
        time: seconds,
        text: text
    };
    chapters.push(this_line_data);

    let data = {  
            'image' : './assets/pointer.png',
            'text' : text,
            'link' : focus_on_point
    }

    if (! sound_CPU.get_point('cursors', this_line_element.id)) {
        sound_CPU.add_point('cursors', seconds, this_line_element.id, data);
    } else {
        data.start = seconds;
        sound_CPU.edit_point('cursors', this_line_element.id, data);
    }
}

function event_line(event) {
    let this_line_element = event.target;
    if (this_line_element.tagName !== 'P' ) {
        this_line_element = this_line_element.closest('p');
    }
    interpret_line(this_line_element);
    interpret_form();
}

function add_events_line(line) {
    for (let event_name of ['input', 'change', 'click']) {
        line.addEventListener(event_name, event_line);
    }
}

function interpret_form(_event) {
    let data;
    let track = document.querySelector('audio').addTextTrack("chapters");

    function prepare_export_file(text) {
        data = new Blob([text], {type: 'text/plain'});
        let textFile = window.URL.createObjectURL(data);
        return textFile;
    }

    function build_html_source() {
        let out1=[];
        let out2=[];
        for(let line of chapters) {
           out1.push(`\n\t<li><a href="#t=${line.time}">${line.text} (${document.CPU.convert.SecondsInColonTime(line.time)})</a></li>`) 
           out2.push(`\n\t<li>${line.text} — (<a href="#t=${line.time}">${document.CPU.convert.SecondsInColonTime(line.time)}</a>)</li>`) 
        }
        return `<ol>${out1.join('')}\n</ol>\n<p>Alternate version :</p>\n<ol>${out2.join('')}\n</ol>`;
    }

    function build_md_source() {
        let out =[];
        for(let line of chapters) {
           out.push(`\n * [${line.text}](#t=${line.time})`) 
        }
        return `${out.join('')}`;
    }

    function build_wiki_source() {
        let out =[];
        for(let line of chapters) {
           out.push(`\n  - [[#t=${line.time}|${line.text}]]`) 
        }
        return `${out.join('')}`;
    }

    function build_vtt_source() {
        let out =[];
        let number = 0;
        for(let line of chapters) {
            number++;
            let start = document.CPU.convert.SecondsInPaddledColonTime(line.time);
            let end = document.CPU.convert.SecondsInPaddledColonTime( number < chapters.length ? chapters[number].time : sound_element.duration );
            out.push(`\n\nchapter-${number}\n${start}.000 --> ${end}.000\n${line.text}`) 
        }
        return `WEBVTT FILE\n${out.join('')}\n`;
    }

    if (_event) {
        _event.preventDefault();
    }
    reorder_lines();
    chapters = [];
    sound_CPU.clear_plane('cursors');
    Array.from(list_element.querySelectorAll('p')).forEach(interpret_line);
    let html_source =  build_html_source();
    if (chapters.length === 0) {
        // empty list
        return;
    }
    document.getElementById('html_out').innerHTML = html_source;
    document.getElementById('html_source').innerText =  html_source;
    document.querySelector('#html_source').open = true;
    document.getElementById('md_source').innerText = build_md_source();
    document.getElementById('wiki_source').innerText = build_wiki_source();
    let vtt = build_vtt_source();
    document.getElementById('vtt_source').innerText = vtt;
    let vtt_virtual_file = prepare_export_file(vtt);
    document.getElementById('vtt_source_download').href = vtt_virtual_file;
    document.getElementById('vtt_source_download').download = sound_element.dataset.title.replace(/(.*)(\.(ogg|mp3|wav|flac|mp4|aac))$/,'$1') + '.vtt';
    document.querySelector('#vtt_source').open = true;
}

window.addEventListener('load', function(){
    document.location.hash = '#configure';

    sound_element = document.getElementById('sound');
    list_element = document.getElementById('list');
    // sometimes not fired at time, perhaps we need a CPULoaded event ?
    sound_CPU = sound_element.CPU_controller().CPU;
    edit_source_audio_element = document.getElementById('source_audio');
    edit_source_waveform_element = document.getElementById('source_waveform');
    edit_source_webvtt_element = document.getElementById('source_webvtt');

    /* Settings */
    edit_source_audio_element.addEventListener('change', set_source_audio);
    edit_source_waveform_element.addEventListener('change', set_source_audio);
    edit_source_webvtt_element.addEventListener('change', set_source_audio);
    document.querySelector('#configure').addEventListener('submit', check_configure);

    /* Chapter editor */
    add_events_line(document.querySelector('p.line'));
    new_chapter_line = document.querySelector('p.line').innerHTML;
    document.getElementById('add').addEventListener('click', add_line);
    list_element.addEventListener('click', check_for_actions);

    sound_CPU.add_plane('cursors', 'Chapters preview', {track   : 'cursors', panel   : true});
    sound_CPU.inject_css('cursors', `
        .cursors {
            left: -6px;
        }
        .cursors .with-preview {
            outline : white 4px solid;
            z-index : 10;
        }
        .cursors a {
            height: 12px;
            width: 12px;
            position: absolute;
            display : block;
        }
        .cursors img {
            height: 12px;
            width: 12px;
        }
    `);

});
</script>

<style>
    #configure label {
        display: flex;
    }

    #configure label span {
        flex : 0 0 150px;
    }

    #configure label input {
        flex : 1 1 auto;
    }

    button {
        padding : 6px;
        border-radius: 4px;
    }

    button[type="submit"] {
        color : white;
        background : green;
    }

    #steps {
        display : none;
    }

    .loaded #steps {
        display: flex;
        width: 100%;
    }

    #steps a {
        padding : 4px;
        border : 1px #ccc solid;
    }

    fieldset {
        border  :1px solid #ccc
    }

    #list p {
        display : none;
        width : 100%;
    }

    #list p.editing {
        display : flex;
    }

    #list p span {
        user-select: none;
        cursor: move;
        flex : 0 0 auto;
    }

    #list p input[type="text"] {
        flex : 1 0 auto;
    }

</style>
