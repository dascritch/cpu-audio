<script src="./dist/cpu-audio.js" async></script>
<link rel="stylesheet" href="./src/global.css" />

<div id="demo">
<cpu-audio 
    title="Au carnaval avec Samba Résille (2003)"
    poster="https://dascritch.net/vrac/.blog2/entendu/.1404-SambaResille_m.jpg"
    canonical="https://dascritch.net/post/2014/04/08/Au-Carnaval-avec-Samba-R%C3%A9sille"
    twitter="@dascritch"
    >
    <audio controls id="sound">
        <source src="https://dascritch.net/vrac/sonores/podcast/1404-SambaResille2003.mp3" type="audio/mpeg">
    </audio>
    <!-- {% include no_component_message.html %} -->
</cpu-audio>
</div>

<p id="steps">
    <a href="#configurator_html">Configure html</a>
    <a href="#generated_html">Generated html</a>
    <a href="#configurator_css">Configure css</a>
    <a href="#generated_css">Generated css</a>
</p>

<form id="configurator_html" action="#generated_html" class="pan" >

<fieldset>
    <label for="source_1">
        <span>
            <select>
                <option value="audio/mpeg">MP3</option>
                <option selected value="audio/ogg">OGG Vorbis</option>
                <option value="audio/aac">MP4 AAC</option>
                <option value="audio/webm">Webm</option>
                <option value="audio/wav">WAV</option>
            </select> sound file
        </span>
        <input id="source_1" name="source_1" type="url" value="https://dascritch.net/vrac/sonores/1404-SambaResille2003.ogg" />
    </label>
    <label for="source_2">
        <span>
            <select>
                <option selected value="audio/mpeg">MP3</option>
                <option value="audio/ogg">OGG Vorbis</option>
                <option value="audio/aac">MP4 AAC</option>
                <option value="audio/webm">Webm</option>
                <option value="audio/wav">WAV</option>
            </select> sound file
        </span>
        <input id="source_2" name="source_2" type="url" value="https://dascritch.net/vrac/sonores/podcast/1404-SambaResille2003.mp3" />
    </label>
    <label for="source_3">
        <span>
            <select>
                <option value="audio/mpeg">MP3</option>
                <option value="audio/ogg">OGG Vorbis</option>
                <option value="audio/aac">MP4 AAC</option>
                <option value="audio/webm">Webm</option>
                <option value="audio/wav">WAV</option>
            </select> sound file
        </span>
        <input id="source_3" name="source_3" type="url" />
    </label>
    <label for="source_vtt">
        <span>Chapter VTT text file</span>
        <input id="source_vtt" name="source_vtt" type="url" />
    </label>
</fieldset>

<fieldset>
    <label for="meta_mode">
        <span>Mode</span>
        <select id="meta_mode" name="meta_mode">
            <option value="default">default : player with poster, timeline, playlist and chapters list</option>
            <option value="compact">compact : play/pause button and time indication</option>
            <option value="button">a single play/pause button only,</option>
            <option value="hidden">hidden, mainly for tests purposes</option>
            <option selected value="">be implicit, as "default"</option>
        </select>
    </label>
    <label for="meta_title">
        <span>Title</span>
        <input id="meta_title" name="meta_title" type="text" value="Au carnaval avec Samba Résille (2003)" />
    </label>
    <label for="meta_poster">
        <span>Cover image url</span>
        <input id="meta_poster" name="meta_poster" type="url" value="https://dascritch.net/vrac/.blog2/entendu/.1404-SambaResille_m.jpg" />
    </label>
    <label for="meta_canonical">
        <span>Canonical page link</span>
        <input id="meta_canonical" name="meta_canonical" type="url" />
    </label>
    <label for="meta_twitter">
        <span>Twitter handle</span>
        <input id="meta_twitter" name="meta_twitter" type="string" pattern="@[\d\w_]+" />
    </label>
</fieldset>

<button type="reset">Reset values</button>
<button type="submit">See result HTML code</button>

</form>


<div class="pan" id="generated_html">
    Paste this HTML code where you want the player in your page
<pre id="code">
</pre>

<a href="#configurator_css">Go to CSS configurator</a>
</div>

<form id="configurator_css" action="#generated_css" class="pan">

<fieldset>
    <label for="css_font-family">
        <span>Font families</span>
        <input id="css_font-family" name="css_font-family" type="text" value='Lato, "Open Sans", "Segoe UI", Frutiger, "Frutiger Linotype", "Dejavu Sans", "Helvetica Neue", Arial, sans-serif' />
    </label>
    <label for="css_inner-shadow">
        <span>Shadow between horizontal panels</span>
        <input id="css_inner-shadow" name="css_inner-shadow" type="text" value="inset 0px 5px 10px -5px black" />
    </label>
</fieldset>

<fieldset>
    <label>
        <span></span><span>Colour</span><span>Background</span>
    </label>
    <label>
        <span>Colours except playing or in error</span>
        <input name="css_color" type="color" value="#dddddd" />
        <input name="css_background" type="color" value="#555555" />
    </label>
    <label for="css_error-background">
        <span>Colours when there is a media error</span>
        <input name="css_error-color" type="color" value="#ffff77" />
        <input name="css_error-background" type="color" value="#aa0000" />
    </label>
    <label for="css_playing-background">
        <span>Colours while playing</span>
        <input name="css_playing-color" type="color" value="#ffffff" />
        <input name="css_playing-background" type="color" value="#444444" />
    </label>
    <label for="css_popup-background">
        <span>Colours for the time pointer</span>
        <input name="css_popup-color" type="color" value="#aaaaaa" />
        <input name="css_popup-background" type="color" value="#333333" />
    </label>
</fieldset>

<fieldset>
    <table>
        <thead>
            <tr>
                <th>Breakpoints</th>
                <th colspan="2">wider</th>
                <th colspan="2"><input name="css_breakpoint[1]" type="text" value="640px"></th>
                <th colspan="2"><input name="css_breakpoint[2]" type="text" value="480px"></th>
                <th>smaller</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th scope="row" colspan="2">Time indicator width</th>
                <td colspan="2"><input name="css_elapse-width[0]" type="text" value="185px" /></td>
                <td colspan="2"><input name="css_elapse-width[1]" type="text" value="160px" /></td>
                <td colspan="2"><input id="css_elapse-width[2]" name="css_elapse-width[2]" type="text" value="80px" /></td>
            </tr>
            <tr>
                <th scope="row" colspan="2">Font size</th>
                <td colspan="2"><input name="css_font-size[0]" type="text" value="15px" /></td>
                <td colspan="2"><input name="css_font-size[1]" type="text" value="13px" /></td>
                <td colspan="2"><input name="css_font-size[2]" type="text" value="" /></td>
            </tr>
            <tr>
                <th scope="row" colspan="2">Height and width of the square buttons</th>
                <td colspan="2"><input name="css_height[0]" type="text" value="64px" /></td>
                <td colspan="2"><input name="css_height[1]" type="text" value="32px" /></td>
                <td colspan="2"><input name="css_height[2]" type="text" value="" /></td>
            </tr>
        </tbody>
    </table>

</fieldset>

<button type="reset">Reset values</button>
<button type="submit">See result CSS code</button>

</form>


<div class="pan" id="generated_css">
    Copy and paste this CSS code into your stylesheet. Or write it :

<pre><style id="style" contenteditable>
</style></pre>
</div>

<script>

let form_html = document.getElementById('configurator_html');
let form_css = document.getElementById('configurator_css');
let cpu_audio = document.querySelector('cpu-audio');


function configurator_html(event) {
    let cpu_audio_attributes = '';
    let audio_sources = '';
    let has_one_source = false;

    function esc(chain) {
        return chain.replace('&','&amp;').replace('"','&quot;').replace('<','&lt;').replace('>','&gt;');
    }

    function adjust_attributes_cpu_audio() {
        for (let attr of ['mode', 'title', 'poster', 'canonical', 'twitter']) {
            let value = form_html.querySelector(`[name="meta_${attr}"]`).value;
            if (value) {
                cpu_audio_attributes += ` ${attr}="${esc(value)}"`;
            }
        }
    }
    function adjust_audio_sources() {
        for (let attr of ['1', '2', '3', 'vtt']) {
            let value = form_html.querySelector(`[name="source_${attr}"]`).value;
            if (value) {
                if (attr === 'vtt') {
                    audio_sources += `\n      <track src="${esc(value)}" kind="chapters" default />`;
                } else {
                    let kind = form_html.querySelector(`[for="source_${attr}"] select`);
                    has_one_source = true;
                    audio_sources += `\n      <source src="${esc(value)}" type="${esc(kind.value)}" />`;
                }
            }
        }
    }

    adjust_attributes_cpu_audio();
    adjust_audio_sources();

    if (!has_one_source) {
        // ajouter les erreurs
    }

    let code = `<cpu-audio${cpu_audio_attributes}>
    <audio controls id="sound">${audio_sources}
    </audio>
</cpu-audio>`;
    document.getElementById('demo').innerHTML = code;
    document.getElementById('code').innerText = code;
    
    if (event) {
        event.preventDefault();
    }
}

function configurator_css(event) {

    function input_changed(element) {
        return element.value !== element.attributes.value.value;
    }

    let css = '';
    let attrs = ['font-family', 'inner-shadow'];
    for (let key of ['','error-','playing-','popup-']) {
        for (let attr of ['color','background']) {
            attrs.push(`${key}${attr}`);
        }
    }
    for (let attr of attrs) {
        let element = form_css.querySelector(`[name="css_${attr}"]`);
        let value = element.value;
        if ((input_changed(element)) && (value !== '')) {
            css += `\n\t--cpu-${attr} : ${value};`;
        }
    }

    if (css !== '') {
        css = `body {\n${css}\n}`;
    }

    for (let level of ['0', '1', '2']) {
        let rules_breakpoint = '';
        for(let attr of ['elapse-width', 'font-size', 'height']) {
            let element = form_css.querySelector(`[name="css_${attr}[${level}]"]`);
            let value = element.value;
            if ((input_changed(element)) && (value !== '')) {
                rules_breakpoint += `\n\t\t--cpu-${attr} : ${value};`;
            }
        }

        if (rules_breakpoint !== '') {
            if (level === '0') {
                css += `\n\nbody, .interface {\n${rules_breakpoint}\n}`;
            } else {
                let max_width = form_css.querySelector(`[name="css_breakpoint[${level}]"]`).value;
                if (max_width !== '') {
                    css += `\n\n@media (max-width: 640px) , @element .interface and (max-width: 640px) {\n\tbody, .interface {${rules_breakpoint}\n\t}\n} `;
                }
            }
        }
    }

    document.getElementById('style').innerHTML = css;
    if (event) {
        event.preventDefault();
    }
}

function noop(event) {
    document.location.hash = '#' + event.target.action.split('#')[1];
    event.preventDefault();
}

function reset(event) {
    let event_change = new Event('change');
    setTimeout( function(){ event.target.dispatchEvent(event_change); }, 100);
}

document.addEventListener('DOMContentLoaded', function(){
    for (let event of ['input', 'change' ]) {
        form_html.addEventListener(event, configurator_html);
        form_css.addEventListener(event, configurator_css);
    }
    form_html.addEventListener('reset', reset);
    form_css.addEventListener('reset', reset);
    form_html.addEventListener('submit', noop);
    form_css.addEventListener('submit', noop);
    configurator_html();
    document.location.hash = '#'+form_html.id; 
}, false);

</script>

<style>

    #steps {
        display: flex;
        width: 100%;
    }

    #steps a {
        padding : 4px;
        border : 1px #ccc solid;
    }

    form label {display : flex;}
    form label * {flex : 1 0 auto;}
    form label span {flex : 0 0 200px;}
    #style {display : block;}

    .pan { display :none ; }
    .pan:target { display :block ; }

    fieldset {
        border  :1px solid #ccc
    }

    table input {
        max-width : 100px;
    }

    /* need to cancel Dinky theme style for this page **/
    table {

    }

    th {
        font-family : "Helvetica Neue", Helvetica, Arial, sans-serif;
        font-size: 14px;
        padding : 4px;
        color : #232323;
        background : transparent;
    }

    td {
        padding : 0px;
        background : transparent;
    }

</style>
