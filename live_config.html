<script src="./build/cpu-audio.js" async></script>
<link rel="stylesheet" href="./src/global.css" />

<div id="demo">
<cpu-audio 
	title="Choose an URL for source and give it a title">
	<audio controls id="sound">
		<source src="./tests-assets/blank.mp3" type="audio/mpeg" />
		<track kind="chapters" src="" default />
	</audio>
	<!-- {% include no_component_message.html %} -->
</cpu-audio>
</div>

<p id="steps">
	<a href="#configurator_html">Configure html</a>
	<a href="#generated_html">Generated html</a>
	<a href="#configurator_css">Configure css</a>
	<a href="#generated_css">Generated css</a>
	<span id="spacer">&nbsp;</span>
	<button type="button" id="do_waiting">Do loading</button>
	<button type="button" id="do_glow">Do glow</button>
	<button type="button" id="do_error">Do error</button>
</p>

<form id="configurator_html" action="#generated_html" class="pan" >

<fieldset>
	<label for="source_1">
		<span>
			<select>
				<option value="audio/mpeg">MP3</option>
				<option selected value="audio/ogg">OGG Vorbis</option>
				<option value="audio/aac">MP4 AAC</option>
				<option value="audio/webm">Webm</option>
				<option value="application/dash+xml">DASH .mpd</option>
				<option value="application/x-mpegurl">HLS .m3u8</option>
				<option value="audio/wav">WAV</option>
			</select> sound file
		</span>
		<input id="source_1" name="source_1" type="url" value="https://dascritch.net/vrac/sonores/1404-SambaResille2003.ogg" placeholder="https://example.com/sound.ogg" />
	</label>
	<label for="source_2">
		<span>
			<select>
				<option selected value="audio/mpeg">MP3</option>
				<option value="audio/ogg">OGG Vorbis</option>
				<option value="audio/aac">MP4 AAC</option>
				<option value="audio/webm">Webm</option>
				<option value="application/dash+xml">DASH .mpd</option>
				<option value="application/x-mpegurl">HLS .m3u8</option>
				<option value="audio/wav">WAV</option>
			</select> sound file
		</span>
		<input id="source_2" name="source_2" type="url" value="https://dascritch.net/vrac/sonores/podcast/1404-SambaResille2003.mp3" placeholder="https://example.com/sound.mp4" />
	</label>
	<label for="source_3">
		<span>
			<select>
				<option value="audio/mpeg">MP3</option>
				<option value="audio/ogg">OGG Vorbis</option>
				<option value="audio/aac">MP4 AAC</option>
				<option value="audio/webm">Webm</option>
				<option value="application/dash+xml">DASH .mpd</option>
				<option value="application/x-mpegurl">HLS .m3u8</option>
				<option value="audio/wav">WAV</option>
			</select> sound file
		</span>
		<input id="source_3" name="source_3" type="url" placeholder="https://example.com/sound.mp3" />
	</label>
	<p>
		<span class="what"></span>
		<label for="is_stream">Is a stream</label> <input id="is_stream" name="is_stream" type="checkbox" value="stream" />, see <a href="./INSTALL.md#special-case-for-live-streamed-media"><i>Special case for live streamed media</i> in <i>INSTALL.md</i></a>. Also check how to <a href="./INSTALL.md#Indicate-a-prefered-downloadable-audio-resource">indicate a prefered downloadable audio resource.</a>
	</p>
	<label for="source_vtt">
		<span>Chapter VTT text file URL</span>
		<input id="source_vtt" name="source_vtt" type="url" placeholder="https://example.com/chapters.vtt" />
	</label>
</fieldset>

<fieldset>
	<label for="meta_mode">
		<span>Mode</span>
		<select id="meta_mode" name="meta_mode">
			<option value="default">default : player with poster, timeline, playlist and chapters list</option>
			<option value="compact">compact : play/pause button and time indication</option>
			<option value="button">button : a single play/pause button only</option>
			<option value="button,compact">button,compact : unfold at play from a button to compact</option>
			<option value="button,default">button,default : unfold at play from a button to full “default” player</option>
			<option value="compact,default">compact,default : unfold at play from “compact” to full “default” player</option>
			<option value="hidden">hidden : mainly for tests purposes</option>
			<option selected value="">be implicit, as “default”</option>
		</select>
	</label>
	<label for="meta_title">
		<span>Title</span>
		<input id="meta_title" name="meta_title" type="text" value="Au carnaval avec Samba Résille (2003)" placeholder="My wonderful sound" />
	</label>
	<label for="meta_poster">
		<span>Cover image url</span>
		<input id="meta_poster" name="meta_poster" type="url" value="https://dascritch.net/vrac/.blog2/entendu/.1404-SambaResille_m.jpg" placeholder="https://example.com/cover.jpg" />
	</label>
	<label for="meta_waveform">
		<span>Waveform image URL</span>
		<input id="meta_waveform" name="meta_waveform" type="url" placeholder="https://example.com/waveform.jpg" />
	</label>
	<label for="meta_duration">
		<span>Estimated duration</span>
		<input id="meta_duration" name="meta_duration" type="text" placeholder="100 or 1:40 or 1m40s" />
	</label>
	<label for="meta_canonical">
		<span>Canonical page link</span>
		<input id="meta_canonical" name="meta_canonical" type="url" placeholder="https://example.com/page.html" />
	</label>
	<label for="meta_download">
		<span>Downloadable audio link</span>
		<input id="meta_download" name="meta_download" type="url" placeholder="https://example.com/audio.mp3" />
	</label>
	<label for="meta_twitter">
		<span>Twitter handle</span>
		<input id="meta_twitter" name="meta_twitter" type="string" pattern="@[\d\w_]+" placeholder="@cpuprogramme" />
	</label>
	
	<p>
		<span class="what">Hide</span>
		<label for="meta_hide_0" class="inline_block"><input id="meta_hide_0" name="meta_hide[]" type="checkbox" value="poster" />Poster</label>
		<label for="meta_hide_1" class="inline_block"><input id="meta_hide_1" name="meta_hide[]" type="checkbox" value="actions" />Actions</label>
		<label for="meta_hide_2" class="inline_block"><input id="meta_hide_2" name="meta_hide[]" type="checkbox" value="chapters" />Chapters</label>
		<label for="meta_hide_3" class="inline_block"><input id="meta_hide_3" name="meta_hide[]" type="checkbox" value="timeline" />Time-line</label>
		<label for="meta_hide_4" class="inline_block"><input id="meta_hide_4" name="meta_hide[]" type="checkbox" value="panels" />Panels</label>
		<label for="meta_hide_5" class="inline_block"><input id="meta_hide_5" name="meta_hide[]" type="checkbox" value="panels-title" />Panels' title</label>
		<label for="meta_hide_6" class="inline_block"><input id="meta_hide_6" name="meta_hide[]" type="checkbox" value="panels-except-play" />Panels except playing</label>
	</p>

	<p>
		<span class="what">Glow</span>
		<label for="meta_glow" class="inline_block"><input id="meta_glow" name="meta_glow" type="checkbox" value="glow" />Glow play button before first play</label>
	</p>

</fieldset>

<button type="reset">Reset values</button>
<button type="submit">See result HTML code</button>

</form>


<div class="pan" id="generated_html">
	Paste this HTML code where you want the player in your page
<pre id="code">
</pre>

<a href="#configurator_css">Go to CSS configurator</a>
</div>

<form id="configurator_css" action="#generated_css" class="pan">

<fieldset>
	<label for="css_font-family">
		<span>Font families</span>
		<input id="css_font-family" name="css_font-family" type="text" value='Lato, "Open Sans", "Segoe UI", Frutiger, "Frutiger Linotype", "Dejavu Sans", "Helvetica Neue", Arial, sans-serif' />
	</label>
	<label for="css_inner-shadow">
		<span>Shadow between horizontal panels</span>
		<input id="css_inner-shadow" name="css_inner-shadow" type="text" value="inset 0px 5px 10px -5px black" />
	</label>
</fieldset>

<fieldset>
	<label>
		<span>&nbsp;</span><div>Colour</div><div>Background</div>
	</label>
	<label>
		<span>Colours except playing or in error</span>
		<input name="css_color" type="color" value="#dddddd" />
		<input name="css_background" type="color" value="#555555" />
	</label>
	<label for="css_error-background">
		<span>Colours when there is a media error</span>
		<input name="css_error-color" type="color" value="#ffff77" />
		<input name="css_error-background" type="color" value="#aa0000" />
	</label>
	<label for="css_playing-background">
		<span>Colours while playing</span>
		<input name="css_playing-color" type="color" value="#ffffff" />
		<input name="css_playing-background" type="color" value="#444444" />
	</label>
	<label for="css_playing-background">
		<span>Alternate focus colours</span>
		<input name="css_focus-color" type="color" value="#555555" />
		<input name="css_focus-background" type="color" value="#dddddd" />
	</label>
	<label for="css_popup-background">
		<span>Colours for the time pointer</span>
		<input name="css_popup-color" type="color" value="#aaaaaa" />
		<input name="css_popup-background" type="color" value="#333333" />
	</label>

	<label for="css_color-transitions">
		<span>Transition duration</span>
		<input name="css_color-transitions" type="range" value="0" min="0" max="2" step="0.1" />
		<input name="css_background-transitions" type="range" value="0" min="0" max="2" step="0.1" />
	</label>
</fieldset>

<fieldset>
	<table>
		<thead>
			<tr>
				<th scope="row">Breakpoints</th>
				<th colspan="2">wider</th>
				<th colspan="2"><input disabled name="css_breakpoint[1]" type="text" value="640px" /></th>
				<th colspan="2"><input disabled name="css_breakpoint[2]" type="text" value="480px" /></th>
				<th>smaller</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<th scope="row" colspan="2">Time indicator width</th>
				<td colspan="2"><input name="css_elapse-width[0]" type="text" value="185px" /></td>
				<td colspan="2"><input name="css_elapse-width[1]" type="text" value="160px" /></td>
				<td colspan="2"><input name="css_elapse-width[2]" type="text" value="80px" /></td>
			</tr>
			<tr>
				<th scope="row" colspan="2">Font size</th>
				<td colspan="2"><input name="css_font-size[0]" type="text" value="15px" /></td>
				<td colspan="2"><input name="css_font-size[1]" type="text" value="13px" /></td>
				<td colspan="2"><input name="css_font-size[2]" type="text" value="" /></td>
			</tr>
			<tr>
				<th scope="row" colspan="2">Font small size</th>
				<td colspan="2"><input name="css_font-small-size[0]" type="text" value="12px" /></td>
				<td colspan="2"><input name="css_font-small-size[1]" type="text" value="10.4px" /></td>
				<td colspan="2"><input name="css_font-small-size[2]" type="text" value="" /></td>
			</tr>
			<tr>
				<th scope="row" colspan="2">Height and width of the square buttons</th>
				<td colspan="2"><input name="css_height[0]" type="text" value="64px" /></td>
				<td colspan="2"><input name="css_height[1]" type="text" value="32px" /></td>
				<td colspan="2"><input name="css_height[2]" type="text" value="" /></td>
			</tr>
		</tbody>
	</table>

</fieldset>

<button type="reset">Reset values</button>
<button type="submit">See result CSS code</button>

</form>


<div class="pan" id="generated_css">
	Copy and paste this CSS code into your stylesheet. Or write it :

<pre><style id="style" contenteditable>
</style></pre>
</div>

<script>

let form_html = document.getElementById('configurator_html');
let form_css = document.getElementById('configurator_css');
let cpu_audio = document.querySelector('cpu-audio');


function configurator_html(event) {
	let cpu_audio_attributes = '';
	let audio_sources = '';
	let has_one_source = false;

	function esc(text) {
		let burn_after_reading = document.createElement('span');
		burn_after_reading.innerText = text;
		let out = burn_after_reading.innerHTML;
		burn_after_reading.remove();
		return out;
	}

	function adjust_attributes_cpu_audio() {
		for (let attr of ['mode', 'title', 'poster', 'waveform', 'canonical', 'duration', 'download', 'twitter']) {
			let value = form_html.querySelector(`[name="meta_${attr}"]`).value;
			if (value) {
				cpu_audio_attributes += ` ${attr}="${esc(value)}"`;
			}
		}
		values_hide = []
		for (let checkbox of Array.from(document.querySelectorAll('[name="meta_hide[]"]'))) {
			if (checkbox.checked) {
				values_hide.push(checkbox.value);
			}
		}
		if (values_hide.length > 0) {
			cpu_audio_attributes += ` hide="${values_hide.join(' ')}"`;
		}
		for (let attr of ['glow']) {
			if (form_html.querySelector(`[name="meta_${attr}"]`).checked) {
				cpu_audio_attributes += ` ${attr}`;
			}
		} 
	}
	function adjust_audio_sources() {
		for (let attr of ['1', '2', '3', 'vtt']) {
			let value = form_html.querySelector(`[name="source_${attr}"]`).value;
			if (value) {
				if (attr === 'vtt') {
					audio_sources += `\n\t\t<track src="${esc(value)}" kind="chapters" default />`;
				} else {
					let kind = form_html.querySelector(`[for="source_${attr}"] select`);
					has_one_source = true;
					audio_sources += `\n\t\t<source src="${esc(value)}" type="${esc(kind.value)}" />`;
				}
			}
		}
	}

	adjust_attributes_cpu_audio();
	adjust_audio_sources();

	if (!has_one_source) {
		// ajouter les erreurs
	}

	let audio_attribs = '';
	if (cpu_audio_attributes.includes(' duration="')) {
		audio_attribs = ' preload="none"';
	}
	if (form_html.querySelector(`[name="is_stream"]`).checked) {
		audio_attribs = ' data-streamed';
	}

	let code = `<cpu-audio${cpu_audio_attributes}>
	<audio controls id="sound"${audio_attribs}>${audio_sources}
\t</audio>
</cpu-audio>`;
	document.getElementById('demo').innerHTML = code;
	document.getElementById('code').innerText = code;
	cpu_audio = document.querySelector('cpu-audio');
	
	event?.preventDefault();
}

function configurator_css(event) {

	function input_changed(element) {
		return element.value !== element.attributes.value.value;
	}

	let css = '';
	let attrs = ['font-family', 'inner-shadow' ,'color-transitions','background-transitions' ];
	for (let key of ['','error-','playing-','focus-','popup-']) {
		for (let attr of ['color','background']) {
			attrs.push(`${key}${attr}`);
		}
	}

	for (let attr of attrs) {
		let element = form_css.querySelector(`[name="css_${attr}"]`);
		let value = element.value;
		if ((input_changed(element)) && (value !== '')) {

			// duration need unit
			if (['color-transitions', 'background-transitions'].includes(attr)) {
				value = value +'s';
			}

			css += `\n\t--cpu-${attr} : ${value};`;
		}
	}

	if (css !== '') {
		css = `body {\n${css}\n}`;
	}

	for (let level of ['0', '1', '2']) {
		let rules_breakpoint = '';
		for(let attr of ['elapse-width', 'font-size', 'font-small-size', 'height']) {
			let element = form_css.querySelector(`[name="css_${attr}[${level}]"]`);
			let value = element.value;
			if ((input_changed(element)) && (value !== '')) {
				rules_breakpoint += `\n\t\t--cpu-${attr} : ${value};`;
			}
		}

		if (rules_breakpoint !== '') {
			if (level === '0') {
				css += `\n\nbody, #interface {\n${rules_breakpoint}\n}`;
			} else {
				let max_width = form_css.querySelector(`[name="css_breakpoint[${level}]"]`).value;
				if (max_width !== '') {
					css += `\n\n@media (max-width: ${max_width}) , @element #interface and (max-width: ${max_width}) {\n\tbody, #interface {${rules_breakpoint}\n\t}\n} `;
				}
			}
		}
	}

	document.getElementById('style').innerHTML = css;
	
	event?.preventDefault();
}

function noop(event) {
	document.location.hash = '#' + event.target.action.split('#')[1];
	event.preventDefault();
}

function reset(event) {
	let event_change = new Event('change');
	setTimeout( function(){ event.target.dispatchEvent(event_change); }, 100);
}

document.addEventListener('DOMContentLoaded', function(){
	for (let event of ['input', 'change' ]) {
		form_html.addEventListener(event, configurator_html);
		form_css.addEventListener(event, configurator_css);
	}
	form_html.addEventListener('reset', reset);
	form_css.addEventListener('reset', reset);
	form_html.addEventListener('submit', noop);
	form_css.addEventListener('submit', noop);
	configurator_html();
	document.location.hash = '#'+form_html.id; 

	document.querySelector('#do_waiting').addEventListener('click', function() {
		cpu_audio.CPU.audiotag.pause();
		cpu_audio.CPU.setActContainer('loading');
	});
	document.querySelector('#do_glow').addEventListener('click', function() {
		cpu_audio.CPU.audiotag.pause();
		cpu_audio.CPU.setActContainer('glow');
	});	
	let in_error = false;
	document.querySelector('#do_error').addEventListener('click', function() {
		if (!in_error) {
			cpu_audio.CPU.showInterface('error');
			cpu_audio.CPU.shadowId('pageerror').innerText = 'This is an error message.';
			in_error = true;
		} else {
			cpu_audio.CPU.showInterface('main');
			cpu_audio.CPU.shadowId('pageerror').innerText = '';
			in_error = false;
		}
	});
}, false);

</script>

<style>

	#steps {
		display: flex;
		width: 100%;
	}

	#steps a {
		padding : 4px;
		border : 1px #ccc solid;
	}

	#spacer {
		flex : 1 1 auto;
	}


	fieldset > label, fieldset p {display : flex;}
	fieldset > label * {flex : 1 0 auto;}
	fieldset > label span, fieldset .what {flex : 0 0 200px;}
	fieldset > label div {text-align : center;}

	.inline_block { display : inline-block; }

	#style {display : block;}

	.pan { display :none ; }
	.pan:target { display :block ; }

	fieldset {
		border  :1px solid #ccc
	}

	table input {
		max-width : 100px;
	}

	/* need to cancel Dinky theme style for this page **/
	table {

	}

	th {
		font-family : "Helvetica Neue", Helvetica, Arial, sans-serif;
		font-size: 14px;
		padding : 4px;
		color : #232323;
		background : transparent;
	}

	td {
		padding : 0px;
		background : transparent;
	}

	input[type="color"] {
		min-height: 30px;
	}

</style>
