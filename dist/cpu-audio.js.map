{"version":3,"sources":["webpack://cpu-audio/./src/00_prologue.js","webpack://cpu-audio/./src/11_utils.js","webpack://cpu-audio/./src/20_convert.js","webpack://cpu-audio/./src/30_trigger.js","webpack://cpu-audio/./src/40_document_cpu.js","webpack://cpu-audio/./src/50_media_element_extension.js","webpack://cpu-audio/./src/10_i18n.js","webpack://cpu-audio/./src/45_element_cpu.js","webpack://cpu-audio/./src/70_cpu_controller.class.js","webpack://cpu-audio/./src/71_cpu_audio.class.js","webpack://cpu-audio/./src/90_main.js","webpack://cpu-audio/./tmp/insert_template.js"],"names":["CpuAudioTagName","CpuControllerTagName","selector_interface","acceptable_selector","passive_ev","once_passive_ev","onDebug","callback_fx","querySelector_apply","selector","callback","subtree","undefined","document","Array","from","querySelectorAll","forEach","is_decent_browser_for_webcomponents","window","customElements","absolutize_url","url","test_element","createElement","href","split","not_screen_context","matchMedia","matches","prevent_link_on_same_page","event","location","target","preventDefault","element_prevent_link_on_same_page","element","addEventListener","escapeHTML","text","burn_after_reading","innerText","out","innerHTML","remove","warn","message","console","units_scale","_is_only_numeric","_any_not_numeric","convert","Infinity","givenTime","seconds","test","Number","indexOf","SubunitTimeInSeconds","ColonTimeInSeconds","key","hasOwnProperty","atoms","replace","pos","length","givenSeconds","converted","inned","multiply","digits","Math","floor","colon_time","SecondsInColonTime","substr","SecondsInTime","toUpperCase","trigger","_timecode_start","_timecode_end","_last_play_error","_remove_timecode_outofborders","at","hashOrder","async","hashcode","at_start","hash","timecode","segments","autoplay","parameter","p_key","p_value","times","timecode_start","TimeInSeconds","CPU","jumpIdAt","global_controller","build_playlist","hover","container","find_container","seeked_time","getClientRects","left","offsetX","clientWidth","audiotag","duration","show_throbber_at","hide_throbber","preview_container_hover","id","closest","names","get_point_names_from_id","highlight_point","throbble","is_audiotag_playing","pause","current_audiotag_playing","isNaN","is_audiotag_streamed","controller","CPU_controller","update_loading","expected_event","recreated_event","recall_me","setAttribute","seekElementAt","play","tagName","localStorage","removeItem","currentSrc","play_once","last_used","unlock","_e","currentTime","promised","then","_","had_played","catch","error","name","CPU_connected","set_act_container","isEqualNode","attach_audiotag_to_controller","show_main","redraw_all_planes","set_mode_container","mult","altKey","ctrlKey","metaKey","shiftKey","seek_relative","hide_throbber_later","keyCode","restart","paused","keymove","keydownplay","reward","foward","fastreward","fast_factor","fastfoward","_hand_on","_press_button","clearTimeout","mini_event","setTimeout","_repeat_button","repeat_delay","repeat_factor","_release_button","cuechange","active_cue","body","classList","body_className_playing_cue","add","update","CPU_update","setItem","String","ended","dataset","playlist_name","playlist","playlists","playlist_index","next_id","next_audiotag","getElementById","observer_cpuaudio","mutationsList","querySelector","info","copy_attributes_to_media_dataset","observer_audio","build_chapters","complete_template","native_share","fetch_audiotag_dataset","navigator","share","title","canonical","_show_alternate_nav","touchstart","show_handheld_nav","alternate_delay","touchcancel","document_CPU","dynamicallyAllocatedIdPrefix","count_element","default_dataset","domain","header_element","content","attr","streamed","recall_stored_play","lasttimecode","getItem","attach_events_audiotag","on","getAttribute","preload","load","connect_audiotag","hidden","removeAttribute","push","this","do_needle_move","secs","mocked_event","readyState","HAVE_FUTURE_DATA","do_element_play","tag","HTMLMediaElement","HAVE_CURRENT_DATA","fastSeek","e","src","child","closest_cpuaudio","find_interface","parentNode","host","current_audiotag","HTMLAudioElement","prototype","api","sources_i18n","lang","toLowerCase","languages","language","browserLanguage","added","line","code","__","acceptable_hide_atttributes","preview_classname","vtt_opentag","vtt_closetag","valid_id","plane_point_names_from_id","CPU_element_api","container_interface","elements","_audiotag","mode_when_play","glow_before_play","current_playlist","_activecue","mode_was","act_was","elapse_was","_CPU_planes","event_name","detail","dispatchEvent","CustomEvent","bubbles","cancelable","composed","mode","act","hide_elements","hide_this","_attr","_preload","hide_panels_except_play_mark","previous_audiotag","_CPU_played","type","ratio","style","width","link_to","_is_at","elapse_element","total_duration","_natural","round","_forced","update_line","plane","is_audiotag_global","add_plane","track","panel","highlight","add_point","link","end","remove_plane","error_message","pageerror","show_interface","MediaError","MEDIA_ERR_ABORTED","media_err_aborted","MEDIA_ERR_NETWORK","media_err_network","MEDIA_ERR_DECODE","media_err_decode","MEDIA_ERR_SRC_NOT_SUPPORTED","media_err_src_not_supported","media_err_unknow","update_error","update_playbutton","update_time","update_time_borders","seconds_begin","seconds_end","is_seconds","sec","right","phylactere","opacity","position_time_element","dateTime","that","_hider","value","ahref","category","hash_at","remove_hash","_url","encodeURI","_twitter","twitter","substring","download_link","download","prerefed_audio_src","update_links","toggle","style_key","css","match","remove_css","appendChild","element_canonical","untitled","poster","backgroundImage","waveform","add_id_to_audiotag","plane_name","get_plane_panel","plane_track","get_plane_track","plane_panel","data","get_plane","highlight_preview","remove_highlights_points_bind","remove_highlights_points","bind","assign_events","inner","draw_plane","default_values","remove_element","point_name","points","get_point_id","vtt_taged","acceptables","not_acceptable_tag","class_name","attribute","$_attr","trim","replaceAll","Object","fromEntries","entries","sort","point_a","point_b","start","get_point","data_link","time_url","plane_point_track","get_point_track","intended_track_id","tabIndex","plane_point_panel","get_plane_nav","get_point_panel","intended_panel_id","time_element","IsoDuration","_fire_event","point","data_point","element_point_track","element_point_panel","draw_point","_st_max","refresh_plane","original_data","will_refresh","clear_plane","point_track_element","s","values","that_start","remove_point","element_id","remove_from_data","keys","nav","plane_resort","undraw_all_planes","point_data","mirror","check_plane","point_track","point_panel","_time","cue","activeCues","startTime","endTime","is","has","textTracks","chapter_track","tracks","kind","cues","prefered_language","_cuechange_event","removeEventListener","cuepoint","translate_vtt","body_class","reposition_tracks","this_build_chapters","track_element","_CPU_load_ev","find_current_playlist","playlist_element","audiotag_id","append","shadowRoot","cliquables","show_actions","_buttons","_actions","_act","timeline_element","do_events","build_chapters_loader","CpuControllerElement","HTMLElement","super","template","attachShadow","build_controller","interface_classlist","modes","hide_those","set_hide_container","CpuAudioElement","connectedCallback","MutationObserver","observe","main","head","loading","moment","more","facebook","e_mail","back","insert_template","define","get","HTMLDocument"],"mappings":"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","file":"cpu-audio.js","sourcesContent":["import './license.txt'\n\nexport const CpuAudioTagName = 'CPU-AUDIO';\nexport const CpuControllerTagName = 'CPU-CONTROLLER';\nexport const selector_interface = '#interface';\nexport const acceptable_selector = 'audio[controls]';\n\n// For addEventListener\n// @private\nexport const passive_ev = {'passive': true};\n// @private\nexport const once_passive_ev = {'passive':true, 'once':true};","import {CpuAudioTagName} from './00_prologue.js'\n\n/**\n * @summary Do litteraly nothing\n */\nfunction noop() {\n}\n\n/**\n * @summary If run in debug context, launch a function for calback\n *\n * @param      {Function|null|undefined}  callback_fx  The function to call\n */\nexport function onDebug(callback_fx) { \n\t// may be used as a noop(); \n\tif (typeof callback_fx === 'function') {\n\t\t// this is needed for testing, as we now run in async tests\n\t\tcallback_fx();\n\t}\n}\n\n/**\n * @summary Process a function on each matched CSS selector found in a DOM tree\n *\n * @param      {string}                selector             The css selector\n * @param      {Function}              callback             The callback function, its 1st parameter will be the matching DOM element\n * @param      {Element|HTMLDocument|ShadowRoot}  [subtree=undefined]  The subtree, by default the whole hosting document\n */\nexport function querySelector_apply(selector, callback, subtree=undefined) {\n\tsubtree = subtree === undefined ? document : subtree;\n\tArray.from(\n\t\tsubtree.querySelectorAll(selector)\n\t).forEach(callback);\n}\n\n/**\n * @summary Determines if the hosting browser can use webcomponents.\n *\n * @return     {boolean}  True if decent browser for webcomponents, False otherwise.\n */\nexport function is_decent_browser_for_webcomponents() {\n\treturn window.customElements !== undefined;\n}\n\n/**\n * @summary Transform a possibily relative URL to an absolute URL, including server name\n *\n * @param      {string}  url     The url\n * @return     {string}  url     Absolute url\n */\nexport function absolutize_url(url) {\n\tlet test_element = document.createElement('a');\n\ttest_element.href = (typeof url !== 'string') ? url : url.split('#')[0];\n\treturn test_element.href;\n}\n\n/**\n * @summary Checks if we are in a screen context, and not a vocal or braille interface\n *\n * @return     {boolean}  False if have a screen\n */\nexport function not_screen_context() {\n\treturn !window.matchMedia(\"screen\").matches;\n}\n\n/**\n * @summary Will prevent a link in a page if linked to the same absolute URL\n *\n * @param      {Event}  event   The event\n */\nfunction prevent_link_on_same_page(event) {\n\tif (absolutize_url(window.location.href) !== absolutize_url(event.target.href)) {\n\t\treturn ;\n\t}\n\tevent.preventDefault();\n}\n\n/**\n * @summary Cancel any action on this link if its href is in this page\n *\n * @param      {Element}  element  The <A> DOM element\n */\nexport function element_prevent_link_on_same_page(element) {\n\telement.addEventListener('click', prevent_link_on_same_page);\n}\n\n/**\n * @summary Determines if event is really an event, and not a faked one\n *\n * @param      {Event|Object}   event   The supposed event\n * @return     {boolean}  True if event, False otherwise.\n */\nfunction _isEvent(event) {\n\t// is this event really triggered via a native event ?\n\treturn event.preventDefault !== undefined;\n}\n\n/**\n * @summary Escape a text. Will truly escape HTML tags and entities. No hazardous regexes or replaces\n *\n * @param      {string}  text    The text\n * @return     {string}  HTML escaped text\n */\nexport function escapeHTML(text) {\n\tlet burn_after_reading = document.createElement('span');\n\tburn_after_reading.innerText = text;\n\tlet out = burn_after_reading.innerHTML;\n\tburn_after_reading.remove();\n\treturn out;\n}\n\n/**\n * @summary check if an element.id is cited in hash url\n *\n * @param      {string}   id      element id to check\n * @return     {boolean}  is in hash\n */\nfunction id_in_hash(id) {\n\treturn location.hash.substr(1).split('&').includes(id);\n}\n\n\n/**\n * @summary Shortcut for console info\n *\n * @param      {string}  message  The message\n */\nexport function info(message) {\n\twindow.console.info(`${CpuAudioTagName}: `,message);\n}\n\n/**\n * @summary Shortcut for console warning\n *\n * @param      {string}  message  The message\n */\nexport function warn(message) {\n\twindow.console.warn(`${CpuAudioTagName}: `,message);\n}\n\n/**\n * @summary Shortcut for console error\n *\n * @param      {string}  message  The message\n */\nexport function error(message) {\n\twindow.console.error(`${CpuAudioTagName}: `,message);\n}","const units_scale = {\n\t'd' : 86400,\n\t'h' : 3600,\n\t'm' : 60,\n\t's' : 1\n};\n\nconst _is_only_numeric = /^\\d+$/;\nconst _any_not_numeric = /\\D*/g;\n\nexport const convert = {\n\n\t// @private\n\t// How Inifity (streamed live media with unspecified duration) should be humanly expressed\n\tInfinity : '?',\n\n\t/**\n\t * @summary convert a string empty, with a number, with a colon-coded or an human-coded timecode in seconds\n\t *\n\t * @public\n\t *\n\t * @class      TimeInSeconds (name)\n\t * @param      {string}  givenTime  The given time\n\t * @return     {number}  time in seconds\n\t */\n\t'TimeInSeconds' : function(givenTime) {\n\t\tlet seconds = 0;\n\t\tif (givenTime !== '') {\n\t\t\tif (_is_only_numeric.test(givenTime)) {\n\t\t\t\tseconds = Number(givenTime);\n\t\t\t} else {\n\t\t\t\tseconds = (givenTime.indexOf(':') === -1) ? \n\t\t\t\t\tconvert.SubunitTimeInSeconds(givenTime) : \n\t\t\t\t\tconvert.ColonTimeInSeconds(givenTime) ;\n\t\t\t}\n\t\t}\n\t\treturn seconds;\n\t},\n\n\t/**\n\t * @summary convert a human-coded (`1h2m3s`) time in seconds\n\t *\n\t * @public\n\t *\n\t * @class      SubunitTimeInSeconds (name)\n\t * @param      {string}  givenTime  The given time\n\t * @return     {number}  seconds\n\t */\n\t'SubunitTimeInSeconds' : function(givenTime) {\n\t\tlet seconds = 0;\n\t\tfor(let key in units_scale) {\n\t\t\tif ( (units_scale.hasOwnProperty(key)) && (givenTime.indexOf(key) !== -1) ) {\n\t\t\t\tlet atoms = givenTime.split(key);\n\t\t\t\tseconds += Number(atoms[0].replace(_any_not_numeric,'' )) * units_scale[key];\n\t\t\t\tgivenTime = atoms[1];\n\t\t\t}\n\t\t}\n\t\treturn seconds;\n\t},\n\n\t/**\n\t * @summary    convert a colon-coded (`01:02:03`) time in seconds\n\t *\n\t * @public\n\t *\n\t * @class      ColonTimeInSeconds (name)\n\t * @param      {string}  givenTime  The given time\n\t * @return     {number}  Time in seconds\n\t */\n\t'ColonTimeInSeconds' : function(givenTime) {\n\t\tlet seconds = 0;\n\t\tlet atoms = givenTime.split(':');\n\t\tlet convert = [1, 60, 3600, 86400];\n\t\tfor (let pos = 0 ; pos < atoms.length ; pos++) {\n\t\t\tseconds += Number(atoms[pos]) * convert[((atoms.length-1) - pos)];\n\t\t}\n\t\treturn seconds;\n\t},\n\n\t/**\n\t * @summary convert a time in seconds in a human-coded time (`1h2m3s`). Zero is `0s`.\n\t * \n\t * @public\n\t *\n\t * @class      SecondsInTime (name)\n\t * @param      {number}   givenSeconds  The given seconds\n\t * @return     {string}   Converted time\n\t */\n\t'SecondsInTime' : function(givenSeconds) {\n\t\tif (givenSeconds == Infinity) {\n\t\t\treturn convert.Infinity;\n\t\t}\n\t\tlet converted = '';\n\t\tlet inned = false;\n\t\tfor(let key in units_scale) {\n\t\t\tif (units_scale.hasOwnProperty(key)) {\n\t\t\t\tlet multiply = units_scale[key];\n\t\t\t\tif ((givenSeconds >= multiply) || (inned)) {\n\t\t\t\t\tinned = true;\n\t\t\t\t\tlet digits = Math.floor(givenSeconds / multiply);\n\t\t\t\t\tconverted += digits + key;\n\t\t\t\t\tgivenSeconds -= digits * multiply;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn converted === '' ? '0s' : converted;\n\t},\n\n\t/**\n\t * @summary    convert a time in seconds in a colon-coded time (`1:02:03s`). Zero is `0:00`.\n\t *\n\t * @public\n\t *\n\t * @class      SecondsInColonTime (name)\n\t * @param      {number}          givenSeconds  The given seconds\n\t * @return     {string}  Converted time\n\t */\n\t'SecondsInColonTime' : function(givenSeconds) {\n\t\tif (givenSeconds == Infinity) {\n\t\t\treturn convert.Infinity;\n\t\t}\n\t\tlet converted = '';\n\t\tlet inned = false;\n\t\tfor (let key in units_scale) {\n\t\t\tif (units_scale.hasOwnProperty(key)) {\n\t\t\t\tlet multiply = units_scale[key];\n\t\t\t\tif ((givenSeconds >= multiply) || (inned)) {\n\t\t\t\t\tinned = true;\n\t\t\t\t\tlet digits = Math.floor(givenSeconds / multiply);\n\t\t\t\t\tconverted += (converted === '' ? '' : ':');\n\t\t\t\t\tconverted += ( ((digits<10) && (converted !== '')) ? '0' : '') + digits ;\n\t\t\t\t\tgivenSeconds -= digits * multiply;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (converted.length === 1) {\n\t\t\t// between 0 and 9 seconds\n\t\t\treturn '0:0' + converted;\n\t\t}\n\t\tif (converted.length === 2) {\n\t\t\t// between 10 and 59 seconds\n\t\t\treturn '0:' + converted;\n\t\t} \n\t\t\n\t\treturn converted === '' ? '0:00' : converted;\n\t},\n\n\t/**\n\t * @summary same as `SecondsInColonTime`, but suited for `<input type=\"time\"\n\t * />`. Zero is `00:00:00`.\n\t *\n\t * @public\n\t *\n\t * @class      SecondsInPaddledColonTime (name)\n\t * @param      {number}  givenSeconds  The given seconds\n\t * @return     {string}  Converted time\n\t */\n\t'SecondsInPaddledColonTime' : function(givenSeconds) {\n\t\tif (givenSeconds == Infinity) {\n\t\t\treturn convert.Infinity;\n\t\t}\n\t\t// principaly needed by <input type=\"time\"> whom needs a really precise HH:MM:SS format\n\t\tlet colon_time = convert.SecondsInColonTime(givenSeconds);\n\t\treturn '00:00:00'.substr(0, 8 - colon_time.length ) + colon_time; \n\t},\n\n\t/**\n\t * @summary convert a duration in an ISO 8601 string suitable for `datetime=\"\"` attribute in <time>\n\t * See spec in https://www.w3.org/TR/html51/infrastructure.html#durations\n\t * \n\t * @public\n\t *\n\t * @class      IsoDuration (name)\n\t * @param      {number}  givenSeconds  Duration, in seconds\n\t * @return     {string}  Converted duration\n\t */\n\t'IsoDuration' : function(givenSeconds) {\n\t\treturn `P${convert.SecondsInTime(givenSeconds).toUpperCase()}`;\n\t}\n}","import {passive_ev, once_passive_ev} from './00_prologue.js'\nimport {info, warn, onDebug} from './11_utils.js'\nimport {convert} from './20_convert.js'\n\nconst KEY_LEFT_ARROW = 37;\nconst KEY_RIGHT_ARROW = 39;\n\nlet NotAllowedError = 'Auto-play prevented : Browser requires a manual interaction first.';\nlet NotSupportedError = 'The browser refuses the audio source, probably due to audio format.';\n\nexport const trigger = {\n\n\t// @private\n\t_timecode_start : 0,\n\t// @private\n\t_timecode_end : false,\n\n\t// @private\n\t_last_play_error : false,\n\n\t/**\n\t * @summary If audio position out of begin/end borders, remove borders\n\t * @private\n\t *\n\t * @param      {number}  at      timecode position\n\t */\n\t_remove_timecode_outofborders : function(at) {\n\t\tif ( \n\t\t\t(at < trigger._timecode_start)\n\t\t\t|| ((trigger._timecode_end !== false) && (at > trigger._timecode_end)) ) {\n\t\t\ttrigger._timecode_start = 0;\n\t\t\ttrigger._timecode_end = false;\n\t\t}\n\t},\n\n\t/**\n\t * @summary    Interprets the hash part of the URL, when loaded or changed\n\t *\n\t * @package\n\t *\n\t * @param      {string|Object}  hashcode     Called hashcode\n\t * @param      {Function}       callback_fx  When done, call a function to end the tests (optional).\n\t */\n\thashOrder : async function(hashcode, callback_fx=undefined) {\n\t\tlet at_start = true;\n\t\tif (typeof hashcode !== 'string') {\n\t\t\tat_start = 'at_start' in hashcode;\n\t\t\thashcode = location.hash.substr(1);\n\t\t}\n\t\tlet hash = '';\n\t\tlet timecode = '';\n\t\tlet segments = hashcode.split('&');\n\t\tlet autoplay = false;\n\n\t\tfor (let parameter of segments) {\n\t\t\tif ((parameter.indexOf('=') === -1) && (hash === '')) {\n\t\t\t\t// should reference to the ID of the element\n\t\t\t\thash = parameter;\n\t\t\t} else {\n\t\t\t\t// should be a key=value parameter\n\t\t\t\tlet atoms = parameter.split('=');\n\t\t\t\tlet p_key = atoms[0];\n\t\t\t\tlet p_value = atoms[1];\n\t\t\t\tswitch (p_key) {\n\t\t\t\t\tcase 't':\n\t\t\t\t\t\t// is a time index\n\t\t\t\t\t\tp_value = (p_value !== '') ? p_value : '0';\n\t\t\t\t\t\ttimecode = p_value;\n\t\t\t\t\t\t// we make autoplay at requested timecode, simplier of the user\n\t\t\t\t\t\tautoplay = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'autoplay':\n\t\t\t\t\t\t// is a card from a social network, run now\n\t\t\t\t\t\tautoplay =  p_value === '1';\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'auto_play':\n\t\t\t\t\t\t// is a card from a social network, run now\n\t\t\t\t\t\tautoplay = p_value === 'true';\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif ((timecode === '') || ((at_start) && (!autoplay))) {\n\t\t\t// this is a normal anchor call. Go back to normal behaviour\n\t\t\tonDebug(callback_fx);\n\t\t\treturn /* false */;\n\t\t}\n\n\t\t// we may have a begin,end notation\n\t\tlet times = timecode.split(',');\n\t\tlet timecode_start = times[0];\n\t\ttrigger._timecode_start = convert.TimeInSeconds(timecode_start);\n\t\ttrigger._timecode_end = times.length > 1 ? convert.TimeInSeconds(times[1]) : false;\n\t\tif (trigger._timecode_end !== false) {\n\t\t\ttrigger._timecode_end = (trigger._timecode_end > trigger._timecode_start) ?\n\t\t\t\ttrigger._timecode_end :\n\t\t\t\tfalse;\n\t\t}\n\n\t\tawait document.CPU.jumpIdAt(hash, timecode_start, callback_fx);\n\n\t\tif (document.CPU.global_controller) {\n\t\t\tdocument.CPU.global_controller.build_playlist();\n\t\t}\n\t\t// scroll to the audio element. Should be reworked, or parametrable , see issue #60\n\t\t// window.location.hash = `#${hash}`;\n\t\treturn /* true */;\n\t},\n\n\t/**\n\t * @summary Update throbber position when hovering the timeline interface\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\thover : function(event) {\n\t\tlet target = event.target;\n\t\tlet container = document.CPU.find_container(target);\n\n\t\tlet target_rect = target.getClientRects()[0];\n\t\tlet relLeft = target_rect.left;\n\t\tlet ratio = event.offsetX / target.clientWidth;\n\t\tlet seeked_time = ratio * container.audiotag.duration;\n\n\t\tcontainer.show_throbber_at(seeked_time);\n\t},\n\n\t/**\n\t * @summary Hide the throbber when leaving the timeline interface\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tout : function(event) {\n\t\tlet container = document.CPU.find_container(event.target);\n\t\tcontainer.hide_throbber();\n\t},\n\n\t/**\n\t * @summary    Highlight the playable positions when hovering a marked link\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tpreview_container_hover : function(event) {\n\t\tlet target = event.target;\n\t\tif (!target.id) {\n\t\t\ttarget = target.closest('[id]');\n\t\t}\n\t\tif (target === null) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet container = document.CPU.find_container(target);\n\t\tlet names = container.get_point_names_from_id(target.id);\n\t\tcontainer.highlight_point(names[0], names[1]);\n\t},\n\n\n\t/**\n\t * @summary Change play position of a audio tag\n\t *\n\t * @param      {Object}  event   The event, may be mocked\n\t */\n\tthrobble : function(event) {\n\t\tlet at = 0;\n\t\tlet target = event.target;\n\t\tlet container = document.CPU.find_container(target);\n\t\tlet audiotag = container.audiotag;\n\n\t\tif (audiotag.duration === Infinity) {\n\t\t\t// CAVEAT : we may have improper duration due to a streamed media\n\t\t\ttrigger.play(event);\n\t\t\treturn ;\n\t\t}\n\n\t\tif ((document.CPU.current_audiotag_playing) && (!document.CPU.is_audiotag_playing(audiotag))) {\n\t\t\t// Chrome needs to STOP any other playing tag before seeking\n\t\t\t//  Very slow seeking on Chrome #89 \n\t\t\ttrigger.pause(undefined, document.CPU.current_audiotag_playing);\n\t\t}\n\n\t\tif ((isNaN(audiotag.duration)) && (!document.CPU.is_audiotag_streamed(audiotag))) {\n\t\t\t// Correct play from position on the timeline when metadata not preloaded #88\n\n\t\t\t// indicate we are loading something\n\t\t\tlet controller = audiotag.CPU_controller();\n\t\t\tif ((controller !== null) && (controller.update_loading)) {\n\t\t\t\tcontroller.update_loading(undefined, 100 * event.offsetX  / target.clientWidth);\n\t\t\t}\n\n\t\t\tlet expected_event = 'loadedmetadata';\n\t\t\tlet recreated_event = {\n\t\t\t\t// we are losing offsetX information\n\t\t\t\t'offsetX' : event.offsetX,\n\t\t\t\t'target'  : event.target\n\t\t\t};\n\t\t\tlet recall_me = function() { \n\t\t\t\ttrigger.throbble(recreated_event);\n\t\t\t};\n\t\t\taudiotag.addEventListener(expected_event, recall_me, once_passive_ev);\n\t\t\t// loading metadata. May not work on Apples\n\t\t\taudiotag.setAttribute('preload', 'metadata'); \n\t\t\treturn ;\n\t\t}\n\n\t\t// We know the media length, normal execution\n\t\tif (event.at !== undefined) {\n\t\t\tat = event.at;\n\t\t} else {\n\t\t\t// normal usage, via an event\n\t\t\tlet ratio = event.offsetX / target.clientWidth;\n\t\t\tat = ratio * audiotag.duration;\n\t\t}\n\t\tdocument.CPU.seekElementAt(audiotag, at);\n\t\ttrigger.play(event);\n\t},\n\n\t/**\n\t * @summary    Do pause\n\t *\n\t * @param      {Object|undefined}   event     The event, may be omitted\n\t * @param      {Element|undefined}  audiotag  The audiotag, may be omitted\n\t */\n\tpause : function(event=undefined, audiotag=undefined) {\n\t\tif (audiotag === undefined) {\n\t\t\tlet target = event.target;\n\t\t\taudiotag = (target.tagName === 'AUDIO') ? target : document.CPU.find_container(target).audiotag;\n\t\t}\n\t\taudiotag.pause();\n\t\tdocument.CPU.current_audiotag_playing = null;\n\t\twindow.localStorage.removeItem(audiotag.currentSrc);\n\t},\n\n\t/**\n\t * @summary    Change referenced playing audio, pause the previous one\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tplay_once : function(event) {\n\t\tlet audiotag = event.target;\n\n\t\tdocument.CPU.last_used = audiotag;\n\n\t\tif ( (document.CPU.only_play_one_audiotag) && (document.CPU.current_audiotag_playing) && (!document.CPU.is_audiotag_playing(audiotag)) ) {\n\t\t\ttrigger.pause(undefined, document.CPU.current_audiotag_playing);\n\n\t\t}\n\t\tdocument.CPU.current_audiotag_playing = audiotag;\n\t},\n\n\t/**\n\t * @summary    Do play an audio tag\n\t *\n\t * @param      {Object|undefined}   event     The event, may be mocked or ommitted\n\t * @param      {Element|undefined}  audiotag  The audiotag\n\t */\n\tplay : function(event=undefined, audiotag=undefined) {\n\n\t\t/*\n\t\t * @param      {Object|undefined}  _e   The event\n\t\t */\n\t\tfunction unlock(_e) {\n\t\t\ttrigger._last_play_error = false;\n\t\t\tif (document.CPU.autoplay) {\n\t\t\t\ttrigger.play(_e, audiotag);\n\t\t\t}\n\t\t}\n\n\t\tif (audiotag === undefined) {\n\t\t\taudiotag = document.CPU.find_container(event.target).audiotag;\n\t\t}\n\n\t\tif ( (event === undefined) && (trigger._last_play_error)) {\n\t\t\twarn(`play() prevented because already waiting for focus`);\n\t\t\treturn;\n\t\t}\n\n\t\ttrigger._last_play_error = false;\n\t\ttrigger._remove_timecode_outofborders(audiotag.currentTime);\n\n\t\tlet promised = audiotag.play();\n\n\t\tif (promised !== undefined) {\n\t\t\tpromised.then(\n\t\t\t\t_ => {\n\t\t\t\t\t// we have a successful play occured, we can display wait event later\n\t\t\t\t\tdocument.CPU.had_played = true;\n\t\t\t\t} \n\t\t\t).catch(\n\t\t\t\terror => {\n\t\t\t\t\ttrigger._last_play_error = true;\n\t\t\t\t\tswitch (error.name) {\n\t\t\t\t\t\tcase 'NotAllowedError':\n\t\t\t\t\t\t\twarn(NotAllowedError);\n\t\t\t\t\t\t\tdocument.addEventListener('focus', unlock, once_passive_ev);\n\t\t\t\t\t\t\tdocument.addEventListener('click', unlock, once_passive_ev);\n\n\t\t\t\t\t\t\tif (audiotag.CPU_connected) {\n\t\t\t\t\t\t\t\taudiotag.CPU_controller().CPU.set_act_container('glow');\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'NotSupportedError':\n\t\t\t\t\t\t\terror(NotSupportedError);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t\tif (document.CPU.global_controller) {\n\t\t\tlet global_controller = document.CPU.global_controller;\n\t\t\tif  (!audiotag.isEqualNode(global_controller.audiotag)) {\n\t\t\t\tglobal_controller.attach_audiotag_to_controller(audiotag);\n\t\t\t\tglobal_controller.audiotag = audiotag;\n\t\t\t\tglobal_controller.show_main();\n\t\t\t\tglobal_controller.redraw_all_planes();\n\t\t\t\tglobal_controller.set_mode_container(); \t// to switch back the display between streamed/not-str medias\n\t\t\t}\n\t\t\tglobal_controller.build_playlist();\n\t\t}\n\t},\n\n\t/**\n\t * @summary Interprets pressed key\n\t *\n\t * @param      {Object}  event   The event\n\t * @param      {number}  mult    Multiply the keypressed act, 1 by default\n\t */\n\tkey : function(event, mult=undefined) {\n\n\t\t// do not interpret key when there is a modifier, for not preventing browsers shortcurs\n\t\tif (event.altKey || event.ctrlKey || event.metaKey || event.shiftKey) {\n\t\t\treturn;\n\t\t}\n\n\t\tmult = mult === undefined ? 1 : mult;\n\t\tlet container = document.CPU.find_container(event.target);\n\t\tlet audiotag = container.audiotag;\n\n\t\t/* @param      {number}  seconds    Relative position fowards */\n\t\tfunction seek_relative(seconds) {\n\t\t\tevent.at = container.audiotag.currentTime + seconds;\n\t\t\tcontainer.show_throbber_at(event.at);\n\t\t\ttrigger.throbble(event);\n\t\t\tcontainer.hide_throbber_later();\n\t\t}\n\n\t\tswitch (event.keyCode) {\n\t\t\t// can't use enter : standard usage\n\t\t\tcase 27 : // esc\n\t\t\t\ttrigger.restart(event);\n\t\t\t\ttrigger.pause(undefined, audiotag);\n\t\t\t\tbreak;\n\t\t\tcase 32 : // space\n\t\t\t\taudiotag.paused ?\n\t\t\t\t\ttrigger.play(event, audiotag) :\n\t\t\t\t\ttrigger.pause(undefined, audiotag);\n\t\t\t\tbreak;\n\t\t\tcase 35 : // end\n\t\t\t\tdocument.CPU.seekElementAt(audiotag, audiotag.duration);\n\t\t\t\tbreak;\n\t\t\tcase 36 : // home\n\t\t\t\ttrigger.restart(event);\n\t\t\t\tbreak;\n\t\t\tcase KEY_LEFT_ARROW : // \n\t\t\t\tseek_relative(- (document.CPU.keymove * mult));\n\t\t\t\tbreak;\n\t\t\tcase KEY_RIGHT_ARROW : // \n\t\t\t\tseek_relative(+ (document.CPU.keymove * mult));\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn ;\n\t\t}\n\t\tevent.preventDefault();\n\t},\n\n\t/**\n\t * @summary Interprets keypress on the play/pause button\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tkeydownplay : function(event) {\n\t\tif (event.keyCode !== 13 ) {\n\t\t\treturn;\n\t\t} \n\t\tlet container = document.CPU.find_container(event.target);\n\t\tlet audiotag = container.audiotag;\n\n\t\taudiotag.paused ?\n\t\t\ttrigger.play(undefined, audiotag) :\n\t\t\ttrigger.pause(undefined, audiotag);\n\t\t\n\t\tevent.preventDefault();\n\t},\n\n\t/**\n\t * @summary Pressing restart button, Rewind at start the audio tag\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\trestart : function(event) {\n\t\tlet container = document.CPU.find_container(event.target);\n\t\tdocument.CPU.seekElementAt(container.audiotag, 0);\n\t},\n\t/**\n\t * @summary Pressing reward button\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\treward : function(event) {\n\t\tevent.keyCode = KEY_LEFT_ARROW;\n\t\ttrigger.key(event);\n\t},\n\t/**\n\t * @summary Pressing foward button\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tfoward : function(event) {\n\t\tevent.keyCode = KEY_RIGHT_ARROW;\n\t\ttrigger.key(event);\n\t},\n\t/**\n\t * @summary Pressing fastreward button\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tfastreward : function(event) {\n\t\tevent.keyCode = KEY_LEFT_ARROW;\n\t\ttrigger.key(event, document.CPU.fast_factor);\n\t},\n\t/**\n\t * @summary Pressing fastfoward button\n\t * Function associated, see below, DO NOT RENAME\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tfastfoward : function(event) {\n\t\tevent.keyCode = KEY_RIGHT_ARROW;\n\t\ttrigger.key(event, document.CPU.fast_factor);\n\t},\n\n\n\t_hand_on : null, // Repeated event allocation\n\t/*\n\t * @summary Start handheld navigation button press\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\t_press_button : function(event) {\n\t\tlet target = event.target.id ? event.target : event.target.closest('button');\n\t\tlet acceptable_actions = ['fastreward', 'reward', 'foward', 'fastfoward'];\n\t\tif ( (!target.id) || (acceptable_actions.indexOf(target.id) === -1)) {\n\t\t\t// we have been misleaded\n\t\t\treturn;\n\t\t}\n\t\t// execute the associated function\n\t\ttrigger[target.id](event);\n\t\tif (trigger._hand_on !== null) {\n\t\t\twindow.clearTimeout(trigger._hand_on);\n\t\t}\n\n\t\tlet mini_event = {\n\t\t\ttarget : target,\n\t\t\tpreventDefault : onDebug\n\t\t};\n\t\ttrigger._hand_on = window.setTimeout(trigger._repeat_button, document.CPU.repeat_delay, mini_event);\n\t\tevent.preventDefault();\n\t},\n\n\t/*\n\t * @summary Repeat during pressing handheld navigation button\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\t_repeat_button : function(event) {\n\t\t// \n\t\ttrigger[event.target.id](event);\n\t\t// next call : repetition are closest\n\t\ttrigger._hand_on = window.setTimeout(trigger._repeat_button, document.CPU.repeat_factor, event);\n\t},\n\n\t/*\n\t * @summary Release handheld navigation button\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\t_release_button : function(event) {\n\t\twindow.clearTimeout(trigger._hand_on);\n\t\ttrigger._hand_on = null;\n\t\tevent.preventDefault();\n\t},\n\n\t/**\n\t * @summary Refresh document body when changing chapter\n\t *\n\t * @param      {Object}   active_cue         \t\tThe TextTrack actived\n\t * @param      {HTMLAudioElement}   audiotag        Audiotag relative to TextTrack\n\t * \n\t * To not warns on classList.remove()\n\t * @suppress {checkTypes} \n\t */\n\tcuechange : function(active_cue, audiotag) {\n\t\tdocument.body.classList.remove(document.CPU.body_className_playing_cue);\n\t\t// giving a class to document.body, with a syntax according to https://www.w3.org/TR/CSS21/syndata.html#characters\n\t\tdocument.CPU.body_className_playing_cue = `cpu_playing_tag_${audiotag.id}_cue_${active_cue.id}`;\n\t\tdocument.body.classList.add(document.CPU.body_className_playing_cue);\n\t},\n\n\n\t/**\n\t * @summary Updatting time position. Pause if a end position is defined\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tupdate : function(event) {\n\t\tlet audiotag = event.target;\n\n\t\tif ((trigger._timecode_end !== false) && (audiotag.currentTime > trigger._timecode_end)) {\n\t\t\ttrigger.pause(undefined, audiotag);\n\t\t}\n\n\t\taudiotag.CPU_update();\n\t\tif ((!audiotag.paused) && (!document.CPU.is_audiotag_streamed(audiotag))) {\n\t\t\twindow.localStorage.setItem(audiotag.currentSrc, String(audiotag.currentTime));\n\t\t}\n\t},\n\n\t/**\n\t * @summary When an audiotag is ended, advance in playlist\n\t *\n\t * @param      {Object}  \t\t\tevent     The event\n\t * @param      {HTMLAudioElement}  \taudiotag  The audiotag\n\t */\n\tended : function(event, audiotag=undefined) {\n\t\t// the media element reached its end \n\t\tif (audiotag === undefined) {\n\t\t\taudiotag = event.target;\n\t\t}\n\t\tif (!('playlist' in audiotag.dataset)) {\n\t\t\treturn;\n\t\t}\n\t\t// and is in a declarated playlist\n\t\tlet playlist_name = audiotag.dataset.playlist;\n\t\tlet playlist = document.CPU.playlists[playlist_name];\n\t\tif (playlist === undefined) {\n\t\t\twarn(`Named playlist ${playlist_name} not created. WTF ?`);\n\t\t\treturn;\n\t\t}\n\t\tlet playlist_index = playlist.indexOf(audiotag.id);\n\t\tif (playlist_index === -1) {\n\t\t\twarn(`Audiotag ${audiotag.id} not in playlist ${playlist_name}. WTF ?`);\n\t\t\treturn;\n\t\t}\n\t\tif ((playlist_index +1) === playlist.length) {\n\t\t\t// end of playlist\n\t\t\treturn;\n\t\t}\n\t\tlet next_id = playlist[playlist_index+1];\n\n\t\tlet next_audiotag = /** @type {HTMLAudioElement} */ (document.getElementById(next_id));\n\t\tif (next_audiotag === null) {\n\t\t\twarn(`Audiotag #${next_id} doesn't exists. WTF ?`);\n\t\t\treturn;\n\t\t}\n\t\t// Play the next media in playlist, starting at zero\n\t\tdocument.CPU.seekElementAt(next_audiotag, 0);\n\t\ttrigger.play({}, next_audiotag);\n\t},\n\n\t/**\n\t * @summary Interprets if <cpu-audio> element is modified \n\t *\n\t * @param      {Object}  mutationsList  The mutations list\n\t */\n\tobserver_cpuaudio : function(mutationsList) {\n\t\tlet container = document.CPU.find_container(mutationsList[0].target);\n\n\t\tlet media_tagname = 'audio';\n\t\tlet audio_element = container.element.querySelector(media_tagname)\n\t\tif (audio_element === null) {\n\t\t\tinfo(`<${media_tagname}> element was removed.`)\n\t\t\tcontainer.element.remove();\n\t\t\treturn;\n\t\t}\n\t\tcontainer.element.copy_attributes_to_media_dataset();\n\t},\n\t/**\n\t * @summary Interprets if <audio> element is modified or removed\n\t * TODO : act when a child change as <source> or <track>\n\t *\n\t * @param      {Object}  mutationsList  The mutations list\n\t */\n\tobserver_audio : function(mutationsList) {\n\t\tlet container = document.CPU.find_container(mutationsList[0].target);\n\n\t\t// in case <track> changed/removed\n\t\tcontainer.build_chapters();\n\n\t\t// in case attributes changed\n\t\tcontainer.complete_template();\n\n\t\tlet global_controller = document.CPU.global_controller;\n\t\tif ((global_controller !== null) && (container.audiotag.isEqualNode(global_controller.audiotag))) {\n\t\t\tglobal_controller.build_chapters();\n\t\t\tglobal_controller.complete_template();\n\t\t}\n\t},\n\n\t/**\n\t * @summary Interprets `navigator.share` native API\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tnative_share : function(event) {\n\t\tlet dataset = document.CPU.find_container(event.target).fetch_audiotag_dataset();;\n\t\tnavigator.share({\n\t\t\t'title': dataset.title,\n\t\t\t'text': dataset.title,\n\t\t\t'url': dataset.canonical\n\t\t});\n\t\tevent.preventDefault();\n\t},\n\n\t_show_alternate_nav : null,\n\n\t/**\n\t * @summary Interprets long play on timeline for alternative fine position\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\ttouchstart : function(event) {\n\t\tlet container = document.CPU.find_container(event.target);\n\t\ttrigger._show_alternate_nav = setTimeout(container.show_handheld_nav, document.CPU.alternate_delay, container);\n\t\t\n\t},\n\n\ttouchcancel : function(event) {\n\t\tclearTimeout(trigger._show_alternate_nav);\n\t},\n\n}\n","import {passive_ev, once_passive_ev, selector_interface, CpuAudioTagName, CpuControllerTagName} from './00_prologue.js'\nimport {is_decent_browser_for_webcomponents, onDebug, warn} from './11_utils.js'\nimport {convert} from './20_convert.js'\nimport {trigger} from './30_trigger.js'\n\nexport let document_CPU = {\n\t// global object for global API\n\n\t// public, parameters\n\t// @public\n\t// @type boolean\n\t'autoplay' : false,\n\n\t// @public \n\t// @type number\n\t'keymove' : 5,\n\t// @public\n\t// @type boolean\n\t'only_play_one_audiotag' : true,\n\t// @public\n\t// @type number\n\t// why 500ms ? Because Chrome will trigger a touchcancel event at 800ms to show a context menu\n\t'alternate_delay' : 500, \n\n\t// @public\n\t// @type number\n\t'fast_factor' : 4,\n\t// @public\n\t// @type number\n\t'repeat_delay' : 400,\n\t// @public\n\t// @type number\n\t'repeat_factor' : 100,\n\n\t// public, actual active elements\n\t// @public\n\t// @type {HTMLAudioElement|null}\n\t'current_audiotag_playing' : null,\n\t// @type {CpuControllerElement|null}\n\t// @public\n\t'global_controller' : null,\n\n\t// private, actual active elements\n\t// @private\n\t// @type {string|null}\n\tbody_className_playing_cue : null,\n\n\t// private,to add attributes for unnamed <audio>\n\t// @private\n\t// @type string\n\tdynamicallyAllocatedIdPrefix : 'CPU-Audio-tag-',\n\t// @private\n\t// @type number\n\tcount_element : 0,\n\n\t// private, indicate a play already occured in the DOM, so we can start any play\n\t// @private\n\t// @type boolean\n\thad_played : false,\n\n\t// private, indicate last used audiotag\n\t// @private\n\t// @type {HTMLAudioElement|null}\n\tlast_used : null,\n\n\t// public, playlists\n\t// @public\n\t// @type Object\n\t'playlists' : {},\n\t// @public\n\t// @type boolean\n\t'advance_in_playlist' : true,\n\n\t// public, Exposing internals needed for tests\n\t// @public\n\t'convert' : convert,\n\t// @public\n\t'trigger' : trigger,\n\n\t// @package, not enough mature\n\t// NOTE : we need to refresh this when the <head> of the host page changes\n\tdefault_dataset : {\n\t\t'title' : /* @type {string|null} */ function () { \n\t\t\t\tfor(let domain of ['og', 'twitter']){\n\t\t\t\t\tlet header_element = document.querySelector(`meta[property=\"${domain}:title\"]`);\n\t\t\t\t\tif (header_element !== null) {\n\t\t\t\t\t\treturn header_element.content;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet title = document.title;\n\t\t\t\treturn title === '' ? null : title;\n\t\t\t}(), \n\t\t'poster' : /* @type {string|null} */ function () {\n\t\t\t\tfor(let attr of ['property=\"og:image\"', 'name=\"twitter:image:src\"']){\n\t\t\t\t\tlet header_element = document.querySelector(`meta[${attr}]`);\n\t\t\t\t\tif (header_element !== null) {\n\t\t\t\t\t\treturn header_element.content;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t}(),\n\t\t'canonical' : /* @type {string|null} */ function () {\n\t\t\t\tlet header_element = document.querySelector('link[rel=\"canonical\"]');\n\t\t\t\tif (header_element !== null) {\n\t\t\t\t\treturn header_element.href;\n\t\t\t\t}\n\t\t\t\treturn location.href.split('#')[0];\n\t\t\t}(),\n\t\t'twitter' : /* @type {string|null} */ function () {\n\t\t\t\tlet header_element = document.querySelector('meta[name=\"twitter:creator\"]');\n\t\t\t\tif ((header_element !== null) && (header_element.content.length>1)) {\n\t\t\t\t\treturn header_element.content;\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t}(),\n\t\t'playlist' : null,\n\t\t'waveform' : null,\n\t\t'duration' : null,\n\t\t'download' : null,\n\t},\n\n\t/**\n\t * @package\n\t * @summary Determines if audiotag source is streamed, and so unactivate reposition, position memory, length display\n\t *\n\t * @param      {HTMLAudioElement|null}  audiotag  The audiotag\n\t * @return     {boolean}            \tTrue if audiotag streamed, False otherwise.\n\t */\n\tis_audiotag_streamed : function(audiotag) {\n\t\treturn ((audiotag === null) || (audiotag.duration === Infinity) || (audiotag.dataset.streamed !== undefined));\n\t},\n\n\t/**\n\t * @package\n\t * @summary At start, will start the last playing <audio> tag at its last known position\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\trecall_stored_play : function(event) {\n\t\tlet audiotag = event.target;\n\t\tif ((document.CPU.current_audiotag_playing !== null) || (document.CPU.is_audiotag_streamed(audiotag))) {\n\t\t\treturn;\n\t\t} \n\t\tlet lasttimecode = Number(window.localStorage.getItem(audiotag.currentSrc));\n\t\t// TODO and no hashed time\n\t\tif ((lasttimecode > 0) && (!trigger._last_play_error)) {\n\t\t\tdocument.CPU.seekElementAt(audiotag, lasttimecode);\n\t\t\ttrigger.play(undefined, audiotag);\n\t\t}\n\t},\n\t/**\n\t * @package, because at start\n\t * @summary Attach events on a <audio> tag\n\t *\n\t * @param      {HTMLAudioElement}  audiotag  The audiotag\n\t */\n\tattach_events_audiotag : function(audiotag) {\n\t\taudiotag.addEventListener('loadedmetadata', document.CPU.recall_stored_play, passive_ev);\n\t\taudiotag.addEventListener('play', trigger.play_once, passive_ev);\n\t\taudiotag.addEventListener('ended', trigger.ended, passive_ev);\n\t\t// those  for PHRACKING SAFARI\n\t\taudiotag.addEventListener('ready', document.CPU.recall_stored_play, passive_ev);\n\t\taudiotag.addEventListener('canplay', document.CPU.recall_stored_play, passive_ev);\n\n\t\t// see https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Media_events for list of events\n\t\t[\n\t\t\t'ready', 'load', 'loadeddata', 'canplay', 'abort', \n\t\t\t'error', 'emptied',\n\t\t\t'play', 'playing', 'pause', 'ended',\n\t\t\t'durationchange',  'loadedmetadata', 'timeupdate', 'waiting'\n\t\t].forEach( (on) => { \n\t\t\taudiotag.addEventListener(on, trigger.update); \n\t\t});\n\n\t\tif (!is_decent_browser_for_webcomponents()) {\n\t\t\t// in case we are in legacy mode\n\t\t\t[\n\t\t\t\t'pause', 'ended'\n\t\t\t].forEach( (on) => { \n\t\t\t\taudiotag.addEventListener(on, trigger.pause); \n\t\t\t});\n\t\t}\n  \n\t\t// ask ASAP metadata about media\n\t\tif (audiotag.getAttribute('preload') === '') {\n\t\t\taudiotag.preload = 'metadata';\n\t\t\taudiotag.load();\n\t\t}\n\t},\n\n\t/**\n\t * @package, launched at start or when the webcomponent appears\n\t * @summary Connects an audiotag to CPU APIs\n\t *\n\t * @param      {HTMLAudioElement}  audiotag  The audiotag\n\t */\n\tconnect_audiotag : function(audiotag) {\n\t\tif (audiotag.CPU_connected) {\n\t\t\treturn;\n\t\t}\n\t\taudiotag.CPU_connected = true;\n\n\t\tdocument.CPU.attach_events_audiotag(audiotag);\n\n\t\t// hide native controls\n\t\taudiotag.hidden = true;\n\t\t// PHRACK SAFARI\n\t\taudiotag.removeAttribute('controls');\n\n\t\t// playlist \n\t\tif (typeof(audiotag.dataset.playlist) === 'string') {\n\t\t\tlet playlist_name = audiotag.dataset.playlist;\n\t\t\tif (!(playlist_name in document.CPU.playlists)) {\n\t\t\t\tdocument.CPU.playlists[playlist_name] = []\n\t\t\t}\n\t\t\tdocument.CPU.playlists[playlist_name].push(audiotag.id)\n\t\t}\n\t},\n\n\t/**\n\t * @public\n\t * @summary Determines if audiotag is currently playing.\n\t *\n\t * @param      {HTMLAudioElement}   audiotag  The audiotag\n\t * @return     {boolean}  True if audiotag playing, False otherwise.\n\t */\n\t'is_audiotag_playing' : function(audiotag) {\n\t\treturn (document.CPU.current_audiotag_playing) && (audiotag.isEqualNode(document.CPU.current_audiotag_playing))\n\t},\n\t/**\n\t * @public\n\t * @summary Determines if audiotag is displayed in <cpu-controller>\n\t *\n\t * @param      {HTMLAudioElement}   audiotag  The audiotag\n\t * @return     {boolean}  True if audiotag global, False otherwise.\n\t */\n\t'is_audiotag_global' : function(audiotag) {\n\t\treturn this.global_controller === null ? this.is_audiotag_playing(audiotag) : audiotag.isEqualNode(this.global_controller.audiotag)\n\t},\n\n\t/**\n\t * @public\n\t * @summary Position a timecode to a named audio tag\n\t *\n\t * @param      {string}   hash         The id=\"\" of an <audio> tag\n\t * @param      {string}   timecode     The timecode, \n\t * @param      {Function|null|undefined}   callback_fx  Function to be called afterwards, for ending tests\n\t */\n\t'jumpIdAt' : async function(hash, timecode, callback_fx=undefined) {\n\n\t\t/**\n\t\t * @param \t{Object}\tevent \ttriggered event, or mockup\n\t\t */\n\t\tfunction do_needle_move(event) {\n\t\t\tlet audiotag = event.target;\n\t\t\tlet secs = convert.TimeInSeconds(timecode);\n\t\t\tdocument.CPU.seekElementAt(audiotag, secs);\n\n\t\t\tlet mocked_event = {'target' : audiotag};\n\t\t\tif (audiotag.readyState >= audiotag.HAVE_FUTURE_DATA) {\n\t\t\t\tdo_element_play(mocked_event);\n\t\t\t} else {\n\t\t\t\taudiotag.addEventListener('canplay', do_element_play, once_passive_ev);\n\t\t\t}\n\t\t\ttrigger.update(mocked_event);\n\t\t}\n\n\t\t/**\n\t\t * @param \t{Object}\tevent \ttriggered event, or mockup\n\t\t */\n\t\tfunction do_element_play(event) {\n\t\t\tlet tag = event.target;\n\t\t\ttrigger.play(undefined, tag);\n\t\t\tonDebug(callback_fx);\n\t\t}\n\n\t\tlet selector_fallback = 'cpu-audio audio'; // should be 'audio[controls]' but PHRACK APPLE !\n\n\t\tlet audiotag = /** @type {HTMLAudioElement} */ ( (hash !== '') ? document.getElementById(hash)  :  document.querySelector(selector_fallback) );\n\n\t\tif ((audiotag === undefined) || (audiotag === null) || (audiotag.currentTime === undefined)) {\n\t\t\twarn(`Unknow audiotag ${hash}`);\n\t\t\treturn;\n\t\t}\n\n\t\tlet mocked_event = {'target' : audiotag};\n\t\tif (audiotag.readyState < HTMLMediaElement.HAVE_CURRENT_DATA) {  /*  WHHYYYY ?????? */\n\t\t\taudiotag.addEventListener('loadedmetadata', do_needle_move , once_passive_ev);\n\t\t\taudiotag.load();\n\t\t\ttrigger.update(mocked_event);\n\t\t} else {\n\t\t\tdo_needle_move(mocked_event);\n\t\t}\n\t\t// No problems\n\t\treturn;\n\t},\n\t/**\n\t * @public\n\t *\n\t * @summary Position a <audio> element to a time position\n\t *\n\t * @param      {HTMLAudioElement}  audiotag  <audio> DOM element\n\t * @param      {number}  seconds   \tWanted position, in seconds\n\t *\n\t * HTMLAudioElement.fastSeek() is an experimental but really fast function. Google Closure doesn't like it in ADVANCED mode\n\t * @suppress {missingProperties} */\n\t'seekElementAt' : function (audiotag, seconds) {\n\t\tif ((isNaN(seconds)) || // may happens, if the audio track is not loaded/loadable\n\t\t\t(document.CPU.is_audiotag_streamed(audiotag))) { // never try to set a position on a streamed media\n\t\t\treturn;\n\t\t}\n\n\t\tif (audiotag.fastSeek !== undefined) {\n\t\t\taudiotag.fastSeek(seconds);\n\t\t} else {\n\t\t\ttry {\n\t\t\t\t// Browsers may not have fastSeek but can set currentTime\n\t\t\t\taudiotag.currentTime = seconds;\n\t\t\t} catch(e) {\n\t\t\t\t// exept sometimes, so you must use standard media fragment\n\t\t\t\taudiotag.src = `${audiotag.currentSrc.split('#')[0]}#t=${seconds}`;\n\t\t\t}\n\t\t}\n\n\t\tlet controller = audiotag.CPU_controller();\n\t\tif ((controller !== null) && (controller.update_loading)) {\n\t\t\t// it may be still constructing it\n\t\t\tcontroller.update_loading(seconds);\n\t\t}\n\t},\n\n\t/**\n\t * @public\n\t * \n\t * @summary For any ShadowDOM element, will returns its parent interface container\n\t *\n\t * @param      {Element}  child   The ShadowDOM child\n\t * @return     {Element}  The #interface element\n\t */\n\t'find_interface' : function(child) {\n\t\treturn child.closest(selector_interface);\n\t},\n\t/**\n\t * @public\n\t *\n\t * @summary For any <audio> tag or its child tag or shadowDOM element, returns the element `CPU` API\n\t *\n\t * @param      {Element}  child   The child\n\t * @return     {CPU_element_api}       Element.CPU\n\t */\n\t'find_container' : function(child) {\n\t\tif ((child.tagName === CpuAudioTagName) \n\t\t\t|| ( child.tagName === CpuControllerTagName)) {\n\t\t\treturn child.CPU\n\t\t}\n\n\t\tlet closest_cpuaudio = child.closest(CpuAudioTagName);\n\t\tif (closest_cpuaudio) {\n\t\t\treturn closest_cpuaudio.CPU\n\t\t}\n\n\t\tlet _interface = document.CPU.find_interface(child);\n\t\treturn _interface.parentNode.host.CPU;\n\t},\n\t/**\n\t * @public\n\t *\n\t * @summary Return the current playing playlist array\n\t *\n\t * @return     {Array}  Array with named id\n\t */\n\t'find_current_playlist' : function() {\n\t\tif (this.global_controller === null)\n\t\t\treturn [];\n\t\tlet current_audiotag = this.global_controller.audiotag;\n\t\tif (current_audiotag === null) {\n\t\t\treturn [];\n\t\t}\n\t\tfor (let playlist_name in this.playlists) {\n\t\t\tif (this.playlists[playlist_name].indexOf(current_audiotag.id) >= 0) {\n\t\t\t\treturn this.playlists[playlist_name];\n\t\t\t}\n\t\t}\n\t\treturn [];\n\t}\n\n}","import {CpuAudioTagName, CpuControllerTagName} from './00_prologue.js'\n\n// Extension on media element\nHTMLAudioElement.prototype.CPU_connected = false;\n\n/**\n * @summary Return the parent <cpu-audio> DOM element\n *\n * @class      CPU_controller (name)\n * @return     {Element}  <cpu-audio> DOM element\n */\nHTMLAudioElement.prototype.CPU_controller = function() {\n\treturn this.closest(CpuAudioTagName);\n}\n\n/**\n * @summary Trigger display updates in the interface\n *\n * @class      CPU_update (name)\n */\nHTMLAudioElement.prototype.CPU_update = function() {\n\tlet controller = this.CPU_controller();\n\tif (controller) {\n\t\tlet api = controller.CPU;\n\t\tif ((api) && (api.update)) {\n\t\t\t// i don't like try catch\n\t\t\tapi.update();\n\t\t}\n\t}\n\tif (document.CPU.global_controller !== null) {\n\t\tdocument.CPU.global_controller.update();\n\t}\n}","const sources_i18n = {\n\t'fr' : {\n\t\t'loading' : 'Chargement en cours',\n\t\t'pause' : 'Pause',\n\t\t'play' : 'Lecture',\n\t\t'canonical' : 'Lien vers la fiche du sonore',\n\t\t'moment' : 'Lien vers ce moment',\n\n\t\t'untitled' : '(sans titre)',\n\t\t'cover' : 'pochette',\n\t\t'more' : 'Actions',\n\t\t'share' : 'Partager',\n\t\t'twitter' : 'Partager sur Twitter',\n\t\t'facebook' : 'Partager sur Facebook',\n\t\t'e_mail' : 'Partager par e-mail',\n\t\t'download' : 'Tlcharger',\n\t\t'back' : 'Annuler',\n\n\t\t'chapters' : 'Chapitres',\n\t\t'playlist' : 'Playlist',\n\n\t\t'media_err_aborted' : 'Vous avez annul la lecture.',\n\t\t'media_err_network' : 'Une erreur rseau a caus l\\'interruption du tlchargement.',\n\t\t'media_err_decode' : 'La lecture du sonore a t annule suite  des problmes de corruption ou de fonctionnalits non supports par votre navigateur.',\n\t\t'media_err_src_not_supported' : 'Le sonore n\\'a pu tre charg, soit  cause de sourcis sur le serveur, le rseau ou parce que le format n\\'est pas support.',\n\t\t'media_err_unknow' : 'Erreur due  une raison inconnue.'\n\t},\n\t'en' : {\n\t\t'loading' : 'Loading',\n\t\t'pause' : 'Pause',\n\t\t'play' : 'Play',\n\t\t'canonical' : 'Link to the sound\\'s page',\n\t\t'moment' : 'Link to this time',\n\n\t\t'untitled' : '(untitled)',\n\t\t'cover' : 'cover',\n\t\t'more' : 'Actions',\n\t\t'share' : 'Share',\n\t\t'twitter' : 'Share on Twitter',\n\t\t'facebook' : 'Share on Facebook',\n\t\t'e_mail' : 'Share via e-mail',\n\t\t'download' : 'Download',\n\t\t'back' : 'Back',\n\n\t\t'chapters' : 'Chapters',\n\t\t'playlist' : 'Playlist',\n\n\t\t'media_err_aborted' : 'You have aborted the play.',\n\t\t'media_err_network' : 'A network error broke the download.',\n\t\t'media_err_decode' : 'Play was canceled due to file corruption or a not supported function in your browser.',\n\t\t'media_err_src_not_supported' : 'The media cannot be downloaded due to server problems, network problems or unsupported by your browser.',\n\t\t'media_err_unknow' : 'Error of unknown cause.'\n\t},\n};\n\n\n// First, we'll try to guess the hosting page language\nlet prefered_language = document.querySelector('html').lang;\n\nif ((!prefered_language.length) || (!(prefered_language.toLowerCase() in sources_i18n))) {\n\n\t// Inexisting ?\n\tprefered_language = 'en';\n\t// We will use english in last resort\n\n\t// trying to find the browser preferences\n\tlet languages = window.navigator.languages;\n\tlanguages = (languages !== undefined) ? \n\t\t\t\tlanguages : \n\t\t\t\t[(navigator.language || navigator.browserLanguage)];\n\tlet added = false;\n\tfor (let line of languages) {\n\t\tif (line.split) {\n\t\t\t// we will only look (yes, this is bad) at the first level xx of any locale xx-YY code\n\t\t\tlet code = line.split('-')[0];\n\t\t\tif ( (!added) && (code in sources_i18n)) {\n\t\t\t\t// we still don't have a locale selected and this one is in our register, we can use it\n\t\t\t\tprefered_language = code;\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport const __ = sources_i18n[prefered_language];","import {passive_ev, once_passive_ev, selector_interface, CpuAudioTagName, CpuControllerTagName} from './00_prologue.js'\nimport {__} from './10_i18n.js'\nimport {absolutize_url, escapeHTML, querySelector_apply, error} from './11_utils.js'\nimport {convert} from './20_convert.js'\nimport {trigger} from './30_trigger.js'\n\n\n// Acceptables attributes values for hide=\"\" parameter on webcomponent\nconst acceptable_hide_atttributes = ['poster', 'actions', 'timeline', 'chapters', 'panels', 'panels-title', 'panels-except-play'];\n\n// should be put in CPU-controller ?\nlet preview_classname = 'with-preview';\n\n\n// regexes used for WebVTT tag validation\nconst vtt_opentag = /<(\\w+)(\\.[^>]+)?( [^>]+)?>/gi;\nconst vtt_closetag = /<\\/(\\w+)( [^>]*)?>/gi;\n\n// Regex used to validate planes, points and injected css names\nconst valid_id = /^[a-zA-Z0-9\\-_]+$/;\n\n// Regex for extracting plane and point names from an id\nconst plane_point_names_from_id = /^([a-zA-Z0-9\\-_]+_)([a-zA-Z0-9\\-_]+)((_.*_)([a-zA-Z0-9\\-_]+))?()$/;\n\n\nexport class CPU_element_api {\n\t/**\n\t *\n\t * @summary Constructs the object.\n\t * @public\n\t *\n\t * @param      {Element}  element              The DOMelement\n\t * @param      {Element}  container_interface  The container interface\n\t */\n\tconstructor(element, container_interface) {\n\t\t// I hate this style. I rather prefer the object notation\n\t\tthis.element = element;\n\t\tthis.elements = {};\n\t\t/** \\@ type {HTMLAudioElement} NOT WORKING AT ALL due to Google Closure bugs */\n\t\tthis.audiotag = element._audiotag;\n\t\tthis.container = container_interface;\n\t\tthis.mode_when_play = null;\n\t\tthis.glow_before_play = false;\n\t\tthis.current_playlist = [];\n\t\tthis._activecue = null;\n\t\tthis.mode_was = null;\n\t\tthis.act_was = null;\n\t\tthis.elapse_was = null;\n\n\t\tif ( (this.audiotag) && (! this.audiotag._CPU_planes)) {\n\t\t\tthis.audiotag._CPU_planes = {}\n\t\t}\n\t}\n\n\t/**\n\t * @summary    create and fire custom events for the global document.\n\t *\n\t * We async-ed it, to avoid ultra-probable performances issues\n\t *\n\t * @param      {string}            event_name  The event name, will be prefixed with CPU_\n\t * @param      {Object|undefined}  detail      Specific public informations about the event\n\t * @return     {Promise}           { description_of_the_return_value }\n\t */\n\tasync _fire_event(event_name, detail = undefined) {\n\t\t/**\n\t\t * Events to be created :\n\t\t *  - plane CRUD\n\t\t *  - point CRUD\n\t\t */\n\t\tthis.element.dispatchEvent(\n\t\t\tnew CustomEvent(`CPU_${event_name}`, {\n\t\t\t\ttarget : this.element,\n\t\t\t\tbubbles : true,\n\t\t\t\tcancelable : false,\n\t\t\t\tcomposed : false,\n\t\t\t\tdetail : detail\n\t\t\t})\n\t\t);\n\t}\n\n\t/**\n\t * @summary Used for `mode=\"\"` attribute. \n\t * @public\n\t *\n\t * @param      {string|null}  mode    Accepted are only in `/\\w+/` format, 'default' by default\n\t */\n\tset_mode_container(mode=null) {\n\t\tmode = mode !== null ? mode : 'default';\n\t\tif (this.mode_was === mode) {\n\t\t\treturn;\n\t\t}\n\t\tthis.container.classList.remove(`mode-${this.mode_was}`);\n\t\tthis.container.classList.add(`mode-${mode}`);\n\t\tthis.mode_was = mode;\n\t}\n\t/**\n\t * @summary Change the presentation style reflecting the media tag status\n\t * @public\n\t *\n\t * @param      {string}  act     can be 'loading', 'pause', 'glow' or 'play'\n\t */\n\tset_act_container(act) {\n\t\tif (this.act_was === act) {\n\t\t\treturn;\n\t\t}\n\t\tif ( (! document.CPU.had_played) && (act === 'loading') ){\n\t\t\treturn;\n\t\t}\n\t\tthis.container.classList.remove(\n\t\t\t'act-loading',\n\t\t\t'act-pause',\n\t\t\t'act-play',\n\t\t\t'act-glow'\n\t\t\t);\n\t\tthis.container.classList.add(`act-${act}`);\n\t\tthis.act_was = act;\n\t}\n\t/**\n\t * @public\n\t * @summary Hide some blocks in the interface\n\t * used for `hide=\"\"` attribute\n\t *\n\t * @param      {Array<string>}  hide_elements  Array of strings, may contains\n\t *                                        'actions' or 'chapters'\n\t * For an unknown reason, Google Closure estimates that hide_elements can be null ??? \n\t */\n\tset_hide_container(hide_elements) {\n\t\tfor (let hide_this of acceptable_hide_atttributes) {\n\t\t\tthis.container.classList.remove(`hide-${hide_this}`)\n\t\t}\n\n\t\tfor (let hide_this of /** @type {!null} */ (hide_elements)) {\n\t\t\thide_this = hide_this.toLowerCase();\n\t\t\tif (acceptable_hide_atttributes.indexOf(hide_this)>-1) {\n\t\t\t\tthis.container.classList.add(`hide-${hide_this}`)\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @public\n\t * @summary update play/pause button according to media status\n\t */\n\tupdate_playbutton() {\n\t\tlet audiotag = this.audiotag;\n\t\tlet _attr = audiotag.getAttribute('preload');\n\t\tlet _preload = _attr ? (_attr.toLowerCase() !== 'none') : true ;\n\t\tif ( \n\t\t\t\t(audiotag.readyState < HTMLMediaElement.HAVE_CURRENT_DATA ) && \n\t\t\t\t((_preload) || (audiotag._CPU_played)) \n\t\t\t) {\n\t\t\tthis.set_act_container('loading');\n\t\t\treturn;\n\t\t}\n\n\t\tif (! ((trigger._last_play_error) && (audiotag.paused))) {\n\t\t\tthis.set_act_container(audiotag.paused ? 'pause' : 'play');\n\t\t}\n\t\tlet hide_panels_except_play_mark = 'last-used';\n\n\t\tlet previous_audiotag = document.CPU.last_used;\n\n\t\tif (!audiotag.paused) {\n\t\t\taudiotag._CPU_played = true;\n\t\t\tthis.container.classList.add(hide_panels_except_play_mark);\n\t\t\tif (this.mode_when_play !== null) {\n\t\t\t\tthis.set_mode_container(this.mode_when_play);\n\t\t\t\tthis.mode_when_play = null;\n\t\t\t}\n\t\t} else {\n\t\t\tif (! this.audiotag.isEqualNode(previous_audiotag)) {\n\t\t\t\tthis.container.classList.remove(hide_panels_except_play_mark);\n\t\t\t}\n\t\t\t// TODO check option\n\t\t\tif ((!audiotag._CPU_played) && (this.glow_before_play)) {\n\t\t\t\tthis.set_act_container('glow');\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Update time-line length\n\t * @private\n\t *\n\t * @param      {string}  type     line to impact. Can be 'elapsed' or 'loading'\n\t * @param      {number}  seconds  The seconds\n\t * @param      {number|undefined=}  ratio    ratio position in case time position are still unknown\n\t */\n\tupdate_line(type, seconds, ratio=undefined) {\n\t\tlet duration = this.audiotag.duration;\n\t\tif (ratio === undefined) {\n\t\t\tratio = duration === 0 ? 0 : (100*seconds / duration);\n\t\t}\n\t\tthis.elements[`${type}line`].style.width = `${ratio}%`;\n\t}\n\n\t/**\n\t * @summary update current timecode and related links\n\t * @private\n\t */\n\tupdate_time() {\n\t\tlet audiotag = this.audiotag;\n\t\tlet timecode = document.CPU.is_audiotag_streamed(audiotag) ? 0 : Math.floor(audiotag.currentTime);\n\t\tlet canonical = audiotag.dataset.canonical;\n\t\tcanonical = canonical === undefined ? '' : canonical;\n\t\tlet link_to = absolutize_url(canonical)+'#';\n\t\tlet _is_at = canonical.indexOf('#'); \n\n\t\tlink_to += ((_is_at === -1) ? audiotag.id : canonical.substr(_is_at+1) )+'&t='+timecode;\n\n\t\tlet elapse_element = this.elements['elapse'];\n\t\telapse_element.href = link_to;\n\n\t\tlet total_duration = '';\n\t\tlet _natural = Math.round(audiotag.duration);\n\t\tif (!isNaN(_natural)){\n\t\t\ttotal_duration = convert.SecondsInColonTime(_natural);\n\t\t} else {\n\t\t\tlet _forced = Math.round(audiotag.dataset.duration);\n\t\t\tif (_forced > 0) {\n\t\t\t\ttotal_duration = convert.SecondsInColonTime(_forced);\n\t\t\t}\n\t\t}\n\t\t \n\t\tlet colon_time = convert.SecondsInColonTime(audiotag.currentTime);\n\t\tlet innerHTML = document.CPU.is_audiotag_streamed(audiotag) ? colon_time :`${colon_time}<span class=\"nosmaller\">\\u00a0/\\u00a0${total_duration}</span>`;\n\n\t\tif (this.elapse_was !== innerHTML) {\n\t\t\telapse_element.innerHTML = innerHTML;\n\t\t\tthis.elapse_was = innerHTML;\n\t\t}\n\n\t\tthis.update_line('loading', audiotag.currentTime);\n\t}\n\n\t/**\n\t * @summary Shows indicators for the limits of the playing position\n\t * @private\n\t */\n\tupdate_time_borders() {\n\t\tlet audiotag = this.audiotag;\n\t\tlet plane = '_borders';\n\t\tif ((!document.CPU.is_audiotag_global(audiotag)) || (trigger._timecode_end === false)) {\n\t\t\tthis.remove_plane(plane);\n\t\t\treturn;\n\t\t}\n\t\tthis.add_plane(plane,'',{ \n\t\t\ttrack   : 'borders',\n\t\t\tpanel   : false,\n\t\t\thighlight : false\n\t\t});\n\t\tthis.add_point(plane, trigger._timecode_start, 'play', {\n\t\t\tlink    : false,\n\t\t\tend     : trigger._timecode_end\n\t\t});\n\n\t}\n\t/**\n\t * @summary Show that the media is loading\n\t * @private\n\t *\n\t * @param      {number}  seconds  The seconds\n\t */\n\tupdate_loading(seconds, ratio) {\n\t\tthis.update_line('loading', seconds, ratio);\n\t\tthis.set_act_container('loading');\n\t}\n\n\t/**\n\t * @summary Show the current media error status\n\t *\n\t * @private\n\t *\n\t * @return     {boolean}  True if an error is displayed\n\t */\n\tupdate_error() {\n\t\t// NOTE : this is not working, even on non supported media type\n\t\t// Chrome logs an error  Uncaught (in promise) DOMException: Failed to load because no supported source was found. \n\t\t// but don't update message\n\t\tlet audiotag = this.audiotag;\n\t\tif (audiotag === null) {\n\t\t\treturn true;\n\t\t}\n\t\tlet error = audiotag.error;\n\t\tif (error !== null) {\n\t\t\tlet error_message;\n\t\t\tlet pageerror = this.elements['pageerror'];\n\t\t\tthis.show_interface('error');\n\t\t\tswitch (error.code) {\n\t\t\t\tcase MediaError.MEDIA_ERR_ABORTED:\n\t\t\t\t\terror_message = __.media_err_aborted;\n\t\t\t\t\tbreak;\n\t\t\t\tcase MediaError.MEDIA_ERR_NETWORK:\n\t\t\t\t\terror_message = __.media_err_network;\n\t\t\t\t\tbreak;\n\t\t\t\tcase MediaError.MEDIA_ERR_DECODE:\n\t\t\t\t\terror_message = __.media_err_decode;\n\t\t\t\t\tbreak;\n\t\t\t\tcase MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:\n\t\t\t\t\terror_message = __.media_err_src_not_supported;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\terror_message = __.media_err_unknow;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tpageerror.innerText = error_message;\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\n\thas_ticker_planes() {\n\t\treturn this.elements['about'].querySelector('.ticker')\n\t}\n\n\t @summary Displays a text in the infoline or hide it\n\t * @public\n\t *\n\t * @param      {string} \t\t\ttext     \tHTML text to display. Or hide it if empty\n\t * @param      {boolean} \t\t\tpriority   \tIf set to true, will hide any track, else, will not be displayed if there is a track\n\n\tflash(text='') {\n\t\t// I still need to complete https://codepen.io/GoOz/pen/QWGGgOo\n\t\tlet indication_classname = 'flash';\n\t\tlet indicate_on = this.elements['about'];\n\t\tif (text) {\n\t\t\tindicate_on.classList.add(indication_classname);\n\t\t\tif (this.has_ticker_planes()) {\n\t\t\t\t// window.setTimeout(() => {this.flash()}, 2000, this);\n\t\t\t}\n\t\t} else {\n\t\t\tindicate_on.classList.remove(indication_classname);\n\t\t\ttext = '';\n\t\t}\n\t\tthis.elements['infoline'].innerHTML = text;\n\t}\n\t*/\n\n\t/**\n\t * @summary Will refresh player interface at each time change (a lot)\n\t *\n\t * @private\n\t */\n\tupdate() {\n\t\tif (!this.update_error()) {\n\t\t\tthis.update_playbutton();\n\t\t\tthis.update_time();\n\t\t\tthis.update_time_borders();\n\t\t}\n\t}\n\n\t/**\n\t * @summary Position an element in the timeline, on its time\n\t * @private\n\t *\n\t * @param      {Element} \t\t\t      element         Element to impact, should be in #time\n\t * @param      {number|undefined}   \t  seconds_begin   Starts position in seconds, do not apply if undefined\n\t * @param      {number|undefined|boolean} seconds_end     Ends position in seconds, do not apply if undefined or false\n\t */\t\n\tposition_time_element(element, seconds_begin=undefined, seconds_end=undefined) {\n\n\t\t/**\n          * @param  {number|undefined|boolean} sec  Is it a \"seconds\" value ?\n          * @return {boolean}\n          */\n\t\tfunction is_seconds(sec) {\n\t\t\t// completely ugly... but  WAT  ! as in https://www.destroyallsoftware.com/talks/wat\n\t\t\treturn ((sec !== undefined) && (sec !== false));\n\t\t}\n\t\tlet duration = this.audiotag.duration;\n\n\t\tif ((duration === 0) || (isNaN(duration))) {\n\t\t\t// duration still unkonw ! We will need to redraw later the tracks\n\t\t}\n\n\t\tif (is_seconds(seconds_begin)) {\n\t\t\telement.style.left =  `${100 * (seconds_begin / duration)}%`;\n\t\t}\n\t\tif (is_seconds(seconds_end)) {\n\t\t\telement.style.right = `${100 - 100 * (seconds_end / duration)}%`;\n\t\t}\n\t\t\n\t}\n\n\t/**\n\t * @summary Shows the throbber\n\t *\n\t * @public\n\t *\n\t * @param      {number}  seeked_time  The seeked time\n\t */\n\tasync show_throbber_at(seeked_time) {\n\t\tlet audiotag = this.audiotag;\n\t\tif (audiotag.duration < 1) {\n\t\t\t// do not try to show if no metadata\n\t\t\treturn;\n\t\t}\n\t\tif ((isNaN(audiotag.duration)) && (!document.CPU.is_audiotag_streamed(audiotag))) {\n\t\t\t// as we navigate on the timeline, we wish to know its total duration\n\t\t\t// yes, this is twice calling, as of trigger.throbble() \n  \t\t\taudiotag.setAttribute('preload', 'metadata'); \n\t\t}\n\n\t\tlet phylactere = this.elements['popup'];\n\t\tlet elapse_element = this.elements['line'];\n\n\t\tphylactere.style.opacity = 1;\n\t\tthis.position_time_element(phylactere, seeked_time);\n\t\tphylactere.innerHTML = convert.SecondsInColonTime(seeked_time);\n\t\tphylactere.dateTime = convert.SecondsInTime(seeked_time).toUpperCase();\n\t}\n\n\t/**\n\t * @summary Hides immediately the throbber.\n\t *\n\t * @public\n\t *\n\t * @param      {Object|undefined}  that    \"this\" callback\n\t */\n\thide_throbber(that=undefined) {\n\t\tthat = that === undefined ? this : that;\n\t\tlet phylactere = that.elements['popup'];\n\t\tphylactere.style.opacity = 0;\n\t}\n\n\t/**\n\t * @summary Hides the throbber later. Will delay the hiding if recalled.\n\t * @public\n\t */\n\thide_throbber_later() {\n\t\tlet hide_throbber_delay = 1000\n\t\tlet phylactere = this.elements['popup'];\n\t\tif (phylactere._hider) {\n\t\t\twindow.clearTimeout(phylactere._hider);\n\t\t}\n\t\tphylactere._hider = window.setTimeout(this.hide_throbber, hide_throbber_delay, this);\n\t}\n\n\t/**\n\t * @summary Will get presentation data from <audio> or from parent document\n\t *\n\t * @package\n\t *\n\t * @return     {Object}  dataset\n\t */\n\tfetch_audiotag_dataset() {\n\t\tlet dataset = {} \n\t\tfor (let key in document.CPU.default_dataset) {\n\t\t\tlet value = null;\n\t\t\tif (key in this.audiotag.dataset) {\n\t\t\t\tvalue = this.audiotag.dataset[key];\n\t\t\t} else {\n\t\t\t\tif (document.CPU.default_dataset[key] !== null) {\n\t\t\t\t\tvalue = document.CPU.default_dataset[key];\n\t\t\t\t}\n\t\t\t}\n\t\t\tdataset[key] = value === undefined ? null : value;\n\t\t}\n\t\treturn dataset;\n\t}\n\n\t/**\n\t * @private\n\t *\n\t * @summary Update links for sharing\n\t */\n\tupdate_links() {\n\t\tlet container = this;\n\t\tfunction ahref(category, href) {\n\t\t\tcontainer.elements[category].href = href;\n\t\t}\n\t\tfunction remove_hash(canonical) {\n\t\t\tlet hash_at = canonical.indexOf('#');\n\t\t\treturn hash_at === -1 ? canonical : canonical.substr(0,hash_at);\n\t\t}\n\n\t\tlet dataset = this.fetch_audiotag_dataset();\n\n\t\tlet url = (dataset.canonical === null ? '' : remove_hash(dataset.canonical))\n\t\t\t\t\t+ `#${this.audiotag.id}` \n\t\t\t\t\t+ ( this.audiotag.currentTime === 0 \n\t\t\t\t\t\t\t? ''\n\t\t\t\t\t\t\t: `&t=${Math.floor(this.audiotag.currentTime)}`\n\t\t\t\t\t\t);\n\n\t\tlet _url = encodeURI(absolutize_url(url));\n\t\tlet _twitter = '';\n\t\tif (\n\t\t\t(dataset.twitter) && /* a little bit better than `dataset.twitter === null` or `typeof dataset.twitter === 'string'` . but really, a little bit */\n\t\t\t(dataset.twitter[0]==='@') /* why did I want an @ in the attribute if I cut it in my code ? to keep HTML readable and comprehensible, instead to developpe attribute name into a \"twitter-handler\" */\n\t\t\t) {\n\t\t\t_twitter = `&via=${dataset.twitter.substring(1)}`;\n\t\t}\n\t\tahref('twitter', `https://twitter.com/share?text=${dataset.title}&url=${_url}${_twitter}`);\n\t\tahref('facebook', `https://www.facebook.com/sharer.php?t=${dataset.title}&u=${_url}`);\n\t\tahref('email', `mailto:?subject=${dataset.title}&body=${_url}`);\n\t\tlet download_link = this.audiotag.currentSrc\n\t\tif (dataset.download) {\n\t\t\tdownload_link = dataset.download;\n\t\t}\n\t\tlet prerefed_audio_src = this.audiotag.querySelector('source[data-downloadable]');\n\t\tif (prerefed_audio_src) {\n\t\t\tdownload_link = prerefed_audio_src.src;\n\t\t}\n\t\tahref('link', download_link);\n\t}\n\n\t/**\n\t * @summary Shows the interface\n\t *\n\t * @public\n\t * @param      {string}  mode    The mode, can be 'main', 'share' or 'error'\n\t */\n\tshow_interface(mode) {\n\t\tthis.container.classList.remove('show-no', 'show-main', 'show-share', 'show-error', 'media-streamed');\n\t\tif (document.CPU.is_audiotag_streamed(this.audiotag)) {\n\t\t\tthis.container.classList.add('media-streamed');\n\t\t}\n\t\tthis.container.classList.add('show-'+mode);\n\t}\n\n\t/**\n\t * @summary Shows the sharing panel\n\t *\n\t * @private\n\t * @param      {Object}  event   The event\n\t */\n\tshow_actions(event) {\n\t\tlet container = (event !== undefined) ?\n\t\t\t\tdocument.CPU.find_container(event.target) :\n\t\t\t\tthis;\n\t\tcontainer.show_interface('share');\n\t\tcontainer.update_links();\n\t}\n\n\t/**\n\t * @summary Shows the main manel\n\t *\n\t * @private\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tshow_main(event = undefined) {\n\t\tlet container = (event !== undefined) ?\n\t\t\t\tdocument.CPU.find_container(event.target) :\n\t\t\t\tthis;\n\t\tcontainer.show_interface('main');\n\t}\n\n\t/**\n\t * @package not mature enough\n\t *\n\t * @summary Shows the handheld fine navigation\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\tshow_handheld_nav(event) {\n\t\tlet container = (event !== undefined) ?\n\t\t\t\tdocument.CPU.find_container(event.target) :\n\t\t\t\tthis;\n\t\tif (document.CPU.is_audiotag_streamed(container.audiotag)) {\n\t\t\treturn;\n\t\t}\n\t\tcontainer.container.classList.toggle('show-handheld-nav');\n\t\tevent.preventDefault();\n\t}\n\n\t/**\n\t * @summary Inject a <style> into the shadowDom\n\t *\n\t * @public\n\t *\n\t * @param \t{string}  style_key   \tA name in the range /[a-zA-Z0-9\\-_]+/, key to tag the created <style>\n\t * @param \t{string}  css \t\t\tinline CSS to inject\n\t */\n\tinject_css(style_key, css) {\n\t\tif (!style_key.match(valid_id)) {\n\t\t\terror(`inject_css invalid key \"${style_key}\"`);\n\t\t\treturn\n\t\t}\n\n\t\tthis.remove_css(style_key);\n\t\tlet element = document.createElement('style');\n\t\telement.id = `style_${style_key}`;\n\t\telement.innerHTML = css;\n\t\tthis.container.appendChild(element);\n\t}\n\n\t/**\n\t * @summary Remove an injected <style> into the shadowDom\n\t *\n\t * @public\n\t *\n\t * @param \t{string}  style_key   \tKey of the created <style> , /[a-zA-Z0-9\\-_]+/\n\t */\n\tremove_css(style_key) {\n\t\tlet element = this.container.querySelector(`#style_${style_key}`);\n\t\tif (element) {\n\t\t\telement.remove();\n\t\t}\n\t}\n\n\t/**\n\t * @summary Adds an identifier to audiotag at build time.\n\t * @private\n\t */\n\tadd_id_to_audiotag() {\n\t\tif (this.audiotag.id === '') {\n\t\t\tthis.audiotag.id = document.CPU.dynamicallyAllocatedIdPrefix + String(document.CPU.count_element++);\n\t\t}\n\t}\n\n\t/**\n\t * @summary Complete the interface at build time\n\t * @package\n\t */\n\tcomplete_template() {\n\t\tlet dataset = this.fetch_audiotag_dataset();\n\t\tlet element_canonical = this.elements['canonical'];\n\n\t\telement_canonical.href = dataset.canonical;\n\n\t\tif (dataset.title === null) {\n\t\t\telement_canonical.classList.add('untitled')\n\t\t\tdataset.title = __.untitled\n\t\t} else {\n\t\t\telement_canonical.classList.remove('untitled')\n\t\t}\n\t\telement_canonical.innerText = dataset.title; \n\t\tthis.elements['poster'].src = dataset.poster === null ? '' : dataset.poster;\n\t\tthis.elements['time'].style.backgroundImage = (dataset.waveform === null) ? '' : `url(${dataset.waveform})`;\n\t}\n\t/**\n\t * @summary Attach the audiotag to the API\n\t * @package\n\t *\n\t * @param      {Element}  audiotag  The audiotag\n\t */\n\tattach_audiotag_to_controller(audiotag) {\n\t\tif (!audiotag) {\n\t\t\treturn;\n\t\t}\n\t\tthis.audiotag = audiotag;\n\n\t\tthis.add_id_to_audiotag()\n\t\tthis.complete_template();\n\n\t\t// throw simplified event\n\t\ttrigger.update({target : audiotag});\n\t}\n\n\n\t/**\n\t * @summary Gets the plane info\n\t * @private\n\t *\n\t * @param      {string}  plane_name     The name\n\t * @return     {Object}                 data of the plane\n\t */\n\tget_plane(plane_name) {\n\t\treturn this.audiotag._CPU_planes[plane_name];\n\t}\n\n\t/**\n\t * @summary Gets the plane track element\n\t * @private\n\t *\n\t * @param      {string}  plane_name   The name\n\t * @return     {Element}    The <aside> track element from ShadowDom interface\n\t */\n\tget_plane_track(plane_name) {\n\t\treturn this.elements['line'].querySelector(`#track_${plane_name}`);\n\t}\n\n\t/**\n\t * @summary Gets the plane panel element\n\t * @private\n\t *\n\t * @param      {string}  plane_name   The name\n\t * @return     {Element}    The panel element from ShadowDom interface\n\t */\n\tget_plane_panel(plane_name) {\n\t\treturn this.container.querySelector(`#panel_${plane_name}`);\n\t}\n\n\t/**\n\t * @summary Gets the <nav><ul> plane panel element\n\t * @private\n\t *\n\t * @param      {string}  plane_name   The name\n\t * @return     {Element}    The <ul> element from ShadowDom interface, null if inexisting\n\t */\n\tget_plane_nav(plane_name) {\n\t\tlet panel = this.get_plane_panel(plane_name);\n\t\treturn panel ? panel.querySelector(`ul`) : null;\n\t}\n\n\t/**\n\t * @summary Draws a plane\n\t * @private\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t */\n\tdraw_plane(plane_name) {\n\t\tlet plane_track = this.get_plane_track(plane_name);\n\t\tif (plane_track) {\n\t\t\tplane_track.remove();\n\t\t}\n\t\tlet plane_panel = this.get_plane_panel(plane_name);\n\t\tif (plane_panel) {\n\t\t\tplane_panel.remove();\n\t\t}\n\n\t\tlet data = this.get_plane(plane_name);\n\t\tif (!data) {\n\t\t\treturn ;\n\t\t}\n\t\tlet highlight_preview = trigger.preview_container_hover;\n\t\tlet remove_highlights_points_bind = this.remove_highlights_points.bind(this);\n\n\t\t/*\n\t\t * @param      {Element}  element  Impacted element\n\t\t */\n\t\tfunction assign_events(element) {\n\t\t\telement.addEventListener('mouseover', highlight_preview, passive_ev);\n\t\t\telement.addEventListener('focusin', highlight_preview, passive_ev);\n\t\t\telement.addEventListener('mouseleave', remove_highlights_points_bind, passive_ev);\n\t\t\telement.addEventListener('focusout', remove_highlights_points_bind, passive_ev);            \n\t\t}\n\n\t\tif (data.track !== false) {\n\t\t\tplane_track = document.createElement('aside');\n\t\t\tplane_track.id = `track_${plane_name}`;\n\t\t\tif (data.track !== true) {\n\t\t\t\tplane_track.classList.add(data.track.split(' '));\n\t\t\t}\n\t\t\t\n\t\t\tthis.elements['line'].appendChild(plane_track);\n\t\t\tassign_events(plane_track);\n\t\t}\n\n\t\tif (data.panel !== false) {\n\t\t\tplane_panel = document.createElement('div');\n\t\t\tplane_panel.id = `panel_${plane_name}`;\n\t\t\tif (data.panel !== true) {\n\t\t\t\tplane_panel.classList.add(data.panel.split(' '));\n\t\t\t}\n\n\t\t\tplane_panel.classList.add('panel');\n\t\t\tlet inner = '<nav><ul></ul></nav>';\n\n\t\t\tif (data['title'] !== undefined) {\n\t\t\t\tinner = `<h6>${escapeHTML(data['title'])}</h6>${inner}`;\n\t\t\t}\n\t\t\tplane_panel.innerHTML = inner;\n\t\t\tthis.container.appendChild(plane_panel);\n\t\t\tassign_events(plane_panel);\n\t\t}\n\n\t\tif (\n\t\t\t(this.element.tagName !== CpuControllerTagName) &&\n\t\t\t(document.CPU.global_controller !== null) &&\n\t\t\t(this.audiotag.isEqualNode(document.CPU.global_controller.audiotag))\n\t\t\t) {\n\t\t\tdocument.CPU.global_controller.draw_plane(plane_name);\n\t\t}\n\n\t}\n\n\t/**\n\t * @summary Add an annotation plane layer\n\t * @public\n\t *\n\t * @param      {string}   plane_name  A name in the range /[a-zA-Z0-9\\-_]+/\n\t * @param      {string}   title       The displayed title for the panel\n\t * @param      {Object}   data        { track : true/false/classnames , \n\t * \t\t\t\t\t\t\t\t\t\tpanel : true/false/classnames , \n\t * \t\t\t\t\t\t\t\t\t\thighlight : true/false }\n\t *\n\t * @return     {boolean}  success\n\t */\n\tadd_plane(plane_name, title, data) {\n\t\tif ((this.element.tagName === CpuControllerTagName) || (! plane_name.match(valid_id)) || (this.get_plane(plane_name) !== undefined)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\tdata = {};\n\t\t} \n\n\t\tif (this.audiotag._CPU_planes === undefined) {\n\t\t\tthis.audiotag._CPU_planes = {};\n\t\t}\n\t\tlet default_values = {\n\t\t\t'track'     : true,\n\t\t\t'panel'     : true,\n\t\t\t'title'     : title,\n\t\t\t'highlight' : true,\n\t\t\t'points'    : {}\n\t\t}\n\n\t\tfor (let key in default_values) {\n\t\t\tif (data[key] === undefined) {\n\t\t\t\tdata[key] = default_values[key];\n\t\t\t}\n\t\t}\n\n\t\tthis.audiotag._CPU_planes[plane_name] = data;\n\t\tthis.draw_plane(plane_name);\n\t\treturn true;\n\t}\n\t/**\n\t * @summary Remove an annotation plane layer\n\t * @public\n\t *\n\t * @param      {string}   name    A name in the range /[a-zA-Z0-9\\-_]+/\n\t *\n\t * @return     {boolean}  success\n\t */\n\tremove_plane(name) {\n\t\tif ( (this.element.tagName === CpuControllerTagName) || (! name.match(valid_id)) || (this.audiotag._CPU_planes[name] === undefined)) {\n\t\t\treturn false;\n\t\t}\n\t\tif (this.audiotag) {\n\t\t\t// we are perhaps in <cpu-controller>\n\t\t\tdelete this.audiotag._CPU_planes[name];\n\t\t}\n\t\tlet remove_element = this.get_plane_track(name);\n\t\tif (remove_element) {\n\t\t\tremove_element.remove()\n\t\t}\n\t\tremove_element = this.get_plane_panel(name);\n\t\tif (remove_element) {\n\t\t\tremove_element.remove();\n\t\t}\n\n\t\tif (\n\t\t\t(this.element.tagName !== CpuControllerTagName) &&\n\t\t\t(document.CPU.global_controller !== null) &&\n\t\t\t(this.audiotag.isEqualNode(document.CPU.global_controller.audiotag))\n\t\t\t) {\n\t\t\t// as plane data is removed, it will remove its aside and track \n\t\t\tdocument.CPU.global_controller.draw_plane(name);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Gets the point track identifier\n\t * @private\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t * @param      {string}  point_name  The point name\n\t * @param      {boolean} panel       Is panel (true) or track (false)\n\t * @return     {string}  The point track identifier.\n\t */\n\tget_point_id(plane_name, point_name, panel) {\n\t\treturn `${panel?'panel':'track'}_${plane_name}_point_${point_name}`;\n\t}\n\n\t/**\n\t * @summary Gets the point info\n\t * @private\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t * @param      {string}  point_name  The point name\n\t * @return     {Object}  Data\n\t */\n\tget_point(plane_name, point_name) {\n\t\treturn this.audiotag._CPU_planes[plane_name].points[point_name];\n\t}\n\n\t/**\n\t * @summary Gets the point element in the track\n\t * @private\n\t *\n\t * @param      {string}  plane_name   The plane\n\t * @param      {string}  point_name   The point\n\t * @return     {Element}    The <div> point element into <aside> from ShadowDom interface\n\t */\n\tget_point_track(plane_name, point_name) {\n\t\treturn this.elements['line'].querySelector('#' + this.get_point_id(plane_name, point_name, false));\n\t}\n\n\t/**\n\t * @summary Gets the point element in the panel\n\t * @private\n\t *\n\t * @param      {string}  plane_name   The plane\n\t * @param      {string}  point_name   The point\n\t * @return     {Element}    The <li> point element into panel from ShadowDom interface\n\t */\n\tget_point_panel(plane_name, point_name) {\n\t\treturn this.container.querySelector('#' + this.get_point_id(plane_name, point_name, true));\n\t}\n\n\t/**\n\t * @summary Transform VTT tag langage into HTML tags, filtering out some\n\t * \n\t * NEVER EVER BELIEVE you can parse HTML with regexes ! This function works because we just do minimalistic changes\n\t * By the way, regexes are really time consuming, both for you and your computer.\n\t * And, sincerely, I love playing on https://regexcrossword.com/\n\t *\n\t * @param      {string}            vtt_taged  The vtt tagged\n\t * @return     string                         HTML tagged string\n\t * \n\t * string.replace().replaceAll() is not corectly understood by Google Closure\n\t * @suppress {missingProperties} */\n\ttranslate_vtt(vtt_taged) {\n\n\t\tlet acceptables = {\n\t\t\t'i'     : 'i',\n\t\t\t'em'    : 'em', // (not in the standard but used in legacy CPU.pm show)\n\t\t\t'b'     : 'b', \n\t\t\t'bold'  : 'strong', // (declared in the MDN page, but never saw it in standard pages)\n\t\t\t'u'     : 'u',\n\t\t\t'lang'  : 'i' // emphasis for typographic convention\n\t\t};\n\n\t\tfunction not_acceptable_tag(/* @param {string} */ name) {\n\t\t\treturn !(name in acceptables);\n\t\t}\n\n\t\t/**\n\t\t * @param      {string}   \t\t   tag \t\t\tUnused regex capture\n\t\t * @param      {string}   \t\t   name \t\tName of the tag\n\t\t * @param      {string}   \t\t   class_name \tattribute key, unused\n\t\t * @param      {string}   \t\t   attribute \tattribute value, may be language code\n\t\t * @return     {string}\n\t\t */\n\t\tfunction opentag(tag, name, class_name, attribute) {\n\t\t\tname = name.toLowerCase();\n\t\t\tif (not_acceptable_tag(name)) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\tlet $_attr = '';\n\t\t\tif (name === 'lang') {\n\t\t\t\t$_attr = ` lang=\"${attribute.trim()}\"`;\n\t\t\t}\n\t\t\treturn `<${acceptables[name]}${$_attr}>`;\n\t\t}\n\n\t\t/**\n\t\t * @param      {string}   \t\t   tag \t\t\tUnused regex capture\n\t\t * @param      {string}   \t\t   name \t\tName of the tag\n\t\t * @return     {string}\n\t\t */\n\t\tfunction closetag(tag, name) {\n\t\t\tname = name.toLowerCase();\n\t\t\tif (not_acceptable_tag(name)) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\treturn `</${acceptables[name]}>`;\n\t\t}\n\n\t\tif ((vtt_taged.split('<').length) !== (vtt_taged.split('>').length)) {\n\t\t\t// unmatching < and >, probably badly written tags, or in full text\n\t\t\t// unsurprisingly, (vtt_taged.split('<').length) is a lot faster than using regex. JS needs a standard property for counting substring occurences in a string\n\t\t\treturn escapeHTML(vtt_taged);\n\t\t}\n\n\t\treturn vtt_taged.\n\t\t\t\treplace(vtt_opentag, opentag).\n\t\t\t\treplace(vtt_closetag, closetag).\n\t\t\t\treplaceAll('\\n', '<br/>');   // JSC_INEXISTENT_PROPERTY ? The property exists, you're drunk Closure !\n\t}\n\n\t/**\n\t * @summary    Resort points of a plane by start-time\n\t * @private\n\t * \n\t * ok, i found it on https://stackoverflow.com/questions/1069666/sorting-object-property-by-values#answer-1069840\n\t *\n\t * @param      {string}   plane_name     The plane name\n\t */\n\tplane_resort(plane_name) {\n\t\tthis.audiotag._CPU_planes[plane_name].points = Object.fromEntries(\n\t\t    Object.entries(this.audiotag._CPU_planes[plane_name].points).sort(\n\t\t    \t(point_a, point_b) => {\n\t\t    \t\treturn point_a[1].start - point_b[1].start;\n\t\t    \t})\n\t\t);\n\t}\n\n\t/**\n\t * @summary Draws a plane point\n\t * @private\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t * @param      {string}  point_name  The point name\n\t */\n\tdraw_point(plane_name, point_name) {\n\t\tlet data = this.get_point(plane_name, point_name);\n\t\tlet audiotag = this.audiotag ? this.audiotag : document.CPU.global_controller.audiotag;\n\n\t\tlet start = data['start'];\n\t\tlet data_link = data['link'];\n\t\tlet link = '#';\n\t\tlet time_url = `#${audiotag.id}&t=${start}`;\n\n\t\tif (data_link === true) {\n\t\t\t// automated link to the audio tag.\n\t\t\t// if the parameter is a string, use it as a simple link\n\t\t\tlink = time_url;\n\t\t}\n\t\tif (typeof(data_link) === 'string') {\n\t\t\t// Author of the page wants a specific url (hoping he know what he do with a \"javascript:\")\n\t\t\tlink = data_link;\n\t\t}\n\n\t\tlet track = this.get_plane_track(plane_name);\n\t\tlet plane_point_track;\n\t\tif (track) {\n\t\t\tplane_point_track = this.get_point_track(plane_name, point_name);\n\t\t\tlet intended_track_id = this.get_point_id(plane_name, point_name, false);\n\t\t\tif (!plane_point_track) {\n\t\t\t\tplane_point_track = document.createElement('a');\n\t\t\t\tplane_point_track.id = intended_track_id;\n\t\t\t\tplane_point_track.tabIndex = -1;\n\t\t\t\ttrack.appendChild(plane_point_track);\n\t\t\t}\n\t\t\tplane_point_track.href = link;\n\n\t\t\tplane_point_track.title = data['text'];\n\t\t\tlet inner = '';\n\t\t\tif (data['image']) {\n\t\t\t\tinner = `<img src=\"${data['image']}\" alt=\"\">`;\n\t\t\t}\n\t\t\tinner += `<span>${data['text']}</span>`;\n\t\t\tplane_point_track.innerHTML = inner;\n\t\t\tthis.position_time_element(plane_point_track, start, data['end']);\n\t\t}\n\n\t\tlet panel = this.get_plane_nav(plane_name);\n\t\tlet plane_point_panel\n\t\tif (panel) {\n\t\t\tplane_point_panel = this.get_point_panel(plane_name, point_name);\n\t\t\tlet data_start = Number(data['start'])\n\t\t\t\n\t\t\tlet intended_panel_id = this.get_point_id(plane_name, point_name, true);\n\t\t\tif (!plane_point_panel) {\n\t\t\t\tplane_point_panel = document.createElement('li');\n\t\t\t\tplane_point_panel.id = intended_panel_id;\n\t\t\t\tplane_point_panel.innerHTML='<a href=\"#\" class=\"cue\"><strong></strong><time></time></a>';\n\t\t\t\tpanel.appendChild(plane_point_panel);\n\t\t\t}\n\n\t\t\tplane_point_panel.querySelector('strong').innerHTML = data['text'];\n\t\t\t// see string format for valid duration time https://www.w3.org/TR/2014/REC-html5-20141028/infrastructure.html#valid-duration-string\n\t\t\tlet time_element = plane_point_panel.querySelector('time');\n\t\t\ttime_element.dateTime = convert.IsoDuration(start);\n\t\t\ttime_element.innerText = convert.SecondsInColonTime(start);\n\n\t\t\tlet action_element = plane_point_panel.querySelector('a');\n\t\t\taction_element.href = link;\n\t\t}\n\n\t\tthis._fire_event('draw_point', {\n\t\t\tplane : plane_name,\n\t\t\tpoint : point_name,\n\t\t\tdata_point :  data,\n\t\t\telement_point_track : plane_point_track,\n\t\t\telement_point_panel : plane_point_panel,\n\t\t});\n\n\t\tif (\n\t\t\t(this.element.tagName !== CpuControllerTagName) &&\n\t\t\t(document.CPU.global_controller !== null) &&\n\t\t\t(this.audiotag.isEqualNode(document.CPU.global_controller.audiotag))\n\t\t\t) {\n\t\t\tdocument.CPU.global_controller.draw_point(plane_name, point_name) \n\t\t}\n\t}\n\n\t/**\n\t * @summary Add an annotation point\n\t * @public\n\t *\n\t * @param      {string}   plane_name      The existing plane name\n\t * @param      {number}   timecode_start  The timecode start for this annotation\n\t * @param      {string}   point_name      The point name, should conform to /^[a-zA-Z0-9\\-_]+$/\n\t * @param      {Object}   data            { 'image' : <url>, \n\t * \t\t\t\t\t\t\t\t\t\t\t'link' : <url>/true (in audio)/false (none), \n\t * \t\t\t\t\t\t\t\t\t\t\t'text' : <text>, \n\t * \t\t\t\t\t\t\t\t\t\t\t'end'  : <seconds> }\n\t *\n\t * @return     {boolean}  success\n\t */\n\tadd_point(plane_name, timecode_start, point_name, data) {\n\t\tdata = data === undefined ? {} : data;\n\t\t\n\t\tif ( (this.element.tagName === CpuControllerTagName) || (this.get_plane(plane_name) === undefined) || (this.get_point(plane_name, point_name) !== undefined) || (timecode_start < 0) || (!point_name.match(valid_id)) ) {\n\t\t\treturn false;\n\t\t}\n\n\t\tdata['start'] = timecode_start;\n\t\tthis.audiotag._CPU_planes[plane_name].points[point_name] = data;\n\n\t\tthis._fire_event('add_point', {\n\t\t\tplane : plane_name,\n\t\t\tpoint : point_name,\n\t\t\tdata_point :  data\n\t\t});\n\n\t\tif (this.audiotag._CPU_planes[plane_name]._st_max > timecode_start) {\n\t\t\t// we need to redraw the plane \n\t\t\tthis.refresh_plane(plane_name);\n\t\t} else {\n\t\t\tthis.draw_point(plane_name, point_name);\n\t\t\tthis.audiotag._CPU_planes[plane_name]._st_max = timecode_start;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Edit an annotation point\n\t * @public\n\t *\n\t * @param      {string}   plane_name      The existing plane name\n\t * @param      {string}   point_name      The existing point name\n\t * @param      {Object}   data            { 'image' : <url>, \n\t * \t\t\t\t\t\t\t\t\t\t\t'link'  : <url>/true (in audio)/false (none), \n\t * \t\t\t\t\t\t\t\t\t\t\t'text'  : <text>, \n\t * \t\t\t\t\t\t\t\t\t\t\t'start' : <seconds>, \n\t * \t\t\t\t\t\t\t\t\t\t\t'end'   : <seconds> }\n\t *\t\t\t\t\t\t\t\t\t\t  will only change keys in the list\n\t */\n\tedit_point(plane_name, point_name, data) {\n\t\tlet original_data = this.get_point(plane_name, point_name);\n\t\tlet will_refresh = false;\n\n\t\tif (('start' in data) && (Number(data['start']) !== original_data['start'])) {\n\t\t\twill_refresh = true;\n\t\t}\n\t\tfor (let key in original_data) {\n\t\t\tif (key in data) {\n\t\t\t\toriginal_data[key] = data[key];\n\t\t\t}\n\t\t}\n\t\t\n\t\tthis.audiotag._CPU_planes[plane_name].points[point_name] = original_data;\n\n\t\tif (will_refresh) {\n\t\t\tthis.clear_plane(plane_name);\n\t\t\tthis.refresh_plane(plane_name);\n\t\t} else {\n\t\t\tthis.draw_point(plane_name, point_name);\n\t\t}\n\n\t\tthis._fire_event('edit_point', {\n\t\t\tplane : plane_name,\n\t\t\tpoint : point_name,\n\t\t\tdata_point :  data\n\t\t});\n\n\t\tlet start = Number(data['start']);\n\t\tif (this.audiotag._CPU_planes[plane_name]._st_max < start) {\n\t\t\tthis.audiotag._CPU_planes[plane_name]._st_max = start;\n\t\t}\n\n\t}\n\n\t/**\n\t * @summary Remove an annotation point\n\t * @public\n\t *\n\t * @param      {string}   plane_name  A name in the range /^[a-zA-Z0-9\\-_$]+/\n\t * @param      {string}   point_name  A name in the range /^[a-zA-Z0-9\\-_$]+/\n\t * @return     {boolean}  success\n\t */\n\tremove_point(plane_name, point_name) {\n\t\tlet point_track_element = this.get_point_track(plane_name, point_name);\n\t\tif (!point_track_element) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis._fire_event('remove_point', {\n\t\t\tplane : plane_name,\n\t\t\tpoint : point_name\n\t\t});\n\n\t\tpoint_track_element.remove();\n\t\tthis.get_point_panel(plane_name, point_name).remove();\n\t\tdelete this.audiotag._CPU_planes[plane_name].points[point_name];\n\n\t\t//  recalc _start_max for caching repaints\n\t\tlet _st_max = 0;\n\t\tfor (let s of Object.values(this.audiotag._CPU_planes[plane_name].points)) {\n\t\t\tlet that_start = Number(s.start);\n\t\t\t_st_max = _st_max < that_start ? that_start : _st_max;\n\t\t}\n\t\tthis.audiotag._CPU_planes[plane_name]._st_max = _st_max;\n\n\t\tif (\n\t\t\t(this.element.tagName !== CpuControllerTagName) &&\n\t\t\t(document.CPU.global_controller !== null) &&\n\t\t\t(this.audiotag.isEqualNode(document.CPU.global_controller.audiotag))\n\t\t\t) {\n\t\t\tdocument.CPU.global_controller.remove_point(plane_name, point_name);\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Gets the plane point names from an id on a ShadowDOM element.\n\t * @package\n\t *\n\t * @param      {string}  element_id  The element identifier\n\t * @return     {Array<string>}    An array with two strings : plane name and point name.\n\t */\n\tget_point_names_from_id(element_id) {\n\t\tlet plane_name = element_id.replace(plane_point_names_from_id,'$2');\n\t\tlet point_name = element_id.replace(plane_point_names_from_id,'$5');\n\t\treturn [plane_name, point_name];\n\t}\n\n\t/**\n\t * @summary Remove any points from an annotation plane\n\t * @public\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t */\n\tclear_plane(plane_name) {\n\t\tlet remove_from_data = this.get_plane(plane_name);\n\t\tif (!remove_from_data) {\n\t\t\treturn false;   \n\t\t}\n\n\t\tfor (let point_name of Object.keys(remove_from_data.points)) {\n\t\t\tthis.remove_point(plane_name, point_name);\n\t\t}\n\t\t// need to repass in case of badly removed / malformed entries\n\t\tlet nav = this.get_plane_nav(plane_name);\n\t\tif (nav !== null) {\n\t\t\tnav.innerHTML = '';\t\n\t\t}\n\t\t// purge repaint flag to redraw\n\t\tthis.audiotag._CPU_planes[plane_name]._st_max = 0;\n\n\t\treturn true;\n\t}\n\n\t/**\n\t * @summary Refresh a plane\n\t * @public\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t */\n\trefresh_plane(plane_name) {\n\t\tthis.plane_resort(plane_name);\n\t\tfor (let point_name of Object.keys(this.audiotag._CPU_planes[plane_name].points)) {\n\t\t\tthis.draw_point(plane_name, point_name);\n\t\t}\n\t}\n\n\n\t/**\n\t * @summary Clean up DOM elements of any annotations, before rebuild them\n\t * @private\n\t */\n\tundraw_all_planes() {\n\t\tquerySelector_apply('aside, div.panel', (element) => { element.remove(); }, this.container);\n\t}\n\n\t/**\n\t * @summary Clear and redraw all planes\n\t * Mainly when cpu-controller is changing targeted audio tag\n\t * @public\n\t */\n\tredraw_all_planes() {\n\t\tthis.undraw_all_planes()\n\t\tfor (let plane_name of Object.keys(this.audiotag._CPU_planes)) {\n\t\t\tthis.draw_plane(plane_name);\n\t\t\tthis.refresh_plane(plane_name);\n\t\t}\n\t}\n\n\n\t/**\n\t * @summary Needed because Chrome can fire loadedmetadata before knowing audio duration. Fired at durationchange\n\t * \n\t * @private\n\t */\n\treposition_tracks() {\n\t\tlet duration = this.audiotag.duration;\n\t\tif ((this.audiotag.duration === 0) || (isNaN(this.audiotag.duration))) {\n\t\t\t// duration still unkown\n\t\t\treturn ;\n\t\t}\n\n\t\tfor (let plane_name in this.audiotag._CPU_planes) {\n\t\t\tlet plane_data = this.get_plane(plane_name);\n\t\t\tif (plane_data.track !== false) {\n\t\t\t\tfor (let point_name of Object.keys(this.audiotag._CPU_planes[plane_name].points)) {\n\t\t\t\t\tlet point_data = this.get_point(plane_name, point_name);\n\t\t\t\t\tlet element = this.get_point_track(plane_name, point_name);\n\t\t\t\t\tthis.position_time_element(element, point_data.start, point_data.end);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Remove any previewes on plane points\n\t * @public\n\t *\n\t * @param      {string}  class_name  Targeted class name, 'with-preview' by default\n\t * @param      {boolean} mirror     Also act on linked cpu-controller/cpu-audio\n\t */\n\tremove_highlights_points(class_name=undefined, mirror=undefined) {\n\t\tmirror = mirror === undefined ? true : mirror;\n\t\tclass_name = (typeof class_name === 'string') ? class_name : preview_classname;\n\t\tquerySelector_apply(`.${class_name}`,(element) => { element.classList.remove(class_name); },this.container);\n\t\t// this.flash(''); // we have a change : redisplay the playing cue text. Not so easy\n\t\tif (\n\t\t\t(mirror) &&\n\t\t\t(document.CPU.global_controller !== null) &&\n\t\t\t(this.audiotag.isEqualNode(document.CPU.global_controller.audiotag))\n\t\t\t) {\n\t\t\tif (this.element.tagName !== CpuControllerTagName) {\n\t\t\t\tdocument.CPU.global_controller.remove_highlights_points(class_name, false);\n\t\t\t} else {\n\t\t\t\tdocument.CPU.find_container(document.CPU.global_controller.audiotag).remove_highlights_points(class_name, false);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Sets a preview on a plane point\n\t * @public\n\t *\n\t * @param      {string}  plane_name  The plane name\n\t * @param      {string}  point_name  The point name\n\t * @param      {string}  class_name  class name, 'with-preview' by default\n\t * @param      {boolean} mirror     Also act on linked cpu-controller/cpu-audio, true by default\n\t */\n\thighlight_point(plane_name, point_name, class_name=undefined, mirror=undefined) {\n\t\tmirror = mirror === undefined ? true : mirror;\n\t\tclass_name = (typeof class_name === 'string') ? class_name : preview_classname;\n\t\tthis.remove_highlights_points(class_name, mirror);\n\n\t\tlet check_plane = this.get_plane(plane_name);\n\n\t\tif ((!check_plane) || (!check_plane['highlight'])) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet track_element = this.get_plane_track(plane_name);\n\t\tif (track_element) {\n\t\t\tlet point_track = this.get_point_track(plane_name, point_name);\n\t\t\tif (point_track) {\n\t\t\t\tpoint_track.classList.add(class_name);\n\t\t\t}\n\t\t}\n\n\t\tlet panel_element = this.get_plane_panel(plane_name);\n\t\tif (panel_element) {\n\t\t\tlet point_panel = this.get_point_panel(plane_name, point_name);\n\t\t\tif (point_panel) {\n\t\t\t\tpoint_panel.classList.add(class_name);\n\t\t\t}\n\t\t}\n\n\t\t/* we need to keep the actual flash message, to recall it\n\t\tlet point = this.get_point(plane_name, point_name);\n\t\tif (point) {\n\t\t\tthis.flash(point['text']); \n\t\t}\n\t\t*/\n\n\t\tif (\n\t\t\t(mirror) &&\n\t\t\t(document.CPU.global_controller !== null) &&\n\t\t\t(this.audiotag.isEqualNode(document.CPU.global_controller.audiotag))\n\t\t\t) {\n\t\t\tif (this.element.tagName !== CpuControllerTagName) {\n\t\t\t\tdocument.CPU.global_controller.highlight_point(plane_name, point_name, class_name, false);\n\t\t\t} else {\n\t\t\t\tdocument.CPU.find_container(document.CPU.global_controller.audiotag).highlight_point(plane_name, point_name, class_name, false);\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * @summary Call when a chapter is changed, to trigger the changes\n\t * @private\n\t *\n\t * @param      {Object}  event   The event\n\t */\n\t_cuechange_event(event) {\n\t\tlet active_cue;\n\t\tlet class_name = 'active-cue';\n\t\tlet plane_name = '_chapters';\n\t\ttry {\n\t\t\t// Chrome may put more than one activeCue. That's a stupid regression from them, but alas... I have to do with\n\t\t\tlet _time = this.audiotag.currentTime;\n\t\t\tfor (let cue of event.target.activeCues) {\n\t\t\t\tif ((cue.startTime <= _time) && (_time < cue.endTime)) {\n\t\t\t\t\tactive_cue = cue;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (Object.is(active_cue, this._activecue)) {\n\t\t\t\treturn ;\n\t\t\t}\n\n\t\t\tthis._activecue = active_cue;\n\t\t\t//this.flash(activecue['text']);\n\t\t\t// do NOT tell me this is ugly, i know this is ugly. I missed something. Teach me how to do it better\n\t\t} catch (error) {\n\t\t\twindow.console.error(error)\n\t\t}\n\n\t\tthis.remove_highlights_points(class_name);\n\t\tif (active_cue) {\n\t\t\ttrigger.cuechange(active_cue, this.audiotag);\n\t\t\tthis._fire_event('chapter_changed', {\n\t\t\t\tcue : active_cue\n\t\t\t});\n\t\t\tthis.highlight_point(plane_name, active_cue.id, class_name);\n\t\t}\n\t}\n\t/**\n\t * @summary Builds or refresh chapters interface.\n\t * @public\n\t *\n\t * @param      {Object|undefined}  event          The event\n\t */\n\tasync build_chapters(event = undefined) {\n\t\t// this functions is called THREE times at load : at build, at loadedmetada event and at load event\n\t\t// and afterwards, we have to reposition track points on duractionchange\n\n\t\tif (this.element.tagName === CpuControllerTagName) {\n\t\t\t// not your job, CPUController\n\t\t\treturn;\n\t\t}\n\n\t\tlet audiotag = this.audiotag;\n\t\tlet has = false;\n\t\tlet plane_name = '_chapters';\n\t\tlet active_cue;\n\n\t\tif (audiotag) {\n\t\t\tif ((audiotag.textTracks) && (audiotag.textTracks.length > 0)) {\n\t\t\t\tlet chapter_track = null;\n\n\t\t\t\tfor (let tracks of audiotag.textTracks) {\n\t\t\t\t\tif (\n\t\t\t\t\t\t\t(tracks.kind.toLowerCase() === 'chapters') &&\n\t\t\t\t\t\t\t(tracks.cues !== null) &&  // linked to default=\"\" attribute, only one per set !\n\t\t\t\t\t\t\t( \n\t\t\t\t\t\t\t\t(chapter_track === null) /* still no active track */ \n\t\t\t\t\t\t\t\t|| (tracks.language.toLowerCase() === prefered_language) /* correspond to <html lang> */ \n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t) {\n\t\t\t\t\t\tchapter_track = tracks;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif ((chapter_track) && (chapter_track.cues.length > 0)) {\n\t\t\t\t\tthis.add_plane(plane_name, __['chapters'], {'track' : 'chapters'});\n\t\t\t\t\t// this.clear_plane(plane_name); // avoid unuseful redraw\n\n\t\t\t\t\tlet _cuechange_event = this._cuechange_event.bind(this);\n\t\t\t\t\t// ugly, but best way to catch the DOM element, as the `cuechange` event won't give it to you via `this` or `event`\n\t\t\t\t\t// adding/reinstall chapter changing event\n\t\t\t\t\tchapter_track.removeEventListener('cuechange', _cuechange_event, passive_ev);\n\t\t\t\t\tchapter_track.addEventListener('cuechange', _cuechange_event, passive_ev);\n\n\t\t\t\t\tfor (let cue of chapter_track.cues) {\n\t\t\t\t\t\tif ((cue.startTime <= cue.startTime) && (cue.startTime < cue.endTime)) {\n\t\t\t\t\t\t\tactive_cue = cue;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (!this.get_point(plane_name, cue.id)) {\n\t\t\t\t\t\t\t// avoid unuseful redraw, again\n\t\t\t\t\t\t\tlet cuepoint = Math.floor(cue.startTime);\n\t\t\t\t\t\t\tthis.add_point(plane_name, cuepoint, cue.id,  {\n\t\t\t\t\t\t\t\t'text' : this.translate_vtt(cue.text),\n\t\t\t\t\t\t\t\t'link' : true,          // point the link to start time position\n\t\t\t\t\t\t\t\t'end'  : cue.endTime    // end timecode of the cue\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (chapter_track.cues.length > 0) {\n\t\t\t\t\t\thas = true;\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.element.tagName === CpuAudioTagName) {\n\t\t\tlet body_class = `cpu_tag_${audiotag.id}_chaptered`;\n\t\t\tif (has) {\n\t\t\t\t/**\n\t\t\t\t * indicate in host page that audio tag chapters are listed see\n\t\t\t\t * https://github.com/dascritch/cpu-audio/issues/36 \n\t\t\t\t */\n\t\t\t\tdocument.body.classList.add(body_class);\n\t\t\t} else {\n\t\t\t\tthis.remove_plane(plane_name);\n\t\t\t\tdocument.body.classList.remove(body_class);\n\t\t\t}\n\n\t\t\t/*\n\t\t\tinfo(`active_cue ${active_cue} && id_in_hash(this.audiotag.id) ${id_in_hash(this.audiotag.id)}`)\n\t\t\tif ((active_cue) && (id_in_hash(this.audiotag.id)) ) {\n\t\t\t\t// shoud be set ONLY if audiotag is alone in page or if audiotag.id named in hash\n\t\t\t\ttrigger.cuechange(active_cue, this.audiotag);\n\t\t\t\tthis._fire_event('chapter_changed', {\n\t\t\t\t\tcue : active_cue\n\t\t\t\t});\n\t\t\t}\n\t\t\t*/\n\t\t}\n\n\t}\n\n\t/**\n\t * @summary Add listeners on tracks to build chapters when loaded\n\t * @private\n\t */\n\tbuild_chapters_loader() {\n\n\t\tthis.audiotag.addEventListener('durationchange', this.reposition_tracks.bind(this), passive_ev);\n\t\tthis.build_chapters();\n\t\tlet this_build_chapters = this.build_chapters.bind(this);\n\t\t// sometimes, we MAY have loose loading\n\n\t\tthis.audiotag.addEventListener('loadedmetadata', this_build_chapters, once_passive_ev);\n\n\t\t\n\t\tlet track_element = this.audiotag.querySelector('track[kind=\"chapters\"]');\n\t\tif ((track_element) && (!track_element._CPU_load_ev)) {\n\t\t\ttrack_element._CPU_load_ev = track_element.addEventListener('load', this_build_chapters, passive_ev);\n\t\t}\n\t}\n\n\t/**\n\t * @summary Builds or refresh the playlist panel. \n\t Should be called only for <cpu-controller>\n\t * @public\n\t */\n\tbuild_playlist() {\n\t\tif (this.element.tagName !== CpuControllerTagName) {\n\t\t\t// Note that ONLY the global controller will display the playlist. For now.\n\t\t\treturn;\n\t\t}\n\n\t\tlet previous_playlist = this.current_playlist;\n\t\tthis.current_playlist = document.CPU.find_current_playlist();\n\n\t\tlet playlist_element = this.elements['playlist'];\n\t\tplaylist_element.innerHTML = '';\n\n\t\tif (this.current_playlist.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tplaylist_element.innerHTML = `<h6>${__['playlist']}</h6>`;\n\t\tfor (let audiotag_id of this.current_playlist) {\n\t\t\tlet audiotag = document.getElementById(audiotag_id);\n\t\t\t\n\t\t\tlet line = document.createElement('a');\n\t\t\tline.classList.add('cue');\n\n\t\t\tif (audiotag_id === this.audiotag.id) {\n\t\t\t\tline.classList.add('active-cue');\n\t\t\t}\n\t\t\tline.href = `#${audiotag.id}&t=0`;\n\t\t\tline.tabIndex = 0;\n\t\t\tline.innerHTML = `<strong>${audiotag.dataset.title}</strong>`;\n\t\t\tplaylist_element.append(line);\n\t\t}\n\n\t}\n\t/**\n\t * @package, because at start\n\t *\n\t * @summary Builds the controller.\n\t */\n\tbuild_controller() {\n\n\t\t// the following mess is to simplify sub-element declaration and selection\n\t\tlet controller = this;\n\t\tquerySelector_apply('[id]', (element) => { controller.elements[element.id] = element; }, this.element.shadowRoot);\n\n\t\t// hide broken image when not loaded\n\t\tthis.elements['poster'].addEventListener('load', () => {\n\t\t\tcontroller.elements['interface'].classList.add('poster-loaded'); \n\t\t}, passive_ev);\n\n\t\tlet cliquables = {\n\t\t\t'pause'     : trigger.play,\n\t\t\t'play'      : trigger.pause,\n\t\t\t'time'      : trigger.throbble,\n\t\t\t'actions'   : this.show_actions,\n\t\t\t'back'      : this.show_main,\n\t\t\t'poster'    : this.show_main,\n\t\t\t'restart'   : trigger.restart,\n\t\t};\n\t\tfor (let that in cliquables) {\n\t\t\tthis.elements[that].addEventListener('click', cliquables[that], passive_ev);\n\t\t}\n\n\t\t// handheld nav to allow long press to repeat action\n\t\tlet _buttons = ['fastreward', 'reward', 'foward', 'fastfoward'];\n\t\tlet _actions = {\n\t\t\t'touchstart'    : true,\n\t\t\t'touchend'      : false,\n\t\t\t'touchcancel'   : false,\n\t\t\t/* PHRACKING IOS PHRACKING SAFARI PHRACKING APPLE */\n\t\t\t'mousedown'     : true,\n\t\t\t'mouseup'       : false,\n\t\t\t'mouseleave'    : false\n\t\t};\n\t\tlet _press = trigger._press_button;\n\t\tlet _release = trigger._release_button;\n\t\tfor (let that of _buttons) {\n\t\t\tfor (let _act in _actions) {\n\t\t\t\tthis.elements[that].addEventListener(_act, _actions[_act] ? trigger._press_button : trigger._release_button);\n\t\t\t}\n\t\t}\n\n\t\t// keyboard management\n\t\tthis.element.addEventListener('keydown', trigger.key);\n\n\t\t// not working correctly :/\n\t\tthis.elements['control'].addEventListener('keydown', trigger.keydownplay);\n\t\t// throbber management\n\t\tlet timeline_element = this.elements['time'];\n\t\tlet do_events = {\n\t\t\t'mouseover' : true,\n\t\t\t'mousemove' : true,\n\t\t\t'mouseout'  : false,\n\n\t\t\t'touchstart'  : true,\n\t\t\t// 'touchmove'   : true,\n\t\t\t'touchend'    : false,\n\t\t\t'touchcancel' : false,\n\t\t}\n\t\tfor (let event_name in do_events) {\n\t\t\ttimeline_element.addEventListener(\n\t\t\t\tevent_name,\n\t\t\t\tdo_events[event_name] ? trigger.hover : trigger.out, passive_ev);\n\t\t}\n\t\t// alternative fine navigation for handhelds\n\t\ttimeline_element.addEventListener('touchstart', trigger.touchstart, passive_ev);\n\t\ttimeline_element.addEventListener('touchend', trigger.touchcancel, passive_ev);\n\t\ttimeline_element.addEventListener('contextmenu', this.show_handheld_nav );\n\n\t\tif (!this.audiotag)  {\n\t\t\t// <cpu-controller> without <cpu-audio> , see https://github.com/dascritch/cpu-audio/issues/91\n\t\t\treturn;\n\t\t}\n\n\t\tthis.show_main();\n\t\tthis.build_chapters_loader();\n\n\t\tthis._fire_event('ready');\n\t}\n};","import {CpuControllerTagName, CpuAudioTagName, acceptable_selector, selector_interface} from './00_prologue.js'\nimport {not_screen_context, warn, querySelector_apply, element_prevent_link_on_same_page} from './11_utils.js'\nimport {trigger} from './30_trigger.js'\nimport {CPU_element_api} from './45_element_cpu.js'\n\n/**\n * Controller without assigned audio element, i.e. global page controller\n *\n * @class      CpuControllerElement (name)\n */\nexport class CpuControllerElement extends HTMLElement {\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis.CPU = null;\n\n\t\tif (not_screen_context()) {\n\t\t\t// I'm not in a screen context, as a braille surface\n\t\t\t// Sorry, but your browser's native controls are surely more accessible\n\t\t\tthis.remove();\n\t\t\treturn ;\n\t\t}\n\n\t\tif (this.tagName === CpuAudioTagName) {\n\t\t\tif (this.querySelector(acceptable_selector) === null) {\n\t\t\t\t// Graceful degradation : do not start if no media element OR no native controls\n\t\t\t\twarn(`Tag <${CpuAudioTagName}> without <audio controls>.\\nSee https://github.com/dascritch/cpu-audio/blob/master/INSTALL.md for a correct installation.`);\n\t\t\t\tthis.remove();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tlet template =  document.querySelector('template#CPU__template');\n\t\tlet shadow_element = this.attachShadow({mode: 'open'});\n\t\tshadow_element.innerHTML = template.innerHTML;\n\t}\n\n\tconnectedCallback() {\n\t\tif (not_screen_context()) {\n\t\t\treturn ;\n\t\t}\n\t\tthis.CPU = new CPU_element_api(\n\t\t\tthis,\n\t\t\tthis.shadowRoot.querySelector(selector_interface)\n\t\t);\n\t\tif (!this.CPU.audiotag) {\n\t\t\tdocument.CPU.global_controller = this.CPU;\n\t\t\tthis.CPU.audiotag = document.querySelector('cpu-audio audio');\n\t\t}\n\n\t\tthis.CPU.build_controller();\n\t\tquerySelector_apply('#canonical', element_prevent_link_on_same_page, this.shadowRoot);\n\n\t\tthis.CPU.attach_audiotag_to_controller(this.CPU.audiotag);\n\n\t\t// construct aspects\n\t\tlet interface_classlist = this.CPU.elements['interface'].classList;\n\n\t\tlet mode = this.getAttribute('mode');\n\t\tif (mode !== null) {\n\t\t// in case of a mode\"still,play\" declaration\n\t\t\tlet modes = mode.split(',');\n\t\t\tif (modes.length > 1) {\n\t\t\t\tmode = this.CPU.audiotag.paused ? modes[0] : modes[1];\n\t\t\t\tthis.CPU.mode_when_play = modes[1];\n\t\t\t}\n\t\t}\n\t\tthis.CPU.set_mode_container(mode);\n\n\t\tlet hide_those = this.getAttribute('hide');\n\t\tif (hide_those !== null) {\n\t\t\tthis.CPU.set_hide_container(hide_those.split(' '));\n\t\t}\n\n\t\tif (navigator.share) {\n\t\t\tinterface_classlist.add('hasnativeshare');\n\t\t\tthis.CPU.elements['nativeshare'].addEventListener('click', trigger.native_share);\n\t\t}\n\n\t\tif (this.getAttribute('glow') !== null) {\n\t\t\tthis.CPU.glow_before_play=true;\n\t\t\tthis.CPU.update_playbutton();\n\t\t}\n\n\t}\n\n\tdisconnectedCallback() {\n\t}\n\n}\n","import {CpuAudioTagName, acceptable_selector} from './00_prologue.js'\nimport {convert} from './20_convert.js'\nimport {trigger} from './30_trigger.js'\nimport {CpuControllerElement} from './70_cpu_controller.class.js'\n\n/**\n * Controller with assigned audio element\n *\n * @class      CpuAudioElement (name)\n */\nexport class CpuAudioElement extends CpuControllerElement {\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis._audiotag = null;\n\t\tthis.audiotag = null;\n\t\tthis.observer_cpuaudio = null;\n\t\tthis.observer_audio = null;\n\t}\n\n\tcopy_attributes_to_media_dataset() {\n\t\t// copying personalized data to audio tag\n\t\tfor (let key in document.CPU.default_dataset) {\n\t\t\tlet value = this.getAttribute(key);\n\t\t\tif (value !== null) {\n\t\t\t\tthis._audiotag.dataset[key] = (key !== 'duration') ? value : convert.TimeInSeconds(value);\n\t\t\t}\n\t\t}\n\t}\n\n\tconnectedCallback() {\n\n\t\tthis._audiotag = this.querySelector(acceptable_selector);\n\t\tif (this._audiotag === null) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.copy_attributes_to_media_dataset();\n\n\t\tsuper.connectedCallback();\n\n\t\tdocument.CPU.connect_audiotag(this.CPU.audiotag);\n\t\n\t\tthis.observer_cpuaudio = new MutationObserver(trigger.observer_cpuaudio);\n\t\tthis.observer_cpuaudio.observe(this, {\n\t\t\t'childList': true,\n\t\t\t'attributes' : true\n\t\t});\n\n\t\tthis.observer_audio = new MutationObserver(trigger.observer_audio);\n\t\tthis.observer_audio.observe(this, {\n\t\t\t'childList': true,\n\t\t\t'attributes' : true,\n\t\t\t'subtree' : true\n\t\t});\n\n\t\t// this.observer.disconnect();\n\n\t}\n\n}\n","/** @license\nCpu-Audio: an extension to the hash system to address timecode into audio/video elements.\nVersion 6.7pre\nCopyright (C) 2014-2021 Xavier \"dascritch\" Mouton-Dubosc & contributors.\nLicense GNU GPL 3\n\n- project mini-site https://dascritch.github.io/cpu-audio/\n- project repository : https://github.com/dascritch/cpu-audio\n- use case : http://cpu.pm\n- blog post : https://dascritch.net/post/2018/11/06/Reconstruire-son-lecteur-audio-pour-le-web\n**/\n\nimport {CpuAudioTagName, CpuControllerTagName, passive_ev, acceptable_selector} from './00_prologue.js'\nimport {is_decent_browser_for_webcomponents, warn, querySelector_apply} from './11_utils.js'\nimport {trigger} from './30_trigger.js'\nimport {document_CPU} from './40_document_cpu.js'\nimport './50_media_element_extension.js'\nimport {CpuControllerElement} from './70_cpu_controller.class.js'\nimport {CpuAudioElement} from './71_cpu_audio.class.js'\nimport {insert_template} from '../tmp/insert_template.js'\n\nexport async function main() {\n\tinsert_template();\n\n\n\tif (!is_decent_browser_for_webcomponents()) {\n\t\twarn(`WebComponent may NOT behave correctly on this browser. Only timecode hash links are activated.\\nSee https://github.com/dascritch/cpu-audio/ for details`);\n\t\tquerySelector_apply(acceptable_selector, document.CPU.attach_events_audiotag);\n\t\tdocument.body.classList.add('cpu-audio-without-webcomponents');\n\t} else {\n\t\twindow.customElements.define(CpuAudioTagName.toLowerCase(), CpuAudioElement);\n\t\twindow.customElements.define(CpuControllerTagName.toLowerCase(), CpuControllerElement); \n\t\tdocument.body.classList.add('cpu-audio-with-webcomponents');\n\t}\n\n\twindow.addEventListener('hashchange', trigger.hashOrder, passive_ev);\n\ttrigger.hashOrder({ at_start : true });\n}\n\n\nif ((document.CPU) || (window.customElements.get(CpuAudioTagName.toLowerCase()))) {\n\twarn('cpu-audio is called twice');\n} else {\n\t// TODO install document.CPU here\n\tHTMLDocument.prototype.CPU = document_CPU;\n\n\tif (document.body !== null) {\n\t\tmain();\n\t} else {\n\t\t// needed in cpu-audio.js context\n\t\tdocument.addEventListener('DOMContentLoaded', main, passive_ev);\n\t}\n}\n\n","// auto-generated source, done via make.sh\nimport {__} from '../src/10_i18n.js'\nexport function insert_template(){\n\tlet style = document.createElement('style');\n\tstyle.innerHTML = `audio[controls]{display:block;width:100%}:root{--cpu-height:64px;--cpu-font-family:Lato,\"Open Sans\",\"Segoe UI\",Frutiger,\"Frutiger Linotype\",\"Dejavu Sans\",\"Helvetica Neue\",Arial,sans-serif;--cpu-font-size:15px;--cpu-font-small-size:calc(var(--cpu-font-size) * 0.8);--cpu-background:#555;--cpu-color:#ddd;--cpu-playing-background:#444;--cpu-playing-color:#fff;--cpu-error-background:#a00;--cpu-error-color:#ff7;--cpu-popup-background:#aaa;--cpu-popup-color:#333;--cpu-cue:#000;--cpu-timeline-limits:#f00;--cpu-elapse-width:160px;--cpu-min-padding:16px;--cpu-inner-shadow:inset 0px 5px 10px -5px black;--cpu-color-transitions:0s;--cpu-background-transitions:0s;--cpu-unfold:0s}@media (max-width:640px){.interface,:root{--cpu-font-size:13px;--cpu-height:48px;--cpu-elapse-width:140px;--cpu-min-padding:4px}@media (max-width:480px){.interface,:root{--cpu-elapse-width:70px}}}`;\n\tdocument.head.appendChild(style);\n\n\tlet template = document.createElement('template');\n\ttemplate.id = 'CPU__template';\n\ttemplate.innerHTML = `<style>:host{all:initial;display:block;contain:content}.act-play{--cpu-background:var(--cpu-playing-background);--cpu-color:var(--cpu-playing-color)}.show-error{--cpu-background:var(--cpu-error-background);--cpu-color:var(--cpu-error-color)}#interface{--cpu-timeline-height:10px;background:var(--cpu-background);color:var(--cpu-color)}#interface,*{font-family:var(--cpu-font-family);font-size:var(--cpu-font-size);font-weight:400;font-style:normal;line-height:1.2;border:none;padding:0;margin:0;text-indent:0;list-style-type:none;user-select:none;transition:color var(--cpu-color-transitions),background-color var(--cpu-background-transitions),opacity var(--cpu-background-transitions)}.show-no main{visibility:hidden}main{display:flex;overflow:hidden;height:var(--cpu-height)}a,button{color:currentColor;border:none;text-decoration:none}button{background:0 0}svg{fill:currentColor;width:var(--cpu-height);height:var(--cpu-height)}em,i{font-style:italic}b,h5 a,strong{font-weight:700}[src='']{visibility:hidden}#pageerror{padding:0 4px;align-self:center}#actions,#control{flex:0 0 var(--cpu-height);width:var(--cpu-height);max-height:var(--cpu-height);height:100%;text-align:center;vertical-align:middle}a{cursor:pointer}#handheld-nav,#loading,#pause,#play,.show-error #pagemain,.show-error #pageshare,.show-error #poster,.show-handheld-nav #titleline,.show-main #pageerror,.show-main #pageshare,.show-share #pageerror,.show-share #pagemain{display:none}.act-glow #pause,.act-loading #loading,.act-pause #pause,.act-play #play{display:block}.act-glow #pause{animation:glow 2s infinite}@keyframes glow{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}.show-main #pagemain,.show-share #pageshare{flex:1 1 100%;display:flex;align-items:center}.act-loading #loading circle{fill:#777;opacity:1;animation:pulse 2s infinite}#loading circle:nth-child(2){animation-delay:.5s}#loading circle:nth-child(3){animation-delay:1s}@keyframes pulse{50%{opacity:0}}#poster{max-width:var(--cpu-height);min-width:var(--cpu-height);max-height:var(--cpu-height);min-height:var(--cpu-height);object-fit:contain;opacity:0}.poster-loaded #poster{opacity:1}.hide-poster #poster{display:none}#actions svg,#control svg{vertical-align:middle;max-width:100%;max-height:100%}#titleline{display:flex;align-items:center}#about,#title{flex:1 1 auto;position:relative}#title{overflow:hidden;text-overflow:''}#title a{display:block;max-height:calc(6px + calc(2 * var(--cpu-font-size)))}#canonical.untitled{font-style:italic}#elapse{flex:0 1 var(--cpu-elapse-width);text-align:right}.mode-compact #elapse{flex:0 0 calc(var(--cpu-elapse-width) + 32px);text-align:center}#time{background-color:#000;background-repeat:no-repeat;background-size:100% 100%;width:100%;height:var(--cpu-timeline-height);display:block;position:relative;cursor:none}#loadingline{background:currentColor;height:var(--cpu-timeline-height);display:block;position:absolute;left:0;pointer-events:none}#loadingline:after{content:'';position:absolute;right:0;width:0;height:var(--cpu-timeline-height);display:block;outline:var(--cpu-color) 4px solid;z-index:127;opacity:0}main:focus #loadingline:after,main:hover #loadingline:after{opacity:1}aside{position:absolute;width:100%}aside a{position:absolute;display:block}aside a span{display:none}aside.chapters{height:2px}aside.chapters a{background:var(--cpu-cue);height:2px;border:1px solid var(--cpu-background)}aside.chapters a.active-cue{background:var(--cpu-color)}aside.borders{pointer-events:none;height:var(--cpu-timeline-height);z-index:4;top:calc(var(--cpu-timeline-height) + 6px)}aside.borders a{height:var(--cpu-timeline-height);background:0 0}aside.borders a:after,aside.borders a:before{pointer-events:none;content:\"\";position:absolute;width:2px;height:var(--cpu-timeline-height);border:2px solid var(--cpu-timeline-limits)}aside.borders a:before{border-right-width:0;left:0}aside.borders a:after{border-left-width:0;left:100%}aside.ticker{height:16px;top:30px}aside.ticker a.active-cue{left:0!important;right:0!important;background:inherit!important;color:inherit!important}aside.ticker a.active-cue span{display:inline-block}.act-loading #loadingline{background:repeating-linear-gradient(45deg,var(--cpu-color) 0,var(--cpu-background) 15px,var(--cpu-color) 30px);background-size:200% 200%;animation:loadingline 1s linear infinite}@keyframes loadingline{0%{background-position-y:var(--cpu-timeline-height)}}#handheld-nav{max-height:calc(6px + calc(2 * var(--cpu-font-size)));padding-bottom:8px}.show-handheld-nav #handheld-nav{display:flex}#handheld-nav *{flex:1 0 auto;height:calc(2 * var(--cpu-font-size))}.hide-actions #actions{visibility:hidden;pointer-events:none;min-width:var(--cpu-min-padding);max-width:var(--cpu-min-padding)}#pageshare{text-align:center}#pageshare a{display:flex;align-items:center;justify-content:center;height:var(--cpu-height)}#pageshare a,#pageshare div{flex:1 0;color:#fff;text-decoration:none;overflow:hidden;text-overflow:clip}#pageshare svg{vertical-align:middle;width:32px;height:32px}#pageshare #nativeshare{display:none}.hasnativeshare #pageshare #nativeshare{display:flex}.hasnativeshare #pageshare .nonativeshare{display:none}#twitter{background:#4db5f4}#facebook,#nativeshare{background:#5974cc}#email{background:#c00}#link{background:#77f}#popup{pointer-events:none;position:absolute;transform:translate(-25px,-19px);z-index:127;min-width:50px;font-size:11px;text-align:center;padding:2px;border-radius:4px;box-shadow:#000 2px 2px;background:var(--cpu-popup-background);color:var(--cpu-popup-color);opacity:0}#popup:before{pointer-events:none;content:\"\";position:absolute;z-index:127;left:20px;bottom:-8px;width:0;height:0;border-top:8px solid var(--cpu-popup-background);border-left:4px solid transparent;border-right:4px solid transparent}.panel{display:flex;list-style:none;flex-direction:column;padding:0 var(--cpu-min-padding);box-shadow:var(--cpu-inner-shadow)}h6{text-align:center}.cue{border-top:1px solid #000;display:flex;margin:0;padding:2px}.cue strong{flex:1 1;font-weight:400}.cue time{flex:0 0 var(--cpu-elapse-width) 0px;text-align:right}.nocuetime time{display:none}.cue time,aside a,aside.ticker *,h6{font-size:var(--cpu-font-small-size)}.mode-compact{width:calc(var(--cpu-elapse-width) + var(--cpu-height) * 2 + 32px)}.mode-button{width:var(--cpu-height)}.mode-button #about,.mode-button #actions,.mode-button #poster,.mode-button .panel,.mode-button aside,.mode-compact #actions,.mode-compact #line,.mode-compact #title,.mode-compact .panel,.mode-compact aside{width:0;display:none}.hide-chapters .chapters,.hide-panels .panel,.hide-panels-except-play .panel,.hide-panels-title h6,.hide-timeline #line,.media-streamed #line,.media-streamed #link,.mode-hidden{display:none}.hide-panels-except-play.last-used .panel{display:flex}.mode-compact.show-main #pagemain{flex:0 0 auto}@media (max-width:640px){.nosmall{display:none!important}#elapse{max-height:16px}#interface{--cpu-timeline-height:8px}#handheld-nav{padding-bottom:4px}aside.ticker{top:22px}}@media (max-width:480px){.nosmaller{display:none!important}.mode-default #elapse{flex:0 1 var(--cpu-elapse-width)}.mode-default #pagemain{padding-bottom:16px}#titleline{height:32px}#line{position:absolute;left:calc(0px - var(--cpu-height));right:calc(0px - var(--cpu-height));height:16px;top:32px}aside a{pointer-events:none}aside.borders{top:-2px}aside.chapters{top:8px}#handheld-nav{padding-bottom:2px}}@media (max-width:320px){.mode-default #elapse,.nosmallest{display:none!important}}@media print{#interface{display:none}}#pageshare div:hover,.active-cue,.with-preview,a:focus,a:hover,button:focus,button:hover{background:var(--cpu-focus-background,var(--cpu-color))!important;color:var(--cpu-focus-color,var(--cpu-background))!important}</style><div id=\"interface\"class=\"show-no\"tabindex=\"0\"><main><img id=\"poster\"class=\"nosmall\"src=\"\"alt=\"\"loading=\"lazy\"decoding=\"async\"><section id=\"pageerror\"role=\"alert\"></section><section id=\"pagemain\"><button type=\"button\"id=\"control\"tabindex=\"0\"><svg id=\"loading\"aria-label=\"${__.loading}\"viewBox=\"0 0 32 32\"aria-hidden=\"true\"><circle cx=\"6\"cy=\"22\"r=\"4\"/><circle cx=\"16\"cy=\"22\"r=\"4\"/><circle cx=\"26\"cy=\"22\"r=\"4\"/><title>${__.loading}</title></svg> <svg id=\"play\"aria-label=\"${__.pause}\"viewBox=\"0 0 32 32\"aria-hidden=\"true\"><title>${__.pause}</title><path d=\"M 6,6 12.667,6 12.667,26 6,26 z\"/><path d=\"M 19.333,6 26,6 26,26 19.333,26 z\"/></svg> <svg id=\"pause\"aria-label=\"${__.play}\"viewBox=\"0 0 32 32\"aria-hidden=\"true\"><title>${__.play}</title><path d=\"M 6,6 6,26 26,16 z\"/></svg></button><div id=\"about\"><div id=\"titleline\"><h5 id=\"title\"><a href=\"#\"id=\"canonical\"aria-label=\"${__.canonical}\"></a></h5><a id=\"elapse\"aria-label=\"${__.moment}\"tabindex=\"-1\"></a></div><div id=\"handheld-nav\"><button type=\"button\"id=\"restart\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><polygon points=\"4,0 8,0 8,16 4,16\"/><path d=\"M 16,0 8,8 16,16 z\"/><path d=\"M 24,0 16,8 24,16 z\"/></svg></button> <button type=\"button\"id=\"fastreward\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 8,0 0,8 8,16 z\"/><path d=\"M 16,0 8,8 16,16 z\"/><path d=\"M 24,0 16,8 24,16 z\"/></svg></button> <button type=\"button\"id=\"reward\"class=\"nosmallest\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 12,0 4,8 12,16 z\"/><path d=\"M 20,0 12,8 20,16 z\"/></svg></button> <button type=\"button\"id=\"foward\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 4,0 12,8 4,16 z\"/><path d=\"M 12,0 20,8 12,16 z\"/></svg></button> <button type=\"button\"id=\"fastfoward\"><svg viewBox=\"0 0 24 16\"aria-hidden=\"true\"><path d=\"M 0,0 8,8 0,16 z\"/><path d=\"M 8,0 16,8 8,16 z\"/><path d=\"M 16,0 24,8 16,16 z\"/></svg></button></div><div id=\"line\"><div id=\"time\"><div id=\"loadingline\"role=\"progressbar\"></div><time id=\"popup\">--:--</time></div></div></div><button id=\"actions\"aria-label=\"${__.more}\"title=\"${__.more}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><circle cx=\"7\"cy=\"16\"r=\"3\"/><circle cx=\"16\"cy=\"16\"r=\"3\"/><circle cx=\"25\"cy=\"16\"r=\"3\"/></svg></button></section><section id=\"pageshare\"><a href=\"#\"target=\"social\"id=\"nativeshare\"aria-label=\"${__.share}\"title=\"${__.share}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 21 0 C 18.2 0 16 2.2 16 5 C 16 5.1 16 5.2 16.0 5.2 L 8.2 9.2 C 7.3 8.4 6.2 8 5 8 C 2.2 8 0 10.2 0 13 C 0 15.8 2.2 18 5 18 C 6.2 18 7.3 17.5 8.2 16.8 L 16 20.8 C 16.0 20.8 16 20.9 16 21 C 16 23.8 18.2 26 21 26 C 23.8 26 26 23.8 26 21 C 26 18.2 23.8 16 21 16 C 19.8 16 18.7 16.4 17.8 17.2 L 10 13.3 C 10 13.2 10 13.1 10 13 C 10 12.9 10 12.8 10 12.8 L 17.8 8.8 C 18.7 9.6 19.8 10 21 10 C 23.8 10 26 7.8 26 5 C 26 2.2 23.8 0 21 0 Z\"></path></svg> <span class=\"nosmall\">${__.share}</span> </a><a href=\"#\"target=\"social\"id=\"twitter\"class=\"nonativeshare\"aria-label=\"${__.twitter}\"title=\"${__.twitter}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 25.9,9.9 C 25.2,10.2 24.4,10.4 23.6,10.5 24.5,10 25.1,9.2 25.4,8.2 24.6,8.8 23.8,9.1 22.9,9.3 22.1,8.5 21.1,8 19.9,8 c -2.2,0 -4,1.8 -4,4 0,0 0,0.6 0.1,0.9 -3.3,-0.2 -6.3,-1.8 -8.3,-4.2 -0.3,0.6 -0.5,1.3 -0.5,2 0,1.4 0.7,2.6 1.8,3.4 -0.7,0 -1.3,-0.2 -1.8,-0.5 0,0 0,0 0,0.1 0,2 1.4,3.6 3.2,4 -0.3,0.1 -0.7,0.1 -1.1,0.1 -0.3,0 -0.5,0 -0.8,-0.1 0.5,1.6 2,2.8 3.7,2.8 -1.4,1.1 -3.1,1.7 -5,1.7 -0.3,0 -0.6,0 -1,-0.1 1.8,1.1 3.9,1.8 6.1,1.8 7.4,0 11.4,-6.1 11.4,-11.4 0,-0.2 0,-0.3 0,-0.5 0.8,-0.6 1.4,-1.3 2,-2.1 z\"/></svg> <span class=\"nosmall\">${__.twitter}</span> </a><a href=\"#\"target=\"social\"id=\"facebook\"class=\"nonativeshare\"aria-label=\"${__.facebook}\"title=\"${__.facebook}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"m 21.1,16 -3.7,0 0,10 -4.3,0 0,-10 -2.1,0 0,-3.3 2.1,0 0,-2.1 c 0,-2.9 1.2,-4.6 4.7,-4.6 l 3.9,0 0,3.5 -3.2,0 c -1,0 -1.1,0.5 -1.1,1.4 l -0,1.8 4.3,0 -0.6,3.3 0,0 z\"/></svg> <span class=\"nosmall\">${__.facebook}</span> </a><a href=\"#\"target=\"social\"id=\"email\"class=\"nonativeshare\"aria-label=\"${__.e_mail}\"title=\"${__.e_mail}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"m 8,9 15.9,0 c 0.3,0 0.6,0.1 0.8,0.2 l -8.8,9 -8.8,-9 c 0.3,-0.1 0.5,-0.2 0.8,-0.2 z m -2,12.3 0,-10.5 c 0,0 0,-0.1 0,-0.1 l 5.8,6 -5.8,5.1 c 0,-0.1 -0.1,-0.3 -0.1,-0.4 z m 17.9,1.8 -15.9,0 c -0.2,0 -0.3,0 -0.5,-0.1 l 5.7,-5 2.8,2.9 2.8,-2.9 5.7,5 c -0.2,0 -0.3,0.1 -0.5,0.1 z m 2,-1.8 c 0,0.2 0,0.3 -0.1,0.5 l -5.8,-5.1 5.8,-6 c 0,0 0,0.1 0,0.1 z\"/></svg> <span class=\"nosmall\">${__.e_mail}</span> </a><a href=\"#\"target=\"social\"download=\"\"id=\"link\"aria-label=\"${__.download}\"title=\"${__.download}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 6,6 26,6 16,26 z\"/><rect x=\"6\"y=\"22\"width=\"20\"height=\"4\"/></svg> <span class=\"nosmall\">${__.download}</span> </a><a id=\"back\"aria-label=\"${__.back}\"title=\"${__.back}\"><svg viewBox=\"0 0 32 32\"aria-hidden=\"true\"><path d=\"M 9,8 24,23 23,24 8,9 z\"/><path d=\"M 9,24 24,9 23,8 8,23 z\"/></svg> <span class=\"nosmall\">${__.back}</span></a></section></main><nav id=\"playlist\"class=\"panel\"></nav></div>`;\n\tdocument.head.appendChild(template);\n}\n"],"sourceRoot":""}