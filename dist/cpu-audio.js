/**

Cpu-Audio, an extension to the hash system to address timecode into audio/video elements
Copyright (C) 2014-2018 Xavier "dascritch" Mouton-Dubosc
License GNU GPL 3

- project repository : https://github.com/dascritch/cpu-audio
- blog post : http://dascritch.net/post/2014/09/03/Timecodehash-%3A-Lier-vers-un-moment-d-un-sonore

Previously TimecodeHash, then OndeMirroir Audio Tag

**/
//# sourceMappingURL=./cpu-audio.js.map

(function(){'use strict';let template,shadow_element;const thisDoc=(document._currentScript||document.currentScript).ownerDocument;const CpuAudioTagName="CPU-AUDIO";const CpuControllerTagName="CPU-CONTROLLER";const selector_interface=".interface";const acceptable_selector="audio[controls]";const acceptable_hide_atttributes=["actions","chapters"];const sources_i18n={"fr":{"loading":"Chargement en cours\u2026","pause":"Pause","play":"Lecture","canonical":"Lien vers la fiche du sonore","moment":"Lien vers ce moment","untitled":"(sans titre)","cover":"pochette","more":"Partager","twitter":"Partager sur Twitter","facebook":"Partager sur Facebook","e_mail":"Partager par e-mail","download":"T\u00e9l\u00e9charger","back":"Annuler","media_err_aborted":"Vous avez annul\u00e9 la lecture.","media_err_network":"Une erreur r\u00e9seau a caus\u00e9 l'interruption du t\u00e9l\u00e9chargement.",
"media_err_decode":"La lecture du sonore a \u00e9t\u00e9 annul\u00e9e suite \u00e0 des probl\u00e8mes de corruption ou de fonctionnalit\u00e9s non support\u00e9s par votre navigateur.","media_err_src_not_supported":"Le sonore n'a pu \u00eatre charg\u00e9, soit \u00e0 cause de sourcis sur le serveur, le r\u00e9seau ou parce que le format n'est pas support\u00e9.","media_err_unknow":"Erreur due \u00e0 une raison inconnue."},"en":{"loading":"Loading\u2026","pause":"Pause","play":"Lecture","canonical":"Link to the sound's page",
"moment":"Link to this time","untitled":"(untitled)","cover":"cover","more":"Share","twitter":"Share on Twitter","facebook":"Share on Facebook","e-mail":"Share via e-mail","download":"Download","back":"Back","media_err_aborted":"You have aborted the play.","media_err_network":"A network error broke the download.","media_err_decode":"Play was canceled due to file corruption or a not supported function in your browser.","media_err_src_not_supported":"The media cannot be downloaded due to server problems, network problems or unsupported by your browser.",
"media_err_unknow":"Error of unknown cause."}};let prefered_language="fr";let languages=window.navigator.languages;languages=languages!==undefined?languages:[navigator.language||navigator.browserLanguage];let added=false;for(let entry in languages){let line=languages[entry];if(line.split){let code=line.split("-")[0];if(!added&&typeof i18n_source==="object"&&i18n_source!==null&&i18n_source[code]!==undefined)prefered_language=code}}const __=sources_i18n[prefered_language];function _insert(){let style=document.createElement("style");style.innerHTML=`/* Fallback */ audio[controls] { display : block; width : 100%; } /* Global default style, usign var. Integrators may override them */ :root { --cpu-height : 64px; --cpu-font-family : Lato, "Open Sans", "Segoe UI", Frutiger, "Frutiger Linotype", "Dejavu Sans", "Helvetica Neue", Arial, sans-serif; --cpu-font-size : 15px; --cpu-background : #555; --cpu-color : #ddd; --cpu-playing-background : #444; --cpu-playing-color : #fff; --cpu-error-background : #a00 ; --cpu-error-color : #ff7 ; --cpu-popup-background : #aaa; --cpu-popup-color : #333; --cpu-elapse-width : 185px; --cpu-min-padding : 16px; --cpu-inner-shadow : inset 0px 5px 10px -5px black; } /* If css element queries not available, fallback to media queries */ @media (max-width: 640px) , @element .interface and (max-width: 640px) { :root , .interface { --cpu-font-size : 13px; --cpu-height : 32px; --cpu-elapse-width : 160px; --cpu-min-padding : 4px; } @media (max-width: 480px) , @element .interface and (max-width: 480px) { :root , .interface { --cpu-elapse-width : 80px; } }`;
document.head.appendChild(style);let template=document.createElement("template");template.id="template_cpu";template.innerHTML=`<style> .interface { font-family : var(--cpu-font-family); font-size : var(--cpu-font-size); } .interface, * { line-height : 1.2; border : none; padding : 0; margin : 0; transition : none; moz-user-select: none; ms-user-select: none; webkit-user-select: none; user-select: none; } .principal { display : flex; overflow : hidden; background : var(--cpu-background); color : var(--cpu-color); height : var(--cpu-height); } .act-error { background : var(--cpu-error-background); color : var(--cpu-error-color); } a { color : var(--cpu-color); border : none; text-decoration : none; } svg { fill : var(--cpu-color); width : var(--cpu-height); height : var(--cpu-height); } a:hover, a:focus { color : var(--cpu-background); background : var(--cpu-color); } a:hover svg , a:focus svg { fill : var(--cpu-background); } .loading circle { fill : #777; } .act-play { background : var(--cpu-playing-background); color : var(--cpu-playing-color); } .act-play svg { fill : var(--cpu-playing-color); } .act-play a { color : var(--cpu-playing-color); } .act-play a:hover, .act-play a:focus { color : var(--cpu-playing-background); background : var(--cpu-playing-color); } .act-play a:hover svg, .act-play a:focus svg { fill : var(--cpu-playing-background); } .show-error { background : var(--cpu-error-background); color : var(--cpu-error-color); } .pageerror { padding: 0px 4px; align-self: center; } .control, .actions, .back { flex : 0 0 var(--cpu-height); width : var(--cpu-height); max-height : var(--cpu-height); height : 100%; text-align : center; vertical-align : middle; } a { cursor : pointer; } .loading, .play, .pause, .show-main .pageshare, .show-main .pageerror, .show-share .pagemain, .show-share .pageerror, .show-error .pagemain, .show-error .pageshare , .show-error .poster { display : none; } .act-loading .loading, .act-play .play, .act-pause .pause { display : block; } .show-share .pageshare, .show-main .pagemain, .share { flex : 1 1 100%; display : flex; align-items: center; } .act-loading .loading circle:nth-child(1) { animation: pulse0 2s infinite; } .act-loading .loading circle:nth-child(2) { animation: pulse1 2s infinite; } .act-loading .loading circle:nth-child(3) { animation: pulse2 2s infinite; } @keyframes pulse0 { 0% {opacity : 1;} 50% {opacity : 0;} 100% {opacity : 1;} } @keyframes pulse1 { 0% {opacity : 0.75;} 12% {opacity : 1;} 62% {opacity : 0;} 100% {opacity : 0.75;} } @keyframes pulse2 { 0% {opacity : 0.5;} 25% {opacity : 1;} 75% {opacity : 0;} 100% {opacity : 0.5;} } @keyframes pulse3 { 0% {opacity : 0.25;} 37% {opacity : 1;} 87% {opacity : 0;} 100% {opacity : 0.25;} } .poster { max-width : var(--cpu-height); min-width : var(--cpu-height); max-height : var(--cpu-height); min-height : var(--cpu-height); object-fit: contain; } .loading svg, .play svg, .pause svg, .actions svg { vertical-align : middle; max-width : 100%; max-height : 100%; } .loading { background : var(--cpu-background) !important; } .titleline { display : flex; } .about, .title { flex : 1 1 100%; position : relative; } .title a { display : block; text-overflow : ellipsis; max-height: 48px; overflow: hidden; } .canonical.untitled { font-style : italic; } .elapse { flex : 1 0 var(--cpu-elapse-width); text-align : right; } .time { background : black; width : 100%; height : 10px; display : block; border-radius : 4px; position : relative; cursor:none; } .loadingline, .elapsedline { background : white; height : 10px ; display : block ; position : absolute; left : 0; border-radius : 4px; pointer-events : none; } .elapsedline { z-index : 2; } .points { display : block ; position : absolute; left : 0; width: 100%; opacity : 0; } .points svg { fill : red; pointer-events : none; position: absolute; z-index : 126; width : 10px; height : 10px; } .act-loading .loadingline { background : repeating-linear-gradient(135deg, #bbb 0, #999 5px, #999 10px, #ddd 15px, #ddd 20px, #bbb 25px); animation: loadingline 500ms linear infinite; } @keyframes loadingline { 0% { background-position-x : -30px; } 100% { background-position-x : 0px;} } .hide-actions .actions { /* we won't display:none, as we need a padding on the right */ visibility : hidden; pointer-events: none; min-width : var(--cpu-min-padding); max-width : var(--cpu-min-padding); } .share { text-align : center; } .share a { height : var(--cpu-height); } .share a, .share div { flex : 1 0; color : white; text-decoration : none; overflow : hidden; text-overflow : clip; } .share a:hover, .share a:focus, .share div:hover { color : var(--cpu-background); background : var(--cpu-color); } .share svg { vertical-align : middle; width : 32px; height : 32px; } .twitter { background : #4DB5F4 } .facebook { background : #5974CC } .email { background : #CC0000 } .link { background : #77F } .popup { pointer-events : none; position: absolute; transform: translate(-25px, -19px); z-index : 127; min-width : 50px; font-size : 11px; text-align : center; padding : 2px; border-radius: 4px; box-shadow: black 2px 2px; background : var(--cpu-popup-background); color : var(--cpu-popup-color); opacity : 0; /* absolute pos, need to repeat it \u2192 https://developer.mozilla.org/en-US/docs/Web/CSS/user-select */ moz-user-select: none; ms-user-select: none; webkit-user-select: none; user-select: none; } .popup:before { pointer-events : none; content:""; position: absolute; z-index : 127; left: 20px; bottom: -8px; width: 0; height : 0; /* arrow form */ border-top: 8px solid var(--cpu-popup-background); border-left: 4px solid transparent; border-right: 4px solid transparent; } .chapters, .playlist { display : flex; overflow : scoll; background : var(--cpu-background); color : var(--cpu-color); list-style: none; flex-direction: column; padding : 0 var(--cpu-min-padding); box-shadow: var(--cpu-inner-shadow); } .cue { border-top : 1px solid black; } .active-cue { background : black; } .cue.active-cue { color : yellow; } .cue a { display : flex; margin : 0px; padding : 2px } .cue strong { flex : 1 1; font-weight : normal; } .cue span { flex : 0 0 var(--cpu-elapse-width); text-align : right; } .mode-compact { width : calc(var(--cpu-elapse-width) + var(--cpu-height) + 32px); } .mode-button { width : var(--cpu-height); } .mode-compact .poster, .mode-compact .title, .mode-compact .line, .mode-compact .actions, .mode-compact .chapters, .mode-button .poster, .mode-button .about, .mode-button .actions, .mode-button .chapters, .mode-hidden, .hide-chapters .chapters { display : none; } .mode-compact.show-main .pagemain { flex : 0 0 auto; } @media (max-width: 640px) , @element .interface and (max-width: 640px) { .nosmall { display : none; } .title a { max-height : 16px; } .elapse { max-height : 16px; } .time, .loadingline, .elapsedline { height : 8px ; } } @media (max-width: 480px) , @element .interface and (max-width: 480px) { .mode-default .notiny { display : none; } .mode-default .elapse { flex : 1 0 var(--cpu-elapse-width); } } @media (max-width: 320px) , @element .interface and (max-width: 320px) { .mode-default .elapse { display : none; } } @media print { .interface { display : none; } }</style><div class="interface" tabindex="0"> <div class="principal"> <img class="poster nosmall" src="" alt="" /> <div class="pageerror"> </div> <div class="pagemain"> <a class="control" tabindex="0"> <div class="loading" title="${__.loading}"> <svg viewBox="0 0 32 32"> <circle cx="6" cy="22" r="4" /> <circle cx="16" cy="22" r="4" /> <circle cx="26" cy="22" r="4" /> </svg> </div> <div class="play" title="${__.pause}"> <svg viewBox="0 0 32 32"> <path d="M 6,6 12.667,6 12.667,26 6,26 z" /> <path d="M 19.333,6 26,6 26,26 19.333,26 z" /> </svg> </div> <div class="pause" title="${__.play}"> <svg viewBox="0 0 32 32"> <path d="M 6,6 6,26 26,16 z" /> </svg> </div> </a> <div class="about"> <div class="titleline"> <div class="title"><a href="#" class="canonical" title="${__.canonical}"></a></div> <a class="elapse" title="${__.moment}" tabindex="-1">\u2026</a> </div> <div class="line"> <div class="time"> <div class="loadingline"></div> <div class="elapsedline"></div> <div class="points"> <svg class="pointstart" viewBox="0 0 2 5"> <path d="M 0,0 2,0 1,1 1,4 2,5 0,5 z" /> </svg> <svg class="pointend" viewBox="0 0 2 5"> <path d="M 2,0 0,0 1,1 1,4 0,5 2,5 z" /> </svg> </div> <time class="popup">--:--</time> </div> </div> </div> <a class="actions" title="${__.more}"> <svg viewBox="0 0 32 32"> <circle cx="12" cy="10" r="4" /> <circle cx="12" cy="22" r="4" /> <circle cx="23" cy="16" r="4" /> <polygon points="12,8 24,14 24,18 12,12"/> <polygon points="12,20 24,14 24,18 12,24"/> </svg> </a> </div> <div class="pageshare"> <div class="share"> <a href="#" target="social" class="twitter nosmall" title="${__.twitter}"> <svg viewBox="0 0 32 32"> <path d="M 25.941,9.885 C 25.221,10.205 24.448,10.422 23.637,10.520 24.465,10.020 25.101,9.230 25.401,8.288 24.626,8.750 23.768,9.086 22.854,9.267 22.122,8.483 21.080,7.993 19.926,7.993 c -2.215,0 -4.011,1.806 -4.011,4.034 0,0.316 0.035,0.623 0.103,0.919 -3.333,-0.168 -6.288,-1.774 -8.267,-4.215 -0.345,0.596 -0.542,1.289 -0.542,2.028 0,1.399 0.708,2.634 1.784,3.358 -0.657,-0.020 -1.276,-0.202 -1.816,-0.504 -3.98e-4,0.016 -3.98e-4,0.033 -3.98e-4,0.050 0,1.954 1.382,3.585 3.217,3.955 -0.336,0.092 -0.690,0.141 -1.056,0.141 -0.258,0 -0.509,-0.025 -0.754,-0.072 0.510,1.602 1.991,2.769 3.746,2.801 -1.372,1.082 -3.102,1.726 -4.981,1.726 -0.323,0 -0.642,-0.019 -0.956,-0.056 1.775,1.144 3.883,1.812 6.148,1.812 7.377,0 11.411,-6.147 11.411,-11.478 0,-0.174 -0.004,-0.348 -0.011,-0.522 0.783,-0.569 1.463,-1.279 2.001,-2.088 z" /> </svg> <span>${__.twitter}</span> </a> <a href="#" target="social" class="facebook nosmall" title="${__.facebook}"> <svg viewBox="0 0 32 32"> <path d="m 21.117,16.002 -3.728,0 0,10.027 -4.297,0 0,-10.027 -2.070,0 0,-3.280 2.070,0 0,-2.130 c 0,-2.894 1.248,-4.616 4.652,-4.616 l 3.922,0 0,3.549 -3.203,0 c -0.950,-0.001 -1.068,0.495 -1.068,1.421 l -0.005,1.775 4.297,0 -0.568,3.280 0,2.34e-4 z" /> </svg> <span>${__.facebook}</span> </a> <a href="#" target="social" class="email" title="${__.e_mail}"> <svg viewBox="0 0 32 32"> <path d="m 8.030,8.998 15.920,0 c 0.284,0 0.559,0.053 0.812,0.155 l -8.773,9.025 -8.773,-9.026 c 0.253,-0.101 0.528,-0.155 0.812,-0.155 z m -1.990,12.284 0,-10.529 c 0,-0.036 0.002,-0.073 0.004,-0.109 l 5.835,6.003 -5.771,5.089 c -0.045,-0.146 -0.068,-0.298 -0.069,-0.453 z m 17.910,1.754 -15.920,0 c -0.175,0 -0.348,-0.020 -0.514,-0.060 l 5.662,-4.993 2.811,2.892 2.811,-2.892 5.662,4.993 c -0.165,0.039 -0.338,0.060 -0.514,0.060 z m 1.990,-1.754 c 0,0.155 -0.023,0.307 -0.068,0.453 l -5.771,-5.089 5.835,-6.003 c 0.002,0.036 0.004,0.073 0.004,0.109 z" /> </svg> <span>${__.e_mail}</span> </a> <a href="#" target="social" class="link" title="${__.download}"> <svg viewBox="0 0 32 32"> <path d="M 6,6 26,6 16,26 z" /> <rect x="6" y="22" width="20" height="4" /> </svg> <span>${__.download}</span></a> <a class="back" title="${__.back}">${__.back}</a> </div> </div> </div> <ul class="chapters"> </ul> <ul class="playlist"> </ul> </div> `;
document.head.appendChild(template)}if(document.head!==null)_insert();else document.addEventListener("DOMContentLoaded",_insert,false);function onDebug(callback_fx){if(typeof callback_fx==="function")callback_fx()}function querySelector_apply(selector,callback,subtree){subtree=subtree===undefined?document:subtree;Array.from(subtree.querySelectorAll(selector)).forEach(callback)}function is_decent_browser_for_webcomponents(){return window.customElements!==undefined}function absolutize_url(url){let test_element=document.createElement("a");test_element.href=typeof url!=="string"?url:url.split("#")[0];return test_element.href}
function not_screen_context(){return!window.matchMedia("screen").matches}function prevent_link_on_same_page(event){if(absolutize_url(window.location.href)!==absolutize_url(event.target.href))return;event.preventDefault()}function element_prevent_link_on_same_page(element){element.addEventListener("click",prevent_link_on_same_page)}function _isEvent(event){return event.preventDefault!==undefined};const convert={units:{"d":86400,"h":3600,"m":60,"s":1},TimeInSeconds:function(givenTime){let seconds=0;if(givenTime!=="")if(/^\d+$/.test(givenTime))seconds=Number(givenTime);else seconds=givenTime.indexOf(":")===-1?this.SubunitTimeInSeconds(givenTime):this.ColonTimeInSeconds(givenTime);return seconds},SubunitTimeInSeconds:function(givenTime){let seconds=0;for(let key in convert.units)if(convert.units.hasOwnProperty(key)&&givenTime.indexOf(key)!==-1){let atoms=givenTime.split(key);seconds+=Number(atoms[0].replace(/\D*/g,
""))*convert.units[key];givenTime=atoms[1]}return seconds},ColonTimeInSeconds:function(givenTime){let seconds=0;let atoms=givenTime.split(":");let convert=[1,60,3600,86400];for(let pos=0;pos<atoms.length;pos++)seconds+=Number(atoms[pos])*convert[atoms.length-1-pos];return seconds},SecondsInTime:function(givenSeconds){let converted="";let inned=false;for(let key in convert.units)if(convert.units.hasOwnProperty(key)){let multiply=convert.units[key];if(givenSeconds>=multiply||inned){inned=true;let digits=
Math.floor(givenSeconds/multiply);converted+=digits+key;givenSeconds-=digits*multiply}}return converted===""?"0s":converted},SecondsInColonTime:function(givenSeconds){let converted="";let inned=false;for(let key in convert.units)if(convert.units.hasOwnProperty(key)){let multiply=convert.units[key];if(givenSeconds>=multiply||inned){inned=true;let digits=Math.floor(givenSeconds/multiply);converted+=converted===""?"":":";converted+=(digits<10&&converted!==""?"0":"")+digits;givenSeconds-=digits*multiply}}if(converted.length===
1)return"0:0"+converted;if(converted.length===2)return"0:"+converted;return converted===""?"0:00":converted}};const trigger={_timecode_start:false,_timecode_end:false,_remove_timecode_outofborders:function(at){if(trigger._timecode_start!==false&&at<trigger._timecode_start||trigger._timecode_end!==false&&at>trigger._timecode_end){trigger._timecode_start=false;trigger._timecode_end=false}},hashOrder:function(hashcode,callback_fx){let at_start=true;if(typeof hashcode!=="string"){at_start="at_start"in hashcode;hashcode=location.hash.substr(1)}let hash="";let timecode="";let segments=hashcode.split("&");let autoplay=
false;for(let _id in segments){let parameter=segments[_id];if(parameter.indexOf("=")===-1&&hash==="")hash=parameter;else{let atoms=parameter.split("=");let p_key=atoms[0];let p_value=atoms[1];switch(p_key){case "t":p_value=p_value!==""?p_value:"0";timecode=p_value;autoplay=true;break;case "autoplay":autoplay=p_value==="1";break;case "auto_play":autoplay=p_value==="true";break}}}if(timecode===""||at_start&&!autoplay){onDebug(callback_fx);return false}let times=timecode.split(",");let timecode_start=
times[0];trigger._timecode_start=convert.TimeInSeconds(timecode_start);trigger._timecode_end=times.length>1?convert.TimeInSeconds(times[1]):false;if(trigger._timecode_end!==false)trigger._timecode_end=trigger._timecode_end>trigger._timecode_start?trigger._timecode_end:false;document.CPU.jumpIdAt(hash,timecode_start,callback_fx);return true},hover:function(event){let container=document.CPU.find_container(event.target);let target_rect=event.target.getClientRects()[0];let relLeft=target_rect.left;let ratio=
event.offsetX/event.target.clientWidth;let seeked_time=ratio*container.audiotag.duration;container.show_throbber_at(seeked_time)},out:function(event){let container=document.CPU.find_container(event.target);container.hide_throbber()},throbble:function(event){let at=0;let container=document.CPU.find_container(event.target);let audiotag=container.audiotag;if(event.at!==undefined)at=event.at;else{let ratio=event.offsetX/event.target.clientWidth;at=ratio*audiotag.duration}trigger._remove_timecode_outofborders(at);
document.CPU.seekElementAt(audiotag,at);trigger.play(event)},pause:function(event,audiotag){if(audiotag===undefined){let target=event.target;audiotag=target.tagName==="AUDIO"?target:document.CPU.find_container(target).audiotag}audiotag.pause();document.CPU.current_audiotag_playing=null;window.localStorage.removeItem(audiotag.currentSrc)},play_once:function(event){let audiotag=event.target;if(document.CPU.only_play_one_audiotag&&document.CPU.current_audiotag_playing&&!document.CPU.is_audiotag_playing(audiotag))trigger.pause(undefined,
document.CPU.current_audiotag_playing);document.CPU.current_audiotag_playing=audiotag},play:function(event,audiotag){if(audiotag===undefined)audiotag=document.CPU.find_container(event.target).audiotag;trigger._remove_timecode_outofborders(audiotag.currentTime);if(document.CPU.global_controller){document.CPU.global_controller.attach_audiotag_to_controller(audiotag);document.CPU.global_controller.audiotag=audiotag;document.CPU.global_controller.show_main();document.CPU.global_controller.build_chapters();
document.CPU.global_controller.build_playlist()}audiotag.play()},key:function(event){let container=document.CPU.find_container(event.target);function seek_relative(seconds){event.at=container.audiotag.currentTime+seconds;container.show_throbber_at(event.at);trigger.throbble(event);container.hide_throbber_later()}switch(event.keyCode){case 27:document.CPU.seekElementAt(container.audiotag,0);trigger.pause(undefined,container.audiotag);break;case 32:container.audiotag.paused?trigger.play(undefined,container.audiotag):
trigger.pause(undefined,container.audiotag);break;case 35:document.CPU.seekElementAt(container.audiotag,container.audiotag.duration);break;case 36:document.CPU.seekElementAt(container.audiotag,0);break;case 37:seek_relative(-document.CPU.keymove);break;case 39:seek_relative(+document.CPU.keymove);break;default:return}event.preventDefault()},keydownplay:function(event){if(event.keyCode!==13)return;let container=document.CPU.find_container(event.target);container.audiotag.paused?trigger.play(undefined,
container.audiotag):trigger.pause(undefined,container.audiotag);event.preventDefault()},cuechange:function(event,chapters_element){if(chapters_element===undefined)return;let classname="active-cue";let previous=chapters_element.querySelector(`.${classname}`);if(previous!==null)previous.classList.remove(classname);if(event.target.activeCues.length===0)return;let cue_id=event.target.activeCues[0].id;chapters_element.querySelector(`#${cue_id}`).classList.add(classname)},update:function(event){let audiotag=
event.target;if(trigger._timecode_end!==false&&audiotag.currentTime>trigger._timecode_end)trigger.pause(undefined,audiotag);audiotag.CPU_update();if(!audiotag.paused)window.localStorage.setItem(audiotag.currentSrc,String(audiotag.currentTime))},ended:function(event,audiotag){if(audiotag===undefined)audiotag=event.target;if(!("playlist"in audiotag.dataset))return;let playlist_name=audiotag.dataset.playlist;let playlist=document.CPU.playlists[playlist_name];if(playlist===undefined){console.warn(`Named playlist ${playlist_name} not created. WTF ?`);
return}let playlist_index=playlist.indexOf(audiotag.id);if(playlist_index===-1){console.warn(`Audiotag ${audiotag.id} not in playlist ${playlist_name}. WTF ?`);return}if(playlist_index+1===playlist.length)return;let next_id=playlist[playlist_index+1];let next_audiotag=document.getElementById(next_id);if(next_audiotag===null){console.warn(`Audiotag #${next_id} doesn't exists. WTF ?`);return}document.CPU.seekElementAt(next_audiotag,0);trigger.play(undefined,next_audiotag)},observer_cpuaudio:function(mutationsList){let container=
document.CPU.find_container(mutationsList[0].target);let audio_element=container.element.querySelector("audio");if(audio_element===null){console.info("<audio> element was removed.");container.element.remove();return}container.element.copy_attributes_to_media_dataset()},observer_audio:function(mutationsList){let container=document.CPU.find_container(mutationsList[0].target);container.build_chapters();container.complete_template();let global_controller=document.CPU.global_controller;if(global_controller&&
container.audiotag.isEqualNode(global_controller.audiotag)){global_controller.build_chapters();global_controller.complete_template()}}};document.CPU=document.CPU?document.CPU:{keymove:5,only_play_one_audiotag:true,current_audiotag_playing:null,global_controller:null,dynamicallyAllocatedIdPrefix:"CPU-Audio-tag-",count_element:0,playlists:{},advance_in_playlist:true,convert:convert,trigger:trigger,default_dataset:{"title":function(){for(let domain of["og","twitter"]){let header_element=window.document.querySelector(`meta[property="${domain}:title"]`);if(header_element!==null)return header_element.content}let title=window.document.title;
return title===""?null:title}(),"poster":function(){for(let attr of['property="og:image"','name="twitter:image:src"']){let header_element=window.document.querySelector(`meta[${attr}]`);if(header_element!==null)return header_element.content}return null}(),"canonical":function(){let header_element=window.document.querySelector('link[rel="canonical"]');if(header_element!==null)return header_element.href;return window.location.href.split("#")[0]}(),"twitter":function(){let header_element=window.document.querySelector('meta[name="twitter:creator"]');
if(header_element!==null&&header_element.content.length>1)return header_element.content;return null}(),"playlist":null},recall_stored_play:function(event){if(document.CPU.current_audiotag_playing!==null)return;let audiotag=event.target;let lasttimecode=Number(window.localStorage.getItem(audiotag.currentSrc));if(lasttimecode>0){document.CPU.seekElementAt(audiotag,lasttimecode);trigger.play(undefined,audiotag)}},recall_audiotag:function(audiotag){audiotag.addEventListener("loadedmetadata",document.CPU.recall_stored_play);
audiotag.addEventListener("play",trigger.play_once);audiotag.addEventListener("ended",trigger.ended);audiotag.addEventListener("ready",document.CPU.recall_stored_play);audiotag.addEventListener("canplay",document.CPU.recall_stored_play);["ready","load","loadeddata","canplay","abort","error","stalled","suspend","emptied","play","playing","pause","ended","durationchange","loadedmetadata","progress","timeupdate","waiting"].forEach(function(on){audiotag.addEventListener(on,trigger.update)});if(!is_decent_browser_for_webcomponents())["pause",
"ended"].forEach(function(on){audiotag.addEventListener(on,trigger.pause)});else audiotag.addEventListener("loadedmetadata",document.CPU.find_container(audiotag).build_chapters);if(audiotag.preload==="")audiotag.preload="metadata";audiotag.load()},connect_audiotag:function(audiotag){document.CPU.recall_audiotag(audiotag);audiotag.hidden=true;audiotag.removeAttribute("controls");if(typeof audiotag.dataset.playlist==="string"){let playlist_name=audiotag.dataset.playlist;if(!(playlist_name in document.CPU.playlists))document.CPU.playlists[playlist_name]=
[];document.CPU.playlists[playlist_name].push(audiotag.id)}},is_audiotag_playing:function(audiotag){return document.CPU.current_audiotag_playing&&audiotag.isEqualNode(document.CPU.current_audiotag_playing)},is_audiotag_global:function(audiotag){return this.global_controller===null?this.is_audiotag_playing(audiotag):audiotag.isEqualNode(this.global_controller.audiotag)},jumpIdAt:function(hash,timecode,callback_fx){function do_needle_move(event){let audiotag=event.target;if(_isEvent(event))audiotag.removeEventListener("loadedmetadata",
do_needle_move,true);let secs=convert.TimeInSeconds(timecode);document.CPU.seekElementAt(audiotag,secs);if(audiotag.readyState>=audiotag.HAVE_FUTURE_DATA)do_element_play({target:audiotag});else audiotag.addEventListener("canplay",do_element_play,true);trigger.update({target:audiotag})}function do_element_play(event){let tag=event.target;trigger.play(undefined,tag);if(_isEvent(event))tag.removeEventListener("canplay",do_element_play,true);onDebug(callback_fx)}let selector_fallback="cpu-audio audio";
let audiotag=hash!==""?document.getElementById(hash):document.querySelector(selector_fallback);if(audiotag===undefined||audiotag===null||audiotag.currentTime===undefined){console.warn("jumpIdAt audiotag ",audiotag);return false}if(audiotag.readyState<audiotag.HAVE_CURRENT_DATA){audiotag.addEventListener("loadedmetadata",do_needle_move,true);audiotag.load()}else do_needle_move({target:audiotag});trigger.update({target:audiotag})},find_interface:function(child){return child.closest(selector_interface)},
find_container:function(child){if(child.tagName===CpuAudioTagName||child.tagName===CpuControllerTagName)return child.CPU;if(child.tagName==="AUDIO")return child.parentNode.CPU;return this.find_interface(child).parentNode.host.CPU},seekElementAt:function(audiotag,seconds){if(isNaN(seconds))return;if(audiotag.fastSeek!==undefined)audiotag.fastSeek(seconds);else try{audiotag.currentTime=seconds}catch(e){audiotag.src=`${audiotag.currentSrc.split("#")[0]}#t=${seconds}`}let controller=audiotag.CPU_controller();
if(controller!==null&&controller.update_loading)controller.update_loading(seconds)},find_current_playlist:function(){let current_audiotag=this.global_controller.audiotag;if(current_audiotag===null)return null;for(let playlist_name in this.playlists)if(this.playlists[playlist_name].indexOf(current_audiotag.id)>=0)return this.playlists[playlist_name];return null}};let CPU_element_api=class{constructor(element,container_interface){this.element=element;this.elements={};this.audiotag=element._audiotag;this.container=container_interface}update_act_container(act){this.container.classList.remove("act-loading","act-pause","act-play");this.container.classList.add(`act-${act}`)}update_playbutton(){if(this.audiotag.readyState<this.audiotag.HAVE_CURRENT_DATA){this.update_act_container("loading");return}this.update_act_container(this.audiotag.paused?"pause":"play")}update_line(type,
seconds){let duration=this.audiotag.duration;this.elements[`${type}line`].style.width=duration===0?0:`${100*seconds/duration}%`}update_buffered(){let end=0;let buffered=this.audiotag.buffered;for(let segment=0;segment++;segment<buffered.length)end=buffered.end(segment);this.update_line("elapsed",end)}update_time(event){let timecode=convert.SecondsInTime(this.audiotag.currentTime);let link_to=absolutize_url(this.audiotag.dataset.canonical)+"#";link_to+=this.audiotag.id?this.audiotag.id+"&":"";link_to+=
"t="+timecode;let elapse_element=this.elements["elapse"];elapse_element.href=link_to;let total_duration="\u2026";if(!isNaN(Math.round(this.audiotag.duration)))total_duration=convert.SecondsInColonTime(Math.round(this.audiotag.duration));elapse_element.innerHTML=`${convert.SecondsInColonTime(this.audiotag.currentTime)}\n                                    <span class="notiny"> / ${total_duration}</span>`;this.update_line("loading",this.audiotag.currentTime);this.update_buffered()}update_time_borders(){if(!document.CPU.is_audiotag_global(this.audiotag)||
trigger._timecode_end===false){this.elements.points.style.opacity=0;return}this.elements.points.style.opacity=1;this.elements.pointstart.style.left=`calc(${100*trigger._timecode_start/this.audiotag.duration}% - 4px)`;this.elements.pointend.style.left=`calc(${100*trigger._timecode_end/this.audiotag.duration}% + 0px)`}update_loading(seconds){this.update_line("loading",seconds);this.update_act_container("loading")}update_error(){if(this.audiotag.error!==null){let error_message;let pageerror=this.elements["pageerror"];
this.show_interface("error");switch(this.audiotag.error.code){case this.audiotag.error.MEDIA_ERR_ABORTED:error_message=__.media_err_aborted;break;case this.audiotag.error.MEDIA_ERR_NETWORK:error_message=__.media_err_network;break;case this.audiotag.error.MEDIA_ERR_DECODE:error_message=__.media_err_decode;break;case this.audiotag.error.MEDIA_ERR_SRC_NOT_SUPPORTED:error_message=__.media_err_src_not_supported;break;default:error_message=__.media_err_unknow;break}pageerror.innerText=error_message;return true}return false}update(){if(!this.update_error()){this.update_playbutton();
this.update_time();this.update_time_borders()}}show_throbber_at(seeked_time){if(this.audiotag.duration<1)return;let phylactere=this.elements["popup"];let elapse_element=this.elements["line"];phylactere.style.opacity=1;phylactere.style.left=100*seeked_time/this.audiotag.duration+"%";phylactere.innerHTML=convert.SecondsInColonTime(seeked_time)}hide_throbber(that){that=that===undefined?this:that;let phylactere=that.elements["popup"];phylactere.style.opacity=0}hide_throbber_later(){let phylactere=this.elements["popup"];
if(phylactere._hider)window.clearTimeout(phylactere._hider);phylactere._hider=window.setTimeout(this.hide_throbber,1E3,this)}fetch_audiotag_dataset(){let dataset={};for(let key in document.CPU.default_dataset){let value=null;if(key in this.audiotag.dataset)value=this.audiotag.dataset[key];else if(document.CPU.default_dataset[key]!==null)value=document.CPU.default_dataset[key];dataset[key]=value===undefined?null:value}return dataset}update_links(){let container=this;function ahref(category,href){container.elements[category].href=
href}function remove_hash(canonical){let hash_at=canonical.indexOf("#");return hash_at===-1?canonical:canonical.substr(0,hash_at)}let dataset=this.fetch_audiotag_dataset();let url=(dataset.canonical===null?"":remove_hash(dataset.canonical))+`#${this.audiotag.id}`+(this.audiotag.currentTime===0?"":`&t=${convert.SecondsInTime(this.audiotag.currentTime)}`);let _url=encodeURI(absolutize_url(url));let _twitter="";if(dataset.twitter&&dataset.twitter[0]==="@")_twitter=`&via=${dataset.twitter.substring(1)}`;
ahref("twitter",`https://twitter.com/share?text=${dataset.title}&url=${_url}${_twitter}`);ahref("facebook",`https://www.facebook.com/sharer.php?t=${dataset.title}&u=${_url}`);ahref("email",`mailto:?subject=${dataset.title}&body=${_url}`);ahref("link",this.audiotag.currentSrc)}show_interface(mode){this.container.classList.remove("show-main","show-share","show-error");this.container.classList.add("show-"+mode)}show_actions(event){let container=event!==undefined?document.CPU.find_container(event.target):
this;container.show_interface("share");container.update_links()}show_main(event){let container=event!==undefined?document.CPU.find_container(event.target):this;container.show_interface("main")}add_id_to_audiotag(){if(this.audiotag.id==="")this.audiotag.id=document.CPU.dynamicallyAllocatedIdPrefix+String(document.CPU.count_element++)}complete_template(){let dataset=this.fetch_audiotag_dataset();this.elements["canonical"].href=dataset.canonical;if(dataset.title===null){this.elements["canonical"].classList.add("untitled");
dataset.title=__.untitled}else this.elements["canonical"].classList.remove("untitled");this.elements["canonical"].innerText=dataset.title;this.elements["poster"].src=dataset.poster}attach_audiotag_to_controller(audiotag){this.audiotag=audiotag;this.add_id_to_audiotag();this.complete_template();trigger.update({target:this.audiotag})}build_chapters(event){let self=this;if(event!==undefined)self=document.CPU.find_container(event.target);let chapters_element=self.elements["chapters"];chapters_element.innerHTML=
"";if(!self.audiotag.textTracks||self.audiotag.textTracks.length===0)return;for(let tracks of self.audiotag.textTracks)if(tracks.kind==="chapters"&&tracks.cues!==null){tracks.addEventListener("cuechange",function(event){trigger.cuechange(event,chapters_element)});for(let cue of tracks.cues){let line=document.createElement("li");line.id=cue.id;line.classList.add("cue");let cuepoint=convert.SecondsInTime(cue.startTime);let cuetime=convert.SecondsInColonTime(cue.startTime);line.innerHTML=`<a href="#${self.audiotag.id}&t=${cuepoint}" tabindex="0">\n                            <strong>${cue.text}</strong>\n                            <span>${cuetime}</span>\n                        </a>`;
chapters_element.append(line)}}if(self.element.tagName===CpuAudioTagName&&document.CPU.is_audiotag_playing(self.audiotag)&&document.CPU.global_controller!==null)document.CPU.global_controller.build_chapters()}build_playlist(){let playlist_element=this.elements["playlist"];playlist_element.innerHTML="";let current_playlist=document.CPU.find_current_playlist();if(current_playlist===null)return;for(let audiotag_id of current_playlist){let audiotag=document.getElementById(audiotag_id);let line=document.createElement("li");
line.classList.add("cue");if(audiotag_id===this.audiotag.id)line.classList.add("active-cue");line.innerHTML=`<a href="#${audiotag.id}&t=0" tabindex="0">\n                                <strong>${audiotag.dataset.title}</strong>\n                            </a>`;playlist_element.append(line)}}build_controller(){this.element.classList.add(this.classname);let controller=this;querySelector_apply("*",function(element){element.classList.forEach(function(this_class){if(controller.elements[this_class]===
undefined)controller.elements[this_class]=element})},this.element.shadowRoot);let cliquables={"pause":trigger.play,"play":trigger.pause,"time":trigger.throbble,"actions":this.show_actions,"back":this.show_main,"poster":this.show_main};for(let that in cliquables)this.elements[that].addEventListener("click",cliquables[that]);this.element.addEventListener("keydown",trigger.key);this.elements["control"].addEventListener("keydown",trigger.keydownplay);let timeline_element=this.elements["time"];let do_events=
{"mouseover":true,"mousemove":true,"mouseout":false,"touchstart":true,"touchend":false,"touchcancel":false};for(let event_name in do_events)timeline_element.addEventListener(event_name,do_events[event_name]?trigger.hover:trigger.out);this.show_main();this.build_chapters()}};HTMLAudioElement.prototype.CPU_controller=function(){return this.closest(CpuAudioTagName)};HTMLAudioElement.prototype.CPU_update=function(){let controller=this.CPU_controller();if(controller){let api=controller.CPU;if(api&&api.update)api.update()}if(document.CPU.global_controller)document.CPU.global_controller.update()};class CpuControllerElement extends HTMLElement{constructor(){super();if(not_screen_context()){this.remove();return}if(this.tagName===CpuAudioTagName)if(this.querySelector(acceptable_selector)===null){console.warn(`Tag <${CpuAudioTagName}> without <audio controls>.\nSee https://github.com/dascritch/cpu-audio/blob/master/INSTALL.md for a correct installation.`);this.remove();return}template=thisDoc.querySelector("template#template_cpu");shadow_element=this.attachShadow({mode:"open"});shadow_element.innerHTML=
template.innerHTML}connectedCallback(){if(not_screen_context())return;this.CPU=new CPU_element_api(this,this.shadowRoot.querySelector(".interface"));if(!this.CPU.audiotag){document.CPU.global_controller=this.CPU;this.CPU.audiotag=window.document.querySelector("cpu-audio audio")}this.CPU.build_controller();querySelector_apply(".canonical",element_prevent_link_on_same_page,this.shadowRoot);this.CPU.attach_audiotag_to_controller(this.CPU.audiotag);let interface_classlist=this.CPU.elements["interface"].classList;
let mode=this.getAttribute("mode");mode=mode!==null?mode:"default";interface_classlist.add(`mode-${mode}`);let hide_those=this.getAttribute("hide");if(hide_those!==null){let hide_elements=hide_those.split(",");for(let hide_this of hide_elements){hide_this=hide_this.toLowerCase();if(acceptable_hide_atttributes.indexOf(hide_this)>-1)interface_classlist.add(`hide-${hide_this}`)}}}disconnectedCallback(){}};class CpuAudioElement extends CpuControllerElement{copy_attributes_to_media_dataset(){for(let key in document.CPU.default_dataset){let value=this.getAttribute(key);if(value!==null)this._audiotag.dataset[key.toLowerCase()]=value}}connectedCallback(){this._audiotag=this.querySelector(acceptable_selector);if(this._audiotag===null)return;this.copy_attributes_to_media_dataset();super.connectedCallback();document.CPU.connect_audiotag(this.CPU.audiotag);this.observer_cpuaudio=new MutationObserver(trigger.observer_cpuaudio);
this.observer_cpuaudio.observe(this,{childList:true,attributes:true});this.observer_audio=new MutationObserver(trigger.observer_audio);this.observer_audio.observe(this,{childList:true,attributes:true,subtree:true})}};function launch(){window.addEventListener("hashchange",trigger.hashOrder,false);trigger.hashOrder({at_start:true});if(!is_decent_browser_for_webcomponents()){console.error(`<${CpuAudioTagName}> WebComponent may NOT behave correctly. Only timecode hash links are activated.\nSee https://github.com/dascritch/cpu-audio/blob/master/index.html for details`);querySelector_apply(acceptable_selector,document.CPU.recall_audiotag);window.document.body.classList.add("cpu-audio-without-webcomponents")}else{window.customElements.define(CpuAudioTagName.toLowerCase(),
CpuAudioElement);window.customElements.define(CpuControllerTagName.toLowerCase(),CpuControllerElement);window.document.body.classList.add("cpu-audio-with-webcomponents")}}if(window.document.body!==null)launch();else window.document.addEventListener("DOMContentLoaded",launch,false);})();
